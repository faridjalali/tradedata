import{V as In,a as Et}from"./vendor-charts-C-3zq_q_.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function n(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(i){if(i.ep)return;i.ep=!0;const o=n(i);fetch(i.href,o)}})();let Ra=[];function Na(){return Ra}let fr=[];const mr=new Map;function Fa(t,e){mr.set(t,e)}function no(t){mr.delete(t)}function _a(t){if(mr.size!==0)for(const e of t){const n=mr.get(e.id);n!==void 0&&(e.is_favorite=n)}}function mt(){return fr}function ei(t){fr=t}function Ba(t,e){_a(e),fr=[...fr.filter(r=>(r.timeframe||"").trim()!==t),...e]}const No="catvue_app_timezone_v1",ti="America/Los_Angeles",Fo=[{value:"America/Los_Angeles",label:"Los Angeles (US Pacific time)"},{value:"America/Denver",label:"Denver (US Mountain time)"},{value:"America/Chicago",label:"Chicago (US Central time)"},{value:"America/New_York",label:"New York (US Eastern time)"},{value:"UTC",label:"UTC"}],Va=new Set(Fo.map(t=>t.value)),fi=new Set;let hr=Ha(),mi=hr;const tr=new Map;function Oa(t){if(!t)return!1;try{return new Intl.DateTimeFormat("en-US",{timeZone:t}),!0}catch{return!1}}function _o(t){const e=String(t||"").trim();return!e||!Va.has(e)||!Oa(e)?ti:e}function Ha(){let t="";try{t=typeof window<"u"?String(window.localStorage.getItem(No)||""):""}catch{t=""}return _o(t)}function Ua(t){try{if(typeof window>"u")return;window.localStorage.setItem(No,t)}catch{}}function za(t,e){const n=Array.isArray(t)?t.join("|"):t,r=Object.entries(e).sort(([i],[o])=>i.localeCompare(o)).map(([i,o])=>`${i}:${String(o)}`);return`${n}|${r.join(",")}`}function qa(){return Fo.map(t=>({...t}))}function ye(){return hr}function Rn(t="en-US",e={}){const n=ye();mi!==n&&(tr.clear(),mi=n);const r=za(t,e),i=tr.get(r);if(i)return i;const o=new Intl.DateTimeFormat(t,{...e,timeZone:n});return tr.set(r,o),o}function Wa(t){const e=_o(t),n=hr;return e===n||(hr=e,Ua(e),tr.clear(),mi=e,fi.forEach(r=>{try{r(e,n)}catch{}})),e}function Ga(t){return fi.add(t),()=>{fi.delete(t)}}const ke=[1,3,7,14,28],hi=new Map,Un=new Map,ja="custom_chart_settings_v1",nr="1min",Ka=new Set(["1min","5min","15min","30min","1hour","4hour"]);function Bo(t){const e=String(t||"").trim().toLowerCase();return e==="bullish"||e==="bearish"?e:"neutral"}function at(t){return String(t||"").trim().toUpperCase()}function Fr(t){const e=String(t||"").trim();return Ka.has(e)?e:nr}function Nn(){try{if(typeof window>"u")return nr;const t=window.localStorage.getItem(ja);if(!t)return nr;const e=JSON.parse(t);return Fr(e?.volumeDelta?.sourceInterval)}catch{return nr}}function Vo(t,e){return`${at(t)}|${Fr(e)}`}function Pi(t,e){const n=Vo(t,e),r=hi.get(n);return r?!Number.isFinite(r.expiresAtMs)||r.expiresAtMs<=Date.now()?(hi.delete(n),null):r:null}function Oo(t,e){const n=Vo(e.ticker,t);hi.set(n,e)}function Ho(){const t={};for(const e of ke)t[String(e)]="neutral";return t}function Za(t){const e=at(t?.ticker);if(!e)return null;const n=Ho(),r=t?.states||{};for(const s of ke)n[String(s)]=Bo(r[String(s)]);const i=Number(t?.expiresAtMs),o=Number.isFinite(i)&&i>Date.now()?i:Date.now()+3600*1e3;return{ticker:e,tradeDate:typeof t?.tradeDate=="string"?t.tradeDate:null,states:n,expiresAtMs:o}}async function Ya(t,e,n){const r=Fr(e),i=n?.forceRefresh===!0,o=n?.noCache===!0,s=Array.from(new Set(t.map(u=>at(u)).filter(Boolean)));if(s.length===0)return new Map;const a=`${r}|${i?"refresh":"cached"}|${o?"nocache":"cache"}|${s.join(",")}`;if(Un.has(a))return await Un.get(a);const l=(async()=>{const u=new Map,c=new URLSearchParams;c.set("tickers",s.join(",")),c.set("vdSourceInterval",r),i&&c.set("refresh","1"),o&&c.set("nocache","1");const d=await fetch(`/api/chart/divergence-summary?${c.toString()}`,{cache:"no-store"});if(!d.ok)throw new Error(`Failed to fetch divergence summary (HTTP ${d.status})`);const f=await d.json(),p=Array.isArray(f?.summaries)?f.summaries:[];for(const h of p){const m=Za(h);m&&(u.set(m.ticker,m),Oo(r,m))}return u})().catch(()=>new Map).finally(()=>{Un.delete(a)});return Un.set(a,l),await l}async function zn(t,e,n){const r=at(t),i=e?Fr(e):Nn(),o=n?.forceRefresh===!0,s=n?.noCache===!0;if(!r)return null;if(!o&&!s){const l=Pi(r,i);if(l)return l}return(await Ya([r],i,{forceRefresh:o,noCache:s})).get(r)||null}function Xa(t,e){t.querySelectorAll(".div-dot, .divergence-mini-cell").forEach(i=>{const o=String(i.dataset.days||"").trim(),s=e?.states?.[o]||"neutral";i.classList.remove("is-bullish","is-bearish","is-neutral"),s==="bullish"?i.classList.add("is-bullish"):s==="bearish"?i.classList.add("is-bearish"):i.classList.add("is-neutral")});const r=(t instanceof HTMLElement,t);r instanceof HTMLElement&&(e?.tradeDate?(r.dataset.tradeDate=e.tradeDate,r.title=`Divergence (${ke.join(", ")}d)`):(r.removeAttribute("data-trade-date"),r.title=`Divergence (${ke.join(", ")}d)`))}const Ja={1:3,3:3,7:2,14:2,28:1};function pi(t,e){let n=0;for(const r of ke){const i=String(r),o=String(t?.[i]||"").trim().toLowerCase(),s=Number(Ja[i]||0);o==="bullish"?n+=s:o==="bearish"&&(n-=s)}return e&&(n+=e.ema8===!0?1:e.ema8===!1?-1:0,n+=e.ema21===!0?1:e.ema21===!1?-1:0,n+=e.sma50===!0?1:e.sma50===!1?-1:0,n+=e.sma200===!0?1:e.sma200===!1?-1:0),n}function ro(t,e){const n=at(t);if(!n)return 0;const r=Nn(),i=Pi(n,r);return i?pi(i.states):0}function yn(t){const e=Nn(),n=Array.from(t.querySelectorAll(".div-dot-row[data-ticker], .divergence-mini[data-ticker]"));for(const r of n){const i=at(r.dataset.ticker);if(!i)continue;const o=Pi(i,e);o&&Xa(r,o)}}function _r(t,e){const n=Nn(),i=Date.now()+3600*1e3;for(const o of t||[]){const s=at(o?.ticker);if(!s)continue;const a=Ho(),l=o?.divergence_states||{};for(const u of ke)a[String(u)]=Bo(l[String(u)]);Oo(n,{ticker:s,tradeDate:typeof o?.divergence_trade_date=="string"?o.divergence_trade_date:null,states:a,expiresAtMs:i})}}const io=new Map,Qa=1440*60*1e3;function el(t){const e=`${t}|date`,n=io.get(e);if(n)return n;const r=new Intl.DateTimeFormat("en-CA",{timeZone:t,year:"numeric",month:"2-digit",day:"2-digit"});return io.set(e,r),r}function ni(t,e){const n=Number(t.find(r=>r.type===e)?.value);return Number.isFinite(n)?n:0}function tl(t,e){const n=el(e).formatToParts(t);return{year:ni(n,"year"),month:ni(n,"month"),day:ni(n,"day")}}function Uo(t,e,n){return`${t}-${String(e).padStart(2,"0")}-${String(n).padStart(2,"0")}`}function nl(t,e){const n=rl(t);if(!Number.isFinite(n))return"";const r=new Date(n+e*Qa);return Uo(r.getUTCFullYear(),r.getUTCMonth()+1,r.getUTCDate())}function rl(t){const e=String(t||"").match(/^(\d{4})-(\d{2})-(\d{2})$/);if(!e)return null;const n=Number(e[1]),r=Number(e[2]),i=Number(e[3]);return!Number.isFinite(n)||!Number.isFinite(r)||!Number.isFinite(i)?null:Date.UTC(n,r-1,i)}function il(t=ye()){const n=tl(new Date,t);return Uo(n.year,n.month,n.day)}function ol(t){return t?t<1e3?t.toFixed(0).padEnd(7):(Math.round(t/1e3)+"K").padEnd(7):"0".padEnd(7)}function sl(t,e="",n="",r=ye()){const i=il(r);if(!i)return{startDate:"",endDate:""};if(t==="1"||t==="2"||t==="5"){const o=nl(i,-29);return o?{startDate:o,endDate:i}:{startDate:"",endDate:""}}if(t==="custom"){const o=String(e||"").trim(),s=String(n||"").trim();return/^\d{4}-\d{2}-\d{2}$/.test(o)&&/^\d{4}-\d{2}-\d{2}$/.test(s)?{startDate:o,endDate:s}:{startDate:"",endDate:""}}return{startDate:"",endDate:""}}function we(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function vn(t,e="desc"){return(n,r)=>{let i=0;if(t==="time")i=(r.timestamp||"").localeCompare(n.timestamp||"");else{if(t==="favorite")return n.is_favorite===r.is_favorite?(r.timestamp||"").localeCompare(n.timestamp||""):(r.is_favorite?1:0)-(n.is_favorite?1:0);if(t==="volume")i=(r.signal_volume||0)-(n.signal_volume||0);else if(t==="score"){let o=r.divergence_states?pi(r.divergence_states,r.ma_states):ro(r.ticker),s=n.divergence_states?pi(n.divergence_states,n.ma_states):ro(n.ticker);if(r.vdf_score&&(o+=Math.round(r.vdf_score/10)),n.vdf_score&&(s+=Math.round(n.vdf_score/10)),o!==s)i=o-s;else{const a=(r.signal_volume||0)-(n.signal_volume||0);a!==0?i=a:i=(r.timestamp||"").localeCompare(n.timestamp||"")}}else i=(r.timestamp||"").localeCompare(n.timestamp||"")}return t!=="favorite"&&e==="asc"?-i:i}}function Tt(t,e,n){const r=document.querySelector(t);r&&r.querySelectorAll(".pane-btn").forEach(i=>{const o=i,s=o.dataset.sort;s===e?(o.classList.add("active"),s!=="favorite"&&o.setAttribute("data-sort-dir",n==="asc"?"↑":"↓")):(o.classList.remove("active"),o.removeAttribute("data-sort-dir"))})}function al(t){const e=String(t||"").trim();if(!e)return"";const n=e.match(/^(\d{4})-(\d{2})-(\d{2})/);if(n){const i=Number(n[2]),o=Number(n[3]);if(Number.isFinite(i)&&i>0&&Number.isFinite(o)&&o>0)return`${i}/${o}`}const r=new Date(e);return Number.isNaN(r.getTime())?"":`${r.getMonth()+1}/${r.getDate()}`}function bn(t){const e=al(t.signal_trade_date||t.divergence_trade_date||t.timestamp)||"--",n="DataAPI",r=t.ma_states||{};let i=!1,o=!1;if(t.signal_direction!==void 0&&t.signal_direction!==null){const m=Number(t.signal_direction);i=m===1,o=m===-1}else i=!!(t.signal_type&&t.signal_type.toLowerCase().includes("bull")),o=!i;const s=i?"bullish-card":o?"bearish-card":"",a=ol(t.signal_volume||0),l=t.is_favorite===!0||String(t.is_favorite).toLowerCase()==="true",u=l?"filled":"",c=l?"visible":"hidden",d=l?"1":"0",f=`
        <svg class="fav-icon ${u}" data-id="${t.id}" data-source="${n}" viewBox="0 0 24 24" width="15" height="15" stroke="currentColor" stroke-width="2.25" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <polyline class="check-mark" points="7.5 12.5 10.5 15.5 16.5 9.5" style="visibility: ${c}; opacity: ${d};"></polyline>
        </svg>
    `,p=ke.map(m=>{const g=String(m),b=String(t.divergence_states?.[g]||"neutral").toLowerCase();return`<span class="div-dot ${b==="bullish"?"is-bullish":b==="bearish"?"is-bearish":"is-neutral"}" data-days="${m}"></span>`}).join(""),h=`
        <span class="ma-dot-row" title="8 EMA - 21 EMA - 50 SMA - 200 SMA">
            <span class="ma-dot ${r.ema8?"is-up":"is-down"}"></span>
            <span class="ma-dot ${r.ema21?"is-up":"is-down"}"></span>
            <span class="ma-dot ${r.sma50?"is-up":"is-down"}"></span>
            <span class="ma-dot ${r.sma200?"is-up":"is-down"}"></span>
        </span>
    `;return`
        <div class="alert-card ${s}" data-ticker="${we(t.ticker)}" data-source="${n}">
            ${f}
            <h3>${we(t.ticker)}</h3>
            
            <div class="metrics-container">
                <div class="metric-item">
                    <span class="div-dot-row" data-ticker="${we(t.ticker)}" title="Divergence (${ke.join(", ")}d)">
                        ${p}
                    </span>
                </div>
                <div class="metric-item" title="Volume">
                    <span class="volume-text">${a}</span>
                    ${t.vdf_detected&&t.vdf_score?`<span class="vdf-score-badge${t.vdf_proximity==="imminent"?" vdf-imminent":t.vdf_proximity==="high"?" vdf-high":""}" title="Score">${t.vdf_score}</span>`:t.vdf_detected?'<span class="vdf-tag">VDF</span>':'<span class="vdf-score-placeholder"></span>'}${t.bull_flag_confidence!=null&&t.bull_flag_confidence>=50?`<span class="bull-flag-badge" title="Bull flag (${t.bull_flag_confidence}%)">BF</span>`:""}
                    ${h}
                </div>
            </div>

            <span class="alert-time">${e}</span>
        </div>
    `}function ll(t){if(!t)return t;const e=a=>({time:a[0],open:a[1],high:a[2],low:a[3],close:a[4],volume:a[5]}),n=(a,l="value")=>({time:a[0],[l]:a[1]}),r=Array.isArray(t.bars)&&t.bars.length>0&&Array.isArray(t.bars[0])?t.bars.map(e):t.bars,i=Array.isArray(t.rsi)&&t.rsi.length>0&&Array.isArray(t.rsi[0])?t.rsi.map(a=>n(a)):t.rsi,o=t.volumeDeltaRsi&&Array.isArray(t.volumeDeltaRsi.rsi)&&t.volumeDeltaRsi.rsi.length>0&&Array.isArray(t.volumeDeltaRsi.rsi[0])?t.volumeDeltaRsi.rsi.map(a=>n(a)):t.volumeDeltaRsi?.rsi||[],s=Array.isArray(t.volumeDelta)&&t.volumeDelta.length>0&&Array.isArray(t.volumeDelta[0])?t.volumeDelta.map(a=>n(a,"delta")):t.volumeDelta;return{...t,bars:r,rsi:i,volumeDeltaRsi:{rsi:o},volumeDelta:s}}function cl(t){if(!t)return t;const e=a=>({time:a[0],open:a[1],high:a[2],low:a[3],close:a[4],volume:a[5]}),n=(a,l="value")=>({time:a[0],[l]:a[1]}),r=Array.isArray(t.latestBar)?e(t.latestBar):t.latestBar,i=Array.isArray(t.latestRsi)?n(t.latestRsi):t.latestRsi,o=Array.isArray(t.latestVolumeDeltaRsi)?n(t.latestVolumeDeltaRsi):t.latestVolumeDeltaRsi,s=Array.isArray(t.latestVolumeDelta)?n(t.latestVolumeDelta,"delta"):t.latestVolumeDelta;return{...t,latestBar:r,latestRsi:i,latestVolumeDeltaRsi:o,latestVolumeDelta:s}}async function $i(t,e,n={}){const r=new URLSearchParams;r.set("format","tuple"),Number.isFinite(n.vdRsiLength)&&r.set("vdRsiLength",String(Math.max(1,Math.floor(Number(n.vdRsiLength))))),typeof n.vdSourceInterval=="string"&&n.vdSourceInterval&&r.set("vdSourceInterval",n.vdSourceInterval),typeof n.vdRsiSourceInterval=="string"&&n.vdRsiSourceInterval&&r.set("vdRsiSourceInterval",n.vdRsiSourceInterval);const i=r.toString(),o=`/api/chart?ticker=${encodeURIComponent(t)}&interval=${e}${i?`&${i}`:""}`,s=await fetch(o,{signal:n.signal});if(typeof n.onResponseMeta=="function"&&n.onResponseMeta({status:s.status,chartCacheHeader:s.headers.get("x-chart-cache")}),!s.ok){const l=await s.json().catch(()=>({error:"Failed to fetch chart data"}));throw new Error(l.error||`HTTP ${s.status}`)}const a=await s.json();return ll(a)}async function ul(t,e,n={}){const r=new URLSearchParams;r.set("format","tuple"),Number.isFinite(n.vdRsiLength)&&r.set("vdRsiLength",String(Math.max(1,Math.floor(Number(n.vdRsiLength))))),typeof n.vdSourceInterval=="string"&&n.vdSourceInterval&&r.set("vdSourceInterval",n.vdSourceInterval),typeof n.vdRsiSourceInterval=="string"&&n.vdRsiSourceInterval&&r.set("vdRsiSourceInterval",n.vdRsiSourceInterval);const i=r.toString(),o=`/api/chart/latest?ticker=${encodeURIComponent(t)}&interval=${e}${i?`&${i}`:""}`,s=await fetch(o,{signal:n.signal});if(typeof n.onResponseMeta=="function"&&n.onResponseMeta({status:s.status,chartCacheHeader:s.headers.get("x-chart-cache")}),!s.ok){const l=await s.json().catch(()=>({error:"Failed to fetch latest chart data"}));throw new Error(l.error||`HTTP ${s.status}`)}const a=await s.json();return cl(a)}const zo={dark:{bgColor:"#0d1117",cardBg:"#161b22",surfaceElevated:"#21262d",surfaceOverlay:"rgba(22, 27, 34, 0.98)",textPrimary:"#c9d1d9",textSecondary:"#8b949e",textMuted:"#484f58",borderColor:"#30363d",highlight:"#58a6ff",highlightText:"#ffffff",bgOverlay95:"rgba(13, 17, 23, 0.95)",cardBgOverlay95:"rgba(22, 27, 34, 0.95)",cardBgOverlay60:"rgba(22, 27, 34, 0.6)",cardBgOverlay50:"rgba(22, 27, 34, 0.5)",borderOverlay22:"rgba(48, 54, 61, 0.22)",borderOverlay30:"rgba(48, 54, 61, 0.3)",highlightOverlay10:"rgba(88, 166, 255, 0.1)",dividerColor:"rgba(255, 255, 255, 0.1)",shadowColor:"rgba(0, 0, 0, 0.4)",monthGridlineColor:"#21262d",spinnerColor:"#58a6ff"},light:{bgColor:"#ffffff",cardBg:"#f6f8fa",surfaceElevated:"#e1e4e8",surfaceOverlay:"rgba(246, 248, 250, 0.98)",textPrimary:"#24292e",textSecondary:"#586069",textMuted:"#959da5",borderColor:"#d0d7de",highlight:"#0969da",highlightText:"#ffffff",bgOverlay95:"rgba(255, 255, 255, 0.95)",cardBgOverlay95:"rgba(246, 248, 250, 0.95)",cardBgOverlay60:"rgba(246, 248, 250, 0.6)",cardBgOverlay50:"rgba(246, 248, 250, 0.5)",borderOverlay22:"rgba(208, 215, 222, 0.22)",borderOverlay30:"rgba(208, 215, 222, 0.3)",highlightOverlay10:"rgba(9, 105, 218, 0.1)",dividerColor:"rgba(0, 0, 0, 0.1)",shadowColor:"rgba(0, 0, 0, 0.12)",monthGridlineColor:"#e1e4e8",spinnerColor:"#0969da"},beige:{bgColor:"#F5F0E8",cardBg:"#FFFFFF",surfaceElevated:"#E8E2D8",surfaceOverlay:"rgba(255, 255, 255, 0.98)",textPrimary:"#3D3929",textSecondary:"#7A7464",textMuted:"#A39E90",borderColor:"#DDD6C8",highlight:"#D97706",highlightText:"#ffffff",bgOverlay95:"rgba(245, 240, 232, 0.95)",cardBgOverlay95:"rgba(255, 255, 255, 0.95)",cardBgOverlay60:"rgba(255, 255, 255, 0.6)",cardBgOverlay50:"rgba(255, 255, 255, 0.5)",borderOverlay22:"rgba(221, 214, 200, 0.22)",borderOverlay30:"rgba(221, 214, 200, 0.3)",highlightOverlay10:"rgba(217, 119, 6, 0.1)",dividerColor:"rgba(0, 0, 0, 0.08)",shadowColor:"rgba(0, 0, 0, 0.1)",monthGridlineColor:"#E8E2D8",spinnerColor:"#D97706"},claude:{bgColor:"#1c1b17",cardBg:"#272521",surfaceElevated:"#33312c",surfaceOverlay:"rgba(39, 37, 33, 0.98)",textPrimary:"#d5d3cc",textSecondary:"#9b9990",textMuted:"#5f5d56",borderColor:"#3d3b36",highlight:"#da7756",highlightText:"#ffffff",bgOverlay95:"rgba(28, 27, 23, 0.95)",cardBgOverlay95:"rgba(39, 37, 33, 0.95)",cardBgOverlay60:"rgba(39, 37, 33, 0.6)",cardBgOverlay50:"rgba(39, 37, 33, 0.5)",borderOverlay22:"rgba(61, 59, 54, 0.22)",borderOverlay30:"rgba(61, 59, 54, 0.3)",highlightOverlay10:"rgba(218, 119, 86, 0.1)",dividerColor:"rgba(255, 255, 255, 0.09)",shadowColor:"rgba(0, 0, 0, 0.45)",monthGridlineColor:"#33312c",spinnerColor:"#da7756"}},qo="app_theme";let tt="dark";function dl(){return tt}function j(){return zo[tt]}function fl(t){if(t!==tt){tt=t,Wo();try{localStorage.setItem(qo,t)}catch{}window.dispatchEvent(new CustomEvent("themechange",{detail:{theme:t}}))}}function Wo(){const t=document.documentElement;t.setAttribute("data-theme",tt);const e=zo[tt];t.style.setProperty("--bg-color",e.bgColor),t.style.setProperty("--card-bg",e.cardBg),t.style.setProperty("--surface-elevated",e.surfaceElevated),t.style.setProperty("--surface-overlay",e.surfaceOverlay),t.style.setProperty("--text-primary",e.textPrimary),t.style.setProperty("--text-secondary",e.textSecondary),t.style.setProperty("--text-muted",e.textMuted),t.style.setProperty("--border-color",e.borderColor),t.style.setProperty("--highlight",e.highlight),t.style.setProperty("--highlight-text",e.highlightText),t.style.setProperty("--bg-overlay-95",e.bgOverlay95),t.style.setProperty("--card-bg-overlay-95",e.cardBgOverlay95),t.style.setProperty("--card-bg-overlay-60",e.cardBgOverlay60),t.style.setProperty("--card-bg-overlay-50",e.cardBgOverlay50),t.style.setProperty("--border-overlay-22",e.borderOverlay22),t.style.setProperty("--border-overlay-30",e.borderOverlay30),t.style.setProperty("--highlight-overlay-10",e.highlightOverlay10),t.style.setProperty("--divider-color",e.dividerColor),t.style.setProperty("--shadow-color",e.shadowColor),t.style.setProperty("--month-gridline-color",e.monthGridlineColor),t.style.setProperty("--spinner-color",e.spinnerColor)}function ml(){try{const t=localStorage.getItem(qo);(t==="light"||t==="beige"||t==="dark"||t==="claude")&&(tt=t)}catch{}Wo()}class Z{static SCALE_LABEL_CHARS=4;static SCALE_MIN_WIDTH_PX=56;static RSI_DATA_MIN=0;static RSI_DATA_MAX=100;static RSI_AXIS_MIN=20;static RSI_AXIS_MAX=80;static MIDLINE_VALUE=50;container;chart;series;lineTools;displayMode;lineColor="#58a6ff";midlineColor=j().textPrimary;midlineStyle="dotted";data;seriesData=[];referenceLines=[];midlinePriceLine=null;priceData=[];priceByTime=new Map;indexByTime=new Map;divergencePointTimeKeys=new Set;divergenceToolActive=!1;highlightSeries=null;firstPoint=null;divergencePoints=[];static MAX_HIGHLIGHT_POINTS=2e3;static FUTURE_TIMELINE_TRADING_DAYS=252;trendLineSeriesList=[];trendlineCrossLabels=[];trendlineDefinitions=[];timelineSeries=null;suppressExternalSync=!1;onTrendLineDrawn;constructor(e){this.container=e.container,this.displayMode=e.displayMode,this.lineColor=e.lineColor||this.lineColor,this.midlineColor=e.midlineColor||this.midlineColor,this.midlineStyle=e.midlineStyle||this.midlineStyle,this.data=this.normalizeRSIData(e.data),this.priceData=e.priceData||[],this.rebuildLookupMaps(),this.seriesData=this.buildSeriesData(this.data,this.priceData),this.onTrendLineDrawn=e.onTrendLineDrawn;const n=j();this.chart=LightweightCharts.createChart(e.container,{height:400,layout:{background:{color:n.bgColor},textColor:n.textPrimary,fontFamily:"'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",attributionLogo:!1},grid:{vertLines:{visible:!1},horzLines:{visible:!1}},timeScale:{visible:!0,timeVisible:!0,secondsVisible:!1,borderVisible:!0,ticksVisible:!0,fixRightEdge:!1,rightBarStaysOnScroll:!1,rightOffset:10,tickMarkFormatter:(r,i)=>this.formatTickMark(r,i),borderColor:n.surfaceElevated},rightPriceScale:{borderColor:n.surfaceElevated,minimumWidth:Z.SCALE_MIN_WIDTH_PX,entireTextOnly:!0,scaleMargins:{top:.2,bottom:.2}},crosshair:{mode:1},kineticScroll:{touch:!1,mouse:!1},handleScroll:{pressedMouseMove:!0,horzTouchDrag:!0,vertTouchDrag:se,mouseWheel:!0},handleScale:{mouseWheel:!0,pinch:!0,axisPressedMouseMove:{time:!0,price:!1},axisDoubleClickReset:{time:!0,price:!1}}}),this.addReferenceLine(50,"Midline",this.midlineColor,this.midlineStyleToLineStyle(this.midlineStyle)),this.updateSeries(),this.updateTimelineSeriesData(),this.chart.subscribeCrosshairMove(r=>{this.divergenceToolActive&&r&&r.time}),this.chart.subscribeClick(r=>{this.divergenceToolActive&&r&&r.time&&this.detectAndHighlightDivergence(r.time)}),this.chart.timeScale().subscribeVisibleLogicalRangeChange(()=>{this.refreshTrendlineCrossLabels()})}normalizeRSIData(e){return e.filter(n=>n&&(typeof n.time=="string"||typeof n.time=="number")&&Number.isFinite(Number(n.value))).map(n=>({...n,value:Math.max(Z.RSI_DATA_MIN,Math.min(Z.RSI_DATA_MAX,Number(n.value)))}))}formatRSIScaleLabel(e){if(!Number.isFinite(e))return"";const n=Number(e).toFixed(1);return n.length>=Z.SCALE_LABEL_CHARS?n:n.padEnd(Z.SCALE_LABEL_CHARS," ")}fixedRSIAutoscaleInfoProvider(){return{priceRange:{minValue:Z.RSI_AXIS_MIN,maxValue:Z.RSI_AXIS_MAX}}}timeKey(e){return typeof e=="number"?String(e):e}rebuildLookupMaps(){this.priceByTime.clear(),this.indexByTime.clear();for(let e=0;e<this.data.length;e++){const n=this.data[e];this.indexByTime.set(this.timeKey(n.time),e)}for(const e of this.priceData){const n=Number(e.close);Number.isFinite(n)&&this.priceByTime.set(this.timeKey(e.time),n)}}toDateFromScaleTime(e){if(typeof e=="number"&&Number.isFinite(e))return new Date(e*1e3);if(typeof e=="string"&&e.trim()){const n=e.includes("T")?e:`${e.replace(" ","T")}Z`,r=new Date(n);return Number.isFinite(r.getTime())?r:null}return e&&typeof e=="object"&&Number.isFinite(e.year)&&Number.isFinite(e.month)&&Number.isFinite(e.day)?new Date(Date.UTC(Number(e.year),Number(e.month)-1,Number(e.day),0,0,0)):null}toUnixSeconds(e){if(typeof e=="number"&&Number.isFinite(e))return e;if(typeof e!="string"||!e.trim())return null;const n=e.includes("T")?e:`${e.replace(" ","T")}Z`,i=new Date(n).getTime();return Number.isFinite(i)?Math.floor(i/1e3):null}formatTickMark(e,n){const r=this.toDateFromScaleTime(e);return r?n===0?r.toLocaleDateString("en-US",{year:"numeric",timeZone:ye()}):n===1?r.toLocaleDateString("en-US",{month:"short",timeZone:ye()}):r.toLocaleDateString("en-US",{day:"numeric",timeZone:ye()}):""}midlineStyleToLineStyle(e){return e==="solid"?0:1}isSyncSuppressed(){return this.suppressExternalSync}inferBarStepSeconds(){if(this.data.length<2)return 1800;const e=[];for(let n=1;n<this.data.length;n++){const r=this.toUnixSeconds(this.data[n-1]?.time),i=this.toUnixSeconds(this.data[n]?.time);if(r===null||i===null)continue;const o=i-r;Number.isFinite(o)&&o>0&&e.push(o)}return e.length===0?1800:(e.sort((n,r)=>n-r),e[Math.floor(e.length*.25)])}barsPerTradingDayFromStep(e){return e<=300?78:e<=900?26:e<=1800?13:e<=3600?7:2}futureBarsForOneYear(){const e=this.inferBarStepSeconds();return this.barsPerTradingDayFromStep(e)*252}ensureTimelineSeries(){this.timelineSeries||(this.timelineSeries=this.chart.addLineSeries({color:"rgba(0, 0, 0, 0)",lineVisible:!1,pointMarkersVisible:!1,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1}))}updateTimelineSeriesData(){if(this.ensureTimelineSeries(),!this.timelineSeries||this.data.length===0)return;const e=this.toUnixSeconds(this.data[this.data.length-1]?.time);if(e===null)return;const n=[{time:e}];let r=e,i=0;for(;i<Z.FUTURE_TIMELINE_TRADING_DAYS;){r+=86400;const o=new Date(r*1e3).getUTCDay();o===0||o===6||(n.push({time:r}),i+=1)}this.timelineSeries.setData(n)}buildSeriesData(e,n){if(!n||n.length===0)return e;const r=new Map;for(const i of e)r.set(String(i.time),Number(i.value));return n.map(i=>{const o=r.get(String(i.time));return Number.isFinite(o)?{time:i.time,value:o}:{time:i.time}})}addReferenceLine(e,n,r,i=2){if(this.referenceLines.push({value:e,label:n,color:r,lineStyle:i}),this.series){const o=this.series.createPriceLine({price:e,color:r,lineWidth:1,lineStyle:i,axisLabelVisible:!1,title:n});n==="Midline"&&(this.midlinePriceLine=o)}}updateSeries(){this.series&&this.chart.removeSeries(this.series),this.midlinePriceLine=null,this.displayMode==="line"?this.series=this.chart.addLineSeries({color:this.lineColor,lineWidth:1,priceFormat:{type:"custom",minMove:1,formatter:e=>this.formatRSIScaleLabel(Number(e))},autoscaleInfoProvider:()=>this.fixedRSIAutoscaleInfoProvider(),priceLineVisible:!1,lastValueVisible:!1}):this.series=this.chart.addHistogramSeries({color:this.lineColor,priceFormat:{type:"custom",minMove:1,formatter:e=>this.formatRSIScaleLabel(Number(e))},autoscaleInfoProvider:()=>this.fixedRSIAutoscaleInfoProvider(),priceLineVisible:!1,lastValueVisible:!1}),this.displayMode==="line"?this.series.setData(this.seriesData):this.series.setData(this.seriesData.map(e=>Number.isFinite(Number(e.value))?{time:e.time,value:e.value,color:this.lineColor}:{time:e.time})),this.referenceLines.forEach(e=>{const n=this.series.createPriceLine({price:e.value,color:e.color,lineWidth:1,lineStyle:e.lineStyle,axisLabelVisible:!1,title:e.label});e.label==="Midline"&&(this.midlinePriceLine=n)})}setDisplayMode(e){this.displayMode!==e&&(this.displayMode=e,this.updateSeries(),this.refreshTrendlineCrossLabels())}setLineColor(e){e&&(this.lineColor=e,this.displayMode==="line"&&this.series?this.series.applyOptions({color:e}):this.displayMode!=="line"&&this.series&&(this.series.applyOptions({color:e}),this.series.setData(this.seriesData.map(n=>Number.isFinite(Number(n.value))?{time:n.time,value:n.value,color:this.lineColor}:{time:n.time}))))}setMidlineOptions(e,n){e&&(this.midlineColor=e),n&&(this.midlineStyle=n);const r=this.midlineStyleToLineStyle(this.midlineStyle);this.referenceLines=this.referenceLines.map(i=>i.label!=="Midline"?i:{...i,color:this.midlineColor,lineStyle:r}),this.midlinePriceLine&&this.midlinePriceLine.applyOptions({color:this.midlineColor,lineStyle:r})}setData(e,n){this.clearDivergence(),this.data=this.normalizeRSIData(e),n&&(this.priceData=n),this.rebuildLookupMaps(),this.seriesData=this.buildSeriesData(this.data,this.priceData),this.series&&(this.displayMode==="line"?this.series.setData(this.seriesData):this.series.setData(this.seriesData.map(r=>Number.isFinite(Number(r.value))?{time:r.time,value:r.value,color:this.lineColor}:{time:r.time}))),this.updateTimelineSeriesData(),this.refreshTrendlineCrossLabels()}updateLatestPoint(e,n){if(!e||typeof e.time!="string"&&typeof e.time!="number")return!1;const r=Number(e.value);if(!Number.isFinite(r)||this.data.length===0)return!1;const i=this.data.length-1,o=this.data[i]?.time,s=this.timeKey(o),a=this.timeKey(e.time);if(s!==a)return!1;const l=Math.max(Z.RSI_DATA_MIN,Math.min(Z.RSI_DATA_MAX,r));if(this.data[i]={...this.data[i],value:l},n&&this.timeKey(n.time)===s){const u=Number(n.close);Number.isFinite(u)&&(this.priceData.length>0&&this.timeKey(this.priceData[this.priceData.length-1].time)===s&&(this.priceData[this.priceData.length-1]={...this.priceData[this.priceData.length-1],close:u}),this.priceByTime.set(s,u))}return this.seriesData.length>0&&this.timeKey(this.seriesData[this.seriesData.length-1].time)===s?this.seriesData[this.seriesData.length-1]={time:o,value:l}:this.seriesData=this.buildSeriesData(this.data,this.priceData),this.series&&(this.displayMode==="line"?this.series.update({time:o,value:l}):this.series.update({time:o,value:l,color:this.lineColor})),this.refreshTrendlineCrossLabels(),!0}getChart(){return this.chart}getSeries(){return this.series}getPersistedTrendlines(){return this.trendlineDefinitions.map(e=>({...e}))}restorePersistedTrendlines(e){if(this.clearDivergence(),!(!Array.isArray(e)||e.length===0))for(const n of e){if(!n)continue;const r=n.time1,i=n.time2,o=Number(n.value1),s=Number(n.value2);typeof r!="string"&&typeof r!="number"||typeof i!="string"&&typeof i!="number"||!Number.isFinite(o)||!Number.isFinite(s)||this.drawTrendLine(r,o,i,s,!0)}}refreshTrendlineLabels(){this.refreshTrendlineCrossLabels()}getLineTools(){return this.lineTools}activateDivergenceTool(){this.divergenceToolActive=!0;const e=this.chart.chartElement();e&&(e.style.cursor="crosshair")}deactivateDivergenceTool(){this.divergenceToolActive=!1;const e=this.chart.chartElement();e&&(e.style.cursor="default"),this.clearHighlights(),this.firstPoint=null,this.divergencePoints=[],this.divergencePointTimeKeys.clear()}detectAndHighlightDivergence(e){const n=this.timeKey(e),r=this.indexByTime.get(n);if(r===void 0){console.log("Clicked point not found in RSI data");return}const i=this.data[r].value,o=this.priceByTime.get(n);if(!Number.isFinite(o)){console.log("Corresponding price data not found");return}const s=Number(o);if(this.firstPoint){if(!this.divergencePointTimeKeys.has(n)){console.log("Second point must be one of the highlighted divergence points");return}console.log(`Drawing trend line from (RSI: ${this.firstPoint.rsi.toFixed(2)}) to (RSI: ${i.toFixed(2)})`),this.drawTrendLine(this.firstPoint.time,this.firstPoint.rsi,e,i),this.clearHighlights(),this.deactivateDivergenceTool(),this.onTrendLineDrawn?.()}else{this.firstPoint={time:e,rsi:i,price:s,index:r},this.divergencePoints=[],this.divergencePointTimeKeys.clear();for(let a=r+1;a<this.data.length;a++){const l=this.data[a].value,u=this.data[a].time,c=this.priceByTime.get(this.timeKey(u));if(Number.isFinite(c)){const d=Number(c),f=l<i&&d>s,p=l>i&&d<s;(f||p)&&(this.divergencePoints.push({time:u,value:l}),this.divergencePointTimeKeys.add(this.timeKey(u)))}}console.log(`Found ${this.divergencePoints.length} divergence points from origin (RSI: ${i.toFixed(2)}, Price: ${s.toFixed(2)})`),this.highlightPoints(this.divergencePoints)}}highlightPoints(e){if(this.clearHighlights(),e.length===0)return;this.highlightSeries=this.chart.addLineSeries({color:"#ff6b6b",lineVisible:!1,pointMarkersVisible:!0,pointMarkersRadius:2,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1,autoscaleInfoProvider:()=>this.fixedRSIAutoscaleInfoProvider()});const n=Math.max(1,Math.ceil(e.length/Z.MAX_HIGHLIGHT_POINTS)),r=n===1?e:e.filter((i,o)=>o%n===0);this.highlightSeries.setData(r)}clearHighlights(){this.highlightSeries&&(this.chart.removeSeries(this.highlightSeries),this.highlightSeries=null)}formatMmDdYyFromUnixSeconds(e){return Number.isFinite(e)?Rn("en-US",{month:"2-digit",day:"2-digit",year:"2-digit"}).format(new Date(Math.round(Number(e))*1e3)):"N/A"}createTrendlineCrossLabelElement(e){const n=document.createElement("div");n.className="trendline-cross-label",n.textContent=e,n.style.position="absolute",n.style.zIndex="29",n.style.minHeight="24px",n.style.display="inline-flex",n.style.alignItems="center",n.style.padding="0 8px",n.style.borderRadius="4px";const r=j();return n.style.border=`1px solid ${r.borderColor}`,n.style.background=r.cardBg,n.style.color=r.textPrimary,n.style.fontSize="12px",n.style.fontFamily="'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",n.style.pointerEvents="none",n.style.whiteSpace="nowrap",n.style.transform="translate(-50%, calc(-100% - 6px))",n}refreshTrendlineCrossLabels(){if(!this.chart||!this.series||!this.container)return;const e=this.container.clientWidth,n=this.container.clientHeight;for(const r of this.trendlineCrossLabels){const i=this.chart.timeScale().timeToCoordinate(r.anchorTime),o=this.series.priceToCoordinate(r.anchorValue);if(!Number.isFinite(i)||!Number.isFinite(o)||i<0||i>e||o<0||o>n){r.element.style.display="none";continue}r.element.style.display="inline-flex",r.element.style.left=`${Math.round(i)}px`,r.element.style.top=`${Math.round(Math.max(8,o))}px`}}clearTrendlineCrossLabels(){for(const e of this.trendlineCrossLabels)e.element.remove();this.trendlineCrossLabels=[]}addTrendlineCrossLabel(e,n,r){const i=this.createTrendlineCrossLabelElement(r);this.container.appendChild(i),this.trendlineCrossLabels.push({element:i,anchorTime:e,anchorValue:n}),this.refreshTrendlineCrossLabels()}projectFutureTradingUnixSeconds(e,n,r){if(r>=86400){const i=Math.floor(n),o=n-i,s=new Date(e*1e3);let a=i;for(;a>0;){s.setUTCDate(s.getUTCDate()+1);const u=s.getUTCDay();u!==0&&u!==6&&a--}const l=Math.floor(s.getTime()/1e3);if(o>0){const u=new Date(s);do u.setUTCDate(u.getUTCDate()+1);while(u.getUTCDay()===0||u.getUTCDay()===6);const c=Math.floor(u.getTime()/1e3);return l+o*(c-l)}return l}return e+n*r}indexToUnixSeconds(e,n,r,i,o){if(!Number.isFinite(e))return null;if(e>n)return i===null?null:this.projectFutureTradingUnixSeconds(i,e-n,o);if(e<0)return r===null?null:r+e*o;const s=Math.max(0,Math.floor(e)),a=Math.min(n,Math.ceil(e)),l=this.toUnixSeconds(this.data[s]?.time),u=this.toUnixSeconds(this.data[a]?.time);if(s===a)return l;if(Number.isFinite(l)&&Number.isFinite(u)){const c=e-s;return Number(l)+(Number(u)-Number(l))*c}return Number.isFinite(l)?Number(l)+(e-s)*o:r===null?null:r+e*o}computeTrendlineMidlineCrossUnixSeconds(e,n,r,i,o,s,a){if(!Number.isFinite(r)||Math.abs(r)<1e-12)return null;const l=e+(Z.MIDLINE_VALUE-n)/r;return Number.isFinite(l)?this.indexToUnixSeconds(l,i,o,s,a):null}drawTrendLine(e,n,r,i,o=!0){const s=this.chart.timeScale().getVisibleLogicalRange?.();this.suppressExternalSync=!0;try{const a=this.indexByTime.get(this.timeKey(e)),l=this.indexByTime.get(this.timeKey(r));if(a===void 0||l===void 0){console.error("Could not find indices for trend line points");return}if(l===a)return;const u=(i-n)/(l-a),c=[],d=this.futureBarsForOneYear(),f=this.data.length-1,p=f+d,h=this.inferBarStepSeconds(),m=this.toUnixSeconds(this.data[0]?.time),g=this.data[f]?.time,b=this.toUnixSeconds(g);for(let C=a;C<=p;C++){const $=n+u*(C-a);if($<Z.RSI_DATA_MIN||$>Z.RSI_DATA_MAX)break;let N=null;C<=f?N=this.data[C]?.time??null:b!==null&&(N=this.projectFutureTradingUnixSeconds(b,C-f,h)),N!=null&&c.push({time:N,value:$})}if(!c.length)return;const v=this.chart.addLineSeries({color:"#ffa500",lineWidth:1,lineStyle:0,autoscaleInfoProvider:()=>this.fixedRSIAutoscaleInfoProvider(),priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1});this.trendLineSeriesList.push(v),v.setData(c);const x=this.computeTrendlineMidlineCrossUnixSeconds(a,n,u,f,m,b,h);this.addTrendlineCrossLabel(e,n,this.formatMmDdYyFromUnixSeconds(x)),o&&this.trendlineDefinitions.push({time1:e,value1:Number(n),time2:r,value2:Number(i)})}finally{if(s)try{this.chart.timeScale().setVisibleLogicalRange(s)}catch{}this.suppressExternalSync=!1}}clearDivergence(e=!1){const n=e?this.chart.timeScale().getVisibleLogicalRange?.():null;e&&(this.suppressExternalSync=!0);try{this.clearHighlights(),this.clearTrendlineCrossLabels();for(const r of this.trendLineSeriesList)try{this.chart.removeSeries(r)}catch{}this.trendLineSeriesList=[],this.trendlineDefinitions=[],this.firstPoint=null,this.divergencePoints=[],this.divergencePointTimeKeys.clear()}finally{if(e&&n)try{this.chart.timeScale().setVisibleLogicalRange(n)}catch{}e&&(this.suppressExternalSync=!1)}}resize(){this.chart&&(this.chart.resize(this.chart.options().width,400),this.refreshTrendlineCrossLabels())}applyTheme(){if(!this.chart)return;const e=j();this.chart.applyOptions({layout:{background:{color:e.bgColor},textColor:e.textPrimary},rightPriceScale:{borderColor:e.surfaceElevated},timeScale:{borderColor:e.surfaceElevated}}),this.setMidlineOptions(e.textPrimary,this.midlineStyle);for(const n of this.trendlineCrossLabels)n.element.style.background=e.cardBg,n.element.style.border=`1px solid ${e.borderColor}`,n.element.style.color=e.textPrimary}destroy(){this.chart&&(this.clearTrendlineCrossLabels(),this.chart.remove())}}const Vt=[{key:"s8",label:"Divergence",defaultWeight:35,tooltip:"Overall price-down + delta-up divergence. The PRIMARY thesis signal. Score = 0 when price is rising or delta is negative."},{key:"s6",label:"Absorption",defaultWeight:25,tooltip:"Percentage of days where price fell but delta was positive. Day-by-day divergence confirmation: institutions buying the dip."},{key:"s1",label:"Net Delta",defaultWeight:15,tooltip:"Total net buying as % of total volume. Supporting signal: is there net buying?"},{key:"s2",label:"Delta Slope",defaultWeight:10,tooltip:"Trend of cumulative weekly delta. Supporting signal: is buying building over time?"},{key:"s3",label:"Delta Shift",defaultWeight:5,tooltip:"Is buying stronger now than before? Compares avg daily delta in the zone to the pre-context period."},{key:"s4",label:"Accum Ratio",defaultWeight:5,tooltip:"Fraction of weeks with positive delta. High ratio = persistent buying across multiple weeks."},{key:"s5",label:"Buy vs Sell",defaultWeight:3,tooltip:"Ratio of large buy days to large sell days. Detects if big-volume days lean bullish or bearish."},{key:"s7",label:"Vol Decline",defaultWeight:2,tooltip:"Volume declining from first-third to last-third of the zone. Supply drying up = fewer sellers remain."}],Go={};Vt.forEach(t=>{Go[t.key]=t.defaultWeight});let de=null,Fn={...Go},jo=null,gi="";function hl(){try{const t=localStorage.getItem("chart_vdf_weights");if(t){const e=JSON.parse(t);if(e&&typeof e=="object")for(const n of Vt)typeof e[n.key]=="number"&&(Fn[n.key]=e[n.key])}}catch{}}function Ko(){return Vt.reduce((t,e)=>t+(Fn[e.key]||0),0)}function Zo(t){if(!t.components)return t.score;const e=Ko();if(e<=0)return 0;let n=0;for(const o of Vt){const s=t.components[o.key]||0;n+=s*((Fn[o.key]||0)/e)}const r=t.concordancePenalty??1,i=t.durationMultiplier??1;return n*r*i}function pl(){const t=Ko();return Vt.map(e=>{const n=Fn[e.key]||0,r=t>0?Math.round(n/t*100):0;return[e.key,e.label,`${r}%`]})}function Ve(t){const e=t.split("-");return e.length<3?t:`${Number(e[1])}/${Number(e[2])}`}function gl(t){return t>=80?"Strong":t>=60?"Moderate":t>=40?"Weak":"Marginal"}function Yo(t){return t>=80?"#26a69a":t>=60?"#8bc34a":j().textPrimary}function Xo(t){return t==="imminent"?"#f44336":t==="high"?"#ff9800":t==="elevated"?"#ffc107":j().textSecondary}function yl(t){const e=j();return pl().map(([n,r,i])=>{const o=Number(t[n])||0,s=Math.max(0,Math.min(100,Math.round(o*100))),a=o>=.7?"#26a69a":o>=.4?"#8bc34a":e.textMuted;return`<div style="display:grid;grid-template-columns:130px 1fr 36px;gap:6px;align-items:center;margin:2px 0;">
      <span style="color:${e.textSecondary};font-size:11px;white-space:nowrap;">${we(r)} (${i})</span>
      <div style="height:4px;background:${e.surfaceElevated};border-radius:2px;overflow:hidden;">
        <div style="height:100%;width:${s}%;background:${a};border-radius:2px;"></div>
      </div>
      <span style="color:${e.textPrimary};font-size:11px;font-family:'SF Mono',Menlo,Monaco,Consolas,monospace;text-align:right;">${o.toFixed(2)}</span>
    </div>`}).join("")}function vl(t,e,n){const r=j(),i=Zo(t),o=Math.round(i*100),s=Math.round(t.score*100),a=!Vt.every(g=>Fn[g.key]===g.defaultWeight),l=n?`Zone ${e+1} (Primary)`:`Zone ${e+1}`,u=Yo(o);let c="";const d=[];t.overallPriceChange!=null&&d.push(`Price: ${t.overallPriceChange>=0?"+":""}${t.overallPriceChange.toFixed(1)}%`),t.netDeltaPct!=null&&d.push(`Net Delta: ${t.netDeltaPct>=0?"+":""}${t.netDeltaPct.toFixed(1)}%`),t.absorptionPct!=null&&d.push(`Absorption: ${t.absorptionPct.toFixed(1)}%`),d.length&&(c=`<div style="margin:4px 0;color:${r.textSecondary};font-size:12px;">${d.join(" &nbsp;|&nbsp; ")}</div>`);let f="";const p=[];t.accumWeeks!=null&&t.weeks&&p.push(`Accum weeks: ${t.accumWeeks}/${t.weeks} (${Math.round(t.accumWeeks/t.weeks*100)}%)`),t.durationMultiplier!=null&&p.push(`Duration: ${t.durationMultiplier.toFixed(3)}x`),t.concordancePenalty!=null&&t.concordancePenalty<1&&p.push(`Concordance: ${t.concordancePenalty.toFixed(3)}x`),p.length&&(f=`<div style="margin:2px 0;color:${r.textSecondary};font-size:12px;">${p.join(" &nbsp;|&nbsp; ")}</div>`);let h="";t.components&&(h=`<div style="margin-top:8px;"><div style="color:${r.textSecondary};font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">Components</div>${yl(t.components)}</div>`);const m=a&&s!==o?`<span style="font-size:10px;color:${r.textMuted};margin-left:4px;">(was ${s})</span>`:"";return`<div style="background:${r.cardBg};border:1px solid ${r.surfaceElevated};border-radius:4px;padding:12px;margin-bottom:8px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
      <span style="font-weight:600;font-size:13px;color:${r.textPrimary};">${we(l)}</span>
      <span><span style="font-family:'SF Mono',Menlo,Monaco,Consolas,monospace;font-size:13px;font-weight:700;color:${u};">${o}</span>${m}</span>
    </div>
    <div style="color:${r.textPrimary};font-size:12px;">${Ve(t.startDate)} → ${Ve(t.endDate)} (${t.windowDays} trading days${t.weeks?`, ${t.weeks} wk`:""})</div>
    ${c}
    ${f}
    ${h}
  </div>`}function bl(t,e){const n=j();let r="";const i=[];return t.priceChangePct!=null&&i.push(`Price ${t.priceChangePct>=0?"+":""}${t.priceChangePct.toFixed(1)}%`),t.netDeltaPct!=null&&i.push(`Delta ${t.netDeltaPct>=0?"+":""}${t.netDeltaPct.toFixed(1)}%`),i.length&&(r=i.join(" while ")+" — selling into strength."),`<div style="background:rgba(239,83,80,0.06);border:1px solid rgba(239,83,80,0.2);border-radius:4px;padding:10px 12px;margin-bottom:8px;">
    <div style="font-weight:600;font-size:12px;color:#ef5350;margin-bottom:2px;">Cluster ${e+1}: ${Ve(t.startDate)} → ${Ve(t.endDate)} (${t.spanDays} days)</div>
    ${r?`<div style="color:${n.textSecondary};font-size:12px;">${we(r)}</div>`:""}
  </div>`}function Sl(t){if(t.level==="none"&&t.compositeScore===0)return"";const e=j(),n=t.level.charAt(0).toUpperCase()+t.level.slice(1),r=Xo(t.level),i=t.signals.map(o=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:2px 0;font-size:12px;">
      <span style="color:${e.textPrimary};">✓ ${we(o.detail)}</span>
      <span style="color:${r};font-family:'SF Mono',Menlo,Monaco,Consolas,monospace;font-weight:600;white-space:nowrap;margin-left:12px;">+${o.points}</span>
    </div>`).join("");return`<div style="margin-top:4px;">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
      <span style="font-family:'SF Mono',Menlo,Monaco,Consolas,monospace;font-size:13px;font-weight:700;color:${r};">${t.compositeScore} pts</span>
      <span style="font-size:11px;font-weight:600;color:${r};border:1px solid ${r};border-radius:3px;padding:0 5px;line-height:16px;">${n}</span>
    </div>
    ${i}
  </div>`}function Jo(){if(de)return de;const t=j(),e=document.getElementById("chart-content");if(!e)return document.createElement("div");const n=document.createElement("div");return n.id="vdf-analysis-panel",n.style.cssText=`width:100%;border-radius:6px;border:1px solid ${t.borderColor};background:${t.bgColor};color:${t.textPrimary};font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;font-size:13px;line-height:1.5;overflow:hidden;display:none;`,e.insertBefore(n,e.firstChild),de=n,n}function xl(){if(!de)return;const t=de.querySelector(".vdf-ap-body");if(!t)return;const e=t.style.display==="none";t.style.display=e?"block":"none";const n=de.querySelector(".vdf-ap-chevron");n&&(n.textContent=e?"▾":"▸");try{localStorage.setItem("chart_vdf_panel_collapsed",e?"0":"1")}catch{}}function Cl(){de&&(de.style.display="none",de.innerHTML="")}function Sn(t,e){jo=t,gi=e,hl();const n=Jo(),r=j();if(!t){n.innerHTML=`<div class="vdf-ap-header" style="display:flex;justify-content:space-between;align-items:center;padding:10px 14px;user-select:none;border-bottom:1px solid ${r.surfaceElevated};opacity:0.45;">
      <div style="display:flex;align-items:center;gap:8px;">
        <span class="vdf-ap-chevron" style="font-size:12px;color:${r.textSecondary};width:12px;">▸</span>
        <span style="font-weight:600;color:${r.textPrimary};">Analysis</span>
        ${e?`<span style="color:${r.textSecondary};font-family:'SF Mono',Menlo,Monaco,Consolas,monospace;font-size:12px;">${we(e)}</span>`:""}
      </div>
    </div>`,n.style.display="block";return}const i=t.zones[0],o=i?Math.round(Zo(i)*100):0,s=t.is_detected?o:Math.round(t.composite_score*100),a=gl(s),l=Yo(s),u=t.details?.metrics;let c=!0;try{c=localStorage.getItem("chart_vdf_panel_collapsed")!=="0"}catch{}const d=c?"▸":"▾",f=c?"none":"block",p=`<div class="vdf-ap-header" style="display:flex;justify-content:space-between;align-items:center;padding:10px 14px;cursor:pointer;user-select:none;border-bottom:1px solid ${r.surfaceElevated};">
    <div style="display:flex;align-items:center;gap:8px;">
      <span class="vdf-ap-chevron" style="font-size:12px;color:${r.textSecondary};width:12px;">${d}</span>
      <span style="font-weight:600;color:${r.textPrimary};">Analysis</span>
      <span style="color:${r.textSecondary};font-family:'SF Mono',Menlo,Monaco,Consolas,monospace;font-size:12px;">${we(e)}</span>
    </div>
    <div style="display:flex;align-items:center;">
      ${t.is_detected?`<span style="font-size:11px;color:${r.textMuted};">${we(a)}</span>`:`<span style="font-size:11px;color:${r.textMuted};">Not detected</span>`}
    </div>
  </div>`;let h="";if(t.is_detected){const g=t.zones.length;let b=`Volume-delta accumulation <span style="color:${l};font-weight:600;">${a}</span> (score: ${s}).`;b+=` ${g} accumulation zone${g!==1?"s":""} detected`,t.weeks&&(b+=` spanning up to ${t.weeks} weeks`),b+=".",u?.scanStart&&u?.scanEnd&&(b+=` Scan: ${Ve(u.scanStart)} → ${Ve(u.scanEnd)}`,u.totalDays&&(b+=` (${u.totalDays} trading days)`),b+="."),t.distribution.length>0&&(b+=` <span style="color:#ef5350;">${t.distribution.length} distribution cluster${t.distribution.length!==1?"s":""}</span> also found.`);const v=`<div style="margin-bottom:16px;font-size:13px;color:${r.textPrimary};">${b}</div>`,x="display:inline-block;width:14px;height:5px;border-radius:1px;vertical-align:middle;margin-right:5px;",C="display:inline-block;width:14px;height:0;border-top:1px dashed;vertical-align:middle;margin-right:5px;",$="display:inline-block;width:3px;height:12px;border-radius:1px;vertical-align:middle;margin-right:5px;",N=[];N.push(`<span style="white-space:nowrap;"><span style="${x}background:rgba(38,166,154,0.7);"></span>Accumulation</span>`),t.distribution.length>0&&N.push(`<span style="white-space:nowrap;"><span style="${x}background:rgba(239,83,80,0.65);"></span>Distribution</span>`),t.zones.some(fe=>(fe.absorptionPct||0)>=5)&&N.push(`<span style="white-space:nowrap;"><span style="${x}background:rgba(255,167,38,0.7);"></span>Absorption</span>`),N.push(`<span style="white-space:nowrap;"><span style="${C}border-color:rgba(38,166,154,0.4);"></span>Zone bounds</span>`);const B=t.proximity;if(B&&B.level!=="none"&&B.compositeScore>0){const fe=Xo(B.level);N.push(`<span style="white-space:nowrap;"><span style="${$}background:${fe};box-shadow:0 0 4px ${fe};"></span>Proximity</span>`)}const zt=`<div style="display:flex;flex-wrap:wrap;gap:12px 16px;padding:8px 12px;background:${r.cardBg};border:1px solid ${r.surfaceElevated};border-radius:4px;margin-bottom:16px;font-size:11px;color:${r.textSecondary};">${N.join("")}</div>`,qt=`font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:${r.textSecondary};margin:16px 0 8px;border-bottom:1px solid ${r.surfaceElevated};padding-bottom:4px;`;let Wt="";t.zones.length>0&&(Wt=`<div style="${qt}">Accumulation Zones</div>`,Wt+=t.zones.map((fe,Fe)=>vl(fe,Fe,Fe===0)).join(""));let Gt="";t.distribution.length>0&&(Gt=`<div style="${qt}">Distribution Clusters</div>`,Gt+=t.distribution.map((fe,Fe)=>bl(fe,Fe)).join(""));let jt="";const Me=t.proximity;if(Me&&(Me.level!=="none"||Me.compositeScore>0)){const fe=Me.level.charAt(0).toUpperCase()+Me.level.slice(1);jt=`<div style="${qt}">Proximity Signals (${Me.compositeScore} pts — ${fe})</div>`,jt+=Sl(Me)}h=`<div style="padding:14px;">${v}${zt}${Wt}${Gt}${jt}</div>`}else{let g="";u?.scanStart&&u?.scanEnd&&(g=` Scan: ${Ve(u.scanStart)} → ${Ve(u.scanEnd)}`,u.totalDays&&(g+=` (${u.totalDays} trading days)`),g+="."),h=`<div style="padding:14px;color:${r.textSecondary};font-size:13px;">No accumulation patterns detected in the scan period.${g}</div>`}n.innerHTML=`${p}<div class="vdf-ap-body" style="display:${f};">${h}</div>`,n.style.display="block";const m=n.querySelector(".vdf-ap-header");m&&m.addEventListener("click",()=>{xl()})}window.addEventListener("themechange",()=>{if(!de||de.style.display==="none")return;const t=j();de.style.cssText=`width:100%;border-radius:6px;border:1px solid ${t.borderColor};background:${t.bgColor};color:${t.textPrimary};font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;font-size:13px;line-height:1.5;overflow:hidden;display:block;`,gi&&Sn(jo,gi)});const Qo="custom_chart_trendlines_v1";function pr(t){if(!Array.isArray(t))return[];const e=[];for(const n of t){if(!n||typeof n!="object")continue;const r=n,i=r.time1,o=r.time2,s=Number(r.value1),a=Number(r.value2);typeof i!="string"&&typeof i!="number"||typeof o!="string"&&typeof o!="number"||!Number.isFinite(s)||!Number.isFinite(a)||e.push({time1:i,value1:s,time2:o,value2:a})}return e}function es(t,e){return`${t.toUpperCase()}|${e}`}function ts(){if(typeof window>"u")return{};try{const t=window.localStorage.getItem(Qo);if(!t)return{};const e=JSON.parse(t),n={};for(const[r,i]of Object.entries(e||{}))n[r]={rsi:pr(i?.rsi),volumeDeltaRsi:pr(i?.volumeDeltaRsi)};return n}catch{return{}}}function Dl(t){if(!(typeof window>"u"))try{window.localStorage.setItem(Qo,JSON.stringify(t))}catch{}}function wl(t,e){const r=ts()[es(t,e)];return{rsi:pr(r?.rsi),volumeDeltaRsi:pr(r?.volumeDeltaRsi)}}let L=null,te="1day",T=null,ne=null,yi=null,D=null,A=null,ie=null,vi=null,xn=null,U=null,Ge=null,bi=null,I=[],kt=new Map,an=null,Xt=[],gr=[],yr=[],rr=new Set,Jt=null,Ne=!1,ve=!1,ht=!1,lt=null,Si=!1,ir=0,V=null,nt=null,Cn=new Map,rt=new Map,Ot=new Map,it=new Map,_n=new Map,Dn=new Map,S=[],vr=[],br=null,Sr=null,xr=null,Cr=null,O=null,q=null,W=null,Y=null,z=null,be=!1,Se=!1,Mt=!1,Lt=!1,At=null,Pt=null,xi=null,Ci=null,ns=null,rs=null,oo=!1,Le=null,or=null,wn=!1,Kt=null,ln=null,sr=!1,ee=new Map,so=!1,ri=null,ii=null,Je=new Map,_=null,me=null,Ye=null,G=null,qn=null,Xe=new Map,F=null;const El=200,is='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="20" x2="20" y2="4"/><polyline points="15 4 20 4 20 9"/></svg>',Tl='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 21h10"/><path d="M5.5 13.5 9 17l8.5-8.5a2.12 2.12 0 0 0-3-3L6 14"/><path d="m2 22 3-3"/></svg>',os='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 18 12 6 20 18"/></svg>',kl=120,Ml=900*1e3,Ll=900*1e3,Al=16,ss="custom_chart_session_cache_v1",Pl=6,$l=9e5,Bn=10,Il=252,le=4,ot=56,Rl="Invalid symbol";function y(){return j()}function as(){return y().monthGridlineColor}const Nl='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>',ls="custom_chart_settings_v1",se=typeof window<"u"&&(window.matchMedia("(max-width: 768px)").matches||"ontouchstart"in window||navigator.maxTouchPoints>0),oi="top-pane-ticker-label",Ii="top-pane-badge",ao=38,cs=6,Ri=8,Vn=8,ge=24,$t=6,Fl="#2962FF",_l=50,Bl=50,Vl=20,Ol=80,us=0,ds=100,Hl=2e3,Ul="#ff6b6b",zl="#ffa500",fs="#089981",ms="#f23645",hs=[{value:"1min",label:"1 min"},{value:"5min",label:"5 min"},{value:"15min",label:"15 min"},{value:"30min",label:"30 min"},{value:"1hour",label:"1 hour"},{value:"4hour",label:"4 hour"}],ps=180,ql={"5min":[],"15min":[],"30min":[],"1hour":[],"4hour":["1day"],"1day":["4hour","1week"],"1week":["1day"]},Qt={length:14,lineColor:"#58a6ff",midlineColor:"#c9d1d9",midlineStyle:"dotted"},ut={length:14,lineColor:Fl,midlineColor:"#c9d1d9",midlineStyle:"dotted",sourceInterval:"1min"},pe={sourceInterval:"1min",divergenceTable:!0,divergentPriceBars:!0,bullishDivergentColor:"#26a69a",bearishDivergentColor:"#ef5350",neutralDivergentColor:"#8b949e"},Oe={maSourceMode:"daily",verticalGridlines:!1,horizontalGridlines:!1,ma:[{enabled:!0,type:"EMA",length:8,color:"#ffa500"},{enabled:!0,type:"EMA",length:21,color:"#8a2be2"},{enabled:!0,type:"SMA",length:50,color:"#00bcd4"},{enabled:!1,type:"SMA",length:200,color:"#90ee90"}]},Ee=["vd-chart-container","price-chart-container","rsi-chart-container","vd-rsi-chart-container"];let ae=[...Ee],Zt=null;const Ni=120,Fi=600,Wl={"vd-chart-container":240,"price-chart-container":400,"rsi-chart-container":400,"vd-rsi-chart-container":400};let En={},lo=!1,Ae=!1;const M={...Qt},w={...ut},E={...pe},k={maSourceMode:Oe.maSourceMode,verticalGridlines:Oe.verticalGridlines,horizontalGridlines:Oe.horizontalGridlines,ma:Oe.ma.map(t=>({...t,series:null,values:[]}))};function Wn(t,e){const n=e==="price"?br:e==="volumeDeltaRsi"?Sr:e==="volumeDelta"?xr:Cr;if(n&&n.parentElement===t)return n;const r=document.createElement("div"),i=e==="price"?"month-grid-overlay-price":e==="volumeDeltaRsi"?"month-grid-overlay-volume-delta-rsi":e==="volumeDelta"?"month-grid-overlay-volume-delta":"month-grid-overlay-rsi";return r.className=`month-grid-overlay ${i}`,r.style.position="absolute",r.style.top="0",r.style.right="0",r.style.bottom="0",r.style.left="0",r.style.pointerEvents="none",r.style.zIndex="6",t.appendChild(r),e==="price"?br=r:e==="volumeDeltaRsi"?Sr=r:e==="volumeDelta"?xr=r:Cr=r,r}function Ie(t){if(typeof t=="number"&&Number.isFinite(t))return t;if(typeof t=="string"&&t.trim()){const e=Date.parse(t.includes("T")?t:`${t.replace(" ","T")}Z`);if(Number.isFinite(e))return Math.floor(e/1e3)}return null}function Gl(t){if(typeof t=="number"&&Number.isFinite(t))return new Date(t*1e3);if(typeof t=="string"&&t.trim()){const e=new Date(t.includes("T")?t:`${t.replace(" ","T")}Z`);return Number.isFinite(e.getTime())?e:null}return t&&typeof t=="object"&&Number.isFinite(t.year)&&Number.isFinite(t.month)&&Number.isFinite(t.day)?new Date(Date.UTC(Number(t.year),Number(t.month)-1,Number(t.day),0,0,0)):null}function _i(t,e){const n=Gl(t);if(!n)return"";const r=ye();return e===0?n.toLocaleDateString("en-US",{year:"numeric",timeZone:r}):e===1?n.toLocaleDateString("en-US",{month:"short",timeZone:r}):n.toLocaleDateString("en-US",{day:"numeric",timeZone:r})}function jl(t){const e=Rn("en-US",{year:"numeric",month:"2-digit"}).formatToParts(new Date(t*1e3)),n=e.find(i=>i.type==="year")?.value||"",r=e.find(i=>i.type==="month")?.value||"";return`${n}-${r}`}function Kl(t){const e=[];let n="";for(const r of t){const i=Ie(r?.time);if(i===null)continue;const o=jl(i);o!==n&&(e.push(i),n=o)}return e}function co(t){return Rn("en-CA",{year:"numeric",month:"2-digit",day:"2-digit"}).format(new Date(t*1e3))}function Zl(t){if(!Array.isArray(t)||t.length===0)return[];const e=Ie(t[t.length-1]?.time);if(!Number.isFinite(e))return[];const n=[{time:Number(e)}];let r=Number(e),i=0;for(;i<Il;){r+=86400;const o=new Date(r*1e3).getUTCDay();o===0||o===6||(n.push({time:r}),i+=1)}return n}function gs(t){const e=Zl(t);yi&&yi.setData(e),vi&&vi.setData(e),bi&&bi.setData(e)}function Yl(t,e){if(!Array.isArray(t)||t.length===0)return[];if(t.length===1)return[50];const n=Math.max(1,Math.floor(e||14)),r=new Array(t.length).fill(50),i=[],o=[];let s=0,a=0;for(let l=1;l<t.length;l++){const u=t[l]-t[l-1],c=u>0?u:0,d=u<0?Math.abs(u):0;if(i.push(c),o.push(d),l<n){const h=l;let m=0,g=0;for(let b=0;b<h;b++)m+=i[b],g+=o[b];s=m/h,a=g/h}else if(l===n){let h=0,m=0;for(let g=l-n;g<l;g++)h+=i[g],m+=o[g];s=h/n,a=m/n}else s=(s*(n-1)+c)/n,a=(a*(n-1)+d)/n;const p=100-100/(1+(a===0?100:s/a));r[l]=Number.isFinite(p)?p:r[l-1]}return r[0]=r[1]??50,r}function ys(t,e){if(!t||t.length===0)return[];const n=t.map(o=>Number(o.close)),r=Yl(n,e),i=[];for(let o=0;o<t.length;o++){const s=r[o];Number.isFinite(s)&&i.push({time:t[o].time,value:Math.round(s*100)/100})}return i}function vs(t){return Array.isArray(t)?t.filter(e=>e&&(typeof e.time=="string"||typeof e.time=="number")&&Number.isFinite(Number(e.value))).map(e=>({time:e.time,value:Number(e.value)})):[]}function Br(t,e){return[String(t||"").trim().toUpperCase(),e,String(w.length),E.sourceInterval,w.sourceInterval].join("|")}function Xl(t){if(!t||typeof t!="object")return!1;const e=t;return!(!Array.isArray(e.bars)||e.bars.length===0)}function Bi(){for(;ee.size>Al;){const t=ee.keys().next().value;if(!t)break;ee.delete(t)}}function bs(){if(!so&&(so=!0,!(typeof window>"u")))try{const t=window.sessionStorage.getItem(ss);if(!t)return;const e=JSON.parse(t);if(!e||e.version!==1||!Array.isArray(e.entries))return;const n=[...e.entries].filter(r=>r&&typeof r.key=="string"&&Number.isFinite(r.updatedAt)&&Xl(r.data)).sort((r,i)=>Number(r.updatedAt)-Number(i.updatedAt));for(const r of n)ee.set(r.key,{data:r.data,updatedAt:Number(r.updatedAt)});Bi()}catch{}}function Vi(){typeof window>"u"||ri===null&&(ri=window.setTimeout(()=>{ri=null;try{const t=Array.from(ee.entries()).reverse(),e=[];let n=0;for(const[i,o]of t){if(!o||!o.data||!Number.isFinite(o.updatedAt))continue;const s={key:i,updatedAt:o.updatedAt,data:o.data},a=JSON.stringify(s);if(a&&!(n+a.length>$l)&&(e.push(s),n+=a.length,e.length>=Pl))break}const r=JSON.stringify({version:1,entries:e});window.sessionStorage.setItem(ss,r)}catch{}},180))}function Jl(){bs();const t=Date.now();let e=!1;for(const[r,i]of ee.entries())(!i||!i.updatedAt||t-i.updatedAt>Ll)&&(ee.delete(r),e=!0);const n=ee.size;Bi(),ee.size!==n&&(e=!0),e&&Vi()}function Oi(t){Jl();const e=ee.get(t);return e&&(ee.delete(t),ee.set(t,e)),e?e.data:null}function Hi(t,e){bs(),ee.delete(t),ee.set(t,{data:e,updatedAt:Date.now()}),Bi(),Vi()}function uo(t){const e=Array.isArray(t?.bars)?t.bars:[];if(!e.length)return"none";const n=e[e.length-1];return[e.length,P(n.time),Number(n.open),Number(n.high),Number(n.low),Number(n.close),Number(n.volume)].join("|")}const Ss={"5min":{fetchMs:[],renderMs:[]},"15min":{fetchMs:[],renderMs:[]},"30min":{fetchMs:[],renderMs:[]},"1hour":{fetchMs:[],renderMs:[]},"4hour":{fetchMs:[],renderMs:[]},"1day":{fetchMs:[],renderMs:[]},"1week":{fetchMs:[],renderMs:[]}},Ui={"5min":{fetchCount:0,renderCount:0,fetchP95Ms:0,renderP95Ms:0,responseCacheHit:0,responseCacheMiss:0,responseCacheUnknown:0},"15min":{fetchCount:0,renderCount:0,fetchP95Ms:0,renderP95Ms:0,responseCacheHit:0,responseCacheMiss:0,responseCacheUnknown:0},"30min":{fetchCount:0,renderCount:0,fetchP95Ms:0,renderP95Ms:0,responseCacheHit:0,responseCacheMiss:0,responseCacheUnknown:0},"1hour":{fetchCount:0,renderCount:0,fetchP95Ms:0,renderP95Ms:0,responseCacheHit:0,responseCacheMiss:0,responseCacheUnknown:0},"4hour":{fetchCount:0,renderCount:0,fetchP95Ms:0,renderP95Ms:0,responseCacheHit:0,responseCacheMiss:0,responseCacheUnknown:0},"1day":{fetchCount:0,renderCount:0,fetchP95Ms:0,renderP95Ms:0,responseCacheHit:0,responseCacheMiss:0,responseCacheUnknown:0},"1week":{fetchCount:0,renderCount:0,fetchP95Ms:0,renderP95Ms:0,responseCacheHit:0,responseCacheMiss:0,responseCacheUnknown:0}};function xs(t){if(!t.length)return 0;const e=[...t].sort((r,i)=>r-i),n=Math.min(e.length-1,Math.max(0,Math.ceil(e.length*.95)-1));return Math.round(e[n]*100)/100}function Cs(t,e){!Number.isFinite(e)||e<0||(t.push(Math.round(e*100)/100),t.length>ps&&t.shift())}function Ds(t,e,n){const r=Ss[t],i=Ui[t];Cs(r.fetchMs,e),i.fetchCount+=1,i.fetchP95Ms=xs(r.fetchMs),n==="hit"?i.responseCacheHit+=1:n==="miss"?i.responseCacheMiss+=1:i.responseCacheUnknown+=1}function fo(t,e){const n=Ss[t],r=Ui[t];Cs(n.renderMs,e),r.renderCount+=1,r.renderP95Ms=xs(n.renderMs)}function Ql(){typeof window>"u"||(window.__chartPerfMetrics={getSnapshot:()=>({byInterval:Ui,sampleMax:ps})})}async function mo(t,e){const n=String(t||"").trim().toUpperCase();if(!n)return;const r=ql[e]||[];Ji();const i=new AbortController;or=i;const o=[];for(const s of r){if(i.signal.aborted)break;const a=Br(n,s);if(Oi(a))continue;if(Je.has(a)){o.push(Je.get(a));continue}const l=$i(n,s,{vdRsiLength:w.length,vdSourceInterval:E.sourceInterval,vdRsiSourceInterval:w.sourceInterval,signal:i.signal}).then(u=>{Hi(a,u)}).catch(()=>{}).finally(()=>{Je.delete(a)});Je.set(a,l),o.push(l)}await Promise.allSettled(o),i.signal.aborted||Lu(e,i.signal).catch(()=>{})}Ql();function Ht(t){if(!Array.isArray(t))return[...Ee];const e=new Set(Ee),n=[];for(const r of t){if(typeof r!="string"||!e.has(r))continue;const i=r;n.includes(i)||n.push(i)}for(const r of Ee)n.includes(r)||n.push(r);return n}function ec(t){if(!Number.isFinite(t))return"";const e=Math.max(0,Math.min(100,Number(t)));let n="";return Math.abs(e)>=100?n=String(Math.round(e)):n=e.toFixed(1),n.length>=le?n:n.padEnd(le," ")}function tc(t){return Array.isArray(t)?t.filter(e=>e&&(typeof e.time=="string"||typeof e.time=="number")&&Number.isFinite(Number(e.delta))).map(e=>({time:e.time,delta:Number(e.delta)})):[]}function nc(t){if(!Number.isFinite(t))return"";const e=t<0?"-":"",n=Math.abs(t),r=le-e.length;if(r<=0)return e.slice(0,le);const i=(u,c)=>{if(c<=0)return Math.trunc(u);const d=10**c;return Math.trunc(u*d)/d},o=u=>u.replace(/\.0+$/,"").replace(/(\.\d*?)0+$/,"$1"),s=(u,c)=>{const d=n/u;if(u!==1&&d<1)return null;const f=r-c.length;if(f<=0)return null;let p=0;for(c?d<10&&(p=1):d>=10&&d<100?p=1:d<10&&(p=2);p>=0;){const h=o(i(d,p).toFixed(p));if(h.length<=f)return`${e}${h}${c}`;p-=1}return null},a=[{divisor:1e9,suffix:"B"},{divisor:1e6,suffix:"M"},{divisor:1e3,suffix:"K"},{divisor:1,suffix:""}];for(const u of a){const c=s(u.divisor,u.suffix);if(c)return c.length>=le?c:c.padEnd(le," ")}const l=[{divisor:1e3,suffix:"K"},{divisor:1e6,suffix:"M"},{divisor:1e9,suffix:"B"}];for(const u of l){const c=r-u.suffix.length;if(c<=0)continue;const d=n/u.divisor,f=String(Math.max(1,Math.trunc(d)));if(f.length>c)continue;const p=`${e}${f}${u.suffix}`;return p.length>=le?p:p.padEnd(le," ")}return e?`${e}0`.padEnd(le," "):"0".padEnd(le," ")}function Vr(){if(!L)return;const t=ts(),e=es(L,te);t[e]={rsi:D?.getPersistedTrendlines()??[],volumeDeltaRsi:yr.map(n=>({...n}))},Dl(t)}function R(){if(!(typeof window>"u"))try{const t={price:{maSourceMode:k.maSourceMode,verticalGridlines:k.verticalGridlines,horizontalGridlines:k.horizontalGridlines,ma:k.ma.map(e=>({enabled:e.enabled,type:e.type,length:e.length,color:e.color}))},rsi:{length:M.length,lineColor:M.lineColor,midlineColor:M.midlineColor,midlineStyle:M.midlineStyle},volumeDelta:{sourceInterval:E.sourceInterval,divergenceTable:E.divergenceTable,divergentPriceBars:E.divergentPriceBars,bullishDivergentColor:E.bullishDivergentColor,bearishDivergentColor:E.bearishDivergentColor,neutralDivergentColor:E.neutralDivergentColor},volumeDeltaRsi:{length:w.length,lineColor:w.lineColor,midlineColor:w.midlineColor,midlineStyle:w.midlineStyle,sourceInterval:w.sourceInterval},paneOrder:[...ae],paneHeights:{...En}};window.localStorage.setItem(ls,JSON.stringify(t))}catch{}}function rc(){if(!(oo||typeof window>"u")){oo=!0;try{const t=window.localStorage.getItem(ls);if(!t)return;const e=JSON.parse(t),n=e?.price;if(n&&(k.maSourceMode=n.maSourceMode==="timeframe"?"timeframe":"daily",typeof n.verticalGridlines=="boolean"&&(k.verticalGridlines=n.verticalGridlines),typeof n.horizontalGridlines=="boolean"&&(k.horizontalGridlines=n.horizontalGridlines),Array.isArray(n.ma)))for(let s=0;s<k.ma.length;s++){const a=n.ma[s];a&&(k.ma[s].enabled=!!a.enabled,k.ma[s].type=a.type==="EMA"?"EMA":"SMA",k.ma[s].length=Math.max(1,Math.floor(Number(a.length)||k.ma[s].length)),typeof a.color=="string"&&a.color.trim()&&(k.ma[s].color=a.color))}const r=e?.rsi;r&&(M.length=Math.max(1,Math.floor(Number(r.length)||M.length)),typeof r.lineColor=="string"&&r.lineColor.trim()&&(M.lineColor=r.lineColor),typeof r.midlineColor=="string"&&r.midlineColor.trim()&&(M.midlineColor=r.midlineColor),M.midlineStyle=r.midlineStyle==="solid"?"solid":"dotted");const i=e?.volumeDelta;if(i){const s=String(i.sourceInterval||"");(s==="1min"||s==="5min"||s==="15min"||s==="30min"||s==="1hour"||s==="4hour")&&(E.sourceInterval=s),typeof i.divergenceTable=="boolean"&&(E.divergenceTable=i.divergenceTable),typeof i.divergentPriceBars=="boolean"&&(E.divergentPriceBars=i.divergentPriceBars),typeof i.bullishDivergentColor=="string"&&i.bullishDivergentColor.trim()&&(E.bullishDivergentColor=i.bullishDivergentColor),typeof i.bearishDivergentColor=="string"&&i.bearishDivergentColor.trim()&&(E.bearishDivergentColor=i.bearishDivergentColor),typeof i.neutralDivergentColor=="string"&&i.neutralDivergentColor.trim()&&(E.neutralDivergentColor=i.neutralDivergentColor)}const o=e?.volumeDeltaRsi;if(o){w.length=Math.max(1,Math.floor(Number(o.length)||w.length)),typeof o.lineColor=="string"&&o.lineColor.trim()&&(w.lineColor=o.lineColor),typeof o.midlineColor=="string"&&o.midlineColor.trim()&&(w.midlineColor=o.midlineColor),w.midlineStyle=o.midlineStyle==="solid"?"solid":"dotted";const s=String(o.sourceInterval||"");(s==="1min"||s==="5min"||s==="15min"||s==="30min"||s==="1hour"||s==="4hour")&&(w.sourceInterval=s)}if(ae=Ht(e?.paneOrder),e?.paneHeights&&typeof e.paneHeights=="object")for(const[s,a]of Object.entries(e.paneHeights))typeof a=="number"&&a>=Ni&&a<=Fi&&(En[s]=a)}catch{}}}function ws(t,e){const n=Math.max(1,Math.floor(e)),r=new Array(t.length).fill(null),i=t.slice();let o=null;for(let a=0;a<i.length;a++)Number.isFinite(i[a])?o=i[a]:o!==null&&(i[a]=o);let s=0;for(let a=0;a<i.length;a++){const l=i[a];Number.isFinite(l)&&(s+=l,a>=n&&(s-=i[a-n]),a>=n-1&&(r[a]=s/n))}return r}function ic(t,e,n){const r=[],i=new Map,o=new Set;for(const u of t){const c=Ie(u?.time),d=Number(u?.close);if(c===null||!Number.isFinite(d))continue;const f=co(c);o.has(f)||(o.add(f),r.push(f)),i.set(f,d)}const s=r.map(u=>Number(i.get(u))),a=e==="EMA"?Es(s,n):ws(s,n),l=new Map;for(let u=0;u<r.length;u++)l.set(r[u],a[u]??null);return t.map(u=>{const c=Ie(u?.time);return c===null?null:l.get(co(c))??null})}function Es(t,e){const n=Math.max(1,Math.floor(e)),r=new Array(t.length).fill(null);if(t.length===0)return r;const i=t.slice();let o=null;for(let l=0;l<i.length;l++)Number.isFinite(i[l])?o=i[l]:o!==null&&(i[l]=o);const s=2/(n+1);let a=null;for(let l=0;l<i.length;l++){const u=i[l];if(Number.isFinite(u)){if(a===null){let c=0,d=0;for(let f=l;f<i.length&&d<n;f++)Number.isFinite(i[f])&&(c+=i[f],d++);a=d>0?c/d:u}else a=u*s+a*(1-s);r[l]=a}}return r}function Di(t){const e=typeof t=="number"?t:Number.NaN;return Number.isFinite(e)&&e>0}function zi(){for(const t of k.ma)t.series&&T&&(T.removeSeries(t.series),t.series=null),T||(t.series=null),t.values=[]}function He(){if(!T||!S.length){zi();return}for(const t of k.ma){const e=Math.max(1,Math.floor(Number(t.length)||1));if(t.length=e,!t.enabled){t.series&&(T.removeSeries(t.series),t.series=null),t.values=[];continue}t.series?t.series.applyOptions({color:t.color}):t.series=T.addLineSeries({color:t.color,lineWidth:1,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1});const n=k.maSourceMode==="daily"?ic(S,t.type,e):t.type==="EMA"?Es(S.map(i=>Number(i.close)),e):ws(S.map(i=>Number(i.close)),e);t.values=n;const r=S.map((i,o)=>{const s=n[o];return Di(s)?{time:i.time,value:s}:{time:i.time}});t.series.setData(r)}}function oc(){if(!T||!Array.isArray(S)||S.length===0)return;if(k.maSourceMode==="daily"){He();return}const t=S.length-1,e=S[t],n=Number(e?.close);if(!Number.isFinite(n)){He();return}for(const r of k.ma){if(!r.enabled||!r.series)continue;const i=Math.max(1,Math.floor(Number(r.length)||1));let o=null;if(r.type==="EMA")if(t===0)o=n;else{const s=Number(r.values[t-1]);if(!Number.isFinite(s)){He();return}const a=2/(i+1);o=n*a+s*(1-a)}else if(t<i-1)o=null;else{let s=0;for(let a=t-i+1;a<=t;a++){const l=Number(S[a]?.close);if(!Number.isFinite(l)){He();return}s+=l}o=s/i}r.values.length!==S.length&&(r.values=new Array(S.length).fill(null)),r.values[t]=Di(o)?o:null,Di(o)?r.series.update({time:e.time,value:o}):r.series.update({time:e.time})}}function Gn(t){t&&(t.innerHTML="")}function jn(t,e){if(!t||!e||(e.innerHTML="",!k.verticalGridlines)||!vr.length)return;const n=e.clientWidth||e.offsetWidth;if(!(!Number.isFinite(n)||n<=0))for(const r of vr){const i=t.timeScale().timeToCoordinate(r);if(!Number.isFinite(i)||i<0||i>n)continue;const o=document.createElement("div");o.style.position="absolute",o.style.top="0",o.style.bottom="0",o.style.left=`${Math.round(i)}px`,o.style.width="1px",o.style.background=as(),e.appendChild(o)}}function Ts(){jn(T,br),jn(A,Sr),jn(U,xr),jn(D?.getChart(),Cr),Os()}function Ze(){ii===null&&(ii=requestAnimationFrame(()=>{ii=null,Ts(),Ys()}))}function qi(){T&&(T.applyOptions({grid:{vertLines:{visible:!1},horzLines:{visible:k.horizontalGridlines,color:as()}}}),Ze())}function ks(){if(!O)return;const t=O.querySelector('[data-price-setting="ma-source"]'),e=O.querySelector('[data-price-setting="v-grid"]'),n=O.querySelector('[data-price-setting="h-grid"]');t&&(t.value=k.maSourceMode),e&&(e.checked=k.verticalGridlines),n&&(n.checked=k.horizontalGridlines);for(let r=0;r<k.ma.length;r++){const i=k.ma[r],o=O.querySelector(`[data-price-setting="ma-enabled-${r}"]`),s=O.querySelector(`[data-price-setting="ma-type-${r}"]`),a=O.querySelector(`[data-price-setting="ma-length-${r}"]`),l=O.querySelector(`[data-price-setting="ma-color-${r}"]`);o&&(o.checked=i.enabled),s&&(s.value=i.type),a&&(a.value=String(i.length)),l&&(l.value=i.color)}}function Ms(){if(!Y)return;const t=Y.querySelector('[data-rsi-setting="length"]'),e=Y.querySelector('[data-rsi-setting="line-color"]'),n=Y.querySelector('[data-rsi-setting="midline-color"]'),r=Y.querySelector('[data-rsi-setting="midline-style"]');t&&(t.value=String(M.length)),e&&(e.value=M.lineColor),n&&(n.value=M.midlineColor),r&&(r.value=M.midlineStyle)}function Ls(){if(!q)return;const t=q.querySelector('[data-vd-setting="source-interval"]'),e=q.querySelector('[data-vd-setting="divergence-table"]'),n=q.querySelector('[data-vd-setting="divergent-price-bars"]'),r=q.querySelector('[data-vd-setting="divergent-bullish-color"]'),i=q.querySelector('[data-vd-setting="divergent-bearish-color"]'),o=q.querySelector('[data-vd-setting="divergent-neutral-color"]');t&&(t.value=E.sourceInterval),e&&(e.checked=E.divergenceTable),n&&(n.checked=E.divergentPriceBars),r&&(r.value=E.bullishDivergentColor),i&&(i.value=E.bearishDivergentColor),o&&(o.value=E.neutralDivergentColor)}function As(){if(!W)return;const t=W.querySelector('[data-vd-rsi-setting="length"]'),e=W.querySelector('[data-vd-rsi-setting="line-color"]'),n=W.querySelector('[data-vd-rsi-setting="midline-color"]'),r=W.querySelector('[data-vd-rsi-setting="midline-style"]'),i=W.querySelector('[data-vd-rsi-setting="source-interval"]');t&&(t.value=String(w.length)),e&&(e.value=w.lineColor),n&&(n.value=w.midlineColor),r&&(r.value=w.midlineStyle),i&&(i.value=w.sourceInterval)}function Yt(){O&&(O.style.display="none"),q&&(q.style.display="none"),W&&(W.style.display="none"),Y&&(Y.style.display="none")}function sc(){return Ht(ae)[0]}function ac(t){const e=String(t.dataset.topPaneBadgeRole||"");return e==="ticker"?0:e==="price-change"?1:100}function Wi(t){const e=Array.from(t.querySelectorAll(".pane-settings-btn, .pane-trendline-btn"));if(!e.length)return ao;const r=e.reduce((i,o)=>{const s=o.offsetLeft+o.offsetWidth;return s>i?s:i},0)+cs;return Math.max(ao,r)}function cn(t){const e=Array.from(t.querySelectorAll(`.${Ii}`)).filter(i=>i.style.display!=="none");if(!e.length)return;const n=e.map((i,o)=>({badge:i,index:o,priority:ac(i)})).sort((i,o)=>i.priority-o.priority||i.index-o.index).map(i=>i.badge);let r=Wi(t);for(const i of n){i.style.left=`${r}px`,i.style.top="8px",i.style.maxWidth=`calc(100% - ${r+30}px)`;const o=Math.ceil(i.getBoundingClientRect().width||i.offsetWidth||0);r+=Math.max(0,o)+cs}}function ho(t){const e=String(t||"").trim().toUpperCase();if(!e)return;const n=`https://www.tradingview.com/symbols/${encodeURIComponent(e)}/`;window.open(n,"_blank","noopener,noreferrer")}function Gi(){const t=sc();for(const i of Ee){const o=document.getElementById(i);if(!o||!(o instanceof HTMLElement))continue;const s=o.querySelector(`.${oi}`);s&&i!==t&&s.remove()}if(!t)return;const e=document.getElementById(t);if(!e||!(e instanceof HTMLElement))return;const n=String(L||"").trim().toUpperCase();let r=e.querySelector(`.${oi}`);if(!n){r&&r.remove();for(const i of Ee){const o=document.getElementById(i);!o||!(o instanceof HTMLElement)||cn(o)}return}if(!r){const i=Wi(e);r=document.createElement("div"),r.className=`${oi} ${Ii}`,r.dataset.topPaneBadgeRole="ticker",r.style.position="absolute",r.style.left=`${i}px`,r.style.top="8px",r.style.zIndex="32",r.style.minHeight="24px",r.style.maxWidth=`calc(100% - ${i+30}px)`,r.style.display="inline-flex",r.style.alignItems="center",r.style.padding="0 8px",r.style.borderRadius="4px",r.style.border=`1px solid ${y().borderColor}`,r.style.background=y().cardBg,r.style.color=y().textPrimary,r.style.fontSize="12px",r.style.fontWeight="600",r.style.fontFamily="'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",r.style.whiteSpace="nowrap",r.style.overflow="hidden",r.style.textOverflow="ellipsis",r.style.pointerEvents="auto",r.style.cursor="pointer",r.removeAttribute("title"),r.setAttribute("role","link"),r.tabIndex=0,r.dataset.clickBound||(r.addEventListener("click",o=>{o.stopPropagation();const s=o.currentTarget;ho(String(s.dataset.tickerSymbol||""))}),r.addEventListener("keydown",o=>{if(o.key!=="Enter"&&o.key!==" ")return;o.preventDefault();const s=o.currentTarget;ho(String(s.dataset.tickerSymbol||""))}),r.dataset.clickBound="1"),e.appendChild(r)}r.dataset.tickerSymbol=n,r.textContent=n;for(const i of Ee){const o=document.getElementById(i);!o||!(o instanceof HTMLElement)||cn(o)}}function Ps(t){for(const e of ae){const n=document.getElementById(e);!n||n.parentElement!==t||t.appendChild(n)}}function lc(t,e,n){if(t===e)return;const r=ae.filter(s=>s!==t),i=r.indexOf(e);if(i<0)return;const o=n?i+1:i;r.splice(o,0,t),ae=Ht(r)}function po(){for(const t of Ee){const e=document.getElementById(t);e&&e.classList.remove("pane-drag-over")}}function $s(t){Ps(t);const e=document.getElementById("price-chart-container"),n=document.getElementById("vd-rsi-chart-container"),r=document.getElementById("rsi-chart-container"),i=document.getElementById("vd-chart-container");e&&n&&r&&i&&qr(e,n,r,i),Or(),Gi()}function cc(){return document.getElementById("custom-chart-container")?.classList.contains("chart-fullscreen")===!0}function Kn(t){const n=Ht(ae).indexOf(t);return n===3&&cc()?!1:n===1||n===3}function Zn(t,e){t&&t.applyOptions({rightPriceScale:{visible:!0},timeScale:{visible:e,borderVisible:e,ticksVisible:e}})}function Or(){Zn(T,Kn("price-chart-container")),Zn(A,Kn("vd-rsi-chart-container")),Zn(D?.getChart(),Kn("rsi-chart-container")),Zn(U,Kn("vd-chart-container"))}function uc(t,e,n){t.dataset.paneId||(t.dataset.paneId=e);let r=t.querySelector(".pane-order-handle");r||(r=document.createElement("button"),r.type="button",r.className="pane-order-handle",r.removeAttribute("title"),r.textContent="",r.setAttribute("aria-label","Reorder pane"),t.appendChild(r)),r.dataset.bound||(r.setAttribute("draggable","true"),r.addEventListener("dragstart",i=>{Zt=e,i.dataTransfer&&(i.dataTransfer.effectAllowed="move",i.dataTransfer.setData("text/plain",e)),po()}),r.addEventListener("dragend",()=>{Zt=null,po()}),r.dataset.bound="1"),t.dataset.dropBound||(t.addEventListener("dragover",i=>{Zt&&(i.preventDefault(),t.classList.add("pane-drag-over"),i.dataTransfer&&(i.dataTransfer.dropEffect="move"))}),t.addEventListener("dragleave",()=>{t.classList.remove("pane-drag-over")}),t.addEventListener("drop",i=>{i.preventDefault(),t.classList.remove("pane-drag-over");const o=Zt;if(Zt=null,!o||o===e)return;const s=ae.indexOf(o),a=ae.indexOf(e),l=s>=0&&a>=0?s<a:!0;lc(o,e,l),$s(n),R()}),t.dataset.dropBound="1")}function dc(t){ae=Ht(ae),Ps(t);for(const e of Ee){const n=document.getElementById(e);!n||!(n instanceof HTMLElement)||n.parentElement!==t||uc(n,e,t)}Gi()}function ji(){if(!D)return;const t=ys(S,M.length);Ot=new Map(t.filter(e=>Number.isFinite(Number(e.value))).map(e=>[P(e.time),Number(e.value)])),D.setData(t,S.map(e=>({time:e.time,close:e.close}))),D.setLineColor(M.lineColor),D.setMidlineOptions(M.midlineColor,M.midlineStyle),Hr()}function Is(t){return t==="solid"?0:1}function Ki(){ie&&ie.applyOptions({color:w.lineColor,lineWidth:1}),xn&&xn.applyOptions({color:w.midlineColor,lineStyle:Is(w.midlineStyle)}),Hr()}function dt(t){Ki(),t&&L&&Te(L,te)}function fc(){zi(),k.maSourceMode=Oe.maSourceMode,k.verticalGridlines=Oe.verticalGridlines,k.horizontalGridlines=Oe.horizontalGridlines;for(let e=0;e<k.ma.length;e++){const n=Oe.ma[e];n&&(k.ma[e].enabled=n.enabled,k.ma[e].type=n.type,k.ma[e].length=n.length,k.ma[e].color=n.color,k.ma[e].series=null,k.ma[e].values=[])}ae=[...Ee];const t=document.getElementById("chart-content");t&&t instanceof HTMLElement&&$s(t),qi(),He(),ks(),R()}function mc(){M.length=Qt.length,M.lineColor=Qt.lineColor,M.midlineColor=Qt.midlineColor,M.midlineStyle=Qt.midlineStyle,ji(),Ms(),R()}function hc(){E.sourceInterval=pe.sourceInterval,E.divergenceTable=pe.divergenceTable,E.divergentPriceBars=pe.divergentPriceBars,E.bullishDivergentColor=pe.bullishDivergentColor,E.bearishDivergentColor=pe.bearishDivergentColor,E.neutralDivergentColor=pe.neutralDivergentColor,L&&Te(L,te),Qe(),Ls(),R()}function pc(){w.length=ut.length,w.lineColor=ut.lineColor,w.midlineColor=ut.midlineColor,w.midlineStyle=ut.midlineStyle,w.sourceInterval=ut.sourceInterval,dt(!0),As(),R()}function Yn(t,e){const n=t.querySelector(`.pane-settings-btn[data-pane="${e}"]`);if(n)return n;const r=document.createElement("button");return r.className="pane-btn pane-overlay pane-settings-btn",r.dataset.pane=e,r.type="button",r.innerHTML=Nl,r.style.left=`${Ri}px`,r.style.top=`${Vn}px`,t.appendChild(r),r}function gc(t){return t==="volumeDelta"?"VD":t==="volumeDeltaRsi"?"VD-RSI":t==="rsi"?"RSI":"Price"}function Xn(t,e){const n=t.querySelector(`.pane-name-badge[data-pane="${e}"]`);if(n)return n;const r=document.createElement("div");return r.className="pane-btn pane-overlay label pane-name-badge",r.dataset.pane=e,r.textContent=gc(e),r.style.left=`${Ri}px`,r.style.top=`${Vn+ge+$t}px`,t.appendChild(r),r}function ct(t,e,n,r){const i=t.querySelector(`.pane-trendline-btn[data-pane="${e}"][data-action="${n}"]`);if(i)return i;const o=document.createElement("button");return o.className="pane-btn pane-overlay pane-trendline-btn",o.dataset.pane=e,o.dataset.action=n,o.type="button",o.title=n==="trend"?"Draw Trendline":n==="erase"?"Erase Trendline":"",o.innerHTML=n==="trend"?is:n==="erase"?Tl:os,o.style.left=`${Ri+(r+1)*(ge+$t)}px`,o.style.top=`${Vn}px`,t.appendChild(o),o}function yc(t,e){return document.querySelector(`.pane-trendline-btn[data-pane="${t}"][data-action="${e}"]`)}function st(t,e,n){const r=yc(t,e);r&&(r.classList.toggle("active",n),r.innerHTML=e==="trend"?is:os)}function oe(t,e){st(t,"trend",e)}function Rs(){if(!Array.isArray(S)||S.length===0)return null;const t=S[S.length-1]?.time;if(typeof t!="string"&&typeof t!="number")return null;if(!T)return t;try{const e=T.timeScale().getVisibleLogicalRange?.(),n=Number(e?.from),r=Number(e?.to);if(!Number.isFinite(n)||!Number.isFinite(r))return t;const i=Math.round((n+r)/2),o=Math.max(0,Math.min(S.length-1,i)),s=S[o]?.time;if(typeof s=="string"||typeof s=="number")return s}catch{}return t}function vc(){if(!D)return;const t=Rs();if(t===null)return;const e=Qs(t,Ot),n=D.getChart?.(),r=D.getSeries?.();if(!(!n||!r||!Number.isFinite(e)))try{n.setCrosshairPosition(Number(e),t,r)}catch{}}function bc(){if(!A||!ie)return;const t=Rs();if(t===null)return;const e=Qs(t,it);if(Number.isFinite(e))try{A.setCrosshairPosition(Number(e),t,ie)}catch{}}function Sc(){if(D){if(ve){D.deactivateDivergenceTool(),ve=!1,oe("rsi",!1);return}be&&Tn(),D.activateDivergenceTool(),ve=!0,oe("rsi",!0),vc()}}function xc(){D?.clearDivergence(!0),D?.deactivateDivergenceTool(),ve=!1,oe("rsi",!1),Vr()}function Cc(){if(A){if(Ne){On(),oe("volumeDeltaRsi",!1);return}Se&&kn(),Gc(),oe("volumeDeltaRsi",!0),bc()}}function Dc(){Xi(!0),On(),oe("volumeDeltaRsi",!1),Vr()}function wc(t){const e=Ie(t);if(e===null)return"";const n=new Date(e*1e3);return te==="1day"||te==="1week"?Rn("en-US",{month:"2-digit",day:"2-digit",year:"2-digit"}).format(n):n.toLocaleString("en-US",{timeZone:ye(),month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1})}function Ec(t,e){const n=e==="rsi"?xi:Ci;if(n&&n.parentElement===t)return n.style.top="0",n.style.right="0",n.style.maxWidth="100%",n;const r=document.createElement("div");r.className=`divergence-plot-overlay divergence-plot-overlay-${e}`,r.style.position="absolute",r.style.top="0",r.style.right="0",r.style.width="468px",r.style.maxWidth="100%",r.style.height="286px",r.style.border=`1px solid ${y().borderColor}`,r.style.borderRadius="6px",r.style.background=y().bgOverlay95,r.style.backdropFilter="blur(4px)",r.style.zIndex="35",r.style.pointerEvents="none",r.style.display="none",r.style.padding="8px",r.style.boxSizing="border-box";const i=document.createElement("div");i.style.position="relative",i.style.width="100%",i.style.height="100%";const o=document.createElement("canvas");return o.className="divergence-plot-overlay-canvas",i.appendChild(o),r.appendChild(i),t.appendChild(r),e==="rsi"?xi=r:Ci=r,r}function Zi(t){return t==="rsi"?ns:rs}function Ns(t,e){t==="rsi"?ns=e:rs=e}function It(t){const e=t==="rsi"?xi:Ci;e&&(e.style.display="none");const n=Zi(t);if(n){try{n.destroy()}catch{}Ns(t,null)}}function Fs(t){if(!Array.isArray(S)||S.length===0)return null;const e=Dn.get(P(t));if(e!==void 0)return e;const n=Ie(t);if(n===null)return null;let r=0,i=Number.POSITIVE_INFINITY;for(let o=0;o<S.length;o++){const s=Ie(S[o]?.time);if(s===null)continue;const a=Math.abs(s-n);a<i&&(i=a,r=o)}return Number.isFinite(i)?r:null}function Tc(t){const e=[],n=[],r=[];for(let i=t;i<S.length;i++){const o=S[i],s=P(o.time),a=Number(Ot.get(s)),l=Number(it.get(s));!Number.isFinite(a)||!Number.isFinite(l)||(e.push(wc(o.time)),n.push(a),r.push(l))}return{labels:e,rsiValues:n,volumeDeltaRsiValues:r}}function Dr(t,e){const n=t==="rsi"?document.getElementById("rsi-chart-container"):document.getElementById("vd-rsi-chart-container");if(!n||!(n instanceof HTMLElement))return;const r=Ec(n,t),i=r.querySelector(".divergence-plot-overlay-canvas");if(!i)return;if(!S.length||e<0||e>=S.length){It(t);return}const o=Tc(e);if(o.rsiValues.length<2){It(t);return}r.style.display="block";const s=Zi(t);if(s){s.data.labels=o.labels,s.data.datasets[0].data=o.rsiValues,s.data.datasets[0].borderColor=M.lineColor,s.data.datasets[1].data=o.volumeDeltaRsiValues,s.data.datasets[1].borderColor=w.lineColor,s.update("none");return}const a=new Chart(i,{type:"line",data:{labels:o.labels,datasets:[{label:"RSI",data:o.rsiValues,borderColor:M.lineColor,backgroundColor:"transparent",borderWidth:1,pointRadius:o.rsiValues.length>24?0:2,tension:.2},{label:"VD RSI",data:o.volumeDeltaRsiValues,borderColor:w.lineColor,backgroundColor:"transparent",borderWidth:1,pointRadius:o.volumeDeltaRsiValues.length>24?0:2,tension:.2}]},options:{responsive:!0,maintainAspectRatio:!1,animation:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!1},tooltip:{backgroundColor:y().cardBgOverlay95,borderColor:y().borderColor,borderWidth:1,titleColor:y().textPrimary,bodyColor:y().textSecondary}},scales:{x:{display:!1,ticks:{color:y().textSecondary,maxRotation:0,autoSkip:!0,maxTicksLimit:6,font:{size:10}},grid:{color:y().borderOverlay22}},y:{display:!1,min:0,max:100,ticks:{color:y().textSecondary,font:{size:10}},grid:{color:y().borderOverlay22}}}}});Ns(t,a)}function Tn(){be=!1,Mt=!1,At=null,st("rsi","divergence",!1),It("rsi")}function kn(){Se=!1,Lt=!1,Pt=null,st("volumeDeltaRsi","divergence",!1),It("volumeDeltaRsi")}function go(t,e){if(!be||e&&!Mt)return;const n=Fs(t);n!==null&&(Mt=!0,At=n,Dr("rsi",n))}function _s(t,e){if(!Se||e&&!Lt)return;const n=Fs(t);n!==null&&(Lt=!0,Pt=n,Dr("volumeDeltaRsi",n))}function kc(){if(be){Tn();return}ve&&(D?.deactivateDivergenceTool(),ve=!1,oe("rsi",!1)),be=!0,Mt=!1,At=null,st("rsi","divergence",!0)}function Mc(){if(Se){kn();return}Ne&&(On(),oe("volumeDeltaRsi",!1)),Se=!0,Lt=!1,Pt=null,st("volumeDeltaRsi","divergence",!0)}function Hr(){be&&Mt&&At!==null&&Dr("rsi",At),Se&&Lt&&Pt!==null&&Dr("volumeDeltaRsi",Pt)}function Lc(){ve&&(D?.deactivateDivergenceTool(),ve=!1,oe("rsi",!1)),Ne&&(On(),oe("volumeDeltaRsi",!1)),be&&Tn(),Se&&kn()}function Ur(t){t.style.fontFamily='-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',t.style.fontSize="12px",t.style.fontWeight="500",t.style.lineHeight="1.2",t.querySelectorAll("div, span, label, input, select, button").forEach(e=>{e.style.fontFamily="inherit",e.style.fontSize="inherit",e.style.fontWeight="inherit",e.style.fontStyle="normal",e.style.letterSpacing="normal"}),t.querySelectorAll("label").forEach(e=>{e.style.display="flex",e.style.justifyContent="space-between",e.style.alignItems="center",e.style.gap="8px",e.style.minHeight="26px"}),t.querySelectorAll('input[type="checkbox"]').forEach(e=>{e.style.width="14px",e.style.height="14px",e.style.margin="0"}),t.querySelectorAll("input, select, button").forEach(e=>{e.style.boxSizing="border-box",e.style.lineHeight="1.2"})}function Ac(t){const e=document.createElement("div");return e.className="pane-settings-panel price-settings-panel",e.style.position="absolute",e.style.left="8px",e.style.top="38px",e.style.zIndex="31",e.style.width="280px",e.style.maxWidth="calc(100% - 16px)",e.style.background=y().cardBgOverlay95,e.style.border=`1px solid ${y().borderColor}`,e.style.borderRadius="6px",e.style.padding="10px",e.style.display="none",e.style.color=y().textPrimary,e.style.backdropFilter="blur(6px)",e.innerHTML=`
    <div style="display:flex; justify-content:space-between; align-items:center; min-height:26px; margin-bottom:8px;">
      <div style="font-weight:600;">Chart</div>
      <button type="button" data-price-setting="reset" style="background:${y().bgColor}; color:${y().textPrimary}; border:1px solid ${y().borderColor}; border-radius:4px; padding:4px 8px; font-size:12px; cursor:pointer;">Reset</button>
    </div>
    <label style="margin-bottom:6px;">
      <span>Vertical gridlines</span>
      <input type="checkbox" data-price-setting="v-grid" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Horizontal gridlines</span>
      <input type="checkbox" data-price-setting="h-grid" />
    </label>
    <label style="margin-bottom:4px;">
      <span>MA source</span>
      <select data-price-setting="ma-source" style="background:${y().bgColor}; color:${y().textPrimary}; border:1px solid ${y().borderColor}; border-radius:4px; padding:2px 4px;">
        <option value="daily">Daily</option>
        <option value="timeframe">Chart</option>
      </select>
    </label>
    ${k.ma.map((n,r)=>`
      <div style="display:grid; grid-template-columns: 20px 64px 58px 1fr; gap:6px; align-items:center; min-height:26px; margin-bottom:6px;">
        <input type="checkbox" data-price-setting="ma-enabled-${r}" title="Enable MA ${r+1}" />
        <select data-price-setting="ma-type-${r}" style="background:${y().bgColor}; color:${y().textPrimary}; border:1px solid ${y().borderColor}; border-radius:4px; padding:2px 4px;">
          <option value="SMA">SMA</option>
          <option value="EMA">EMA</option>
        </select>
        <input data-price-setting="ma-length-${r}" type="number" min="1" max="500" step="1" style="width:58px; background:${y().bgColor}; color:${y().textPrimary}; border:1px solid ${y().borderColor}; border-radius:4px; padding:2px 4px;" />
        <input data-price-setting="ma-color-${r}" type="color" style="width:100%; height:24px; border:none; background:transparent; padding:0;" />
      </div>
    `).join("")}
  `,Ur(e),e.addEventListener("input",n=>{const r=n.target;if(!r)return;const i=r.dataset.priceSetting||"";if(i==="ma-source"){k.maSourceMode=r.value==="timeframe"?"timeframe":"daily",He(),R();return}if(i==="v-grid"){k.verticalGridlines=r.checked,Ze(),R();return}if(i==="h-grid"){k.horizontalGridlines=r.checked,qi(),R();return}const o=i.match(/^ma-(enabled|type|length|color)-(\d)$/);if(!o)return;const s=o[1],a=Number(o[2]),l=k.ma[a];l&&(s==="enabled"?l.enabled=r.checked:s==="type"?l.type=r.value==="EMA"?"EMA":"SMA":s==="length"?l.length=Math.max(1,Math.floor(Number(r.value)||14)):s==="color"&&(l.color=r.value||l.color),He(),R())}),e.addEventListener("click",n=>{const r=n.target;r&&r.dataset.priceSetting==="reset"&&(n.preventDefault(),fc())}),t.appendChild(e),e}function Pc(t){const e=document.createElement("div");return e.className="pane-settings-panel rsi-settings-panel",e.style.position="absolute",e.style.left="8px",e.style.top="38px",e.style.zIndex="31",e.style.width="230px",e.style.maxWidth="calc(100% - 16px)",e.style.background=y().cardBgOverlay95,e.style.border=`1px solid ${y().borderColor}`,e.style.borderRadius="6px",e.style.padding="10px",e.style.display="none",e.style.color=y().textPrimary,e.style.backdropFilter="blur(6px)",e.innerHTML=`
    <div style="display:flex; justify-content:space-between; align-items:center; min-height:26px; margin-bottom:8px;">
      <div style="font-weight:600;">RSI</div>
      <button type="button" data-rsi-setting="reset" style="background:${y().bgColor}; color:${y().textPrimary}; border:1px solid ${y().borderColor}; border-radius:4px; padding:4px 8px; font-size:12px; cursor:pointer;">Reset</button>
    </div>
    <label style="margin-bottom:6px;">
      <span>Length</span>
      <input data-rsi-setting="length" type="number" min="1" max="200" step="1" style="width:64px; background:${y().bgColor}; color:${y().textPrimary}; border:1px solid ${y().borderColor}; border-radius:4px; padding:2px 4px;" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Line color</span>
      <input data-rsi-setting="line-color" type="color" style="width:64px; height:24px; border:none; background:transparent; padding:0;" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Midline color</span>
      <input data-rsi-setting="midline-color" type="color" style="width:64px; height:24px; border:none; background:transparent; padding:0;" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Midline style</span>
      <select data-rsi-setting="midline-style" style="background:${y().bgColor}; color:${y().textPrimary}; border:1px solid ${y().borderColor}; border-radius:4px; padding:2px 4px;">
        <option value="dotted">Dotted</option>
        <option value="solid">Solid</option>
      </select>
    </label>
  `,Ur(e),e.addEventListener("input",n=>{const r=n.target;if(!r)return;const i=r.dataset.rsiSetting||"";if(i==="length"){M.length=Math.max(1,Math.floor(Number(r.value)||14)),ji(),R();return}if(i==="line-color"){M.lineColor=r.value||M.lineColor,D?.setLineColor(M.lineColor),R();return}if(i==="midline-color"){M.midlineColor=r.value||M.midlineColor,D?.setMidlineOptions(M.midlineColor,M.midlineStyle),R();return}if(i==="midline-style"){M.midlineStyle=r.value==="solid"?"solid":"dotted",D?.setMidlineOptions(M.midlineColor,M.midlineStyle),R();return}}),e.addEventListener("click",n=>{const r=n.target;r&&r.dataset.rsiSetting==="reset"&&(n.preventDefault(),mc())}),t.appendChild(e),e}function $c(t){const e=document.createElement("div");return e.className="pane-settings-panel volume-delta-settings-panel",e.style.position="absolute",e.style.left="8px",e.style.top="38px",e.style.zIndex="31",e.style.width="230px",e.style.maxWidth="calc(100% - 16px)",e.style.background=y().cardBgOverlay95,e.style.border=`1px solid ${y().borderColor}`,e.style.borderRadius="6px",e.style.padding="10px",e.style.display="none",e.style.color=y().textPrimary,e.style.backdropFilter="blur(6px)",e.innerHTML=`
    <div style="display:flex; justify-content:space-between; align-items:center; min-height:26px; margin-bottom:8px;">
      <div style="font-weight:600;">Volume Delta</div>
      <button type="button" data-vd-setting="reset" style="background:${y().bgColor}; color:${y().textPrimary}; border:1px solid ${y().borderColor}; border-radius:4px; padding:4px 8px; font-size:12px; cursor:pointer;">Reset</button>
    </div>
    <label style="margin-bottom:6px;">
      <span>Source</span>
      <select data-vd-setting="source-interval" style="background:${y().bgColor}; color:${y().textPrimary}; border:1px solid ${y().borderColor}; border-radius:4px; padding:2px 4px;">
        ${hs.map(n=>`<option value="${n.value}">${n.label}</option>`).join("")}
      </select>
    </label>
    <label style="margin-bottom:6px;">
      <span>Divergence table</span>
      <input type="checkbox" data-vd-setting="divergence-table" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Divergent price bars</span>
      <input type="checkbox" data-vd-setting="divergent-price-bars" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Bullish</span>
      <input type="color" data-vd-setting="divergent-bullish-color" style="width:64px; height:24px; border:none; background:transparent; padding:0;" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Bearish</span>
      <input type="color" data-vd-setting="divergent-bearish-color" style="width:64px; height:24px; border:none; background:transparent; padding:0;" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Neutral</span>
      <input type="color" data-vd-setting="divergent-neutral-color" style="width:64px; height:24px; border:none; background:transparent; padding:0;" />
    </label>
  `,Ur(e),e.addEventListener("input",n=>{const r=n.target;if(!r)return;const i=r.dataset.vdSetting||"";if(i==="source-interval"){const o=String(r.value||"");if(o!=="1min"&&o!=="5min"&&o!=="15min"&&o!=="30min"&&o!=="1hour"&&o!=="4hour")return;E.sourceInterval=o,L&&Te(L,te),R();return}if(i==="divergence-table"){E.divergenceTable=r.checked,nt&&zr(nt,S),R();return}if(i==="divergent-price-bars"){E.divergentPriceBars=r.checked,Qe(),R();return}if(i==="divergent-bullish-color"){E.bullishDivergentColor=r.value||E.bullishDivergentColor,Qe(),R();return}if(i==="divergent-bearish-color"){E.bearishDivergentColor=r.value||E.bearishDivergentColor,Qe(),R();return}if(i==="divergent-neutral-color"){E.neutralDivergentColor=r.value||E.neutralDivergentColor,Qe(),R();return}}),e.addEventListener("click",n=>{const r=n.target;r&&r.dataset.vdSetting==="reset"&&(n.preventDefault(),hc())}),t.appendChild(e),e}function Ic(t){const e=document.createElement("div");return e.className="pane-settings-panel volume-delta-rsi-settings-panel",e.style.position="absolute",e.style.left="8px",e.style.top="38px",e.style.zIndex="31",e.style.width="230px",e.style.maxWidth="calc(100% - 16px)",e.style.background=y().cardBgOverlay95,e.style.border=`1px solid ${y().borderColor}`,e.style.borderRadius="6px",e.style.padding="10px",e.style.display="none",e.style.color=y().textPrimary,e.style.backdropFilter="blur(6px)",e.innerHTML=`
    <div style="display:flex; justify-content:space-between; align-items:center; min-height:26px; margin-bottom:8px;">
      <div style="font-weight:600;">Volume Delta RSI</div>
      <button type="button" data-vd-rsi-setting="reset" style="background:${y().bgColor}; color:${y().textPrimary}; border:1px solid ${y().borderColor}; border-radius:4px; padding:4px 8px; font-size:12px; cursor:pointer;">Reset</button>
    </div>
    <label style="margin-bottom:6px;">
      <span>Length</span>
      <input data-vd-rsi-setting="length" type="number" min="1" max="200" step="1" style="width:64px; background:${y().bgColor}; color:${y().textPrimary}; border:1px solid ${y().borderColor}; border-radius:4px; padding:2px 4px;" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Source</span>
      <select data-vd-rsi-setting="source-interval" style="background:${y().bgColor}; color:${y().textPrimary}; border:1px solid ${y().borderColor}; border-radius:4px; padding:2px 4px;">
        ${hs.map(n=>`<option value="${n.value}">${n.label}</option>`).join("")}
      </select>
    </label>
    <label style="margin-bottom:6px;">
      <span>Line color</span>
      <input data-vd-rsi-setting="line-color" type="color" style="width:64px; height:24px; border:none; background:transparent; padding:0;" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Midline color</span>
      <input data-vd-rsi-setting="midline-color" type="color" style="width:64px; height:24px; border:none; background:transparent; padding:0;" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Midline style</span>
      <select data-vd-rsi-setting="midline-style" style="background:${y().bgColor}; color:${y().textPrimary}; border:1px solid ${y().borderColor}; border-radius:4px; padding:2px 4px;">
        <option value="dotted">Dotted</option>
        <option value="solid">Solid</option>
      </select>
    </label>
  `,Ur(e),e.addEventListener("input",n=>{const r=n.target;if(!r)return;const i=r.dataset.vdRsiSetting||"";if(i==="length"){w.length=Math.max(1,Math.floor(Number(r.value)||14)),dt(!0),R();return}if(i==="source-interval"){const o=String(r.value||"");if(o!=="1min"&&o!=="5min"&&o!=="15min"&&o!=="30min"&&o!=="1hour"&&o!=="4hour")return;w.sourceInterval=o,dt(!0),R();return}if(i==="line-color"){w.lineColor=r.value||w.lineColor,dt(!1),R();return}if(i==="midline-color"){w.midlineColor=r.value||w.midlineColor,dt(!1),R();return}if(i==="midline-style"){w.midlineStyle=r.value==="solid"?"solid":"dotted",dt(!1),R();return}}),e.addEventListener("click",n=>{const r=n.target;r&&r.dataset.vdRsiSetting==="reset"&&(n.preventDefault(),pc())}),t.appendChild(e),e}function Rc(t,e,n,r){const i=Yn(t,"price");lu(t),uu(t);const o=cu(t),s=Yn(e,"volumeDeltaRsi"),a=Yn(n,"rsi"),l=Yn(r,"volumeDelta");Xn(t,"price"),Xn(e,"volumeDeltaRsi"),Xn(n,"rsi"),Xn(r,"volumeDelta");const u=ct(e,"volumeDeltaRsi","trend",0),c=ct(e,"volumeDeltaRsi","erase",1),d=ct(e,"volumeDeltaRsi","divergence",2),f=ct(n,"rsi","trend",0),p=ct(n,"rsi","erase",1),h=ct(n,"rsi","divergence",2);(!O||O.parentElement!==t)&&(O?.parentElement&&O.parentElement.removeChild(O),O=Ac(t)),(!Y||Y.parentElement!==n)&&(Y?.parentElement&&Y.parentElement.removeChild(Y),Y=Pc(n)),(!W||W.parentElement!==e)&&(W?.parentElement&&W.parentElement.removeChild(W),W=Ic(e)),(!q||q.parentElement!==r)&&(q?.parentElement&&q.parentElement.removeChild(q),q=$c(r)),ks(),Ls(),As(),Ms(),i.dataset.bound||(i.addEventListener("click",m=>{m.stopPropagation();const g=O?.style.display==="block"?"none":"block";Yt(),O&&(O.style.display=g)}),i.dataset.bound="1"),s.dataset.bound||(s.addEventListener("click",m=>{m.stopPropagation();const g=W?.style.display==="block"?"none":"block";Yt(),W&&(W.style.display=g)}),s.dataset.bound="1"),l.dataset.bound||(l.addEventListener("click",m=>{m.stopPropagation();const g=q?.style.display==="block"?"none":"block";Yt(),q&&(q.style.display=g)}),l.dataset.bound="1"),a.dataset.bound||(a.addEventListener("click",m=>{m.stopPropagation();const g=Y?.style.display==="block"?"none":"block";Yt(),Y&&(Y.style.display=g)}),a.dataset.bound="1"),u.dataset.bound||(u.addEventListener("click",m=>{m.preventDefault(),m.stopPropagation(),Cc()}),u.dataset.bound="1"),c.dataset.bound||(c.addEventListener("click",m=>{m.preventDefault(),m.stopPropagation(),Dc()}),c.dataset.bound="1"),d.dataset.bound||(d.addEventListener("click",m=>{m.preventDefault(),m.stopPropagation(),Mc()}),d.dataset.bound="1"),f.dataset.bound||(f.addEventListener("click",m=>{m.preventDefault(),m.stopPropagation(),Sc()}),f.dataset.bound="1"),p.dataset.bound||(p.addEventListener("click",m=>{m.preventDefault(),m.stopPropagation(),xc()}),p.dataset.bound="1"),h.dataset.bound||(h.addEventListener("click",m=>{m.preventDefault(),m.stopPropagation(),kc()}),h.dataset.bound="1"),o.dataset.bound||(o.addEventListener("click",m=>{m.preventDefault(),m.stopPropagation(),L&&(Ei(!0),Xs(L,!0).finally(()=>{Ei(!1)}))}),o.dataset.bound="1"),oe("rsi",ve),oe("volumeDeltaRsi",Ne),st("rsi","divergence",be),st("volumeDeltaRsi","divergence",Se),document.body.dataset.chartSettingsBound||(document.addEventListener("click",m=>{const g=m.target;g&&(g.closest(".pane-settings-panel")||g.closest(".pane-settings-btn")||Yt())}),document.addEventListener("keydown",m=>{m.key==="Escape"&&Lc()}),document.body.dataset.chartSettingsBound="1")}function Nc(t){let e=t.querySelector(".price-pane-change");if(e)return e;const n=Wi(t);return e=document.createElement("div"),e.className=`price-pane-change ${Ii}`,e.dataset.topPaneBadgeRole="price-change",e.style.position="absolute",e.style.left=`${n}px`,e.style.top="8px",e.style.zIndex="30",e.style.minHeight="24px",e.style.display="inline-flex",e.style.alignItems="center",e.style.padding="0 8px",e.style.borderRadius="4px",e.style.border=`1px solid ${y().borderColor}`,e.style.background=y().cardBg,e.style.color=y().textPrimary,e.style.fontSize="12px",e.style.fontFamily="'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",e.style.pointerEvents="none",e.style.display="none",t.appendChild(e),e}function Fc(t){if(rt=new Map,!(!Array.isArray(t)||t.length<2))for(let e=1;e<t.length;e++){const n=Number(t[e]?.close),r=Number(t[e-1]?.close);if(!Number.isFinite(n)||!Number.isFinite(r)||r===0)continue;const i=(n-r)/r*100;rt.set(P(t[e].time),i)}}function ce(t,e){const n=Nc(t);if(!S.length||rt.size===0){n.style.display="none",n.textContent="",cn(t);return}const r=S[S.length-1]?.time,i=e!=null?P(e):P(r),o=Number(rt.get(i));if(!Number.isFinite(o)){n.style.display="none",n.textContent="",cn(t);return}const s=o>0?"+":"";n.textContent=`${s}${o.toFixed(2)}%`,n.style.color=o>0?"#26a69a":o<0?"#ef5350":y().textPrimary,n.style.display="inline-flex",cn(t)}function _c(t){let e=t.querySelector(".price-pane-message");return e||(e=document.createElement("div"),e.className="price-pane-message",e.style.position="absolute",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.color=y().textSecondary,e.style.fontSize="1rem",e.style.fontWeight="600",e.style.pointerEvents="none",e.style.zIndex="20",e.style.display="none",t.appendChild(e),e)}function yo(t,e){const n=_c(t);if(!e){n.style.display="none",n.textContent="";return}n.textContent=e,n.style.display="block"}function Bc(t){const e=String(t?.message||t||"");return/No .*data available for this ticker|No valid chart bars/i.test(e)}function Vc(t){if(!Number.isFinite(t))return"";const e=Math.abs(t);let n="";if(e>=100)n=String(Math.round(t));else if(e>=10){const r=Math.round(t*10)/10;Math.abs(r)>=100?n=String(Math.round(r)):n=r.toFixed(1)}else n=(Math.round(t*100)/100).toFixed(2);return n.length>=le?n:n.padEnd(le," ")}function P(t){return typeof t=="number"?String(t):t}function Yi(){return{priceRange:{minValue:Vl,maxValue:Ol}}}function Bs(t){return Math.max(us,Math.min(ds,Number(t)))}function Vs(t){const e=document.getElementById("vd-rsi-chart-container");e&&(e.style.cursor=t?"crosshair":"default")}function je(t){return Ie(t)}function Oc(t){return Number.isFinite(t)?Rn("en-US",{month:"2-digit",day:"2-digit",year:"2-digit"}).format(new Date(Math.round(Number(t))*1e3)):"N/A"}function Hc(t){const e=document.createElement("div");return e.className="trendline-cross-label",e.textContent=t,e.style.position="absolute",e.style.zIndex="29",e.style.minHeight="24px",e.style.display="inline-flex",e.style.alignItems="center",e.style.padding="0 8px",e.style.borderRadius="4px",e.style.border=`1px solid ${y().borderColor}`,e.style.background=y().cardBg,e.style.color=y().textPrimary,e.style.fontSize="12px",e.style.fontFamily="'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",e.style.pointerEvents="none",e.style.whiteSpace="nowrap",e.style.transform="translate(-50%, calc(-100% - 6px))",e}function Os(){const t=document.getElementById("vd-rsi-chart-container");if(!t||!A||!ie)return;const e=t.clientWidth,n=t.clientHeight;for(const r of gr){const i=A.timeScale().timeToCoordinate(r.anchorTime),o=ie.priceToCoordinate(r.anchorValue);if(!Number.isFinite(i)||!Number.isFinite(o)||i<0||i>e||o<0||o>n){r.element.style.display="none";continue}r.element.style.display="inline-flex",r.element.style.left=`${Math.round(i)}px`,r.element.style.top=`${Math.round(Math.max(8,o))}px`}}function vo(){for(const t of gr)t.element.remove();gr=[]}function Uc(t,e,n){const r=document.getElementById("vd-rsi-chart-container");if(!r)return;const i=Hc(n);r.appendChild(i),gr.push({element:i,anchorTime:t,anchorValue:e}),Os()}function Hs(t,e,n){if(n>=86400){const l=Math.floor(e),u=e-l,c=new Date(t*1e3);let d=l;for(;d>0;){c.setUTCDate(c.getUTCDate()+1);const p=c.getUTCDay();p!==0&&p!==6&&d--}const f=Math.floor(c.getTime()/1e3);if(u>0){const p=new Date(c);do p.setUTCDate(p.getUTCDate()+1);while(p.getUTCDay()===0||p.getUTCDay()===6);const h=Math.floor(p.getTime()/1e3);return f+u*(h-f)}return f}const r=zs(n),i=Math.floor(e/r),o=e-i*r,s=new Date(t*1e3);let a=i;for(;a>0;){s.setUTCDate(s.getUTCDate()+1);const l=s.getUTCDay();l!==0&&l!==6&&a--}return Math.floor(s.getTime()/1e3)+o*n}function zc(t,e,n,r,i){if(!Number.isFinite(t))return null;if(t>e)return r===null?null:Hs(r,t-e,i);if(t<0)return n===null?null:n+t*i;const o=Math.max(0,Math.floor(t)),s=Math.min(e,Math.ceil(t)),a=je(I[o]?.time),l=je(I[s]?.time);if(o===s)return a;if(Number.isFinite(a)&&Number.isFinite(l)){const u=t-o;return Number(a)+(Number(l)-Number(a))*u}return Number.isFinite(a)?Number(a)+(t-o)*i:n===null?null:n+t*i}function qc(t,e,n,r,i,o,s){if(!Number.isFinite(n)||Math.abs(n)<1e-12)return null;const a=t+(Bl-e)/n;return Number.isFinite(a)?zc(a,r,i,o,s):null}function Us(){if(I.length<2)return 1800;const t=[];for(let e=1;e<I.length;e++){const n=je(I[e-1].time),r=je(I[e].time);if(n===null||r===null)continue;const i=r-n;Number.isFinite(i)&&i>0&&t.push(i)}return t.length===0?1800:(t.sort((e,n)=>e-n),t[Math.floor(t.length*.25)])}function zs(t){return t<=300?78:t<=900?26:t<=1800?13:t<=3600?7:2}function Wc(){const t=Us();return zs(t)*252}function qs(){if(!(!an||!A)){try{A.removeSeries(an)}catch{}an=null}}function Ws(t=!1){const e=t&&A?A.timeScale().getVisibleLogicalRange?.():null;if(t&&(ht=!0),!A||Xt.length===0){Xt=[],yr=[],vo(),t&&(ht=!1);return}try{for(const n of Xt)try{A.removeSeries(n)}catch{}Xt=[],yr=[],vo()}finally{if(t&&e)try{A.timeScale().setVisibleLogicalRange(e)}catch{}t&&(ht=!1)}}function Gs(){qs(),Jt=null,rr.clear()}function On(){Ne=!1,Gs(),Vs(!1)}function Gc(){Ne=!0,Vs(!0)}function Xi(t=!1){Gs(),Ws(t)}function jc(t){if(qs(),!A||t.length===0)return;an=A.addLineSeries({color:Ul,lineVisible:!1,pointMarkersVisible:!0,pointMarkersRadius:2,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1,autoscaleInfoProvider:()=>Yi()});const e=Math.max(1,Math.ceil(t.length/Hl)),n=e===1?t:t.filter((r,i)=>i%e===0);an.setData(n)}function js(t,e,n,r,i=!0){if(!A||!I.length)return;const o=kt.get(P(t)),s=kt.get(P(n));if(o===void 0||s===void 0||o===s)return;const a=(r-e)/(s-o),l=I.length-1,u=Wc(),c=l+u,d=Us(),f=je(I[0]?.time),p=je(I[l]?.time),h=A.timeScale().getVisibleLogicalRange?.(),m=[];ht=!0;try{for(let v=o;v<=c;v++){const x=e+a*(v-o);if(!Number.isFinite(x)||x<us||x>ds)break;let C=null;v<=l?C=I[v]?.time??null:p!==null&&(C=Hs(p,v-l,d)),C!=null&&m.push({time:C,value:x})}if(!m.length)return;const g=A.addLineSeries({color:zl,lineWidth:1,lineStyle:0,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1,autoscaleInfoProvider:()=>Yi()});g.setData(m),Xt.push(g);const b=qc(o,e,a,l,f,p,d);Uc(t,e,Oc(b)),i&&yr.push({time1:t,value1:Number(e),time2:n,value2:Number(r)})}finally{if(h)try{A.timeScale().setVisibleLogicalRange(h)}catch{}ht=!1}}function Kc(t){if(!Ne)return;const e=P(t),n=kt.get(e);if(n===void 0)return;const r=I[n];if(!r)return;const i=Number(r.value),o=Cn.get(e);if(!Number.isFinite(i)||!Number.isFinite(o))return;const s=Number(o);if(!Jt){Jt={time:t,rsi:i,price:s,index:n};const a=[];rr.clear();for(let l=n+1;l<I.length;l++){const u=I[l],c=Number(u?.value);if(!Number.isFinite(c))continue;const d=Cn.get(P(u.time));if(!Number.isFinite(d))continue;const f=Number(d),p=c<i&&f>s,h=c>i&&f<s;!p&&!h||(a.push({time:u.time,value:c}),rr.add(P(u.time)))}jc(a);return}rr.has(e)&&(js(Jt.time,Jt.rsi,t,i),On(),oe("volumeDeltaRsi",!1),Vr())}function Zc(t,e){return!t||!e?!1:Math.abs(Number(t.from)-Number(e.from))<1e-6&&Math.abs(Number(t.to)-Number(e.to))<1e-6}function Yc(t){const e=In(t,{layout:{background:{color:y().bgColor},textColor:y().textPrimary,fontFamily:"'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",attributionLogo:!1},grid:{vertLines:{visible:!1},horzLines:{visible:!1}},crosshair:{mode:se?Et.Magnet:Et.Normal},kineticScroll:{touch:!1,mouse:!1},handleScroll:{pressedMouseMove:!0,horzTouchDrag:!0,vertTouchDrag:se,mouseWheel:!0},handleScale:{mouseWheel:!0,pinch:!0,axisPressedMouseMove:!0,axisDoubleClickReset:!0},rightPriceScale:{borderColor:y().surfaceElevated,minimumWidth:ot,entireTextOnly:!0},timeScale:{visible:!1,timeVisible:!0,secondsVisible:!1,borderVisible:!1,fixRightEdge:!1,rightBarStaysOnScroll:!1,rightOffset:Bn,tickMarkFormatter:_i}}),n=e.addCandlestickSeries({upColor:"#26a69a",downColor:"#ef5350",borderVisible:!1,wickUpColor:"#26a69a",wickDownColor:"#ef5350",priceFormat:{type:"custom",minMove:.01,formatter:i=>Vc(Number(i))}}),r=e.addLineSeries({color:"rgba(0, 0, 0, 0)",lineVisible:!1,pointMarkersVisible:!1,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1});return{chart:e,series:n,timelineSeries:r}}function Xc(t){const e=In(t,{layout:{background:{color:y().bgColor},textColor:y().textPrimary,fontFamily:"'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",attributionLogo:!1},grid:{vertLines:{visible:!1},horzLines:{visible:!1}},crosshair:{mode:se?Et.Magnet:Et.Normal},kineticScroll:{touch:!1,mouse:!1},handleScroll:{pressedMouseMove:!0,horzTouchDrag:!0,vertTouchDrag:se,mouseWheel:!0},handleScale:{mouseWheel:!0,pinch:!0,axisPressedMouseMove:{time:!0,price:!1},axisDoubleClickReset:{time:!0,price:!1}},rightPriceScale:{borderColor:y().surfaceElevated,minimumWidth:ot,entireTextOnly:!0,scaleMargins:{top:.2,bottom:.2}},timeScale:{visible:!1,timeVisible:!0,secondsVisible:!1,borderVisible:!1,fixRightEdge:!1,rightBarStaysOnScroll:!1,rightOffset:Bn,tickMarkFormatter:_i}}),n=e.addLineSeries({color:w.lineColor,lineWidth:1,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1,priceFormat:{type:"custom",minMove:.1,formatter:i=>ec(Number(i))},autoscaleInfoProvider:()=>Yi()}),r=e.addLineSeries({color:"rgba(0, 0, 0, 0)",lineVisible:!1,pointMarkersVisible:!1,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1});return xn=n.createPriceLine({price:_l,color:w.midlineColor,lineWidth:1,lineStyle:Is(w.midlineStyle),axisLabelVisible:!1,title:"Midline"}),e.subscribeClick(i=>{if(!(!i||!i.time)){if(Se){_s(i.time,!1);return}Ne&&Kc(i.time)}}),{chart:e,rsiSeries:n,timelineSeries:r}}function Jc(t){const e=In(t,{layout:{background:{color:y().bgColor},textColor:y().textPrimary,fontFamily:"'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",attributionLogo:!1},grid:{vertLines:{visible:!1},horzLines:{visible:!1}},crosshair:{mode:se?Et.Magnet:Et.Normal},kineticScroll:{touch:!1,mouse:!1},handleScroll:{pressedMouseMove:!0,horzTouchDrag:!0,vertTouchDrag:se,mouseWheel:!0},handleScale:{mouseWheel:!0,pinch:!0,axisPressedMouseMove:{time:!0,price:!1},axisDoubleClickReset:{time:!0,price:!1}},rightPriceScale:{borderColor:y().surfaceElevated,minimumWidth:ot,entireTextOnly:!0},timeScale:{visible:!1,timeVisible:!0,secondsVisible:!1,borderVisible:!1,fixRightEdge:!1,rightBarStaysOnScroll:!1,rightOffset:Bn,tickMarkFormatter:_i}}),n=e.addHistogramSeries({base:0,priceLineVisible:!1,lastValueVisible:!1,priceFormat:{type:"custom",minMove:1,formatter:i=>nc(Number(i))}}),r=e.addLineSeries({color:"rgba(0, 0, 0, 0)",lineVisible:!1,pointMarkersVisible:!1,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1});return n.createPriceLine({price:0,color:y().textSecondary,lineWidth:1,lineStyle:2,axisLabelVisible:!1,title:""}),U=e,{chart:e,histogramSeries:n,timelineSeries:r}}function Qc(t,e){if(!ie)return;Xi(),I=vs(e?.rsi||[]).map(o=>({time:o.time,value:Bs(Number(o.value))})),kt=new Map;for(let o=0;o<I.length;o++)kt.set(P(I[o].time),o);const r=new Map;for(const o of I)r.set(P(o.time),Number(o.value));const i=t.map(o=>{const s=r.get(P(o.time));return Number.isFinite(s)?{time:o.time,value:Number(s)}:{time:o.time}});ie.setData(i),it=new Map;for(const o of t){const s=P(o.time),a=r.get(s);Number.isFinite(a)&&it.set(s,Number(a))}Hr()}function eu(t){if(Ws(),!(!Array.isArray(t)||t.length===0))for(const e of t){const n=e?.time1,r=e?.time2,i=Number(e?.value1),o=Number(e?.value2);typeof n!="string"&&typeof n!="number"||typeof r!="string"&&typeof r!="number"||!Number.isFinite(i)||!Number.isFinite(o)||js(n,i,r,o,!0)}}function tu(){if(!L)return;const t=wl(L,te);D?.restorePersistedTrendlines(t.rsi),eu(t.volumeDeltaRsi)}function nu(t,e){if(!Ge)return;const n=new Map;for(const i of e){const o=Number(i.delta);Number.isFinite(o)&&n.set(P(i.time),o)}const r=t.map(i=>{const o=n.get(P(i.time))??0,s=Number.isFinite(Number(o))?Number(o):0;return{time:i.time,value:s,color:s>=0?fs:ms}});Ge.setData(r),_n=new Map(r.map(i=>[P(i.time),Number(i.value)||0])),Qe()}function ru(t){if(z&&z.parentElement===t)return z.style.top="8px",z.style.transform="none",z.style.right=`${ot+8}px`,z.style.display="flex",z.style.flexDirection="row",z.style.alignItems="center",z.style.gap=`${$t}px`,z.style.background="transparent",z.style.border="none",z.style.borderRadius="0",z.style.overflow="visible",z;const e=document.createElement("div");return e.className="volume-delta-divergence-summary",e.style.position="absolute",e.style.top="8px",e.style.transform="none",e.style.right=`${ot+8}px`,e.style.zIndex="34",e.style.display="flex",e.style.flexDirection="row",e.style.alignItems="center",e.style.gap=`${$t}px`,e.style.background="transparent",e.style.border="none",e.style.borderRadius="0",e.style.overflow="visible",e.style.pointerEvents="auto",t.appendChild(e),z=e,e}function wi(){z&&(z.style.display="none",z.innerHTML="")}function zr(t,e,n){if(!E.divergenceTable){wi();return}const r=ru(t);r.innerHTML="",r.style.display="flex",r.style.flexDirection="row",r.style.alignItems="center";const i=String(L||"").trim().toUpperCase(),o=E.sourceInterval,s=`${i}|${o}|${Date.now()}`;r.dataset.requestToken=s;let a=!1,l=null;const u=(f,p,h)=>{const m=document.createElement("div");return m.textContent=f,m.title=h,m.style.display="inline-flex",m.style.alignItems="center",m.style.justifyContent="center",m.style.width=`${ge}px`,m.style.height=`${ge}px`,m.style.padding="0",m.style.borderRadius="4px",m.style.border=`1px solid ${y().borderColor}`,m.style.background=y().cardBg,m.style.fontSize="12px",m.style.fontWeight="600",m.style.lineHeight="1",m.style.fontFamily="'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",m.style.color=p,m.style.pointerEvents="none",m},c=()=>{a||(a=!0,d(l,!0),zn(i,o,{forceRefresh:!0,noCache:!0}).then(f=>{r.dataset.requestToken===s&&String(L||"").trim().toUpperCase()===i&&(l=f||null,d(l,!1))}).catch(()=>{r.dataset.requestToken===s&&String(L||"").trim().toUpperCase()===i&&d(l,!1)}).finally(()=>{a=!1}))},d=(f,p=!1)=>{if(r.dataset.requestToken!==s||String(L||"").trim().toUpperCase()!==i)return;r.innerHTML="";const h=document.createElement("button");h.type="button",h.className="pane-btn refresh-btn",h.style.position="relative",Mn(h,p),h.addEventListener("click",m=>{m.preventDefault(),m.stopPropagation(),c()}),r.appendChild(h);for(let m=0;m<ke.length;m++){const g=ke[m],b=f?.states?.[String(g)]||"neutral",v=b==="bullish"?"#26a69a":b==="bearish"?"#ef5350":y().textPrimary,x=u(String(g),v,`Last ${g} day${g===1?"":"s"}${f?.tradeDate?` (as of ${f.tradeDate})`:""}`);r.appendChild(x)}};d(null,!1),!(!i||!Array.isArray(e)||e.length<2)&&zn(i,o).then(f=>{if(r.dataset.requestToken!==s)return;l=f||null,d(l,!1),(!f||!Number.isFinite(f.expiresAtMs)||f.expiresAtMs<=Date.now())&&zn(i,o,{forceRefresh:!0,noCache:!0}).then(h=>{r.dataset.requestToken===s&&(l=h||null,d(l,!1))}).catch(()=>{})}).catch(()=>{zn(i,o,{forceRefresh:!0,noCache:!0}).then(f=>{r.dataset.requestToken===s&&(l=f||null,d(l,!1))}).catch(()=>{d(l,!1)})})}function Ks(){return y().textPrimary}const bo="http://www.w3.org/2000/svg",iu=["M21.5 2v6h-6","M21.5 8A10 10 0 0 0 5.6 5.6","M2.5 22v-6h6","M2.5 16A10 10 0 0 0 18.4 18.4"];function ou(){const t=document.createElementNS(bo,"svg");t.setAttribute("width","11"),t.setAttribute("height","11"),t.setAttribute("viewBox","0 0 24 24"),t.setAttribute("fill","none"),t.setAttribute("stroke","currentColor"),t.setAttribute("stroke-width","2.5"),t.setAttribute("stroke-linecap","round"),t.setAttribute("stroke-linejoin","round"),t.style.display="block";for(const e of iu){const n=document.createElementNS(bo,"path");n.setAttribute("d",e),t.appendChild(n)}return t}function Mn(t,e){t.innerHTML="";const n=ou();t.appendChild(n),t.classList.toggle("loading",e),t.style.cursor=e?"wait":"pointer",t.style.pointerEvents=e?"none":"auto"}function su(){return y().textMuted}const au="#ef5350";function Zs(t){if(Ye&&Ye.parentElement===t)return Ye;Ye?.parentElement&&Ye.parentElement.removeChild(Ye);const e=document.createElement("div");return e.className="vdf-toolbar",e.style.position="absolute",e.style.top=`${Vn}px`,e.style.right=`${ot+8}px`,e.style.zIndex="34",e.style.display="flex",e.style.flexDirection="row",e.style.alignItems="center",e.style.gap=`${$t}px`,e.style.pointerEvents="auto",t.appendChild(e),Ye=e,e}function lu(t){const e=Zs(t);if(_&&_.parentElement===e)return _;_&&_.parentElement&&_.parentElement.removeChild(_);const n=document.createElement("button");return n.className="pane-btn label vdf-indicator-btn",n.type="button",n.textContent="VDF",n.style.width="auto",n.style.minWidth=`${ge}px`,n.style.height=`${ge}px`,n.style.padding="0 5px",n.style.color=Ks(),n.style.fontSize="12px",n.style.fontWeight="700",n.style.letterSpacing="0.5px",n.style.lineHeight=`${ge}px`,e.appendChild(n),_=n,n}function cu(t){const e=Zs(t);if(me&&me.parentElement===e)return me;me&&me.parentElement&&me.parentElement.removeChild(me);const n=document.createElement("button");return n.className="pane-btn refresh-btn vdf-refresh-btn",n.type="button",n.style.position="relative",_&&_.parentElement===e?e.insertBefore(n,_):e.appendChild(n),me=n,Ei(!1),n}function Ei(t){me&&(me.removeAttribute("title"),Mn(me,t))}function So(t,e){_&&(_.style.color=t,e!==void 0&&(_.title=e))}function xo(t){if(_){if(t.is_detected){const e=Math.round(t.composite_score*100);_.textContent=String(e),_.style.color=e>=80?"#26a69a":e>=60?"#8bc34a":y().textPrimary;const n=t.proximity?.level||"none";n==="imminent"||n==="high"?_.style.borderColor="#ff9800":n==="elevated"?_.style.borderColor="#ffc107":_.style.borderColor=""}else _.textContent="VDF",_.style.color=su(),_.style.borderColor="";_.removeAttribute("title")}}function uu(t){if(G&&G.parentElement===t)return G;G&&G.parentElement&&G.parentElement.removeChild(G);const e=document.createElement("button");return e.className="pane-btn label bull-flag-indicator-btn",e.type="button",e.textContent="BF",e.style.position="absolute",e.style.top=`${Vn+ge+$t}px`,e.style.right=`${ot+8}px`,e.style.zIndex="34",e.style.width="auto",e.style.minWidth=`${ge}px`,e.style.height=`${ge}px`,e.style.padding="0 5px",e.style.color=y().textMuted,e.style.fontSize="12px",e.style.fontWeight="700",e.style.letterSpacing="0.5px",e.style.lineHeight=`${ge}px`,e.style.pointerEvents="auto",t.appendChild(e),G=e,e}function Co(t){if(!G)return;const e=t.bull_flag_confidence;e!=null&&e>=50?(G.textContent="BF",G.style.color="#4caf50",G.style.borderColor="#4caf50",G.title=`Bull flag (${e}%)`):(G.textContent="BF",G.style.color=y().textMuted,G.style.borderColor="",G.title="")}function du(t){if(F&&F.parentElement===t)return F;F?.parentElement&&F.parentElement.removeChild(F);const e=document.createElement("div");return e.className="vd-zone-overlay",e.style.position="absolute",e.style.top="0",e.style.right="0",e.style.bottom="0",e.style.left="0",e.style.pointerEvents="none",e.style.zIndex="5",t.appendChild(e),F=e,e}function Ln(t){if(!F||(F.innerHTML="",!T||!t))return;const e=F.clientWidth||F.offsetWidth,n=F.clientHeight||F.offsetHeight;if(!Number.isFinite(e)||e<=0)return;const r=new Map;for(const f of S){const p=Ie(f?.time);if(p===null)continue;const h=new Date(p*1e3).toLocaleDateString("en-CA",{timeZone:"America/New_York",year:"numeric",month:"2-digit",day:"2-digit"});r.has(h)||r.set(h,p)}const i=f=>{const p=r.get(f);if(p===void 0)return null;const h=T.timeScale().timeToCoordinate(p);return Number.isFinite(h)?h:null},o=t.allZones&&t.allZones.length>0?t.allZones:t.zones;if(o)for(const f of o){const p=i(f.startDate),h=i(f.endDate);if(p==null||h==null)continue;const m=Math.min(p,h),g=Math.abs(h-p);if(m>e||m+g<0)continue;const b=.04+f.score*.08,v=document.createElement("div");v.style.cssText=`position:absolute;left:${Math.round(m)}px;top:0;width:${Math.max(Math.round(g),2)}px;height:100%;background:rgba(38,166,154,${b.toFixed(3)});border-left:1px solid rgba(38,166,154,0.3);border-right:1px solid rgba(38,166,154,0.3);`;const x=document.createElement("div");x.style.cssText="position:absolute;top:2px;right:2px;font-size:9px;color:rgba(38,166,154,0.8);font-family:monospace;",x.textContent=(f.score*100).toFixed(0),v.appendChild(x),F.appendChild(v)}if(t.distribution)for(const f of t.distribution){const p=i(f.startDate),h=i(f.endDate);if(p==null||h==null)continue;const m=Math.min(p,h),g=Math.abs(h-p);if(m>e||m+g<0)continue;const b=document.createElement("div");b.style.cssText=`position:absolute;left:${Math.round(m)}px;top:0;width:${Math.max(Math.round(g),2)}px;height:100%;background:rgba(239,83,80,0.06);border-left:1px solid rgba(239,83,80,0.3);border-right:1px solid rgba(239,83,80,0.3);`,F.appendChild(b)}const s=5,a=1,l=2,u=o&&o.length>0,c=t.distribution&&t.distribution.length>0;if(n>60&&(u||c)){const f=n-l-s,p=f-a-s,h=p-a-s;if(o)for(const m of o){const g=i(m.startDate),b=i(m.endDate);if(g==null||b==null)continue;const v=Math.min(g,b),x=Math.abs(b-g);if(v>e||v+x<0)continue;const C=(.4+m.score*.5).toFixed(2),$=document.createElement("div");$.style.cssText=`position:absolute;left:${Math.round(v)}px;top:${h}px;width:${Math.max(Math.round(x),2)}px;height:${s}px;background:rgba(38,166,154,${C});border-radius:1px;`,F.appendChild($)}if(t.distribution)for(const m of t.distribution){const g=i(m.startDate),b=i(m.endDate);if(g==null||b==null)continue;const v=Math.min(g,b),x=Math.abs(b-g);if(v>e||v+x<0)continue;const C=document.createElement("div");C.style.cssText=`position:absolute;left:${Math.round(v)}px;top:${p}px;width:${Math.max(Math.round(x),2)}px;height:${s}px;background:rgba(239,83,80,0.65);border-radius:1px;`,F.appendChild(C)}if(o)for(const m of o){const g=m.absorptionPct||0;if(g<5)continue;const b=i(m.startDate),v=i(m.endDate);if(b==null||v==null)continue;const x=Math.min(b,v),C=Math.abs(v-b);if(x>e||x+C<0)continue;const $=Math.min(.3+g/100*.6,.9).toFixed(2),N=document.createElement("div");N.style.cssText=`position:absolute;left:${Math.round(x)}px;top:${f}px;width:${Math.max(Math.round(C),2)}px;height:${s}px;background:rgba(255,167,38,${$});border-radius:1px;`,F.appendChild(N)}}if(o)for(const f of o){const p=i(f.startDate),h=i(f.endDate);if(p!=null&&p>=0&&p<=e){const m=document.createElement("div");m.style.cssText=`position:absolute;left:${Math.round(p)}px;top:0;width:0;height:100%;border-left:1px dashed rgba(38,166,154,0.25);`,F.appendChild(m)}if(h!=null&&h>=0&&h<=e){const m=document.createElement("div");m.style.cssText=`position:absolute;left:${Math.round(h)}px;top:0;width:0;height:100%;border-left:1px dashed rgba(38,166,154,0.25);`,F.appendChild(m)}}if(t.distribution)for(const f of t.distribution){const p=i(f.startDate),h=i(f.endDate);if(p!=null&&p>=0&&p<=e){const m=document.createElement("div");m.style.cssText=`position:absolute;left:${Math.round(p)}px;top:0;width:0;height:100%;border-left:1px dashed rgba(239,83,80,0.2);`,F.appendChild(m)}if(h!=null&&h>=0&&h<=e){const m=document.createElement("div");m.style.cssText=`position:absolute;left:${Math.round(h)}px;top:0;width:0;height:100%;border-left:1px dashed rgba(239,83,80,0.2);`,F.appendChild(m)}}const d=t.proximity;if(d&&d.level!=="none"&&d.compositeScore>0){const f=d.level==="imminent"?"244,67,54":d.level==="high"?"255,152,0":"255,193,7",p=d.level==="imminent"?.4:d.level==="high"?.3:.2,h=document.createElement("div");h.style.cssText=`position:absolute;right:0;top:0;width:3px;height:100%;background:rgba(${f},${p});box-shadow:0 0 8px rgba(${f},${(p*1.5).toFixed(2)}),0 0 16px rgba(${f},${p});`,d.level==="imminent"&&(h.className="vdf-prox-pulse"),F.appendChild(h)}}function Ys(){if(!F||!L)return;const t=new Date().toLocaleDateString("en-CA",{timeZone:"America/New_York",year:"numeric",month:"2-digit",day:"2-digit"}),e=Xe.get(`${L}|${t}`);Ln(e||null)}async function Xs(t,e=!1){if(!t||qn===t&&!e)return;const n=new Date().toLocaleDateString("en-CA",{timeZone:"America/New_York",year:"numeric",month:"2-digit",day:"2-digit"}),r=`${t}|${n}`;if(!e&&Xe.has(r)){const i=Xe.get(r);xo(i),Co(i),Ln(i),Sn(i,t);return}qn=t,So(Ks(),"VDF: Loading...");try{const i=new URLSearchParams({ticker:t,mode:"chart"});e&&i.set("force","1");const o=await fetch(`/api/chart/vdf-status?${i}`);if(!o.ok)throw new Error(`HTTP ${o.status}`);const s=await o.json();if(L!==t)return;const a={is_detected:s.is_detected||!1,composite_score:Number(s.composite_score)||0,status:s.status||"",weeks:Number(s.weeks)||0,bull_flag_confidence:s.bull_flag_confidence!=null?Number(s.bull_flag_confidence):null,zones:Array.isArray(s.zones)?s.zones:[],allZones:Array.isArray(s.allZones)?s.allZones:Array.isArray(s.zones)?s.zones:[],distribution:Array.isArray(s.distribution)?s.distribution:[],proximity:s.proximity||{compositeScore:0,level:"none",signals:[]},details:s.details||void 0};if(Xe.set(r,a),Xe.size>El){const l=Xe.keys().next().value;l!==void 0&&Xe.delete(l)}xo(a),Co(a),Ln(a),Sn(a,t)}catch{L===t&&So(au,"VDF: Failed to load")}finally{qn===t&&(qn=null)}}function Qe(){if(!ne)return;if(!Array.isArray(S)||S.length===0){ne.setData([]);return}if(!E.divergentPriceBars){ne.setData(S);return}const t=E.bullishDivergentColor||pe.bullishDivergentColor,e=E.bearishDivergentColor||pe.bearishDivergentColor,r=String(E.neutralDivergentColor||"").trim().toLowerCase()===y().textPrimary?pe.neutralDivergentColor:E.neutralDivergentColor||pe.neutralDivergentColor,i=S.map((o,s)=>{const a=Number(o?.close),l=Number(S[s-1]?.close),u=Number(_n.get(P(o.time))),c=s>0&&Number.isFinite(a)&&Number.isFinite(l),d=Number.isFinite(u);let f=r;if(c&&d){const p=u>0&&a<l,h=u<0&&a>l;p?f=t:h&&(f=e)}return{...o,color:f}});ne.setData(i)}function fu(t){return t.filter(e=>e&&(typeof e.time=="string"||typeof e.time=="number")&&Number.isFinite(Number(e.open))&&Number.isFinite(Number(e.high))&&Number.isFinite(Number(e.low))&&Number.isFinite(Number(e.close)))}function qr(t,e,n,r){if(!T)return;const i=t.getBoundingClientRect(),o=e.getBoundingClientRect(),s=n.getBoundingClientRect(),a=r.getBoundingClientRect(),l=Math.max(1,Math.floor(i.width)),u=Math.max(1,Math.floor(i.height)),c=Math.max(1,Math.floor(o.width)),d=Math.max(1,Math.floor(o.height)),f=Math.max(1,Math.floor(s.width)),p=Math.max(1,Math.floor(s.height)),h=Math.max(1,Math.floor(a.width)),m=Math.max(1,Math.floor(a.height));T.applyOptions({width:l,height:u}),A&&A.applyOptions({width:c,height:d}),D&&(D.getChart().applyOptions({width:f,height:p}),D.refreshTrendlineLabels()),U&&U.applyOptions({width:h,height:m}),Ze()}function mu(t,e,n,r){lt||(lt=new ResizeObserver(()=>{qr(t,e,n,r)}),lt.observe(t),lt.observe(e),lt.observe(n),lt.observe(r))}function hu(t,e,n,r){const i=[t,e,n,r];for(const o of i){const s=En[o.id];s&&s>=Ni&&s<=Fi&&(o.style.height=`${s}px`)}}function pu(t,e,n,r){if(lo)return;lo=!0;const i=[t,e,n,r];for(const o of i){const s=document.createElement("div");s.className="pane-resize-handle",o.appendChild(s);let a=0,l=0;const u=d=>{const f=d.clientY-a,p=Math.min(Fi,Math.max(Ni,l+f));o.style.height=`${p}px`},c=d=>{s.classList.remove("active"),s.releasePointerCapture(d.pointerId),s.removeEventListener("pointermove",u),s.removeEventListener("pointerup",c);const f=o.getBoundingClientRect().height;En[o.id]=Math.round(f),R()};s.addEventListener("pointerdown",d=>{d.preventDefault(),d.stopPropagation(),a=d.clientY,l=o.getBoundingClientRect().height,s.classList.add("active"),s.setPointerCapture(d.pointerId),s.addEventListener("pointermove",u),s.addEventListener("pointerup",c)}),s.addEventListener("dblclick",d=>{d.preventDefault(),d.stopPropagation();const f=Wl[o.id];f&&(o.style.height=`${f}px`,delete En[o.id],R())})}}function _e(t){const e=t.querySelector(".chart-loading-overlay");e&&e.remove();const n=document.createElement("div");n.className="chart-loading-overlay",n.style.cssText=`
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: ${y().bgOverlay95};
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    pointer-events: none;
  `;const r=document.createElement("div");r.innerHTML=`
    <svg width="40" height="40" viewBox="0 0 40 40" style="animation: spin 1s linear infinite;">
      <circle cx="20" cy="20" r="16" fill="none" stroke="${y().spinnerColor}" stroke-width="3"
              stroke-dasharray="80" stroke-dashoffset="60" stroke-linecap="round" opacity="0.8"/>
    </svg>
    <style>
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    </style>
  `,n.appendChild(r),t.appendChild(n)}function Jn(t,e){const n=t.querySelector(".chart-loading-overlay");n&&n.remove();const r=document.createElement("div");r.className="chart-loading-overlay",r.style.cssText=`
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: ${y().bgOverlay95};
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    pointer-events: auto;
  `;const i=document.createElement("button");i.type="button",i.textContent="Try Refreshing",i.style.background=y().cardBg,i.style.color=y().textPrimary,i.style.border=`1px solid ${y().borderColor}`,i.style.borderRadius="6px",i.style.padding="8px 12px",i.style.fontSize="12px",i.style.fontWeight="600",i.style.cursor="pointer",i.style.fontFamily="'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",i.addEventListener("click",o=>{o.preventDefault(),e()}),r.appendChild(i),t.appendChild(r)}function Be(t){const e=t.querySelector(".chart-loading-overlay");e&&e.remove()}function gu(t){const e=L;e&&(Kt!==null&&(window.clearTimeout(Kt),Kt=null),Kt=window.setTimeout(()=>{Kt=null,!(!L||L!==e)&&Te(e,t)},kl))}function yu(){return!(document.visibilityState!=="visible"||document.getElementById("view-live")?.classList.contains("hidden")||document.getElementById("ticker-view")?.classList.contains("hidden"))}function vu(t){if(!ne||!D||!ie||!Ge||!Array.isArray(S)||S.length===0)return!1;const e=S.length-1,n=S[e],r=t.latestBar;if(!r||P(n?.time)!==P(r.time))return!1;const i=n.time,o=P(i);S[e]={...n,...r};const s=Number(S[e].close);if(Number.isFinite(s)&&Cn.set(o,s),Dn.set(o,e),e>0){const c=Number(S[e-1]?.close);if(Number.isFinite(c)&&c!==0&&Number.isFinite(s)){const d=(s-c)/c*100;rt.set(o,d)}}const a=Number(t.latestRsi?.value);if(Number.isFinite(a)&&(Ot.set(o,Number(a)),!D.updateLatestPoint({time:i,value:Number(a)},Number.isFinite(s)?{time:i,close:s}:void 0)))return!1;const l=Number(t.latestVolumeDeltaRsi?.value);if(Number.isFinite(l)){const c=Bs(Number(l));it.set(o,c),I.length>0&&P(I[I.length-1].time)===o&&(I[I.length-1]={...I[I.length-1],value:c}),ie.update({time:i,value:c})}const u=Number(t.latestVolumeDelta?.delta);if(Number.isFinite(u)){const c=Number(u);_n.set(o,c),Ge.update({time:i,value:c,color:c>=0?fs:ms})}return E.divergentPriceBars?Qe():ne.update(S[e]),oc(),V&&ce(V,null),nt&&zr(nt,S),Hr(),!0}async function bu(t,e){const n=performance.now();let r=null;const i=await ul(t,e,{vdRsiLength:w.length,vdSourceInterval:E.sourceInterval,vdRsiSourceInterval:w.sourceInterval,onResponseMeta:c=>{r=c.chartCacheHeader}});if(Ds(e,performance.now()-n,r),!L||L!==t||te!==e||!Array.isArray(S)||S.length===0)return;const o=S[S.length-1]?.time,s=i.latestBar;if(o==null||!s){await Te(t,e,{silent:!0});return}const a=P(o),l=P(s.time);if(a!==l){await Te(t,e,{silent:!0});return}vu(i)||await Te(t,e,{silent:!0})}function Do(t,e,n,r,i){const o=fu(t.bars||[]);if(o.length===0)throw new Error("No valid chart bars returned for this ticker/interval");vr=Kl(o),gs(o);const s=ys(o,M.length),a={rsi:vs(t.volumeDeltaRsi?.rsi||[])},l=tc(t.volumeDelta||[]);S=o,Dn=new Map;for(let u=0;u<o.length;u++)Dn.set(P(o[u].time),u);Fc(o),Cn=new Map(o.map(u=>[P(u.time),Number(u.close)])),Ot=new Map(s.filter(u=>Number.isFinite(Number(u.value))).map(u=>[P(u.time),Number(u.value)])),ne&&ne.setData(o),ce(e,null),Qc(o,a),nu(o,l),zr(i,o),Ki(),!D&&r?(D=new Z({container:r,data:s,displayMode:"line",lineColor:M.lineColor,midlineColor:M.midlineColor,midlineStyle:M.midlineStyle,priceData:o.map(u=>({time:u.time,close:u.close})),onTrendLineDrawn:()=>{D?.deactivateDivergenceTool(),ve=!1,oe("rsi",!1),Vr()}}),qr(e,n,r,i),Or()):D&&D.setData(s,o.map(u=>({time:u.time,close:u.close}))),ji(),tu(),Du(),He(),Cu(),Js(),Ze(),L&&Xs(L)}function Su(){ln===null&&(ln=window.setInterval(()=>{if(sr||Le||!L||!yu())return;const t=L,e=te;sr=!0,bu(t,e).catch(()=>{}).finally(()=>{sr=!1})},Ml))}function xu(){return wn}function Ji(){if(or){try{or.abort()}catch{}or=null}}function Qi(){if(Le){try{Le.abort()}catch{}Le=null}Ji(),ln!==null&&(window.clearInterval(ln),ln=null),sr=!1,wn=!1,ir++}async function Te(t,e=te,n={}){const r=n.silent===!0;rc();const i=L,o=te,s=++ir,a=typeof i=="string"&&(i!==t||o!==e),l=e==="1week"&&(typeof i!="string"||a);te=e,L=t;const u=Br(t,e);a&&(Mt=!1,Lt=!1,At=null,Pt=null,be=!1,Se=!1,Ne=!1,ve=!1,It("rsi"),It("volumeDeltaRsi"),Si=!1,Ae=!1,Cl());const c=document.getElementById("chart-content");if(!c||!(c instanceof HTMLElement)){console.error("Chart content container not found");return}dc(c);const d=document.getElementById("price-chart-container"),f=document.getElementById("vd-rsi-chart-container"),p=document.getElementById("rsi-chart-container"),h=document.getElementById("vd-chart-container"),m=document.getElementById("chart-error");if(!d||!f||!p||!h||!m){console.error("Chart containers not found");return}if(V=d,nt=h,m.style.display="none",m.textContent="",yo(d,null),Wn(d,"price"),Wn(f,"volumeDeltaRsi"),Wn(p,"rsi"),Wn(h,"volumeDelta"),du(d),Jo(),Sn(null,L||""),Rc(d,f,p,h),Gi(),!T){const{chart:x,series:C,timelineSeries:$}=Yc(d);T=x,ne=C,yi=$,qi()}if(!A){const{chart:x,rsiSeries:C,timelineSeries:$}=Xc(f);A=x,ie=C,vi=$,Ki()}if(!U){const{chart:x,histogramSeries:C,timelineSeries:$}=Jc(h);U=x,Ge=C,bi=$}hu(d,f,p,h),mu(d,f,p,h),pu(d,f,p,h),qr(d,f,p,h),Or();const g=r?null:Oi(u),b=!!g;if(g){const x=performance.now();Do(g,d,f,p,h),fo(e,performance.now()-x),l&&wo(),mo(t,e)}else r||(_e(d),_e(f),_e(p),_e(h));if(Ji(),Le)try{Le.abort()}catch{}const v=new AbortController;Le=v,r||(wn=!0);try{const x=performance.now();let C=null;const $=await $i(t,e,{vdRsiLength:w.length,vdSourceInterval:E.sourceInterval,vdRsiSourceInterval:w.sourceInterval,signal:v.signal,onResponseMeta:K=>{C=K.chartCacheHeader}});if(Ds(e,performance.now()-x,C),s!==ir)return;if(!b||uo(g)!==uo($)){const K=performance.now();Do($,d,f,p,h),fo(e,performance.now()-K),l&&wo()}Hi(u,$),mo(t,e),r||(Be(d),Be(f),Be(p),Be(h))}catch(x){if(s!==ir||x?.name==="AbortError"||(console.error("Failed to load chart:",x),r)||b)return;if(Bc(x)){Be(d),Be(f),Be(p),Be(h),ne&&ne.setData([]),rt=new Map,ce(d,null),D&&D.setData([],[]),A&&ie?.setData([]),U&&Ge?.setData([]),gs([]),Xi(),I=[],kt=new Map,it=new Map,_n=new Map,wi(),S=[],Dn=new Map,zi(),vr=[],Gn(br),Gn(Sr),Gn(xr),Gn(Cr),Ln(null),Sn(null,""),yo(d,Rl),Tn(),kn(),m.style.display="none",m.textContent="";return}rt=new Map,ce(d,null),wi(),Tn(),kn(),m.style.display="none",m.textContent="";const C=()=>{_e(d),_e(f),_e(p),_e(h),Te(t,e)};Jn(d,C),Jn(f,C),Jn(p,C),Jn(h,C)}finally{r||(wn=!1),Le===v&&(Le=null);const x=document.getElementById("chart-refresh-btn");x&&Mn(x,!1)}}function Js(){if(!T)return;const t=T.timeScale().getVisibleLogicalRange();if(t)try{A&&A.timeScale().setVisibleLogicalRange(t),D&&D.getChart().timeScale().setVisibleLogicalRange(t),U&&U.timeScale().setVisibleLogicalRange(t),Ze()}catch{}}function Cu(){if(!T)return;const t=Bn;T.timeScale().applyOptions({rightOffset:t}),A&&A.timeScale().applyOptions({rightOffset:t}),D&&D.getChart().timeScale().applyOptions({rightOffset:t}),U&&U.timeScale().applyOptions({rightOffset:t}),Ze()}function wo(){if(!T||te!=="1week"||!Array.isArray(S)||S.length===0)return;const t=S.length-1,e=Math.min(S.length,78),n=Math.max(0,t-e+1),r=t+Bn;try{T.timeScale().setVisibleLogicalRange({from:n,to:r}),Js(),Ze()}catch{}}function Qs(t,e){const n=en(t,e);return n?n.value:null}function en(t,e){const n=Number(e.get(P(t)));if(Number.isFinite(n))return{time:t,value:n};if(!Array.isArray(S)||S.length===0)return null;const r=je(t);for(let i=S.length-1;i>=0;i--){const o=S[i];if(!o)continue;const s=o.time;if(r!==null){const l=je(s);if(l!==null&&l>r)continue}const a=Number(e.get(P(s)));if(Number.isFinite(a))return{time:s,value:a}}return null}function ea(){Ae=!Ae;const t={visible:!Ae},e={crosshair:{vertLine:t,horzLine:t}};T&&T.applyOptions(e),A&&A.applyOptions(e),U&&U.applyOptions(e),D&&D.getChart()?.applyOptions(e),Ae&&(T?.clearCrosshairPosition(),A?.clearCrosshairPosition(),U?.clearCrosshairPosition(),D?.getChart()?.clearCrosshairPosition())}function Du(){if(Si||!T||!A||!D||!U||!ne||!ie||!Ge)return;Si=!0;const t=A,e=D.getChart(),n=U;let r=null;const i=c=>{requestAnimationFrame(()=>{r===c&&(r=null)})},o=(c,d)=>{if(!d)return;const f=[{owner:"price",chart:T},{owner:"volumeDeltaRsi",chart:t},{owner:"rsi",chart:e},{owner:"volumeDelta",chart:n}];for(const p of f){if(p.owner===c)continue;const h=p.chart.timeScale().getVisibleLogicalRange();Zc(h,d)||p.chart.timeScale().setVisibleLogicalRange(d)}Ze()};T.timeScale().subscribeVisibleLogicalRangeChange(c=>{if(!(!c||r==="volumeDeltaRsi"||r==="rsi"||r==="volumeDelta")){r="price";try{o("price",c)}finally{i("price")}}}),t.timeScale().subscribeVisibleLogicalRangeChange(c=>{if(!ht&&!(!c||r==="price"||r==="rsi"||r==="volumeDelta")){r="volumeDeltaRsi";try{o("volumeDeltaRsi",c)}finally{i("volumeDeltaRsi")}}}),e.timeScale().subscribeVisibleLogicalRangeChange(c=>{if(!D?.isSyncSuppressed?.()&&!(!c||r==="price"||r==="volumeDeltaRsi"||r==="volumeDelta")){r="rsi";try{o("rsi",c)}finally{i("rsi")}}}),n.timeScale().subscribeVisibleLogicalRangeChange(c=>{if(!(!c||r==="price"||r==="volumeDeltaRsi"||r==="rsi")){r="volumeDelta";try{o("volumeDelta",c)}finally{i("volumeDelta")}}});const s=c=>{const d=en(c,Cn);if(d&&ne)try{T.setCrosshairPosition(d.value,d.time,ne)}catch{T.clearCrosshairPosition()}else T.clearCrosshairPosition()},a=c=>{const d=en(c,it);if(d)try{t.setCrosshairPosition(d.value,d.time,ie)}catch{t.clearCrosshairPosition()}else t.clearCrosshairPosition()},l=c=>{const d=en(c,Ot),f=D?.getSeries();if(d&&f)try{e.setCrosshairPosition(d.value,d.time,f)}catch{e.clearCrosshairPosition()}else e.clearCrosshairPosition()},u=c=>{const d=en(c,_n);if(d)try{n.setCrosshairPosition(d.value,d.time,Ge)}catch{n.clearCrosshairPosition()}else n.clearCrosshairPosition()};if(T.subscribeCrosshairMove(c=>{if(!c||!c.time){t.clearCrosshairPosition(),e.clearCrosshairPosition(),n.clearCrosshairPosition(),V&&ce(V,null);return}Ae||(V&&ce(V,c.time),a(c.time),l(c.time),u(c.time))}),t.subscribeCrosshairMove(c=>{if(!c||!c.time){T.clearCrosshairPosition(),e.clearCrosshairPosition(),n.clearCrosshairPosition(),V&&ce(V,null);return}Ae||(Se&&_s(c.time,!0),V&&ce(V,c.time),s(c.time),l(c.time),u(c.time))}),e.subscribeCrosshairMove(c=>{if(!c||!c.time){T.clearCrosshairPosition(),t.clearCrosshairPosition(),n.clearCrosshairPosition(),V&&ce(V,null);return}Ae||(be&&go(c.time,!0),V&&ce(V,c.time),s(c.time),a(c.time),u(c.time))}),n.subscribeCrosshairMove(c=>{if(!c||!c.time){T.clearCrosshairPosition(),t.clearCrosshairPosition(),e.clearCrosshairPosition(),V&&ce(V,null);return}Ae||(V&&ce(V,c.time),s(c.time),a(c.time),l(c.time))}),e.subscribeClick(c=>{!c||!c.time||be&&go(c.time,!1)}),se){let c=0;const d=()=>{const f=Date.now();f-c<300?(ea(),c=0):c=f};T.subscribeClick(d),t.subscribeClick(d),e.subscribeClick(d),n.subscribeClick(d)}}function wu(){const t=document.getElementById("chart-controls");if(!t)return;Su(),t.querySelectorAll("button[data-interval]").forEach(n=>{n.addEventListener("click",r=>{const i=r.currentTarget,o=i.getAttribute("data-interval");o&&(t.querySelectorAll("button[data-interval]").forEach(s=>s.classList.remove("active")),i.classList.add("active"),L&&gu(o))})}),t.querySelectorAll("button[data-mode]").forEach(n=>{n.addEventListener("click",r=>{const i=r.currentTarget,o=i.getAttribute("data-mode");o&&(t.querySelectorAll("button[data-mode]").forEach(s=>s.classList.remove("active")),i.classList.add("active"),D&&D.setDisplayMode(o))})}),ku();const e=document.getElementById("custom-chart-container");if(e&&se){let n=0;e.addEventListener("touchend",r=>{const i=Date.now();i-n<300?(r.preventDefault(),ea(),n=0):n=i})}}const Eu=`<svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
  <polyline points="5.5 1 1 1 1 5.5"/>
  <polyline points="10.5 1 15 1 15 5.5"/>
  <polyline points="10.5 15 15 15 15 10.5"/>
  <polyline points="5.5 15 1 15 1 10.5"/>
</svg>`,Tu=`<svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
  <polyline points="1 5.5 5.5 5.5 5.5 1"/>
  <polyline points="15 5.5 10.5 5.5 10.5 1"/>
  <polyline points="15 10.5 10.5 10.5 10.5 15"/>
  <polyline points="1 10.5 5.5 10.5 5.5 15"/>
</svg>`;function ku(){const t=document.getElementById("chart-fullscreen-btn"),e=document.getElementById("custom-chart-container"),n=document.getElementById("chart-nav-prev"),r=document.getElementById("chart-nav-next"),i=document.getElementById("chart-refresh-btn");if(!t||!e)return;i&&(Mn(i,!1),i.addEventListener("click",()=>{if(!L||wn)return;const a=Br(L,te);ee.delete(a),Vi(),Mn(i,!0),Te(L,te)})),n&&n.addEventListener("click",()=>ft(-1)),r&&r.addEventListener("click",()=>ft(1)),Mu();const o=()=>{const a=e.classList.contains("chart-fullscreen");t.innerHTML=a?Tu:Eu,t.title="Fullscreen",Or()},s=()=>{e.classList.toggle("chart-fullscreen"),o()};t.addEventListener("click",s),document.addEventListener("keydown",a=>{const l=document.getElementById("ticker-view");!l||l.classList.contains("hidden")||(a.key==="Escape"&&e.classList.contains("chart-fullscreen")&&(e.classList.remove("chart-fullscreen"),o()),a.code==="Space"&&document.activeElement?.tagName!=="INPUT"&&(a.preventDefault(),s()),a.key==="ArrowLeft"?ft(-1):a.key==="ArrowRight"&&ft(1))})}function ft(t){const e=Aa(),n=Pa(),r=document.getElementById("ticker-view")?.dataset.ticker;if(!e||!r)return;let i="";n==="divergence"?i=e==="daily"?"divergence-daily-container":"divergence-weekly-container":i=e==="daily"?"daily-container":"weekly-container";const o=document.getElementById(i);if(!o)return;const s=Array.from(o.querySelectorAll(".alert-card")),a=s.findIndex(u=>u.dataset.ticker===r);if(a===-1)return;const l=a+t;if(l>=0&&l<s.length){const c=s[l].dataset.ticker;c&&window.showTickerView&&window.showTickerView(c,n,e)}}function Mu(){const t=document.getElementById("custom-chart-container");t&&t.addEventListener("dblclick",e=>{const n=t.getBoundingClientRect();if(!(e.clientX-n.left>n.width-60))return;const o=Ht(ae),s=o[2],a=o[3],l=d=>{const f=document.getElementById(d);return!f||f.style.display==="none"?null:f.getBoundingClientRect()},u=l(s);if(u&&e.clientY>=u.top&&e.clientY<=u.bottom){ft(1);return}const c=l(a);if(c&&e.clientY>=c.top&&e.clientY<=c.bottom){ft(-1);return}})}function Eo(t){const e=Aa(),n=Pa(),r=document.getElementById("ticker-view")?.dataset.ticker;if(!e||!r)return null;let i="";n==="divergence"?i=e==="daily"?"divergence-daily-container":"divergence-weekly-container":i=e==="daily"?"daily-container":"weekly-container";const o=document.getElementById(i);if(!o)return null;const s=Array.from(o.querySelectorAll(".alert-card")),a=s.findIndex(u=>u.dataset.ticker===r);if(a===-1)return null;const l=a+t;return l>=0&&l<s.length&&s[l].dataset.ticker||null}async function Lu(t,e){const n=Eo(1),r=Eo(-1),i=async o=>{if(e?.aborted)return;const s=Br(o,t);if(Oi(s)||Je.has(s))return;const a=$i(o,t,{vdRsiLength:w.length,vdSourceInterval:E.sourceInterval,vdRsiSourceInterval:w.sourceInterval,signal:e}).then(l=>Hi(s,l)).catch(()=>{}).finally(()=>Je.delete(s));return Je.set(s,a),a};n&&await i(n),r&&await i(r)}function Au(){const t=y(),e=n=>{n.style.border=`1px solid ${t.borderColor}`,n.style.background=t.cardBg,n.style.color=t.textPrimary};document.querySelectorAll(".trendline-cross-label").forEach(e),document.querySelectorAll(".top-pane-badge").forEach(n=>{n.style.border=`1px solid ${t.borderColor}`,n.style.background=t.cardBg,n.classList.contains("price-pane-change")||(n.style.color=t.textPrimary)}),document.querySelectorAll(".divergence-plot-overlay").forEach(n=>{n.style.border=`1px solid ${t.borderColor}`,n.style.background=t.bgOverlay95}),document.querySelectorAll(".pane-settings-panel").forEach(n=>{n.style.background=t.cardBgOverlay95,n.style.border=`1px solid ${t.borderColor}`,n.style.color=t.textPrimary,n.querySelectorAll('button, select, input[type="number"]').forEach(r=>{r.style.background=t.bgColor,r.style.color=t.textPrimary,r.style.borderColor=t.borderColor})}),document.querySelectorAll(".price-pane-message").forEach(n=>{n.style.color=t.textSecondary}),document.querySelectorAll(".chart-loading-overlay").forEach(n=>{n.style.background=t.bgOverlay95;const r=n.querySelector("button");r&&(r.style.background=t.cardBg,r.style.color=t.textPrimary,r.style.borderColor=t.borderColor)});for(const n of["rsi","volumeDeltaRsi"]){const r=Zi(n);if(r)try{r.options.plugins.tooltip.backgroundColor=t.cardBgOverlay95,r.options.plugins.tooltip.borderColor=t.borderColor,r.options.plugins.tooltip.titleColor=t.textPrimary,r.options.plugins.tooltip.bodyColor=t.textSecondary,r.options.scales.x.ticks.color=t.textSecondary,r.options.scales.x.grid.color=t.borderOverlay22,r.options.scales.y.ticks.color=t.textSecondary,r.options.scales.y.grid.color=t.borderOverlay22,r.update("none")}catch{}}}window.addEventListener("themechange",()=>{const t=y(),e={layout:{background:{color:t.bgColor},textColor:t.textPrimary},rightPriceScale:{borderColor:t.surfaceElevated},timeScale:{borderColor:t.surfaceElevated},grid:{horzLines:{color:t.monthGridlineColor}}};T&&T.applyOptions(e),U&&U.applyOptions(e),A&&A.applyOptions(e),D&&D.applyTheme(),xn&&(w.midlineColor=t.textPrimary,xn.applyOptions({color:t.textPrimary})),Ts(),Ys(),Au(),nt&&Array.isArray(S)&&S.length>=2&&zr(nt,S)});function Pu(t){return typeof t=="boolean"?t:typeof t=="string"?t.toLowerCase()==="true":typeof t=="number"?t===1:!1}function ta(t){const e=t,n=Number(e.id);if(!Number.isFinite(n))throw new Error("Invalid divergence payload: missing/invalid id");return{...e,id:n,is_favorite:Pu(e.is_favorite),source:"DataAPI"}}async function $u(t=""){try{const e=new URLSearchParams(String(t||"").replace(/^\?/,""));e.set("vd_source_interval",Nn());const n=await fetch(`/api/divergence/signals?${e.toString()}`);if(!n.ok)throw new Error("Network response was not ok");const r=await n.json();if(!Array.isArray(r))throw new Error("Invalid divergence payload: expected array");return r.map(ta)}catch(e){throw console.error("Error fetching divergence signals:",e),e}}async function Iu(t){const e=await fetch(`/api/divergence/signals/${t}/favorite`,{method:"POST"});if(!e.ok)throw new Error("Network response was not ok");return ta(await e.json())}async function Ru(){const t=await fetch("/api/divergence/fetch-daily/run",{method:"POST",headers:{"Content-Type":"application/json"}}),e=await t.json().catch(()=>({}));if(!t.ok){if(t.status===409&&String(e?.status||"")==="running")return{status:"running"};const n=typeof e?.error=="string"&&e.error.trim()?e.error.trim():`Failed to start fetch-daily run (HTTP ${t.status})`;throw new Error(n)}return{status:String(e?.status||"started")}}async function Nu(){const t=await fetch("/api/divergence/fetch-daily/stop",{method:"POST",headers:{"Content-Type":"application/json"}}),e=await t.json().catch(()=>({}));if(!t.ok){if(t.status===409&&typeof e?.status=="string")return{status:e.status};const n=typeof e?.error=="string"&&e.error.trim()?e.error.trim():`Failed to stop fetch-daily run (HTTP ${t.status})`;throw new Error(n)}return{status:String(e?.status||"stop-requested")}}async function Fu(){const t=await fetch("/api/divergence/fetch-weekly/run",{method:"POST",headers:{"Content-Type":"application/json"}}),e=await t.json().catch(()=>({}));if(!t.ok){if(t.status===409&&String(e?.status||"")==="running")return{status:"running"};const n=typeof e?.error=="string"&&e.error.trim()?e.error.trim():`Failed to start fetch-weekly run (HTTP ${t.status})`;throw new Error(n)}return{status:String(e?.status||"started")}}async function _u(){const t=await fetch("/api/divergence/fetch-weekly/stop",{method:"POST",headers:{"Content-Type":"application/json"}}),e=await t.json().catch(()=>({}));if(!t.ok){if(t.status===409&&typeof e?.status=="string")return{status:e.status};const n=typeof e?.error=="string"&&e.error.trim()?e.error.trim():`Failed to stop fetch-weekly run (HTTP ${t.status})`;throw new Error(n)}return{status:String(e?.status||"stop-requested")}}async function Bu(){const t=await fetch("/api/divergence/vdf-scan/run",{method:"POST",headers:{"Content-Type":"application/json"}}),e=await t.json().catch(()=>({}));if(!t.ok){if(t.status===409&&String(e?.status||"")==="running")return{status:"running"};const n=typeof e?.error=="string"&&e.error.trim()?e.error.trim():`Failed to start VDF scan (HTTP ${t.status})`;throw new Error(n)}return{status:String(e?.status||"started")}}async function Vu(){const t=await fetch("/api/divergence/vdf-scan/stop",{method:"POST",headers:{"Content-Type":"application/json"}}),e=await t.json().catch(()=>({}));if(!t.ok){if(t.status===409&&typeof e?.status=="string")return{status:e.status};const n=typeof e?.error=="string"&&e.error.trim()?e.error.trim():`Failed to stop VDF scan (HTTP ${t.status})`;throw new Error(n)}return{status:String(e?.status||"stop-requested")}}async function na(){const t=await fetch("/api/divergence/scan/status"),e=await t.json().catch(()=>null);if(!t.ok||!e){const n=typeof e?.error=="string"&&e.error.trim()?e.error.trim():"Failed to fetch divergence scan status";throw new Error(n)}return{running:!!e.running,lastScanDateEt:e.lastScanDateEt??null,scanControl:e.scanControl??null,tableBuild:e.tableBuild??null,fetchDailyData:e.fetchDailyData??null,fetchWeeklyData:e.fetchWeeklyData??null,vdfScan:e.vdfScan??null,latestJob:e.latestJob??null}}const Ou=10,Hu=40,Uu=4,zu=20,qu=.05,Wu=-1.2,ra=8,eo=5,ia=50,Qn=38.2,Gu=50;function ar(t){const e=t.length;if(e<2)return{slope:0,intercept:0,r2:0};let n=0,r=0,i=0,o=0;for(let f=0;f<e;f++)n+=f,r+=t[f],i+=f*f,o+=f*t[f];const s=e*i-n*n;if(s===0)return{slope:0,intercept:0,r2:0};const a=(e*o-n*r)/s,l=(r-a*n)/e,u=r/e;let c=0,d=0;for(let f=0;f<e;f++)c+=(t[f]-u)**2,d+=(t[f]-l-a*f)**2;return{slope:a,intercept:l,r2:c>0?1-d/c:0}}function oa(t){return t<5?t/5*.5:t<=7?.7+(t-5)*.15:t<=15?1:t<=20?1-(t-15)*.1:.3}function sa(t){if(t<=0)return 1;if(t<=Qn)return 1-t/Qn*.15;const e=(t-Qn)/(ia-Qn);return Math.max(0,.85-e*.85)}function ju(t,e,n,r,i,o){const s=ar(t),a=s.slope/e*100;if(a>qu||a<Wu)return null;const l=Math.max(0,s.r2)*20,u=Math.max(0,1-n/ra)*20,d=Math.abs(a- -.3),f=Math.max(0,1-d/1.2)*15,p=sa(r)*20,h=oa(o)*10,m=Math.min(1,(i-eo)/25)*15;return{confidence:Math.round(l+u+f+p+h+m),slopePerBar:Math.round(a*100)/100,r2:Math.round(s.r2*1e3)/1e3}}function Ku(t,e,n,r,i,o,s){if(t.length<4)return null;const a=t.map(Fe=>Fe.high),l=t.map(Fe=>Fe.low),u=ar(a),c=ar(l),d=ar(e),f=u.slope/n*100,p=c.slope/n*100;if(f>=0||p<=-.05)return null;const h=t.length,m=u.intercept-c.intercept,g=u.intercept+u.slope*(h-1)-(c.intercept+c.slope*(h-1));if(m<=0||g<=0)return null;const b=g/m;if(b>.85)return null;const v=d.slope/n*100;if(v>.5||v<-1.5)return null;const x=Math.max(0,1-(b-.15)/.7)*20,$=(Math.max(0,u.r2)+Math.max(0,c.r2))/2*20,N=Math.abs(f),K=Math.abs(p),B=Math.max(N,K,.001),zt=Math.abs(N-K)/B,qt=Math.max(0,1-zt)*5,Wt=sa(i)*20,Gt=oa(s)*10,jt=Math.min(1,(o-eo)/25)*15,Me=Math.max(0,d.r2)*10;return{confidence:Math.round(x+$+qt+Wt+Gt+jt+Me),slopePerBar:Math.round(v*100)/100,r2:Math.round(d.r2*1e3)/1e3}}function Zu(t){if(t.length<Ou)return null;const e=Math.max(0,t.length-Hu),n=t.slice(e),r=n.length;let i=null,o=0;for(let s=Uu;s<=Math.min(zu,r-3);s++){const a=r-s,l=n.slice(a),u=l.map(B=>B.close),c=u.reduce((B,zt)=>B+zt,0)/u.length;if(c<=0)continue;const d=n.slice(0,a);if(d.length<3)continue;const f=Math.min(...d.map(B=>B.low)),p=Math.max(...d.slice(-Math.min(5,d.length)).map(B=>B.high)),h=(p-f)/f*100;if(h<eo)continue;const m=p-f,g=Math.min(...u),b=m>0?(p-g)/m*100:0;if(b>ia)continue;const v=Math.max(...l.map(B=>B.high)),x=Math.min(...l.map(B=>B.low)),C=(v-x)/c*100;if(C>ra)continue;const $=ju(u,c,C,b,h,s),N=Ku(l,u,c,C,b,h,s),K=$&&$.confidence>=(N?.confidence??0)?$:N;K&&K.confidence>o&&(o=K.confidence,i={confidence:K.confidence,flagStartIndex:a+e,flagEndIndex:r-1+e,slopePerBar:K.slopePerBar,r2:K.r2,channelWidthPct:Math.round(C*100)/100,retracePct:Math.round(b*10)/10})}return i&&i.confidence>=Gu?i:null}let Wr="1",Gr="1",aa="",la="",ca="",ua="",Pe="score",$e="score",Ue="desc",ze="desc";const Re=100,Hn='<svg width="10" height="10" viewBox="0 0 10 10" fill="currentColor"><rect width="10" height="10" rx="1"/></svg>';let An=Re,Pn=Re,lr=null,si=!1,er=0;const To=3;let pt=-1,gt=-1,wr=0;const Yu=8e3;let yt=!1,vt=!1,bt=!1,J=!1,Q=!1,un=!1,ai=-1,St=null,cr=null,et=null,dn=null,tn=null,ur=null;const xe=new Map,Xu=400;let li=!1;const Ju='<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#26a69a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="2" x2="4" y2="22"/><path d="M4 2 L20 7 L4 12 Z" fill="#26a69a" fill-opacity="0.35" stroke="#26a69a"/></svg>',qe=new Map;let nn=null;function Qu(){return se&&localStorage.getItem("minichart_mobile")==="on"}function ed(){return nn||(nn=new IntersectionObserver(t=>{for(const e of t){const n=e.target,r=n.dataset.ticker;if(r)if(e.isIntersecting){if(qe.has(r))continue;const i=xe.get(r);i&&i.length>0?Lo(n,r,i):fetch(`/api/chart/mini-bars?ticker=${encodeURIComponent(r)}`).then(o=>o.ok?o.json():null).then(o=>{const s=Array.isArray(o?.bars)?o.bars:[];s.length>0&&(xe.set(r,s),n.isConnected&&!qe.has(r)&&Lo(n,r,s))}).catch(()=>{})}else{const i=qe.get(r);i&&(i.remove(),qe.delete(r),n.innerHTML="")}}},{rootMargin:"300px 0px 300px 0px",threshold:0}),nn)}function td(t){if(xe.size<=t)return;const e=xe.size-t,n=xe.keys();for(let r=0;r<e;r++){const i=n.next().value;i!==void 0&&xe.delete(i)}}async function da(t){if(li||t.length===0)return;const e=t.filter(n=>!xe.has(n.toUpperCase()));if(e.length!==0){li=!0;try{const n=await fetch(`/api/chart/mini-bars/batch?tickers=${encodeURIComponent(e.join(","))}`);if(!n.ok)return;const i=(await n.json())?.results||{};for(const[o,s]of Object.entries(i))Array.isArray(s)&&s.length>0&&xe.set(o.toUpperCase(),s);td(Xu)}catch{}finally{li=!1}}}function Er(t){return t==="daily"?Wr:Gr}function nd(t,e,n){t==="daily"?(aa=e,la=n):(ca=e,ua=n)}function rd(t){return t==="daily"?{from:aa,to:la}:{from:ca,to:ua}}function xt(t,e){const n=new Set;for(const o of t){const s=o.signal_trade_date||(o.timestamp?o.timestamp.slice(0,10):null);s&&n.add(s)}const r=[...n].sort((o,s)=>s.localeCompare(o)),i=new Set(r.slice(0,e));return t.filter(o=>{const s=o.signal_trade_date||(o.timestamp?o.timestamp.slice(0,10):null);return s?i.has(s):!1})}function Ti(t,e){return e==="1"?xt(t,1):e==="2"?xt(t,2):e==="5"?xt(t,5):t}function fa(){return{button:document.getElementById("divergence-run-btn"),status:document.getElementById("divergence-run-status")}}function ma(){return{button:document.getElementById("divergence-run-table-btn"),status:document.getElementById("divergence-table-run-status")}}function ha(){return{button:document.getElementById("divergence-fetch-daily-btn"),status:document.getElementById("divergence-fetch-daily-status")}}function pa(){return{button:document.getElementById("divergence-fetch-weekly-btn"),status:document.getElementById("divergence-fetch-weekly-status")}}function id(){return{pauseResumeButton:document.getElementById("divergence-run-pause-resume-btn"),stopButton:document.getElementById("divergence-run-stop-btn")}}function od(){return{pauseResumeButton:document.getElementById("divergence-table-pause-resume-btn"),stopButton:document.getElementById("divergence-table-stop-btn"),manualUpdateButton:document.getElementById("divergence-manual-update-btn")}}function sd(){return{stopButton:document.getElementById("divergence-fetch-daily-stop-btn")}}function ad(){return{stopButton:document.getElementById("divergence-fetch-weekly-stop-btn")}}function Tr(t,e=!1){const{button:n}=fa();n&&(n.disabled=t||e,n.classList.toggle("active",t),n.textContent=t?"Running":"Run Fetch")}function kr(t){const{status:e}=fa();e&&(e.textContent=t)}function Mr(t,e=!1){const{button:n}=ma();n&&(n.disabled=t||e,n.classList.toggle("active",t),n.textContent=t?"Running":"Run Table")}function Lr(t){const{status:e}=ma();e&&(e.textContent=t)}function Rt(t,e=!1){const{button:n}=ha();n&&(n.disabled=t,n.classList.toggle("active",t),e&&!t?n.textContent="Resume Fetch":n.textContent="Fetch Daily")}function Ce(t){const{status:e}=ha();e&&(e.textContent=t)}function Nt(t,e=!1){const{button:n}=pa();n&&(n.disabled=t,n.classList.toggle("active",t),e&&!t?n.textContent="Resume Fetch":n.textContent="Fetch Weekly")}function De(t){const{status:e}=pa();e&&(e.textContent=t)}function ga(){return{button:document.getElementById("divergence-vdf-scan-btn"),status:document.getElementById("divergence-vdf-scan-status")}}function ld(){return{stopButton:document.getElementById("divergence-vdf-scan-stop-btn")}}function Ft(t){const{button:e}=ga();e&&(e.disabled=t,e.classList.toggle("active",t),e.textContent="Analyze")}function We(t){const{status:e}=ga();e&&(e.textContent=t)}function Ar(t){const{stopButton:e}=ld(),n=t?.vdfScan||null,r=!!n?.running,i=!!n?.stop_requested;e&&(e.innerHTML=Hn,e.disabled=!r||i,e.classList.toggle("active",r),e.setAttribute("aria-label","Stop VDF Scan"))}function Pr(t){const{pauseResumeButton:e,stopButton:n}=id(),r=t?.scanControl||null,i=!!(r?.running||t?.running),o=!!r?.pause_requested,s=!!r?.can_resume,a=!!r?.stop_requested;e&&(e.textContent=s&&!i?"▶":"⏸",e.disabled=i?o:!s,e.classList.toggle("active",i||s),e.setAttribute("aria-label",s&&!i?"Resume Run Fetch":"Pause Run Fetch"),e.title=s&&!i?"Resume Run Fetch":"Pause Run Fetch"),n&&(n.innerHTML=Hn,n.disabled=!i||a,n.classList.toggle("active",i),n.setAttribute("aria-label","Stop Run Fetch"),n.title="Stop Run Fetch")}function $r(t){const{pauseResumeButton:e,stopButton:n,manualUpdateButton:r}=od(),i=t?.tableBuild||null,o=!!i?.running,s=!!i?.pause_requested,a=!!i?.stop_requested,l=!!i?.can_resume;e&&(e.textContent=l&&!o?"▶":"⏸",e.disabled=o?s:!l,e.classList.toggle("active",o||l),e.setAttribute("aria-label",l&&!o?"Resume Run Table":"Pause Run Table"),e.title=l&&!o?"Resume Run Table":"Pause Run Table"),n&&(n.innerHTML=Hn,n.disabled=!o||a,n.classList.toggle("active",o),n.setAttribute("aria-label","Stop Run Table"),n.title="Stop Run Table"),r&&(r.disabled=!1)}function Ir(t){const{stopButton:e}=sd(),n=t?.fetchDailyData||null,r=!!n?.running,i=!!n?.stop_requested;e&&(e.innerHTML=Hn,e.disabled=!r||i,e.classList.toggle("active",r),e.setAttribute("aria-label","Stop Fetch Daily"))}function Rr(t){const{stopButton:e}=ad(),n=t?.fetchWeeklyData||null,r=!!n?.running,i=!!n?.stop_requested;e&&(e.innerHTML=Hn,e.disabled=!r||i,e.classList.toggle("active",r),e.setAttribute("aria-label","Stop Fetch Weekly"))}function re(t){const e=String(t?.message||t||"").trim();return e?/not configured/i.test(e)?"DB issue":/unauthorized/i.test(e)?"Unauthorized":/already running|running/i.test(e)?"Running":e.length>56?`${e.slice(0,56)}...`:e:"Run failed"}function H(t){const e=String(t||"").trim();if(!e)return null;const n=e.match(/^(\d{4})-(\d{2})-(\d{2})/);return n?`${n[1]}-${n[2]}-${n[3]}`:null}function cd(t){const e=String(t||"").trim();if(!e)return null;const n=new Date(e);if(isNaN(n.getTime()))return null;const r=n.toLocaleDateString("en-US",{timeZone:"America/New_York",year:"numeric",month:"2-digit",day:"2-digit"}),[i,o,s]=r.split("/");return!i||!o||!s?null:`${s}-${i.padStart(2,"0")}-${o.padStart(2,"0")}`}function _t(t){const e=t.split("-");if(e.length!==3)return"";const n=Number(e[1]),r=Number(e[2]);return!Number.isFinite(n)||n<=0||!Number.isFinite(r)||r<=0?"":`${n}/${r}`}function ko(t){const e=t.latestJob,n=H(t.lastScanDateEt)||H(e?.scanned_trade_date)||H(e?.run_for_date)||H(e?.finished_at)||H(e?.started_at);if(!n)return"Fetched";const r=_t(n);return r?`Fetched ${r}`:"Fetched"}function ya(t){const e=t.latestJob,n=t.scanControl||null;if(t.running){const r=Number(e?.processed_symbols||0),i=Number(e?.total_symbols||0);return n?.stop_requested?i>0?`Stopping ${r}/${i}`:"Stopping":n?.pause_requested?i>0?`Pausing ${r}/${i}`:"Pausing":i>0?`Running ${r}/${i}`:"Running"}if(e?.status==="paused"){const r=Number(e?.processed_symbols||0),i=Number(e?.total_symbols||0);return i>0?`Paused ${r}/${i}`:"Paused"}return e?.status==="stopped"?"Stopped":e?.status==="completed"?ko(t):e?.status==="failed"?"Last run failed":t.lastScanDateEt||e?.run_for_date||e?.finished_at||e?.started_at?ko(t):"Idle"}function va(t){const e=t.tableBuild;if(!e)return"Table idle";const n=String(e.status||"").toLowerCase(),r=Number(e.error_tickers||0);if(n==="stopped")return"Table stopped";if(n==="paused"){const i=Number(e.processed_tickers||0),o=Number(e.total_tickers||0);return o>0?`Paused ${i}/${o}`:"Table paused"}if(e.running){const i=Number(e.processed_tickers||0),o=Number(e.total_tickers||0);return e.stop_requested?o>0?`Stopping ${i}/${o}`:"Stopping":e.pause_requested?o>0?`Pausing ${i}/${o}`:"Pausing":o>0?`Table ${i}/${o}`:"Table running"}if(n==="completed"){const i=H(e.last_published_trade_date||null),o=i?_t(i):"";return o?`Table ${o}`:"Table fetched"}if(n==="completed-with-errors"){const i=H(e.last_published_trade_date||null),o=i?_t(i):"";return o&&r>0?`Table ${o} (${r} errors)`:r>0?`Table done (${r} errors)`:o?`Table ${o}`:"Table fetched"}return n==="failed"?"Table failed":"Table idle"}function ba(t){const e=t.fetchDailyData,n=t.latestJob,r=H(e?.last_published_trade_date||null)||H(t.lastScanDateEt)||H(n?.scanned_trade_date)||H(n?.run_for_date)||H(n?.finished_at)||H(n?.started_at),i=r?_t(r):"";if(!e)return i?`Fetched ${i}`:"Due for Fetch";const o=String(e.status||"").toLowerCase();if(o==="stopping")return"Stopping";if(o==="stopped")return e.can_resume?"Resumable Stop":"Stopped";if(e.running){const s=Number(e.processed_tickers||0),a=Number(e.total_tickers||0);return e.stop_requested?"Stopping":o==="running-retry"?"Retrying":o==="running-ma"?`MA ${s} / ${a}`:o==="running-ma-retry"?"MA - Retrying":`${s} / ${a}`}return o==="completed"?i?`Fetched ${i}`:"Due for Fetch":o==="completed-with-errors"?i?`Fetched (E) ${i}`:"Due for Fetch":o==="failed"?i?`Failed ${i}`:"Due for Fetch":i?`Fetched ${i}`:"Due for Fetch"}function Sa(t){const e=t.fetchWeeklyData,n=t.latestJob,r=H(e?.last_published_trade_date||null)||H(t.lastScanDateEt)||H(n?.scanned_trade_date)||H(n?.run_for_date)||H(n?.finished_at)||H(n?.started_at),i=r?_t(r):"";if(!e)return i?`Fetched ${i}`:"Due for Fetch";const o=String(e.status||"").toLowerCase();if(o==="stopping")return"Stopping";if(o==="stopped")return e.can_resume?"Resumable Stop":"Stopped";if(e.running){const s=Number(e.processed_tickers||0),a=Number(e.total_tickers||0);return e.stop_requested?"Stopping":o==="running-retry"?"Retrying":o==="running-ma"?`MA ${s} / ${a}`:o==="running-ma-retry"?"MA - Retrying":`${s} / ${a}`}return o==="completed"?i?`Fetched ${i}`:"Due for Fetch":o==="completed-with-errors"?i?`Fetched (E) ${i}`:"Due for Fetch":o==="failed"?i?`Failed ${i}`:"Due for Fetch":i?`Fetched ${i}`:"Due for Fetch"}function xa(t){const e=t.vdfScan;if(!e)return"Due for Fetch";const n=String(e.status||"").toLowerCase(),r=cd(e.finished_at||e.started_at||null),i=r?_t(r):"";if(n==="stopping")return"Stopping";if(n==="stopped")return e.can_resume?"Resumable Stop":"Stopped";if(e.running){const o=Number(e.processed_tickers||0),s=Number(e.total_tickers||0);return e.stop_requested?"Stopping":n==="running-retry"?"Retrying":`${o} / ${s}`}return n==="completed"?i?`Ran ${i}`:"Due for Fetch":n==="completed-with-errors"?i?`Ran (E) ${i}`:"Due for Fetch":n==="failed"?i?`Failed ${i}`:"Due for Fetch":i?`Ran ${i}`:"Due for Fetch"}function Nr(){lr!==null&&(window.clearInterval(lr),lr=null)}function fn(t=!1,e){if(xu())return;const n=Date.now();!t&&n-wr<Yu||(wr=n,e?Bt(e).then(()=>Ke(e)).catch(()=>{}):Zr().then(Yr).catch(()=>{}))}async function jr(t){if(!si){si=!0;try{const e=await na();er=0,yt=!!e.tableBuild?.running,vt=!!e.fetchDailyData?.running,bt=!!e.fetchWeeklyData?.running,Tr(e.running,!!e.scanControl?.can_resume),kr(ya(e)),Pr(e);const n=yt;Mr(n,!!e.tableBuild?.can_resume),Lr(va(e)),$r(e);const r=vt,i=!!e.fetchDailyData?.can_resume;Rt(r,i),Ce(ba(e)),Ir(e);const o=bt,s=!!e.fetchWeeklyData?.can_resume;Nt(o,s),De(Sa(e)),Rr(e);const a=!!e.vdfScan?.running;if(Ft(a),We(xa(e)),Ar(e),r?(J=!0,Q=!1):o&&(Q=!0,J=!1),r&&J){const l=Number(e.fetchDailyData?.processed_tickers||0),u=l!==pt;pt=l,fn(u,"1d")}else pt=-1;if(o&&Q){const l=Number(e.fetchWeeklyData?.processed_tickers||0),u=l!==gt;gt=l,fn(u,"1w")}else gt=-1;if(a&&un){const l=Number(e.vdfScan?.processed_tickers||0),u=l!==ai;ai=l,u&&fn(!0)}else ai=-1;!r&&!o&&!a&&(wr=0),!e.running&&!n&&!r&&!o&&!a&&(Nr(),t&&(J&&(await Bt("1d"),Ke("1d")),Q&&(await Bt("1w"),Ke("1w")),un&&(await Zr(),Yr())),J=!1,Q=!1,un=!1)}catch(e){er+=1,er<To?console.warn(`Scan status poll failed (${er}/${To}), retrying next cycle`):(console.error("Failed to poll divergence scan status:",e),yt=!1,vt=!1,bt=!1,kr(re(e)),Lr(re(e)),Ce(re(e)),De(re(e)),Nr(),Tr(!1,!1),Pr(null),Mr(!1,!1),$r(null),Rt(!1,!1),Ir(null),Nt(!1,!1),Rr(null),Ft(!1),Ar(null),J=!1,Q=!1)}finally{si=!1}}}function Kr(t){Nr(),lr=window.setInterval(()=>{jr(t)},2500)}async function Ut(){try{const t=await na();yt=!!t.tableBuild?.running,vt=!!t.fetchDailyData?.running,bt=!!t.fetchWeeklyData?.running,Tr(t.running,!!t.scanControl?.can_resume),kr(ya(t)),Pr(t);const e=yt;Mr(e,!!t.tableBuild?.can_resume),Lr(va(t)),$r(t);const n=vt,r=!!t.fetchDailyData?.can_resume;Rt(n,r),Ce(ba(t)),Ir(t);const i=bt,o=!!t.fetchWeeklyData?.can_resume;Nt(i,o),De(Sa(t)),Rr(t);const s=!!t.vdfScan?.running;if(Ft(s),We(xa(t)),Ar(t),n?(J=!0,Q=!1):i&&(Q=!0,J=!1),n&&J){const a=Number(t.fetchDailyData?.processed_tickers||0),l=a!==pt;pt=a,fn(l,"1d")}else pt=-1;if(i&&Q){const a=Number(t.fetchWeeklyData?.processed_tickers||0),l=a!==gt;gt=a,fn(l,"1w")}else gt=-1;!n&&!i&&(wr=0),t.running||e||n||i||s?Kr(!0):(Nr(),J=!1,Q=!1)}catch(t){console.error("Failed to sync divergence scan UI state:",t),yt=!1,vt=!1,bt=!1,Tr(!1,!1),Pr(null),kr(re(t)),Mr(!1,!1),Lr(re(t)),$r(null),Rt(!1,!1),Ce(re(t)),Ir(null),Nt(!1,!1),De(re(t)),Rr(null),Ft(!1),Ar(null),J=!1,Q=!1}}async function ud(){Rt(!0),Ce("Starting"),J=!0,Q=!1;try{const t=await Ru();t.status==="running"?Ce("Already running"):t.status==="resumed"&&Ce("Resuming"),Kr(!0),await jr(!1)}catch(t){console.error("Failed to start fetch-daily run:",t),Rt(!1),Ce(re(t))}}async function dd(){Nt(!0),De("Starting"),Q=!0,J=!1;try{const t=await Fu();t.status==="running"?De("Already running"):t.status==="resumed"&&De("Resuming"),Kr(!0),await jr(!1)}catch(t){console.error("Failed to start fetch-weekly run:",t),Nt(!1),De(re(t))}}async function fd(){try{(await Nu()).status==="stop-requested"&&Ce("Stopping"),J=!1,await Ut()}catch(t){console.error("Failed to stop fetch-daily run:",t),Ce(re(t))}}async function md(){try{(await _u()).status==="stop-requested"&&De("Stopping"),Q=!1,await Ut()}catch(t){console.error("Failed to stop fetch-weekly run:",t),De(re(t))}}async function hd(){Ft(!0),We("Starting"),un=!0,J=!1,Q=!1;try{const t=await Bu();t.status==="running"?We("Already running"):t.status==="resumed"&&We("Resuming"),Kr(!0),await jr(!1)}catch(t){console.error("Failed to start VDF scan:",t),Ft(!1),We(re(t))}}async function pd(){try{(await Vu()).status==="stop-requested"&&We("Stopping"),un=!1,await Ut()}catch(t){console.error("Failed to stop VDF scan:",t),We(re(t))}}async function Zr(t){try{const[e,n]=await Promise.all([Bt("1d"),Bt("1w")]),r=[...e,...n];return _r(r),r}catch(e){return console.error("Error fetching divergence signals:",e),[]}}function ki(t,e,n){if(t>=e)return"";const r=e-t,i=Math.min(r,Re);return`<button class="pane-btn show-more-btn" data-timeframe="${n}">▼ Show ${i} more (${t}/${e})</button>`}function Yr(){const t=mt();_r(t),An=Re,Pn=Re;const e=document.getElementById("divergence-daily-container"),n=document.getElementById("divergence-weekly-container");if(!e||!n)return;let r=t.filter(u=>(u.timeframe||"").trim()==="1d"),i=t.filter(u=>(u.timeframe||"").trim()==="1w");r=Ti(r,Wr),i=Ti(i,Gr),Pe==="favorite"&&(r=r.filter(u=>u.is_favorite)),$e==="favorite"&&(i=i.filter(u=>u.is_favorite)),r.sort(vn(Pe==="favorite"?"time":Pe,Ue)),i.sort(vn($e==="favorite"?"time":$e,ze));const o=r.slice(0,An),s=i.slice(0,Pn);e.innerHTML=o.map(bn).join("")+ki(o.length,r.length,"1d"),n.innerHTML=s.map(bn).join("")+ki(s.length,i.length,"1w"),yn(e),yn(n);const a=[...o.map(u=>u.ticker),...s.map(u=>u.ticker)],l=Array.from(new Set(a.map(u=>u.toUpperCase())));da(l).then(()=>{$n(e),$n(n)}).catch(()=>{})}async function Bt(t){try{const e=t==="1d"?"daily":"weekly",n=Er(e),r=rd(e),{startDate:i,endDate:o}=sl(n,r.from,r.to);if(!i||!o)return[];const s=`?start_date=${i}&end_date=${o}&timeframe=${t}`,a=await $u(s);return _r(a),Ba(t,a),a}catch(e){return console.error(`Error fetching divergence signals for ${t}:`,e),[]}}function Ke(t){const e=mt(),n=t==="1d"?"divergence-daily-container":"divergence-weekly-container",r=document.getElementById(n);if(!r)return;const o=Er(t==="1d"?"daily":"weekly"),s=t==="1d"?Pe:$e,a=t==="1d"?Ue:ze;let l=e.filter(f=>(f.timeframe||"").trim()===t);l=Ti(l,o),s==="favorite"&&(l=l.filter(f=>f.is_favorite)),l.sort(vn(s==="favorite"?"time":s,a));const u=t==="1d"?An:Pn,c=l.slice(0,u);r.innerHTML=c.map(bn).join("")+ki(c.length,l.length,t),yn(r);const d=Array.from(new Set(c.map(f=>f.ticker.toUpperCase())));da(d).then(()=>{$n(r)}).catch(()=>{})}function Ct(){if(et!==null&&(window.clearTimeout(et),et=null),dn){try{dn.abort()}catch{}dn=null}if(cr){try{cr.remove()}catch{}cr=null}St&&(St.remove(),St=null),tn=null,ur=null}async function Mo(t,e,n=!1){if(tn===t&&St)return;Ct(),tn=t;const r=document.createElement("div");r.className="mini-chart-overlay";const i=n||window.innerWidth<768,o=i?Math.floor(window.innerWidth*.5):500,s=i?Math.floor(o*.6):300,a=j();r.style.cssText=`
        position: fixed;
        width: ${o}px;
        height: ${s}px;
        background: ${a.bgColor};
        border: 1px solid ${a.borderColor};
        border-radius: 6px;
        z-index: 1000;
        pointer-events: none;
        overflow: hidden;
        box-shadow: 0 8px 24px ${a.shadowColor};
    `;const l=8;let u,c;i?(u=window.innerWidth-o,c=e.bottom+l,c+s>window.innerHeight&&(c=e.top-s-l)):(u=e.right+l,c=e.top,u+o>window.innerWidth&&(u=e.left-o-l)),u<0&&(u=0),c+s>window.innerHeight&&(c=window.innerHeight-s-l),c<0&&(c=l),r.style.left=`${u}px`,r.style.top=`${c}px`,document.body.appendChild(r),St=r;let d;const f=xe.get(t);if(f)d=f;else{const g=new AbortController;dn=g;try{const b=await fetch(`/api/chart/mini-bars?ticker=${encodeURIComponent(t)}`,{signal:g.signal});if(!b.ok)throw new Error(`HTTP ${b.status}`);const v=await b.json();d=Array.isArray(v?.bars)?v.bars:[],d.length>0&&xe.set(t,d)}catch{tn===t&&Ct();return}dn=null}if(tn!==t||!St)return;if(d.length===0){Ct();return}const p=In(r,{width:o,height:s,layout:{background:{color:a.bgColor},textColor:a.textPrimary,fontFamily:"'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",attributionLogo:!1},grid:{vertLines:{visible:!1},horzLines:{visible:!1}},rightPriceScale:{visible:!1},timeScale:{visible:!1},handleScroll:!1,handleScale:!1,crosshair:{vertLine:{visible:!1},horzLine:{visible:!1}}});cr=p,p.addCandlestickSeries({upColor:"#26a69a",downColor:"#ef5350",borderVisible:!1,wickUpColor:"#26a69a",wickDownColor:"#ef5350",priceLineVisible:!1,lastValueVisible:!1}).setData(d),p.timeScale().fitContent();const m=Zu(d);if(m){const g=document.createElement("div");g.className="mini-chart-bull-flag-icon",g.innerHTML=Ju,g.title=`Bull flag/pennant detected (confidence: ${m.confidence}%)`,r.appendChild(g)}}function gd(t){const e=nn,n=t.querySelectorAll(".inline-minichart");for(const r of n){e&&e.unobserve(r);const i=r.dataset.ticker;if(i){const o=qe.get(i);o&&(o.remove(),qe.delete(i))}r.remove()}}function Lo(t,e,n){requestAnimationFrame(()=>{if(!t.isConnected||qe.has(e))return;const r=t.clientWidth||t.getBoundingClientRect().width||300,i=t.clientHeight||120;if(r<=0)return;const o=j(),s=In(t,{width:r,height:i,layout:{background:{color:o.bgColor},textColor:o.textPrimary,fontFamily:"'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",attributionLogo:!1},grid:{vertLines:{visible:!1},horzLines:{visible:!1}},rightPriceScale:{visible:!1},timeScale:{visible:!1},handleScroll:!1,handleScale:!1,crosshair:{vertLine:{visible:!1},horzLine:{visible:!1}}});s.addCandlestickSeries({upColor:"#26a69a",downColor:"#ef5350",borderVisible:!1,wickUpColor:"#26a69a",wickDownColor:"#ef5350",priceLineVisible:!1,lastValueVisible:!1}).setData(n),s.timeScale().fitContent(),qe.set(e,s)})}function $n(t){if(!Qu()){gd(t);return}const e=ed(),n=t.querySelectorAll(".alert-card");for(const r of n){const i=r.dataset.ticker;if(!i)continue;const o=r.nextElementSibling;if(o&&o.classList.contains("inline-minichart")&&o.dataset.ticker===i)continue;const s=document.createElement("div");s.className="inline-minichart",s.dataset.ticker=i,r.after(s),e.observe(s)}}function ci(t,e){const n=t.querySelector(".check-mark");e?(t.classList.add("filled"),n&&(n.style.visibility="visible",n.style.opacity="1")):(t.classList.remove("filled"),n&&(n.style.visibility="hidden",n.style.opacity="0"))}function Ao(t){const n=t.target.closest(".fav-icon");if(!n)return;t.stopPropagation();const r=n.dataset.id,i="DataAPI";if(!r)return;const o=Number(r),s=document.querySelectorAll(`.fav-icon[data-id="${r}"][data-source="${i}"]`),a=n.classList.contains("filled"),l=!a;s.forEach(d=>ci(d,l));const u=mt(),c=u.findIndex(d=>d.id===o);c!==-1&&(u[c].is_favorite=l,ei(u)),Fa(o,l),Iu(o).then(d=>{no(o);const f=mt(),p=f.findIndex(m=>m.id===d.id);p!==-1&&(f[p].is_favorite=d.is_favorite,ei(f)),document.querySelectorAll(`.fav-icon[data-id="${r}"][data-source="${i}"]`).forEach(m=>ci(m,d.is_favorite))}).catch(d=>{console.error("Favorite toggle failed:",d),no(o);const f=mt(),p=f.findIndex(m=>m.id===o);p!==-1&&(f[p].is_favorite=a,ei(f)),document.querySelectorAll(`.fav-icon[data-id="${r}"][data-source="${i}"]`).forEach(m=>ci(m,a))})}function yd(){const t=document.getElementById("view-divergence");if(!t)return;t.addEventListener("click",Ao);const e=document.getElementById("ticker-view");e&&e.addEventListener("click",Ao),t.addEventListener("click",s=>{const a=s.target;if(a.closest(".fav-icon"))return;if(i){i=!1;return}const l=a.closest(".alert-card");if(l){const u=l.dataset.ticker;if(u&&window.showTickerView){let c=null;l.closest("#divergence-daily-container")?c="daily":l.closest("#divergence-weekly-container")&&(c="weekly"),window.showTickerView(u,"divergence",c)}}}),document.querySelectorAll("#view-divergence .divergence-daily-sort .pane-btn").forEach(s=>{s.addEventListener("click",()=>{const a=s.dataset.sort;vd(a)})}),document.querySelectorAll("#view-divergence .divergence-weekly-sort .pane-btn").forEach(s=>{s.addEventListener("click",()=>{const a=s.dataset.sort;bd(a)})});let n=null,r=!1,i=!1,o=0;t.addEventListener("mouseenter",s=>{if(se||Date.now()-o<1e3)return;const u=s.target.closest(".alert-card");if(!u)return;const c=u.dataset.ticker;c&&ur!==u&&(ur=u,et!==null&&window.clearTimeout(et),et=window.setTimeout(()=>{et=null;const d=u.getBoundingClientRect();Mo(c,d)},1e3))},!0),t.addEventListener("mouseleave",s=>{const a=s,u=a.target.closest(".alert-card");if(!u)return;const c=a.relatedTarget;c&&u.contains(c)||(ur=null,Ct())},!0),t.addEventListener("contextmenu",s=>{s.target.closest(".alert-card")&&s.preventDefault()}),t.addEventListener("selectstart",s=>{s.target.closest(".alert-card")&&s.preventDefault()}),se||(t.addEventListener("touchstart",s=>{const a=s;if(a.touches.length!==1)return;const u=a.target.closest(".alert-card");if(!u)return;const c=u.dataset.ticker;c&&(r=!1,n!==null&&window.clearTimeout(n),n=window.setTimeout(()=>{n=null,r=!0;const d=u.getBoundingClientRect();Mo(c,d,!0)},600))},{passive:!0}),t.addEventListener("touchmove",()=>{n!==null&&(window.clearTimeout(n),n=null)},{passive:!0}),t.addEventListener("touchend",()=>{n!==null&&(window.clearTimeout(n),n=null),o=Date.now(),r&&(Ct(),i=!0),r=!1},{passive:!0}),t.addEventListener("touchcancel",()=>{n!==null&&(window.clearTimeout(n),n=null),o=Date.now(),r&&Ct(),r=!1},{passive:!0})),window.addEventListener("minichartmobilechange",()=>{const s=document.getElementById("divergence-daily-container"),a=document.getElementById("divergence-weekly-container");s&&$n(s),a&&$n(a)}),t.addEventListener("click",s=>{const a=s.target.closest(".show-more-btn");if(!a)return;const l=a.dataset.timeframe;l&&(l==="1d"?(An+=Re,Ke("1d")):(Pn+=Re,Ke("1w")))})}function vd(t){t===Pe&&t!=="favorite"?Ue=Ue==="desc"?"asc":"desc":(Pe=t,Ue="desc"),An=Re,Tt("#view-divergence .divergence-daily-sort",Pe,Ue),Ke("1d")}function bd(t){t===$e&&t!=="favorite"?ze=ze==="desc"?"asc":"desc":($e=t,ze="desc"),Pn=Re,Tt("#view-divergence .divergence-weekly-sort",$e,ze),Ke("1w")}function Sd(){Pe="score",Ue="desc",$e="score",ze="desc",Wr="1",Gr="1",Tt("#view-divergence .divergence-daily-sort",Pe,Ue),Tt("#view-divergence .divergence-weekly-sort",$e,ze)}function Mi(t,e,n=!0){if(t==="daily"?Wr=e:Gr=e,document.querySelectorAll(`.column-tf-controls[data-column="${t}"]`).forEach(r=>{r.querySelectorAll(".pane-btn[data-tf]").forEach(i=>{const o=i;o.classList.toggle("active",o.dataset.tf===e)})}),n){const r=t==="daily"?"1d":"1w";Bt(r).then(()=>Ke(r))}}let Dt="score",wt="score",rn="desc",on="desc";function Ca(t){t===Dt&&t!=="favorite"?rn=rn==="desc"?"asc":"desc":(Dt=t,rn="desc"),Tt(".ticker-daily-sort",Dt,rn);const e=document.getElementById("ticker-view");if(!e)return;const n=e.dataset.ticker;n&&to(n,{refreshCharts:!1})}function Da(t){t===wt&&t!=="favorite"?on=on==="desc"?"asc":"desc":(wt=t,on="desc"),Tt(".ticker-weekly-sort",wt,on);const e=document.getElementById("ticker-view");if(!e)return;const n=e.dataset.ticker;n&&to(n,{refreshCharts:!1})}function to(t,e={}){const n=e.refreshCharts!==!1,r=[...Na(),...mt()];_r(r);const i=r.filter(c=>c.ticker===t);let o=i.filter(c=>(c.timeframe||"").trim()==="1d"),s=i.filter(c=>(c.timeframe||"").trim()==="1w");const a=(c,d)=>d==="1"?xt(c,1):d==="2"?xt(c,2):d==="5"?xt(c,5):c;o=a(o,Er("daily")),s=a(s,Er("weekly")),Dt==="favorite"&&(o=o.filter(c=>c.is_favorite)),wt==="favorite"&&(s=s.filter(c=>c.is_favorite)),o.sort(vn(Dt==="favorite"?"time":Dt,rn)),s.sort(vn(wt==="favorite"?"time":wt,on));const l=document.getElementById("ticker-daily-container");l&&(l.innerHTML=o.map(bn).join(""),o.length>0&&yn(l));const u=document.getElementById("ticker-weekly-container");u&&(u.innerHTML=s.map(bn).join(""),s.length>0&&yn(u)),n&&Te(t)}let sn=null,wa=5,Li="SVIX";async function xd(t,e){const n=await fetch(`/api/breadth?ticker=${t}&days=${e}`);if(!n.ok)throw new Error("Failed to fetch breadth data");return n.json()}function Po(t){if(t.length===0)return[];const e=t[0];return e===0?t.map(()=>100):t.map(n=>n/e*100)}function Cd(t,e,n){const r=document.getElementById("breadth-chart");if(!r)return;const i=j(),o=ye();sn&&(sn.destroy(),sn=null);const s=n?new Set(t.map(f=>new Date(f.date).toLocaleDateString("en-US",{timeZone:o}))).size:0,a=t.map(f=>{if(n){const h=new Date(f.date);return s>1?h.toLocaleDateString("en-US",{month:"numeric",day:"numeric",timeZone:o}):h.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",timeZone:o})}return new Date(f.date+"T00:00:00").toLocaleDateString("en-US",{month:"short",day:"numeric",timeZone:o})}),l=t.map(f=>f.spy),u=t.map(f=>f.comparison),c=Po(l),d=Po(u);sn=new Chart(r,{type:"line",data:{labels:a,datasets:[{label:"SPY",data:c,borderColor:"#58a6ff",backgroundColor:"transparent",borderWidth:2.5,pointRadius:c.length>15?0:3,pointHoverRadius:5,tension:.3,order:1,fill:!1},{label:e,data:d,borderColor:"#d2a8ff",backgroundColor:"transparent",borderWidth:2.5,pointRadius:d.length>15?0:3,pointHoverRadius:5,tension:.3,order:2,fill:{target:0,above:"rgba(63, 185, 80, 0.18)",below:"rgba(248, 81, 73, 0.18)"}}]},options:{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{labels:{color:i.textPrimary,font:{size:12},usePointStyle:!0,pointStyle:"line"}},tooltip:{backgroundColor:i.cardBgOverlay95,borderColor:i.borderColor,borderWidth:1,titleColor:i.textPrimary,bodyColor:i.textSecondary,padding:12,callbacks:{label:function(f){const p=f.parsed.y.toFixed(2);return`${f.dataset.label}: ${p}`}}},filler:{propagate:!0}},scales:{x:{ticks:{color:i.textSecondary,maxRotation:0,autoSkip:!0,maxTicksLimit:10,font:{size:11}},grid:{color:i.borderOverlay30}},y:{ticks:{color:i.textSecondary,font:{size:11},callback:function(f){return f.toFixed(1)}},grid:{color:i.borderOverlay30}}}}})}async function Xr(){const t=document.getElementById("breadth-error");t&&(t.style.display="none");try{const e=await xd(Li,wa);if(e.points.length===0){t&&(t.textContent="No data available for this timeframe",t.style.display="block");return}Cd(e.points,Li,e.intraday)}catch(e){console.error("Breadth load error:",e),t&&(t.textContent="Failed to load breadth data",t.style.display="block")}}function Dd(t){wa=t,document.querySelectorAll("#breadth-tf-btns .pane-btn").forEach(e=>{e.classList.toggle("active",Number(e.dataset.days)===t)}),Xr()}function wd(t){Li=t,document.querySelectorAll("#breadth-metric-btns .pane-btn").forEach(e=>{e.classList.toggle("active",e.dataset.metric===t)}),Xr()}function Ea(){Xr()}window.addEventListener("themechange",()=>{sn&&Xr()});let mn=null,ui=!1;const dr=8;let he=0,hn=[];function ue(t){return String(t??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function X(t,e=0){const n=Number(t);return Number.isFinite(n)?n.toFixed(Math.max(0,e)):"--"}function Ta(t){const e=String(t||"").trim();return e||"idle"}function Ed(t){const e=String(t||"").trim();if(!e)return"--";const n=new Date(e);return Number.isNaN(n.getTime())?"--":n.toLocaleString()}function di(t,e,n){const r=Ta(e?.status||n?.status||(n?.running?"running":"idle")),i=Number(e?.tickers?.processed??n?.processed_tickers??0),o=Number(e?.tickers?.total??n?.total_tickers??0),s=Number(e?.tickers?.errors??0),a=X(e?.api?.p95LatencyMs,1),l=X(e?.api?.avgLatencyMs,1),u=X(e?.api?.calls,0),c=X(e?.api?.failures,0),d=X(e?.api?.rateLimited,0),f=X(e?.db?.flushCount,0),p=X(e?.db?.summaryRows,0),h=X(e?.db?.signalRows,0),m=X(e?.durationSeconds,1),g=ue(e?.phase||"--"),b=Array.isArray(e?.failedTickers)?e.failedTickers:[],v=Array.isArray(e?.retryRecovered)?e.retryRecovered:[],x=b.length,C=v.length;let $="";if(x>0||C>0){const N=b.map(B=>`<span class="log-failed-ticker">${ue(B)}</span>`).join(""),K=v.map(B=>`<span class="log-recovered-ticker">${ue(B)}</span>`).join("");$=`
          <details class="log-failed-details">
            <summary class="log-failed-summary">
              ${x>0?`${x} failed`:""}${x>0&&C>0?", ":""}${C>0?`${C} recovered via retry`:""}
            </summary>
            <div class="log-failed-body">
              ${x>0?`<div class="log-failed-label">Failed:</div><div class="log-failed-list">${N}</div>`:""}
              ${C>0?`<div class="log-recovered-label">Recovered:</div><div class="log-failed-list">${K}</div>`:""}
            </div>
          </details>
        `}return`
      <article class="log-run-card">
        <div class="log-run-card-title">
          <span>${ue(t)}</span>
          <span class="log-run-card-status">${ue(r)}</span>
        </div>
        <div class="log-run-metrics">
          <span class="log-metric-key">Tickers</span><span class="log-metric-val">${i}/${o||0}</span>
          <span class="log-metric-key">Errors</span><span class="log-metric-val">${s}</span>
          <span class="log-metric-key">API calls</span><span class="log-metric-val">${u}</span>
          <span class="log-metric-key">API fail</span><span class="log-metric-val">${c}</span>
          <span class="log-metric-key">429 count</span><span class="log-metric-val">${d}</span>
          <span class="log-metric-key">API p95 ms</span><span class="log-metric-val">${a}</span>
          <span class="log-metric-key">API avg ms</span><span class="log-metric-val">${l}</span>
          <span class="log-metric-key">DB flushes</span><span class="log-metric-val">${f}</span>
          <span class="log-metric-key">Summary rows</span><span class="log-metric-val">${p}</span>
          <span class="log-metric-key">Signal rows</span><span class="log-metric-val">${h}</span>
          <span class="log-metric-key">Duration s</span><span class="log-metric-val">${m}</span>
          <span class="log-metric-key">Phase</span><span class="log-metric-val">${g}</span>
        </div>
        ${$}
      </article>
    `}function Td(t){const e=t.config||{},n=ue(e.divergenceSourceInterval||"--"),r=X(e.divergenceLookbackDays,0),i=X(e.divergenceConcurrencyConfigured,0),o=X(e.divergenceFlushSize,0),s=X(e.dataApiMaxRequestsPerSecond,0),a=X(e.dataApiRateBucketCapacity,0),l=X(e.dataApiTimeoutMs,0),u=t.schedulerEnabled?"on":"off";return`
      <article class="log-run-card">
        <div class="log-run-card-title">
          <span>Runtime Config</span>
          <span class="log-run-card-status">${ue(u)}</span>
        </div>
        <div class="log-run-metrics">
          <span class="log-metric-key">Source</span><span class="log-metric-val">${n}</span>
          <span class="log-metric-key">Lookback d</span><span class="log-metric-val">${r}</span>
          <span class="log-metric-key">Concurrency</span><span class="log-metric-val">${i}</span>
          <span class="log-metric-key">Flush size</span><span class="log-metric-val">${o}</span>
          <span class="log-metric-key">API max rps</span><span class="log-metric-val">${s}</span>
          <span class="log-metric-key">Bucket cap</span><span class="log-metric-val">${a}</span>
          <span class="log-metric-key">Timeout ms</span><span class="log-metric-val">${l}</span>
        </div>
      </article>
    `}function kd(t){const e=document.getElementById("logs-run-cards");if(!e)return;const n=[di("Fetch Daily",t.runs?.fetchDaily,t.statuses?.fetchDaily),di("Fetch Weekly",t.runs?.fetchWeekly,t.statuses?.fetchWeekly),di("VDF Scan",t.runs?.vdfScan,t.statuses?.vdfScan),Td(t)];e.innerHTML=n.join("")}function Md(t){const e=Number(t?.tickers?.processed||0),n=Number(t?.tickers?.total||0),r=Number(t?.tickers?.errors||0),i=Number(t?.api?.calls||0),o=X(t?.api?.p95LatencyMs,1),s=Array.isArray(t?.failedTickers)?t.failedTickers:[],a=Array.isArray(t?.retryRecovered)?t.retryRecovered:[],l=s.length,u=a.length;let c="";if(l>0||u>0){const d=s.map(p=>`<span class="log-failed-ticker">${ue(p)}</span>`).join(""),f=a.map(p=>`<span class="log-recovered-ticker">${ue(p)}</span>`).join("");c=`
          <details class="log-failed-details">
            <summary class="log-failed-summary">
              ${l>0?`${l} failed`:""}${l>0&&u>0?", ":""}${u>0?`${u} recovered`:""}
            </summary>
            <div class="log-failed-body">
              ${l>0?`<div class="log-failed-label">Failed:</div><div class="log-failed-list">${d}</div>`:""}
              ${u>0?`<div class="log-recovered-label">Recovered:</div><div class="log-failed-list">${f}</div>`:""}
            </div>
          </details>
        `}return`
      <article class="log-history-entry">
        <div class="log-history-header">
          <span>${ue(String(t?.runType||"run"))}</span>
          <span>${ue(Ta(t?.status))}</span>
        </div>
        <div class="log-history-sub">
          ${ue(Ed(t?.startedAt))} |
          tickers ${e}/${n}${r>0?` (${r} err)`:""} |
          api ${i} |
          p95 ${o}ms
        </div>
        ${c}
      </article>
    `}function Ai(){const t=document.getElementById("logs-history-container"),e=document.getElementById("logs-history-pagination");if(!t)return;if(hn.length===0){t.innerHTML='<div class="loading">No run history yet</div>',e&&(e.innerHTML="");return}const n=Math.ceil(hn.length/dr);he>=n&&(he=n-1),he<0&&(he=0);const r=he*dr,i=hn.slice(r,r+dr),o=he===0,s=he>=n-1,a=i.map(Md).join(""),c=n>1?`<button class="pane-btn log-history-prev${o?" disabled":""}"${o?" disabled":""}><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button><button class="pane-btn log-history-next${s?" disabled":""}"${s?" disabled":""}><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg></button>`:"";t.innerHTML=a,e&&(e.innerHTML=c)}function Ld(t){hn=Array.isArray(t.history)?t.history:[],Ai()}async function Ad(){const t=await fetch("/api/logs/run-metrics",{cache:"no-store"});if(!t.ok)throw new Error(`Failed to fetch run metrics (HTTP ${t.status})`);return t.json()}async function Jr(){if(ui)return;ui=!0;const t=document.getElementById("logs-refresh-btn");t?.classList.add("loading");try{const e=await Ad();kd(e),Ld(e)}catch(e){const n=document.getElementById("logs-history-container");n&&!n.children.length&&(n.innerHTML='<div class="loading">Failed to load logs</div>'),console.error("Failed to refresh logs view:",e)}finally{ui=!1,t?.classList.remove("loading")}}function Pd(){mn===null&&(mn=window.setInterval(()=>{Jr().catch(()=>{})},5e3))}function $d(){mn!==null&&(window.clearInterval(mn),mn=null)}function Id(){document.getElementById("logs-refresh-btn")?.addEventListener("click",()=>{Jr().catch(()=>{})}),document.addEventListener("click",e=>{const n=e.target;if(n.closest(".log-history-prev"))he>0&&(he--,Ai());else if(n.closest(".log-history-next")){const r=Math.ceil(hn.length/dr);he<r-1&&(he++,Ai())}})}let pn="divergence",ka=0,Ma="divergence",La=null,$o=!1;const Io=8;window.setTickerDailySort=Ca;window.setTickerWeeklySort=Da;function Aa(){return La}function Pa(){return Ma}window.showTickerView=function(t,e="divergence",n=null){Ma=e,La=n,ka=window.scrollY,pn!=="divergence"&&Qr("divergence"),Ia("divergence");const r=document.getElementById("ticker-view");r&&(Qi(),r.dataset.ticker=t,document.getElementById("dashboard-view")?.classList.add("hidden"),document.getElementById("view-divergence")?.classList.add("hidden"),r.classList.remove("hidden"),to(t),window.scrollTo(0,0))};window.showOverview=function(){Qi();const t=document.getElementById("ticker-view");t&&delete t.dataset.ticker,Qr("divergence"),window.scrollTo(0,ka)};function Qr(t){pn=t,Ia(t),document.getElementById("view-logs")?.classList.add("hidden"),document.getElementById("view-divergence")?.classList.add("hidden"),document.getElementById("view-breadth")?.classList.add("hidden"),document.getElementById("ticker-view")?.classList.add("hidden"),Qi(),$d(),$a(),t==="logs"?(document.getElementById("view-logs")?.classList.remove("hidden"),Jr().catch(()=>{}),Pd()):t==="divergence"?(document.getElementById("view-divergence")?.classList.remove("hidden"),Zr().then(Yr),Ut()):t==="breadth"&&(document.getElementById("view-breadth")?.classList.remove("hidden"),Ea())}function $a(){document.getElementById("header-nav-dropdown")?.classList.add("hidden"),document.getElementById("header-nav-dropdown")?.classList.remove("open")}function Ia(t){document.querySelectorAll(".header-nav-item").forEach(e=>e.classList.remove("active")),document.querySelector(`.header-nav-item[data-view="${t}"]`)?.classList.add("active")}function Rd(){const t=document.getElementById("search-toggle"),e=document.getElementById("search-input"),n=document.getElementById("search-container");!t||!e||!n||(t.addEventListener("click",r=>{r.stopPropagation(),e.classList.contains("active")?(e.classList.remove("active"),e.blur()):(e.classList.add("active"),e.focus())}),n.addEventListener("click",()=>{e.classList.contains("active")||(e.classList.add("active"),e.focus())}),e.addEventListener("keydown",r=>{if(r.key==="Enter"){const i=e.value.trim().toUpperCase();i&&(window.showTickerView(i),e.value="",e.blur(),e.classList.remove("active"))}}),document.addEventListener("keydown",r=>{document.activeElement instanceof HTMLInputElement||document.activeElement instanceof HTMLTextAreaElement||document.activeElement.isContentEditable||r.ctrlKey||r.altKey||r.metaKey||r.key.length>1||/^[a-zA-Z0-9]$/.test(r.key)&&(e.classList.contains("active")||e.classList.add("active"),e.focus())}))}async function Nd(){if(pn==="divergence"){await Zr(),Yr();return}if(pn==="breadth"){Ea();return}pn==="logs"&&await Jr()}function Fd(){const t=document.getElementById("global-settings-container"),e=document.getElementById("global-settings-toggle"),n=document.getElementById("global-settings-panel");let r=document.getElementById("global-timezone-select");if(!t||!e||!n)return;const i=()=>{n.querySelectorAll(".global-settings-toggle-row").forEach(g=>g.remove());const h=n.querySelector("#global-enable-v3-fetch, #enable-v3-fetch");h&&(h.closest(".global-settings-row")||h).remove(),n.querySelectorAll("label, span, div").forEach(g=>{String(g.textContent||"").trim().toLowerCase()==="enable v3 fetch"&&(g.closest(".global-settings-row")||g).remove()})},o=()=>{if(r)return r;const h=document.createElement("div");h.className="global-settings-row global-settings-timezone-row";const m=document.createElement("label");m.className="global-settings-label",m.htmlFor="global-timezone-select",m.textContent="Timezone";const g=document.createElement("select");return g.id="global-timezone-select",g.className="glass-input global-settings-select",g.setAttribute("aria-label","Timezone"),h.append(m,g),n.append(h),r=g,g};i(),r=o();const s=r,a=()=>{n.classList.add("hidden"),e.classList.remove("active")},l=()=>{n.classList.remove("hidden"),e.classList.add("active"),s.value=ye()},u=qa();s.innerHTML=u.map(h=>`<option value="${h.value}">${h.label}</option>`).join(""),s.value=ye(),s.addEventListener("change",()=>{Wa(s.value)}),Ga(h=>{s.value=h,Nd().catch(m=>{console.error("Failed to refresh UI after timezone change:",m)})}),e.addEventListener("click",h=>{h.stopPropagation(),n.classList.contains("hidden")?(l(),Ut().catch(()=>{})):a()}),n.addEventListener("click",h=>{h.stopPropagation()}),document.addEventListener("click",h=>{const m=h.target;m&&(m.closest("#global-settings-container")||a())});const c=n.querySelectorAll(".theme-swatch-btn"),d=dl();c.forEach(h=>{h.classList.toggle("active",h.dataset.theme===d),h.addEventListener("click",()=>{const m=h.dataset.theme;fl(m),c.forEach(g=>g.classList.toggle("active",g.dataset.theme===m))})});const f=n.querySelectorAll("[data-minichart-mobile]"),p=localStorage.getItem("minichart_mobile")||"off";f.forEach(h=>{h.classList.toggle("active",h.dataset.minichartMobile===p),h.addEventListener("click",()=>{const m=h.dataset.minichartMobile||"off";f.forEach(g=>g.classList.toggle("active",g.dataset.minichartMobile===m));try{localStorage.setItem("minichart_mobile",m)}catch{}window.dispatchEvent(new CustomEvent("minichartmobilechange",{detail:{value:m}}))})})}async function _d(){try{return(await fetch("/api/auth/check")).ok}catch{return!1}}async function Bd(t){try{return(await fetch("/api/auth/verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({passcode:t})})).ok}catch{return!1}}async function Vd(t){const e=document.getElementById("site-lock-overlay");if(!e){t();return}e.dataset.doubleTapBound||(e.addEventListener("dblclick",v=>{v.preventDefault()}),e.dataset.doubleTapBound="1");const n=e.querySelector(".site-lock-panel"),r=document.getElementById("site-lock-status"),i=Array.from(e.querySelectorAll(".site-lock-dot")),o=Array.from(e.querySelectorAll("[data-lock-digit]")),s=Array.from(e.querySelectorAll("[data-lock-action]"));if(await _d()){e.classList.add("hidden"),document.body.classList.remove("site-locked"),t();return}document.body.classList.add("site-locked"),e.classList.remove("hidden");let a="",l=!1;const u=()=>{for(let v=0;v<i.length;v++)i[v].classList.toggle("filled",v<a.length)},c=v=>{r&&(r.textContent=v)},d=()=>{a="",u()},f=()=>{e.classList.add("hidden"),document.body.classList.remove("site-locked"),window.removeEventListener("keydown",b,!0),t()},p=()=>{c(""),d(),n&&(n.classList.remove("shake"),n.offsetWidth,n.classList.add("shake")),window.setTimeout(()=>{n&&n.classList.remove("shake")},320)},h=async()=>{if(a.length<Io||l)return;l=!0;const x=await Bd(a);l=!1,x?f():p()},m=v=>{/^[0-9]$/.test(v)&&(a.length>=Io||(a+=v,c(""),u(),h()))},g=()=>{a.length&&(a=a.slice(0,-1),c(""),u())};o.forEach(v=>{v.addEventListener("click",()=>{m(String(v.dataset.lockDigit||""))})}),s.forEach(v=>{v.addEventListener("click",()=>{const x=String(v.dataset.lockAction||"");if(x==="clear"){d(),c("");return}x==="back"&&g()})});const b=v=>{if(e.classList.contains("hidden"))return;const x=v.key;if(/^[0-9]$/.test(x)){v.preventDefault(),m(x);return}if(x==="Backspace"){v.preventDefault(),g();return}x==="Escape"&&(v.preventDefault(),d(),c(""))};window.addEventListener("keydown",b,!0),u()}function Od(){const t=document.getElementById("header-nav-toggle"),e=document.getElementById("header-nav-dropdown");!t||!e||(t.addEventListener("click",n=>{n.stopPropagation(),gn(),e.classList.contains("open")?(e.classList.remove("open"),setTimeout(()=>e.classList.add("hidden"),150)):(e.classList.remove("hidden"),requestAnimationFrame(()=>e.classList.add("open")))}),e.addEventListener("click",n=>{const r=n.target.closest(".header-nav-item");if(!r)return;const i=r.dataset.view;i&&(Qr(i),e.classList.remove("open"),setTimeout(()=>e.classList.add("hidden"),150))}))}function Hd(){document.addEventListener("click",t=>{const e=t.target,n=e.closest(".column-tf-controls .pane-btn[data-tf]");if(n){const i=n.closest(".column-tf-controls");if(!i)return;const o=i.dataset.column,s=n.dataset.tf;if(!o||!s)return;if(s==="custom"){const a=i.querySelector(".column-tf-custom-panel");if(a){const l=!a.classList.contains("hidden");gn(),l||(a.classList.remove("hidden"),requestAnimationFrame(()=>a.classList.add("open")))}Mi(o,s,!1);return}gn(),Mi(o,s);return}const r=e.closest(".column-tf-apply");if(r){const i=r.closest(".column-tf-custom-panel");i&&qd(i);return}e.closest(".column-tf-custom-panel")||e.closest(".column-tf-controls")||gn()}),document.addEventListener("input",Ud),document.addEventListener("keydown",zd)}function Ro(t){if(t.match(/^(\d{4})-(\d{2})-(\d{2})$/))return t;const n=t.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);return n?`${n[3]}-${n[1]}-${n[2]}`:null}function Ud(t){const e=t.target;if(!e||!(e.classList.contains("column-tf-from")||e.classList.contains("column-tf-to")))return;let r=e.value.replace(/\D/g,"");r.length>8&&(r=r.slice(0,8));let i="";if(r.length<=2?i=r:r.length<=4?i=r.slice(0,2)+"/"+r.slice(2):i=r.slice(0,2)+"/"+r.slice(2,4)+"/"+r.slice(4),e.value=i,i.length===10&&e.classList.contains("column-tf-from")){const s=e.closest(".column-tf-custom-panel")?.querySelector(".column-tf-to");s&&!s.value&&s.focus()}}function zd(t){const e=t.target;!e||!(e.classList.contains("column-tf-from")||e.classList.contains("column-tf-to"))||t.key==="Enter"&&(t.preventDefault(),e.closest(".column-tf-custom-panel")?.querySelector(".column-tf-apply")?.click())}function qd(t){const e=t.closest(".column-tf-controls");if(!e)return;const n=e.dataset.column,r=t.querySelector(".column-tf-from"),i=t.querySelector(".column-tf-to"),o=Ro(r?.value||""),s=Ro(i?.value||"");n&&o&&s&&(nd(n,o,s),Mi(n,"custom")),gn()}function gn(){document.querySelectorAll(".column-tf-custom-panel").forEach(t=>{t.classList.remove("open"),t.classList.add("hidden")})}function Wd(){$o||($o=!0,se&&(document.documentElement.style.webkitUserSelect="none",document.documentElement.style.userSelect="none",document.documentElement.style.webkitTouchCallout="none",document.addEventListener("contextmenu",t=>{t.preventDefault()})),document.getElementById("ticker-back-btn")?.addEventListener("click",window.showOverview),document.getElementById("divergence-fetch-daily-btn")?.addEventListener("click",()=>{ud()}),document.getElementById("divergence-fetch-daily-stop-btn")?.addEventListener("click",()=>{fd()}),document.getElementById("divergence-fetch-weekly-btn")?.addEventListener("click",()=>{dd()}),document.getElementById("divergence-fetch-weekly-stop-btn")?.addEventListener("click",()=>{md()}),document.getElementById("divergence-vdf-scan-btn")?.addEventListener("click",()=>{hd()}),document.getElementById("divergence-vdf-scan-stop-btn")?.addEventListener("click",()=>{pd()}),document.querySelectorAll(".ticker-daily-sort .pane-btn").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.sort;Ca(e)})}),document.querySelectorAll(".ticker-weekly-sort .pane-btn").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.sort;Da(e)})}),document.querySelectorAll("#breadth-tf-btns .pane-btn").forEach(t=>{t.addEventListener("click",()=>{const e=Number(t.dataset.days);Dd(e)})}),document.querySelectorAll("#breadth-metric-btns .pane-btn").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.metric;wd(e);const n=document.getElementById("breadth-subtitle");n&&(n.textContent=`SPY vs ${e} — Normalized`)})}),Od(),Hd(),document.addEventListener("click",t=>{const e=t.target;e&&(e.closest("#header-nav-container")||$a())}),Sd(),Ut().catch(()=>{}),Qr("divergence"),Fd(),Rd(),Id(),yd(),Gd(),wu())}document.addEventListener("DOMContentLoaded",()=>{ml(),Vd(()=>{Wd()})});function Gd(){((e,n)=>{e&&e.addEventListener("click",r=>{if(window.innerWidth>768)return;const i=r.target;if(!i)return;const o=i.closest("h2");if(!o||!(o.closest(".column-header")||o.closest(".header-title-group")))return;const a=o.closest(".column");a&&a.closest(n)&&a.classList.toggle("collapsed")})})(document.getElementById("view-divergence"),"#divergence-dashboard-view")}
