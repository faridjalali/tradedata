(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function i(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(r){if(r.ep)return;r.ep=!0;const s=i(r);fetch(r.href,s)}})();function Y(){const e=new Date;e.setHours(0,0,0,0),e.setDate(e.getDate()+4-(e.getDay()||7));const t=new Date(e.getFullYear(),0,1),i=Math.ceil(((e.getTime()-t.getTime())/864e5+1)/7);return`${e.getFullYear()}-W${i.toString().padStart(2,"0")}`}function U(){const e=new Date,t=(e.getMonth()+1).toString().padStart(2,"0");return`${e.getFullYear()}-${t}`}function ue(e){if(!e)return"";const t=new Date(e),i=new Date,n=new Date(t);n.setHours(0,0,0,0);const r=new Date(i);r.setHours(0,0,0,0);const s=r.getTime()-n.getTime(),o=Math.floor(s/(1e3*60*60*24));return o===0?"Today":o===1?"1d ago":`${o}d ago`}function fe(e){if(!e)return"0".padEnd(7);let t;return e>=1e3?t=(e/1e3).toFixed(1)+"K":t=e.toString(),t.padEnd(7)}function he(e,t,i){let n="",r="";if(e==="30"||e==="7"||e==="1"){const s=parseInt(e),o=new Date,c=new Date;c.setDate(o.getDate()-s),r=o.toISOString(),n=c.toISOString()}else if(e==="week"){if(!t)return{startDate:"",endDate:""};const s=t.split("-W"),o=s[0],c=s[1],l=parseInt(o),a=parseInt(c),u=new Date(l,0,4),m=u.getDay()===0?6:u.getDay()-1,h=new Date(u.setDate(u.getDate()-m)),g=new Date(h.setDate(h.getDate()+(a-1)*7));g.setHours(0,0,0,0);const k=new Date(g);k.setDate(g.getDate()+6),k.setHours(23,59,59,999),n=g.toISOString(),r=k.toISOString()}else{if(!i)return{startDate:"",endDate:""};const s=i.split("-"),o=Number(s[0]),c=Number(s[1]),l=new Date(o,c-1,1),a=new Date(o,c,0);a.setHours(23,59,59,999),n=l.toISOString(),r=a.toISOString()}return{startDate:n,endDate:r}}function A(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function $(e){return(t,i)=>e==="time"?(i.timestamp||"").localeCompare(t.timestamp||""):e==="favorite"?t.is_favorite===i.is_favorite?(i.timestamp||"").localeCompare(t.timestamp||""):(i.is_favorite?1:0)-(t.is_favorite?1:0):e==="volume"?(i.signal_volume||0)-(t.signal_volume||0):e==="intensity"?(i.intensity_score||0)-(t.intensity_score||0):e==="combo"?(i.combo_score||0)-(t.combo_score||0):(i.timestamp||"").localeCompare(t.timestamp||"")}function me(e){return typeof e=="boolean"?e:typeof e=="string"?e.toLowerCase()==="true":typeof e=="number"?e===1:!1}function K(e){const t=e,i=Number(t.id);if(!Number.isFinite(i))throw new Error("Invalid alert payload: missing/invalid id");return{...t,id:i,is_favorite:me(t.is_favorite)}}async function Z(e=""){try{const t=await fetch(`/api/alerts${e}`);if(!t.ok)throw new Error("Network response was not ok");const i=await t.json();if(!Array.isArray(i))throw new Error("Invalid alert payload: expected array");return i.map(K)}catch(t){throw console.error("Error fetching alerts:",t),t}}async function ge(e){const t=await fetch(`/api/alerts/${e}/favorite`,{method:"POST"});if(!t.ok)throw new Error("Network response was not ok");return K(await t.json())}let X=[];function R(){return X}function G(e){X=e}function V(e){const t=ue(e.timestamp);let i=!1,n=!1;if(e.signal_direction!==void 0&&e.signal_direction!==null){const N=Number(e.signal_direction);i=N===1,n=N===-1}else i=!!(e.signal_type&&e.signal_type.toLowerCase().includes("bull")),n=!i;const r=i?"bullish-card":n?"bearish-card":"",s=fe(e.signal_volume||0),o=e.intensity_score||0,c=e.combo_score||0,l=i?"#3fb950":"#f85149",a="#0d1117",u=`background: conic-gradient(${l} ${o}%, ${a} 0%);`,m=`background: conic-gradient(${l} ${c}%, ${a} 0%);`,h=e.is_favorite===!0||String(e.is_favorite).toLowerCase()==="true",g=h?"filled":"",k=h?"visible":"hidden",le=h?"1":"0",de=`
        <svg class="fav-icon ${g}" data-id="${e.id}" viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <polyline class="check-mark" points="9 12 11 14 15 10" style="visibility: ${k}; opacity: ${le};"></polyline>
        </svg>
    `;return`
        <div class="alert-card ${r}" data-ticker="${A(e.ticker)}">
            ${de}
            <h3>${A(e.ticker)}</h3>
            
            <div class="metrics-container">
                <div class="metric-item" title="Intensity: ${o}">
                    <div class="score-circle" style="${u}"></div>
                </div>
                <div class="metric-item" title="Combo: ${c}">
                    <div class="score-circle" style="${m}"></div>
                </div>
                <div class="metric-item" title="Signal Volume">
                    <span class="volume-text">${s}</span>
                </div>
            </div>

            <span class="alert-time">${t}</span>
        </div>
    `}let w="1",J="time",Q="time";function ye(e){w=e}function ve(){return w==="30"||w==="7"||w==="1"?!0:w==="week"?document.getElementById("history-week").value===Y():document.getElementById("history-month").value===U()}async function D(e){try{const t=document.getElementById("history-week")?.value||"",i=document.getElementById("history-month")?.value||"",{startDate:n,endDate:r}=he(w,t,i);if(!n||!r)return[];const s=`?start_date=${n}&end_date=${r}`,o=await Z(s);return G(o),o}catch(t){return console.error("Error fetching live alerts:",t),[]}}function y(){const e=R();document.getElementById("ticker-view").classList.add("hidden"),document.getElementById("dashboard-view").classList.remove("hidden"),document.getElementById("reset-filter").classList.add("hidden");const t=document.getElementById("daily-container"),i=document.getElementById("weekly-container"),n=e.filter(s=>(s.timeframe||"").trim()==="1d"),r=e.filter(s=>(s.timeframe||"").trim()==="1w");n.sort($(J)),r.sort($(Q)),t.innerHTML=n.map(V).join(""),i.innerHTML=r.map(V).join("")}function be(){const e=document.getElementById("view-live");e&&e.addEventListener("click",t=>{const i=t.target,n=i.closest(".fav-icon");if(n){t.stopPropagation();const s=n.dataset.id;if(s){const o=document.querySelectorAll(`.fav-icon[data-id="${s}"]`),c=n.classList.contains("filled");o.forEach(l=>{const a=l.querySelector(".check-mark");c?(l.classList.remove("filled"),a&&(a.style.visibility="hidden",a.style.opacity="0")):(l.classList.add("filled"),a&&(a.style.visibility="visible",a.style.opacity="1"))}),ge(Number(s)).then(l=>{const a=R(),u=a.findIndex(m=>m.id===l.id);u!==-1&&(a[u].is_favorite=l.is_favorite,G(a),o.forEach(m=>{const h=m.querySelector(".check-mark");l.is_favorite?(m.classList.add("filled"),h&&(h.style.visibility="visible",h.style.opacity="1")):(m.classList.remove("filled"),h&&(h.style.visibility="hidden",h.style.opacity="0"))}))}).catch(()=>{o.forEach(l=>{const a=l.querySelector(".check-mark");c?(l.classList.add("filled"),a&&(a.style.visibility="visible",a.style.opacity="1")):(l.classList.remove("filled"),a&&(a.style.visibility="hidden",a.style.opacity="0"))})})}return}const r=i.closest(".alert-card");if(r){const s=r.dataset.ticker;s&&window.showTickerView&&window.showTickerView(s)}})}function we(e){J=e;const t=document.querySelector("#dashboard-view .column:first-child .header-sort-controls");t&&t.querySelectorAll(".tf-btn").forEach(i=>{const n=i;n.dataset.sort===e?n.classList.add("active"):n.classList.remove("active")}),y()}function pe(e){Q=e;const t=document.querySelector("#dashboard-view .column:last-child .header-sort-controls");t&&t.querySelectorAll(".tf-btn").forEach(i=>{const n=i;n.dataset.sort===e?n.classList.add("active"):n.classList.remove("active")}),y()}async function ee(){const e=document.querySelector("#leaderboard-controls .tf-btn.active"),t=e?e.dataset.days:"30";try{const i=await Z(`?days=${t}`);ke(i)}catch(i){console.error("Error fetching leaderboard:",i)}}function ke(e){const t={};e.forEach(r=>{t[r.ticker]||(t[r.ticker]={dailyBullSum:0,dailyBullCount:0,dailyBearSum:0,dailyBearCount:0,weeklyBullSum:0,weeklyBullCount:0,weeklyBearSum:0,weeklyBearCount:0});const s=r.combo_score||0,o=r.signal_type&&r.signal_type.toLowerCase().includes("bull");r.timeframe==="1w"?o?(t[r.ticker].weeklyBullSum+=s,t[r.ticker].weeklyBullCount++):(t[r.ticker].weeklyBearSum+=s,t[r.ticker].weeklyBearCount++):o?(t[r.ticker].dailyBullSum+=s,t[r.ticker].dailyBullCount++):(t[r.ticker].dailyBearSum+=s,t[r.ticker].dailyBearCount++)});const i=Object.keys(t),n=(r,s)=>i.filter(o=>t[o][s]>0).map(o=>({ticker:o,avgScore:Math.round(t[o][r]/t[o][s])})).sort((o,c)=>c.avgScore-o.avgScore).slice(0,10);C("lb-daily-bull",n("dailyBullSum","dailyBullCount")),C("lb-daily-bear",n("dailyBearSum","dailyBearCount")),C("lb-weekly-bull",n("weeklyBullSum","weeklyBullCount")),C("lb-weekly-bear",n("weeklyBearSum","weeklyBearCount"))}function C(e,t){const i=document.getElementById(e);if(i){if(t.length===0){i.innerHTML='<tr><td colspan="2" style="text-align:center; color:#8b949e">No signals found</td></tr>';return}i.innerHTML=`
        <tbody>
            ${t.map(n=>`
                <tr class="clickable-row" data-ticker="${A(n.ticker)}">
                    <td>${A(n.ticker)}</td>
                    <td>${n.avgScore}</td>
                </tr>
            `).join("")}
        </tbody>
    `}}function Le(){const e=document.getElementById("view-leaderboard");e&&e.addEventListener("click",t=>{const n=t.target.closest(".clickable-row");n&&n.dataset.ticker&&window.showTickerView&&window.showTickerView(n.dataset.ticker)})}async function Se(e,t){const i=`/api/chart?ticker=${encodeURIComponent(e)}&interval=${t}`,n=await fetch(i);if(!n.ok){const r=await n.json().catch(()=>({error:"Failed to fetch chart data"}));throw new Error(r.error||`HTTP ${n.status}`)}return n.json()}function Ee(e){const t=[];for(let i=0;i<e.length;i+=2)i+1<e.length?t.push({time:e[i].time,open:e[i].open,high:Math.max(e[i].high,e[i+1].high),low:Math.min(e[i].low,e[i+1].low),close:e[i+1].close,volume:e[i].volume+e[i+1].volume}):t.push(e[i]);return t}class Be{chart;series;lineTools;displayMode;data;referenceLines=[];priceData=[];divergenceToolActive=!1;highlightSeries=null;firstPoint=null;divergencePoints=[];trendLineSeries=null;constructor(t){this.displayMode=t.displayMode,this.data=t.data,this.priceData=t.priceData||[],this.chart=LightweightCharts.createChart(t.container,{height:400,layout:{background:{color:"#0d1117"},textColor:"#c9d1d9"},grid:{vertLines:{visible:!1},horzLines:{visible:!1}},timeScale:{timeVisible:!0,secondsVisible:!1,borderColor:"#21262d"},rightPriceScale:{borderColor:"#21262d",scaleMargins:{top:.1,bottom:.1}},crosshair:{mode:1}}),this.addReferenceLine(70,"Overbought","#f85149"),this.addReferenceLine(30,"Oversold","#3fb950"),this.updateSeries(),this.chart.subscribeCrosshairMove(i=>{this.divergenceToolActive&&i&&i.time}),this.chart.subscribeClick(i=>{this.divergenceToolActive&&i&&i.time&&this.detectAndHighlightDivergence(i.time)})}addReferenceLine(t,i,n){const r=this.chart.addLineSeries({color:n,lineWidth:1,lineStyle:2,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1});this.referenceLines=this.referenceLines||[],this.referenceLines.push({line:r,value:t})}updateSeries(){if(this.series&&this.chart.removeSeries(this.series),this.displayMode==="line"?this.series=this.chart.addLineSeries({color:"#58a6ff",lineWidth:2,priceLineVisible:!0,lastValueVisible:!0}):this.series=this.chart.addHistogramSeries({color:"#58a6ff",priceFormat:{type:"price",precision:2,minMove:.01},priceLineVisible:!0,lastValueVisible:!0}),this.displayMode==="line"?this.series.setData(this.data):this.series.setData(this.data.map(t=>({time:t.time,value:t.value,color:"#58a6ff"}))),this.data.length>0&&this.referenceLines.length>0){const t=this.data[0].time,i=this.data[this.data.length-1].time;this.referenceLines.forEach(({line:n,value:r})=>{n.setData([{time:t,value:r},{time:i,value:r}])})}}setDisplayMode(t){this.displayMode!==t&&(this.displayMode=t,this.updateSeries())}setData(t,i){if(this.data=t,i&&(this.priceData=i),this.series&&(this.displayMode==="line"?this.series.setData(t):this.series.setData(t.map(n=>({time:n.time,value:n.value,color:"#58a6ff"})))),t.length>0&&this.referenceLines.length>0){const n=t[0].time,r=t[t.length-1].time;this.referenceLines.forEach(({line:s,value:o})=>{s.setData([{time:n,value:o},{time:r,value:o}])})}}getChart(){return this.chart}getSeries(){return this.series}getLineTools(){return this.lineTools}activateDivergenceTool(){this.divergenceToolActive=!0;const t=this.chart.chartElement();t&&(t.style.cursor="crosshair")}deactivateDivergenceTool(){this.divergenceToolActive=!1;const t=this.chart.chartElement();t&&(t.style.cursor="default"),this.clearHighlights(),this.firstPoint=null,this.divergencePoints=[]}detectAndHighlightDivergence(t){const i=this.data.findIndex(o=>o.time===t);if(i===-1){console.log("Clicked point not found in RSI data");return}const n=this.data[i].value,r=this.priceData.find(o=>o.time===t);if(!r){console.log("Corresponding price data not found");return}const s=r.close;if(this.firstPoint){if(!this.divergencePoints.some(c=>c.time===t)){console.log("Second point must be one of the highlighted divergence points");return}console.log(`Drawing trend line from (RSI: ${this.firstPoint.rsi.toFixed(2)}) to (RSI: ${n.toFixed(2)})`),this.drawTrendLine(this.firstPoint.time,this.firstPoint.rsi,t,n),this.clearHighlights(),this.firstPoint=null,this.divergencePoints=[]}else{this.firstPoint={time:t,rsi:n,price:s,index:i},this.divergencePoints=[];for(let o=i+1;o<this.data.length;o++){const c=this.data[o].value,l=this.priceData.find(a=>a.time===this.data[o].time);if(l){const a=l.close;c<n&&a>s&&this.divergencePoints.push(this.data[o])}}console.log(`Found ${this.divergencePoints.length} divergence points from origin (RSI: ${n.toFixed(2)}, Price: ${s.toFixed(2)})`),this.highlightPoints(this.divergencePoints)}}highlightPoints(t){this.clearHighlights(),t.length!==0&&(this.highlightSeries=this.chart.addLineSeries({color:"#ff6b6b",lineWidth:0,pointMarkersVisible:!0,pointMarkersRadius:5}),this.highlightSeries.setData(t))}clearHighlights(){this.highlightSeries&&(this.chart.removeSeries(this.highlightSeries),this.highlightSeries=null)}drawTrendLine(t,i,n,r){const s=this.data.findIndex(a=>a.time===t),o=this.data.findIndex(a=>a.time===n);if(s===-1||o===-1){console.error("Could not find indices for trend line points");return}const c=(r-i)/(o-s),l=[];for(let a=s;a<this.data.length;a++){const u=i+c*(a-s);l.push({time:this.data[a].time,value:u})}this.trendLineSeries&&this.chart.removeSeries(this.trendLineSeries),this.trendLineSeries=this.chart.addLineSeries({color:"#ffa500",lineWidth:2,lineStyle:0,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1}),this.trendLineSeries.setData(l)}clearDivergence(){this.clearHighlights(),this.trendLineSeries&&(this.chart.removeSeries(this.trendLineSeries),this.trendLineSeries=null),this.firstPoint=null,this.divergencePoints=[]}resize(){this.chart&&this.chart.resize(this.chart.options().width,400)}destroy(){this.chart&&this.chart.remove()}}let L=null,P="1day",f=null,_=null,x=null,d=null,T=!1,S=null,E=null,H=null,p=null,v=null;function Ce(e){if(!(L===e&&f&&d)){if(L=e,S=document.getElementById("price-chart-container"),E=document.getElementById("rsi-chart-container"),H=document.getElementById("chart-loading"),p=document.getElementById("chart-error"),v=document.getElementById("chart-content"),!S||!E){console.error("Chart containers not found");return}f||(Ie(),De()),te(e,P)}}function Ie(){!S||!E||f||(f=LightweightCharts.createChart(S,{height:400,layout:{background:{color:"#0d1117"},textColor:"#c9d1d9"},grid:{vertLines:{visible:!1},horzLines:{visible:!1}},timeScale:{visible:!1},rightPriceScale:{borderColor:"#21262d"},crosshair:{mode:1}}),_=f.addCandlestickSeries({upColor:"#3fb950",downColor:"#f85149",borderVisible:!1,wickUpColor:"#3fb950",wickDownColor:"#f85149"}),x=f.addLineSeries({color:"#ffa500",lineWidth:2,priceLineVisible:!1,lastValueVisible:!0,crosshairMarkerVisible:!0,title:"SMA 50"}))}function De(){document.querySelectorAll("#chart-controls .feed-controls-group:first-child .tf-btn").forEach(n=>{n.addEventListener("click",r=>{const o=r.target.dataset.interval;o&&L&&Te(o)})}),document.querySelectorAll("#drawing-tools .tf-btn").forEach(n=>{n.addEventListener("click",r=>{const o=r.target.dataset.tool;o&&$e(o)})}),document.querySelectorAll("#chart-controls .feed-controls-group:last-child .tf-btn").forEach(n=>{n.addEventListener("click",r=>{const o=r.target.dataset.mode;o&&d&&Me(o)})})}function Te(e){if(T||!L||e===P)return;P=e,document.querySelectorAll("#chart-controls .feed-controls-group:first-child .tf-btn").forEach(i=>{i.classList.toggle("active",i.dataset.interval===e)}),te(L,e)}function Me(e){if(!d)return;document.querySelectorAll("#chart-controls .feed-controls-group:last-child .tf-btn").forEach(i=>{i.classList.toggle("active",i.dataset.mode===e)}),d.setDisplayMode(e)}async function te(e,t){if(!T){T=!0,Ve();try{const i=await Se(e,t);let n=i.bars,r=i.rsi;if(t==="2hour"){n=Ee(n);const s=new Set(n.map(o=>o.time));r=i.rsi.filter(o=>s.has(o.time))}_&&_.setData(n),x&&i.sma&&x.setData(i.sma),!d&&E?(d=new Be({container:E,data:r,displayMode:"line",priceData:n.map(s=>({time:s.time,close:s.close}))}),Ae()):d&&d.setData(r,n.map(s=>({time:s.time,close:s.close}))),f&&d&&(f.timeScale().fitContent(),setTimeout(()=>{f.timeScale().scrollToRealTime()},50)),Pe()}catch(i){console.error("Failed to load chart data:",i),_e(i instanceof Error?i.message:"Failed to load chart data")}finally{T=!1}}}function Ae(){if(!f||!d)return;const e=d.getChart();let t=!1,i=!1;f.timeScale().subscribeVisibleLogicalRangeChange(n=>{n&&!i&&(t=!0,e.timeScale().setVisibleLogicalRange(n),t=!1)}),e.timeScale().subscribeVisibleLogicalRangeChange(n=>{n&&!t&&(i=!0,f.timeScale().setVisibleLogicalRange(n),i=!1)}),f.subscribeCrosshairMove(n=>{if(!n||!n.time){e.clearCrosshairPosition();return}e.setCrosshairPosition(n.logical,n.time)}),e.subscribeCrosshairMove(n=>{if(!n||!n.time){f.clearCrosshairPosition();return}f.setCrosshairPosition(n.logical,n.time)})}function $e(e){if(!d){console.warn("RSI chart not available");return}try{if(e==="clear"){d.clearDivergence(),d.deactivateDivergenceTool(),document.querySelectorAll("#drawing-tools .tf-btn").forEach(r=>r.classList.remove("active"));return}const t=document.querySelectorAll("#drawing-tools .tf-btn"),i=Array.from(t).find(n=>n.dataset.tool==="trend");e==="trend"&&(i.classList.contains("active")?(i.classList.remove("active"),d.deactivateDivergenceTool()):(t.forEach(r=>r.classList.remove("active")),i.classList.add("active"),d.activateDivergenceTool()))}catch(t){console.error("Error activating divergence tool:",t)}}function Ve(){p&&(p.style.display="none"),v&&(v.style.opacity="0.8")}function Pe(){v&&(v.style.opacity="1")}function _e(e){p&&(p.textContent=e,p.style.display="block"),H&&(H.style.display="none"),v&&(v.style.opacity="0.5")}window.addEventListener("resize",()=>{f&&f.resize(S?.clientWidth||0,400),d&&d.resize()});let ie="time",ne="time",W=null;function re(e){ie=e,oe(".ticker-daily-sort",e);const t=document.getElementById("ticker-view");if(!t)return;const i=t.dataset.ticker;i&&B(i)}function se(e){ne=e,oe(".ticker-weekly-sort",e);const t=document.getElementById("ticker-view");if(!t)return;const i=t.dataset.ticker;i&&B(i)}function oe(e,t){document.querySelectorAll(`${e} .tf-btn`).forEach(i=>{const n=i;n.classList.toggle("active",n.dataset.sort===t)})}function B(e){const i=R().filter(c=>c.ticker===e),n=i.filter(c=>(c.timeframe||"").trim()==="1d"),r=i.filter(c=>(c.timeframe||"").trim()==="1w");n.sort($(ie)),r.sort($(ne)),z("ticker-daily-avg",n),z("ticker-weekly-avg",r);const s=document.getElementById("ticker-daily-container");s&&(n.length===0?s.innerHTML='<div style="text-align:center; padding:20px; color:var(--text-secondary)">No daily alerts</div>':s.innerHTML=n.map(V).join(""));const o=document.getElementById("ticker-weekly-container");o&&(r.length===0?o.innerHTML='<div style="text-align:center; padding:20px; color:var(--text-secondary)">No weekly alerts</div>':o.innerHTML=r.map(V).join("")),xe(e),Ce(e)}function z(e,t){const i=document.getElementById(e);if(!i)return;if(t.length===0){i.innerHTML="";return}let n=0;t.forEach(u=>{const m=u.combo_score||0,g=(u.signal_type||"").toLowerCase().includes("bull");n+=g?m:-m});const r=Math.round(n/t.length),s=Math.abs(r),a=`background: conic-gradient(${r>=0?"#3fb950":"#f85149"} ${s}%, #0d1117 0%);`;i.innerHTML=`
        <div class="metric-item" title="Average Score: ${r}">
            <div class="score-circle" style="${a}"></div>
        </div>
    `}function xe(e){typeof TradingView>"u"||W!==e&&(W=e,new TradingView.widget({width:"100%",height:600,symbol:e,interval:"D",timezone:"Etc/UTC",theme:"dark",style:"1",locale:"en",toolbar_bg:"#f1f3f6",enable_publishing:!1,allow_symbol_change:!1,container_id:"tradingview_chart",studies:[{id:"MASimple@tv-basicstudies",inputs:{length:50}}]}))}let I=null,ae=5,F="SVIX";async function He(e,t){const i=await fetch(`/api/breadth?ticker=${e}&days=${t}`);if(!i.ok)throw new Error("Failed to fetch breadth data");return i.json()}function j(e){if(e.length===0)return[];const t=e[0];return t===0?e.map(()=>100):e.map(i=>i/t*100)}function Fe(e,t,i){const n=document.getElementById("breadth-chart");if(!n)return;I&&(I.destroy(),I=null);const r=e.map(a=>i?new Date(a.date).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",timeZone:"America/Los_Angeles"}):new Date(a.date+"T00:00:00").toLocaleDateString("en-US",{month:"short",day:"numeric"})),s=e.map(a=>a.spy),o=e.map(a=>a.comparison),c=j(s),l=j(o);I=new Chart(n,{type:"line",data:{labels:r,datasets:[{label:"SPY",data:c,borderColor:"#58a6ff",backgroundColor:"transparent",borderWidth:2.5,pointRadius:c.length>15?0:3,pointHoverRadius:5,tension:.3,order:1,fill:!1},{label:t,data:l,borderColor:"#d2a8ff",backgroundColor:"transparent",borderWidth:2.5,pointRadius:l.length>15?0:3,pointHoverRadius:5,tension:.3,order:2,fill:{target:0,above:"rgba(63, 185, 80, 0.18)",below:"rgba(248, 81, 73, 0.18)"}}]},options:{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{labels:{color:"#c9d1d9",font:{size:12},usePointStyle:!0,pointStyle:"line"}},tooltip:{backgroundColor:"rgba(22, 27, 34, 0.95)",borderColor:"#30363d",borderWidth:1,titleColor:"#c9d1d9",bodyColor:"#8b949e",padding:12,callbacks:{label:function(a){const u=a.parsed.y.toFixed(2);return`${a.dataset.label}: ${u}`}}},filler:{propagate:!0}},scales:{x:{ticks:{color:"#8b949e",maxRotation:0,autoSkip:!0,maxTicksLimit:10,font:{size:11}},grid:{color:"rgba(48, 54, 61, 0.3)"}},y:{ticks:{color:"#8b949e",font:{size:11},callback:function(a){return a.toFixed(1)}},grid:{color:"rgba(48, 54, 61, 0.3)"}}}}})}async function q(){const e=document.getElementById("breadth-error");e&&(e.style.display="none");try{const t=await He(F,ae);if(t.points.length===0){e&&(e.textContent="No data available for this timeframe",e.style.display="block");return}Fe(t.points,F,t.intraday)}catch(t){console.error("Breadth load error:",t),e&&(e.textContent="Failed to load breadth data",e.style.display="block")}}function Re(e){ae=e,document.querySelectorAll("#breadth-tf-btns .tf-btn").forEach(t=>{t.classList.toggle("active",Number(t.dataset.days)===e)}),q()}function qe(e){F=e,document.querySelectorAll("#breadth-metric-btns .tf-btn").forEach(t=>{t.classList.toggle("active",t.dataset.metric===e)}),q()}function Oe(){q()}let O="live",ce=0;window.setDailySort=we;window.setWeeklySort=pe;window.setTickerDailySort=re;window.setTickerWeeklySort=se;window.showTickerView=function(e){O!=="live"&&M("live"),ce=window.scrollY;const t=document.getElementById("ticker-view");t&&(t.dataset.ticker=e,document.getElementById("reset-filter")?.classList.remove("hidden"),document.getElementById("dashboard-view")?.classList.add("hidden"),t.classList.remove("hidden"),B(e),window.scrollTo(0,0))};window.showOverview=function(){const e=document.getElementById("ticker-view");e&&delete e.dataset.ticker,y(),window.scrollTo(0,ce)};function M(e){O=e,document.querySelectorAll(".nav-btn").forEach(t=>t.classList.remove("active")),document.getElementById(`nav-${e}`)?.classList.add("active"),document.getElementById("view-live")?.classList.add("hidden"),document.getElementById("view-leaderboard")?.classList.add("hidden"),document.getElementById("view-breadth")?.classList.add("hidden"),document.getElementById("live-controls")?.classList.add("hidden"),document.getElementById("leaderboard-controls")?.classList.add("hidden"),document.getElementById("breadth-controls")?.classList.add("hidden"),e==="live"?(document.getElementById("view-live")?.classList.remove("hidden"),document.getElementById("live-controls")?.classList.remove("hidden")):e==="leaderboard"?(document.getElementById("view-leaderboard")?.classList.remove("hidden"),document.getElementById("leaderboard-controls")?.classList.remove("hidden"),ee()):e==="breadth"&&(document.getElementById("view-breadth")?.classList.remove("hidden"),document.getElementById("breadth-controls")?.classList.remove("hidden"),Oe())}function b(e){ye(e);const t=document.getElementById("btn-30"),i=document.getElementById("btn-7"),n=document.getElementById("btn-1"),r=document.getElementById("btn-week"),s=document.getElementById("btn-month"),o=document.getElementById("history-week"),c=document.getElementById("history-month");[t,i,n,r,s].forEach(l=>l?.classList.remove("active")),o?.classList.add("hidden"),c?.classList.add("hidden"),e==="30"?t?.classList.add("active"):e==="7"?i?.classList.add("active"):e==="1"?n?.classList.add("active"):e==="week"?(r?.classList.add("active"),o?.classList.remove("hidden")):e==="month"&&(s?.classList.add("active"),c?.classList.remove("hidden")),D().then(()=>{const l=document.getElementById("ticker-view"),a=l?.dataset.ticker;a&&!l?.classList.contains("hidden")?B(a):y()})}function Ne(){const e=document.getElementById("search-toggle"),t=document.getElementById("search-input"),i=document.getElementById("search-container");!e||!t||!i||(e.addEventListener("click",n=>{n.stopPropagation(),t.classList.contains("active")?(t.classList.remove("active"),t.blur()):(t.classList.add("active"),t.focus())}),i.addEventListener("click",()=>{t.classList.contains("active")||(t.classList.add("active"),t.focus())}),t.addEventListener("keydown",n=>{if(n.key==="Enter"){const r=t.value.trim().toUpperCase();r&&(window.showTickerView(r),t.value="",t.blur(),t.classList.remove("active"))}}),document.addEventListener("keydown",n=>{document.activeElement instanceof HTMLInputElement||document.activeElement instanceof HTMLTextAreaElement||document.activeElement.isContentEditable||n.ctrlKey||n.altKey||n.metaKey||n.key.length>1||/^[a-zA-Z0-9]$/.test(n.key)&&(t.classList.contains("active")||t.classList.add("active"),t.focus())}))}document.addEventListener("DOMContentLoaded",()=>{document.getElementById("nav-live")?.addEventListener("click",()=>M("live")),document.getElementById("nav-leaderboard")?.addEventListener("click",()=>{M("leaderboard")}),document.getElementById("nav-breadth")?.addEventListener("click",()=>M("breadth")),document.getElementById("reset-filter")?.addEventListener("click",window.showOverview),document.getElementById("btn-30")?.addEventListener("click",()=>b("30")),document.getElementById("btn-7")?.addEventListener("click",()=>b("7")),document.getElementById("btn-1")?.addEventListener("click",()=>b("1")),document.getElementById("btn-week")?.addEventListener("click",()=>b("week")),document.getElementById("btn-month")?.addEventListener("click",()=>b("month"));const e=document.getElementById("history-week"),t=document.getElementById("history-month");document.querySelectorAll(".ticker-daily-sort .tf-btn").forEach(i=>{i.addEventListener("click",()=>{const n=i.dataset.sort;re(n)})}),document.querySelectorAll(".ticker-weekly-sort .tf-btn").forEach(i=>{i.addEventListener("click",()=>{const n=i.dataset.sort;se(n)})}),e&&(e.value=Y()),t&&(t.value=U()),e?.addEventListener("change",()=>D().then(y)),t?.addEventListener("change",()=>D().then(y)),document.querySelectorAll("#leaderboard-controls .tf-btn").forEach(i=>{i.addEventListener("click",n=>{document.querySelectorAll("#leaderboard-controls .tf-btn").forEach(r=>r.classList.remove("active")),n.target.classList.add("active"),ee()})}),document.querySelectorAll("#breadth-tf-btns .tf-btn").forEach(i=>{i.addEventListener("click",()=>{const n=Number(i.dataset.days);Re(n)})}),document.querySelectorAll("#breadth-metric-btns .tf-btn").forEach(i=>{i.addEventListener("click",()=>{const n=i.dataset.metric;qe(n);const r=document.getElementById("breadth-subtitle");r&&(r.textContent=`SPY vs ${n} â€” Normalized`)})}),b("1"),setInterval(()=>{O==="live"&&ve()&&D().then(()=>{const i=document.getElementById("ticker-view"),n=i?.dataset.ticker;n&&!i?.classList.contains("hidden")?B(n):y()})},1e4),Ne(),be(),Le(),We()});function We(){const e=document.getElementById("view-live");e&&e.addEventListener("click",t=>{if(window.innerWidth>768)return;const i=t.target;if(i.tagName!=="H2"||!(i.closest(".column-header")||i.closest(".header-title-group")))return;const r=i.closest(".column");r&&r.classList.toggle("collapsed")})}
