(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function n(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(r){if(r.ep)return;r.ep=!0;const o=n(r);fetch(r.href,o)}})();function H(){const e=new Date;e.setHours(0,0,0,0),e.setDate(e.getDate()+4-(e.getDay()||7));const t=new Date(e.getFullYear(),0,1),n=Math.ceil(((e.getTime()-t.getTime())/864e5+1)/7);return`${e.getFullYear()}-W${n.toString().padStart(2,"0")}`}function x(){const e=new Date,t=(e.getMonth()+1).toString().padStart(2,"0");return`${e.getFullYear()}-${t}`}function J(e){if(!e)return"";const t=new Date(e),n=new Date,i=new Date(t);i.setHours(0,0,0,0);const r=new Date(n);r.setHours(0,0,0,0);const o=r.getTime()-i.getTime(),s=Math.floor(o/(1e3*60*60*24));return s===0?"Today":s===1?"1d ago":`${s}d ago`}function Q(e){if(!e)return"0".padEnd(7);let t;return e>=1e3?t=(e/1e3).toFixed(1)+"K":t=e.toString(),t.padEnd(7)}function ee(e,t,n){let i="",r="";if(e==="30"||e==="7"||e==="1"){const o=parseInt(e),s=new Date,a=new Date;a.setDate(s.getDate()-o),r=s.toISOString(),i=a.toISOString()}else if(e==="week"){if(!t)return{startDate:"",endDate:""};const o=t.split("-W"),s=o[0],a=o[1],l=parseInt(s),c=parseInt(a),d=new Date(l,0,4),m=d.getDay()===0?6:d.getDay()-1,u=new Date(d.setDate(d.getDate()-m)),f=new Date(u.setDate(u.getDate()+(c-1)*7));f.setHours(0,0,0,0);const h=new Date(f);h.setDate(f.getDate()+6),h.setHours(23,59,59,999),i=f.toISOString(),r=h.toISOString()}else{if(!n)return{startDate:"",endDate:""};const o=n.split("-"),s=Number(o[0]),a=Number(o[1]),l=new Date(s,a-1,1),c=new Date(s,a,0);c.setHours(23,59,59,999),i=l.toISOString(),r=c.toISOString()}return{startDate:i,endDate:r}}function L(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function B(e){return(t,n)=>e==="time"?(n.timestamp||"").localeCompare(t.timestamp||""):e==="favorite"?t.is_favorite===n.is_favorite?(n.timestamp||"").localeCompare(t.timestamp||""):(n.is_favorite?1:0)-(t.is_favorite?1:0):e==="volume"?(n.signal_volume||0)-(t.signal_volume||0):e==="intensity"?(n.intensity_score||0)-(t.intensity_score||0):e==="combo"?(n.combo_score||0)-(t.combo_score||0):(n.timestamp||"").localeCompare(t.timestamp||"")}function te(e){return typeof e=="boolean"?e:typeof e=="string"?e.toLowerCase()==="true":typeof e=="number"?e===1:!1}function N(e){const t=e,n=Number(t.id);if(!Number.isFinite(n))throw new Error("Invalid alert payload: missing/invalid id");return{...t,id:n,is_favorite:te(t.is_favorite)}}async function V(e=""){try{const t=await fetch(`/api/alerts${e}`);if(!t.ok)throw new Error("Network response was not ok");const n=await t.json();if(!Array.isArray(n))throw new Error("Invalid alert payload: expected array");return n.map(N)}catch(t){throw console.error("Error fetching alerts:",t),t}}async function ne(e){const t=await fetch(`/api/alerts/${e}/favorite`,{method:"POST"});if(!t.ok)throw new Error("Network response was not ok");return N(await t.json())}let q=[];function C(){return q}function F(e){q=e}function S(e){const t=J(e.timestamp);let n=!1,i=!1;if(e.signal_direction!==void 0&&e.signal_direction!==null){const $=Number(e.signal_direction);n=$===1,i=$===-1}else n=!!(e.signal_type&&e.signal_type.toLowerCase().includes("bull")),i=!n;const r=n?"bullish-card":i?"bearish-card":"",o=Q(e.signal_volume||0),s=e.intensity_score||0,a=e.combo_score||0,l=n?"#3fb950":"#f85149",c="#0d1117",d=`background: conic-gradient(${l} ${s}%, ${c} 0%);`,m=`background: conic-gradient(${l} ${a}%, ${c} 0%);`,u=e.is_favorite===!0||String(e.is_favorite).toLowerCase()==="true",f=u?"filled":"",h=u?"visible":"hidden",X=u?"1":"0",G=`
        <svg class="fav-icon ${f}" data-id="${e.id}" viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <polyline class="check-mark" points="9 12 11 14 15 10" style="visibility: ${h}; opacity: ${X};"></polyline>
        </svg>
    `;return`
        <div class="alert-card ${r}" data-ticker="${L(e.ticker)}">
            ${G}
            <h3>${L(e.ticker)}</h3>
            
            <div class="metrics-container">
                <div class="metric-item" title="Intensity: ${s}">
                    <div class="score-circle" style="${d}"></div>
                </div>
                <div class="metric-item" title="Combo: ${a}">
                    <div class="score-circle" style="${m}"></div>
                </div>
                <div class="metric-item" title="Signal Volume">
                    <span class="volume-text">${o}</span>
                </div>
            </div>

            <span class="alert-time">${t}</span>
        </div>
    `}let v="1",O="time",W="time";function ie(e){v=e}function re(){return v==="30"||v==="7"||v==="1"?!0:v==="week"?document.getElementById("history-week").value===H():document.getElementById("history-month").value===x()}async function p(e){try{const t=document.getElementById("history-week")?.value||"",n=document.getElementById("history-month")?.value||"",{startDate:i,endDate:r}=ee(v,t,n);if(!i||!r)return[];const o=`?start_date=${i}&end_date=${r}`,s=await V(o);return F(s),s}catch(t){return console.error("Error fetching live alerts:",t),[]}}function y(){const e=C();document.getElementById("ticker-view").classList.add("hidden"),document.getElementById("dashboard-view").classList.remove("hidden"),document.getElementById("reset-filter").classList.add("hidden");const t=document.getElementById("daily-container"),n=document.getElementById("weekly-container"),i=e.filter(o=>(o.timeframe||"").trim()==="1d"),r=e.filter(o=>(o.timeframe||"").trim()==="1w");i.sort(B(O)),r.sort(B(W)),t.innerHTML=i.map(S).join(""),n.innerHTML=r.map(S).join("")}function oe(){const e=document.getElementById("view-live");e&&e.addEventListener("click",t=>{const n=t.target,i=n.closest(".fav-icon");if(i){t.stopPropagation();const o=i.dataset.id;if(o){const s=document.querySelectorAll(`.fav-icon[data-id="${o}"]`),a=i.classList.contains("filled");s.forEach(l=>{const c=l.querySelector(".check-mark");a?(l.classList.remove("filled"),c&&(c.style.visibility="hidden",c.style.opacity="0")):(l.classList.add("filled"),c&&(c.style.visibility="visible",c.style.opacity="1"))}),ne(Number(o)).then(l=>{const c=C(),d=c.findIndex(m=>m.id===l.id);d!==-1&&(c[d].is_favorite=l.is_favorite,F(c),s.forEach(m=>{const u=m.querySelector(".check-mark");l.is_favorite?(m.classList.add("filled"),u&&(u.style.visibility="visible",u.style.opacity="1")):(m.classList.remove("filled"),u&&(u.style.visibility="hidden",u.style.opacity="0"))}))}).catch(()=>{s.forEach(l=>{const c=l.querySelector(".check-mark");a?(l.classList.add("filled"),c&&(c.style.visibility="visible",c.style.opacity="1")):(l.classList.remove("filled"),c&&(c.style.visibility="hidden",c.style.opacity="0"))})})}return}const r=n.closest(".alert-card");if(r){const o=r.dataset.ticker;o&&window.showTickerView&&window.showTickerView(o)}})}function se(e){O=e;const t=document.querySelector("#dashboard-view .column:first-child .header-sort-controls");t&&t.querySelectorAll(".tf-btn").forEach(n=>{const i=n;i.dataset.sort===e?i.classList.add("active"):i.classList.remove("active")}),y()}function ce(e){W=e;const t=document.querySelector("#dashboard-view .column:last-child .header-sort-controls");t&&t.querySelectorAll(".tf-btn").forEach(n=>{const i=n;i.dataset.sort===e?i.classList.add("active"):i.classList.remove("active")}),y()}async function P(){const e=document.querySelector("#leaderboard-controls .tf-btn.active"),t=e?e.dataset.days:"30";try{const n=await V(`?days=${t}`);ae(n)}catch(n){console.error("Error fetching leaderboard:",n)}}function ae(e){const t={};e.forEach(r=>{t[r.ticker]||(t[r.ticker]={dailyBullSum:0,dailyBullCount:0,dailyBearSum:0,dailyBearCount:0,weeklyBullSum:0,weeklyBullCount:0,weeklyBearSum:0,weeklyBearCount:0});const o=r.combo_score||0,s=r.signal_type&&r.signal_type.toLowerCase().includes("bull");r.timeframe==="1w"?s?(t[r.ticker].weeklyBullSum+=o,t[r.ticker].weeklyBullCount++):(t[r.ticker].weeklyBearSum+=o,t[r.ticker].weeklyBearCount++):s?(t[r.ticker].dailyBullSum+=o,t[r.ticker].dailyBullCount++):(t[r.ticker].dailyBearSum+=o,t[r.ticker].dailyBearCount++)});const n=Object.keys(t),i=(r,o)=>n.filter(s=>t[s][o]>0).map(s=>({ticker:s,avgScore:Math.round(t[s][r]/t[s][o])})).sort((s,a)=>a.avgScore-s.avgScore).slice(0,10);k("lb-daily-bull",i("dailyBullSum","dailyBullCount")),k("lb-daily-bear",i("dailyBearSum","dailyBearCount")),k("lb-weekly-bull",i("weeklyBullSum","weeklyBullCount")),k("lb-weekly-bear",i("weeklyBearSum","weeklyBearCount"))}function k(e,t){const n=document.getElementById(e);if(n){if(t.length===0){n.innerHTML='<tr><td colspan="2" style="text-align:center; color:#8b949e">No signals found</td></tr>';return}n.innerHTML=`
        <tbody>
            ${t.map(i=>`
                <tr class="clickable-row" data-ticker="${L(i.ticker)}">
                    <td>${L(i.ticker)}</td>
                    <td>${i.avgScore}</td>
                </tr>
            `).join("")}
        </tbody>
    `}}function le(){const e=document.getElementById("view-leaderboard");e&&e.addEventListener("click",t=>{const i=t.target.closest(".clickable-row");i&&i.dataset.ticker&&window.showTickerView&&window.showTickerView(i.dataset.ticker)})}let R="time",j="time",_=null;function z(e){R=e,K(".ticker-daily-sort",e);const t=document.getElementById("ticker-view");if(!t)return;const n=t.dataset.ticker;n&&w(n)}function Y(e){j=e,K(".ticker-weekly-sort",e);const t=document.getElementById("ticker-view");if(!t)return;const n=t.dataset.ticker;n&&w(n)}function K(e,t){document.querySelectorAll(`${e} .tf-btn`).forEach(n=>{const i=n;i.classList.toggle("active",i.dataset.sort===t)})}function w(e){const n=C().filter(a=>a.ticker===e),i=n.filter(a=>(a.timeframe||"").trim()==="1d"),r=n.filter(a=>(a.timeframe||"").trim()==="1w");i.sort(B(R)),r.sort(B(j)),A("ticker-daily-avg",i),A("ticker-weekly-avg",r);const o=document.getElementById("ticker-daily-container");o&&(i.length===0?o.innerHTML='<div style="text-align:center; padding:20px; color:var(--text-secondary)">No daily alerts</div>':o.innerHTML=i.map(S).join(""));const s=document.getElementById("ticker-weekly-container");s&&(r.length===0?s.innerHTML='<div style="text-align:center; padding:20px; color:var(--text-secondary)">No weekly alerts</div>':s.innerHTML=r.map(S).join("")),de(e)}function A(e,t){const n=document.getElementById(e);if(!n)return;if(t.length===0){n.innerHTML="";return}let i=0;t.forEach(d=>{const m=d.combo_score||0,f=(d.signal_type||"").toLowerCase().includes("bull");i+=f?m:-m});const r=Math.round(i/t.length),o=Math.abs(r),c=`background: conic-gradient(${r>=0?"#3fb950":"#f85149"} ${o}%, #0d1117 0%);`;n.innerHTML=`
        <div class="metric-item" title="Average Score: ${r}">
            <div class="score-circle" style="${c}"></div>
        </div>
    `}function de(e){typeof TradingView>"u"||_!==e&&(_=e,new TradingView.widget({width:"100%",height:600,symbol:e,interval:"D",timezone:"Etc/UTC",theme:"dark",style:"1",locale:"en",toolbar_bg:"#f1f3f6",enable_publishing:!1,allow_symbol_change:!1,container_id:"tradingview_chart",studies:[{id:"MASimple@tv-basicstudies",inputs:{length:50}}]}))}let b=null,U=1,I="SVIX";async function ue(e,t){const n=await fetch(`/api/breadth?ticker=${e}&days=${t}`);if(!n.ok)throw new Error("Failed to fetch breadth data");return n.json()}function M(e){if(e.length===0)return[];const t=e[0];return t===0?e.map(()=>100):e.map(n=>n/t*100)}function me(e,t,n){const i=document.getElementById("breadth-chart");if(!i)return;b&&(b.destroy(),b=null);const r=e.map(c=>n?new Date(c.date).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",timeZone:"America/New_York"}):new Date(c.date+"T00:00:00").toLocaleDateString("en-US",{month:"short",day:"numeric"})),o=e.map(c=>c.spy),s=e.map(c=>c.comparison),a=M(o),l=M(s);b=new Chart(i,{type:"line",data:{labels:r,datasets:[{label:"SPY",data:a,borderColor:"#58a6ff",backgroundColor:"transparent",borderWidth:2.5,pointRadius:a.length>15?0:3,pointHoverRadius:5,tension:.3,order:1,fill:!1},{label:t,data:l,borderColor:"#d2a8ff",backgroundColor:"transparent",borderWidth:2.5,pointRadius:l.length>15?0:3,pointHoverRadius:5,tension:.3,order:2,fill:{target:0,above:"rgba(63, 185, 80, 0.18)",below:"rgba(248, 81, 73, 0.18)"}}]},options:{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{labels:{color:"#c9d1d9",font:{size:12},usePointStyle:!0,pointStyle:"line"}},tooltip:{backgroundColor:"rgba(22, 27, 34, 0.95)",borderColor:"#30363d",borderWidth:1,titleColor:"#c9d1d9",bodyColor:"#8b949e",padding:12,callbacks:{label:function(c){const d=c.parsed.y.toFixed(2);return`${c.dataset.label}: ${d}`}}},filler:{propagate:!0}},scales:{x:{ticks:{color:"#8b949e",maxRotation:0,autoSkip:!0,maxTicksLimit:10,font:{size:11}},grid:{color:"rgba(48, 54, 61, 0.3)"}},y:{ticks:{color:"#8b949e",font:{size:11},callback:function(c){return c.toFixed(1)}},grid:{color:"rgba(48, 54, 61, 0.3)"}}}}})}async function D(){const e=document.getElementById("breadth-loading"),t=document.getElementById("breadth-error");e&&(e.style.display="block"),t&&(t.style.display="none");try{const n=await ue(I,U);if(e&&(e.style.display="none"),n.points.length===0){t&&(t.textContent="No data available for this timeframe",t.style.display="block");return}me(n.points,I,n.intraday)}catch(n){console.error("Breadth load error:",n),e&&(e.style.display="none"),t&&(t.textContent="Failed to load breadth data",t.style.display="block")}}function fe(e){U=e,document.querySelectorAll("#breadth-tf-btns .tf-btn").forEach(t=>{t.classList.toggle("active",Number(t.dataset.days)===e)}),D()}function ye(e){I=e,document.querySelectorAll("#breadth-metric-btns .tf-btn").forEach(t=>{t.classList.toggle("active",t.dataset.metric===e)}),D()}function ge(){D()}let T="live",Z=0;window.setDailySort=se;window.setWeeklySort=ce;window.setTickerDailySort=z;window.setTickerWeeklySort=Y;window.showTickerView=function(e){T!=="live"&&E("live"),Z=window.scrollY;const t=document.getElementById("ticker-view");t&&(t.dataset.ticker=e,document.getElementById("reset-filter")?.classList.remove("hidden"),document.getElementById("dashboard-view")?.classList.add("hidden"),t.classList.remove("hidden"),w(e),window.scrollTo(0,0))};window.showOverview=function(){const e=document.getElementById("ticker-view");e&&delete e.dataset.ticker,y(),window.scrollTo(0,Z)};function E(e){T=e,document.querySelectorAll(".nav-btn").forEach(t=>t.classList.remove("active")),document.getElementById(`nav-${e}`)?.classList.add("active"),document.getElementById("view-live")?.classList.add("hidden"),document.getElementById("view-leaderboard")?.classList.add("hidden"),document.getElementById("view-breadth")?.classList.add("hidden"),document.getElementById("live-controls")?.classList.add("hidden"),document.getElementById("leaderboard-controls")?.classList.add("hidden"),document.getElementById("breadth-controls")?.classList.add("hidden"),e==="live"?(document.getElementById("view-live")?.classList.remove("hidden"),document.getElementById("live-controls")?.classList.remove("hidden")):e==="leaderboard"?(document.getElementById("view-leaderboard")?.classList.remove("hidden"),document.getElementById("leaderboard-controls")?.classList.remove("hidden"),P()):e==="breadth"&&(document.getElementById("view-breadth")?.classList.remove("hidden"),document.getElementById("breadth-controls")?.classList.remove("hidden"),ge())}function g(e){ie(e);const t=document.getElementById("btn-30"),n=document.getElementById("btn-7"),i=document.getElementById("btn-1"),r=document.getElementById("btn-week"),o=document.getElementById("btn-month"),s=document.getElementById("history-week"),a=document.getElementById("history-month");[t,n,i,r,o].forEach(l=>l?.classList.remove("active")),s?.classList.add("hidden"),a?.classList.add("hidden"),e==="30"?t?.classList.add("active"):e==="7"?n?.classList.add("active"):e==="1"?i?.classList.add("active"):e==="week"?(r?.classList.add("active"),s?.classList.remove("hidden")):e==="month"&&(o?.classList.add("active"),a?.classList.remove("hidden")),p().then(()=>{const l=document.getElementById("ticker-view"),c=l?.dataset.ticker;c&&!l?.classList.contains("hidden")?w(c):y()})}function ve(){const e=document.getElementById("search-toggle"),t=document.getElementById("search-input"),n=document.getElementById("search-container");!e||!t||!n||(e.addEventListener("click",i=>{i.stopPropagation(),t.classList.contains("active")?(t.classList.remove("active"),t.blur()):(t.classList.add("active"),t.focus())}),n.addEventListener("click",()=>{t.classList.contains("active")||(t.classList.add("active"),t.focus())}),t.addEventListener("keydown",i=>{if(i.key==="Enter"){const r=t.value.trim().toUpperCase();r&&(window.showTickerView(r),t.value="",t.blur(),t.classList.remove("active"))}}),document.addEventListener("keydown",i=>{document.activeElement instanceof HTMLInputElement||document.activeElement instanceof HTMLTextAreaElement||document.activeElement.isContentEditable||i.ctrlKey||i.altKey||i.metaKey||i.key.length>1||/^[a-zA-Z0-9]$/.test(i.key)&&(t.classList.contains("active")||t.classList.add("active"),t.focus())}))}document.addEventListener("DOMContentLoaded",()=>{document.getElementById("nav-live")?.addEventListener("click",()=>E("live")),document.getElementById("nav-leaderboard")?.addEventListener("click",()=>{E("leaderboard")}),document.getElementById("nav-breadth")?.addEventListener("click",()=>E("breadth")),document.getElementById("reset-filter")?.addEventListener("click",window.showOverview),document.getElementById("btn-30")?.addEventListener("click",()=>g("30")),document.getElementById("btn-7")?.addEventListener("click",()=>g("7")),document.getElementById("btn-1")?.addEventListener("click",()=>g("1")),document.getElementById("btn-week")?.addEventListener("click",()=>g("week")),document.getElementById("btn-month")?.addEventListener("click",()=>g("month"));const e=document.getElementById("history-week"),t=document.getElementById("history-month");document.querySelectorAll(".ticker-daily-sort .tf-btn").forEach(n=>{n.addEventListener("click",()=>{const i=n.dataset.sort;z(i)})}),document.querySelectorAll(".ticker-weekly-sort .tf-btn").forEach(n=>{n.addEventListener("click",()=>{const i=n.dataset.sort;Y(i)})}),e&&(e.value=H()),t&&(t.value=x()),e?.addEventListener("change",()=>p().then(y)),t?.addEventListener("change",()=>p().then(y)),document.querySelectorAll("#leaderboard-controls .tf-btn").forEach(n=>{n.addEventListener("click",i=>{document.querySelectorAll("#leaderboard-controls .tf-btn").forEach(r=>r.classList.remove("active")),i.target.classList.add("active"),P()})}),document.querySelectorAll("#breadth-tf-btns .tf-btn").forEach(n=>{n.addEventListener("click",()=>{const i=Number(n.dataset.days);fe(i)})}),document.querySelectorAll("#breadth-metric-btns .tf-btn").forEach(n=>{n.addEventListener("click",()=>{const i=n.dataset.metric;ye(i);const r=document.getElementById("breadth-subtitle");r&&(r.textContent=`SPY vs ${i} â€” Normalized`)})}),g("1"),setInterval(()=>{T==="live"&&re()&&p().then(()=>{const n=document.getElementById("ticker-view"),i=n?.dataset.ticker;i&&!n?.classList.contains("hidden")?w(i):y()})},1e4),ve(),oe(),le(),he()});function he(){const e=document.getElementById("view-live");e&&e.addEventListener("click",t=>{if(window.innerWidth>768)return;const n=t.target;if(n.tagName!=="H2"||!(n.closest(".column-header")||n.closest(".header-title-group")))return;const r=n.closest(".column");r&&r.classList.toggle("collapsed")})}
