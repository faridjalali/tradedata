import{V as fi,a as mi}from"./vendor-charts-C-3zq_q_.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}})();const br="catvue_app_timezone_v1",zn="America/Los_Angeles",Sr=[{value:"America/Los_Angeles",label:"Los Angeles (US Pacific time)"},{value:"America/Denver",label:"Denver (US Mountain time)"},{value:"America/Chicago",label:"Chicago (US Central time)"},{value:"America/New_York",label:"New York (US Eastern time)"},{value:"UTC",label:"UTC"}],so=new Set(Sr.map(t=>t.value)),Jn=new Set;let cn=lo(),Qn=cn;const sn=new Map;function oo(t){if(!t)return!1;try{return new Intl.DateTimeFormat("en-US",{timeZone:t}),!0}catch{return!1}}function Dr(t){const e=String(t||"").trim();return!e||!so.has(e)||!oo(e)?zn:e}function lo(){let t="";try{t=typeof window<"u"?String(window.localStorage.getItem(br)||""):""}catch{t=""}return Dr(t)}function ao(t){try{if(typeof window>"u")return;window.localStorage.setItem(br,t)}catch{}}function co(t,e){const n=Array.isArray(t)?t.join("|"):t,i=Object.entries(e).sort(([r],[s])=>r.localeCompare(s)).map(([r,s])=>`${r}:${String(s)}`);return`${n}|${i.join(",")}`}function uo(){return Sr.map(t=>({...t}))}function K(){return cn}function Ot(t="en-US",e={}){const n=K();Qn!==n&&(sn.clear(),Qn=n);const i=co(t,e),r=sn.get(i);if(r)return r;const s=new Intl.DateTimeFormat(t,{...e,timeZone:n});return sn.set(i,s),s}function fo(t){const e=Dr(t),n=cn;return e===n||(cn=e,ao(e),sn.clear(),Qn=e,Jn.forEach(i=>{try{i(e,n)}catch{}})),e}function mo(t){return Jn.add(t),()=>{Jn.delete(t)}}const $e=[1,3,7,14,28],ei=new Map,Gt=new Map,ho="custom_chart_settings_v1",on="1min",go=new Set(["1min","5min","15min","30min","1hour","4hour"]);function wr(t){const e=String(t||"").trim().toLowerCase();return e==="bullish"||e==="bearish"?e:"neutral"}function Ge(t){return String(t||"").trim().toUpperCase()}function _n(t){const e=String(t||"").trim();return go.has(e)?e:on}function bt(){try{if(typeof window>"u")return on;const t=window.localStorage.getItem(ho);if(!t)return on;const e=JSON.parse(t);return _n(e?.volumeDelta?.sourceInterval)}catch{return on}}function Cr(t,e){return`${Ge(t)}|${_n(e)}`}function kr(t,e){const n=Cr(t,e),i=ei.get(n);return i?!Number.isFinite(i.expiresAtMs)||i.expiresAtMs<=Date.now()?(ei.delete(n),null):i:null}function Er(t,e){const n=Cr(e.ticker,t);ei.set(n,e)}function Tr(){const t={};for(const e of $e)t[String(e)]="neutral";return t}function po(t){const e=Ge(t?.ticker);if(!e)return null;const n=Tr(),i=t?.states||{};for(const o of $e)n[String(o)]=wr(i[String(o)]);const r=Number(t?.expiresAtMs),s=Number.isFinite(r)&&r>Date.now()?r:Date.now()+3600*1e3;return{ticker:e,tradeDate:typeof t?.tradeDate=="string"?t.tradeDate:null,states:n,expiresAtMs:s}}async function yo(t,e,n){const i=_n(e),r=n?.forceRefresh===!0,s=Array.from(new Set(t.map(a=>Ge(a)).filter(Boolean)));if(s.length===0)return new Map;const o=`${i}|${r?"refresh":"cached"}|nocache|${s.join(",")}`;if(Gt.has(o))return await Gt.get(o);const l=(async()=>{const a=new Map,d=new URLSearchParams;d.set("tickers",s.join(",")),d.set("vdSourceInterval",i),r&&d.set("refresh","1"),d.set("nocache","1");const c=await fetch(`/api/chart/divergence-summary?${d.toString()}`,{cache:"no-store"});if(!c.ok)throw new Error(`Failed to fetch divergence summary (HTTP ${c.status})`);const u=await c.json(),m=Array.isArray(u?.summaries)?u.summaries:[];for(const h of m){const f=po(h);f&&(a.set(f.ticker,f),Er(i,f))}return a})().catch(()=>new Map).finally(()=>{Gt.delete(o)});return Gt.set(o,l),await l}async function zi(t,e,n){const i=Ge(t),r=e?_n(e):bt(),s=n?.forceRefresh===!0;return i&&(await yo([i],r,{forceRefresh:s})).get(i)||null}function vo(t,e){t.querySelectorAll(".divergence-mini-cell").forEach(r=>{const s=String(r.dataset.days||"").trim(),o=e?.states?.[s]||"neutral";r.classList.remove("is-bullish","is-bearish","is-neutral"),o==="bullish"?r.classList.add("is-bullish"):o==="bearish"?r.classList.add("is-bearish"):r.classList.add("is-neutral")});const i=(t instanceof HTMLElement,t);i instanceof HTMLElement&&(e?.tradeDate?(i.dataset.tradeDate=e.tradeDate,i.title=`Daily divergence as of ${e.tradeDate}`):(i.removeAttribute("data-trade-date"),i.title="Daily divergence"))}const bo={1:3,3:3,7:2,14:2,28:1};function ti(t,e){let n=0;for(const i of $e){const r=String(i),s=String(t?.[r]||"").trim().toLowerCase(),o=Number(bo[r]||0);s==="bullish"?n+=o:s==="bearish"&&(n-=o)}return e&&(n+=e.ema8===!0?1:e.ema8===!1?-1:0,n+=e.ema21===!0?1:e.ema21===!1?-1:0,n+=e.sma50===!0?1:e.sma50===!1?-1:0,n+=e.sma200===!0?1:e.sma200===!1?-1:0),n}function Wi(t,e){const n=Ge(t);if(!n)return 0;const i=bt(),r=kr(n,i);return r?ti(r.states):0}function Ve(t){const e=bt(),n=Array.from(t.querySelectorAll(".divergence-mini[data-ticker]"));for(const i of n){const r=Ge(i.dataset.ticker);if(!r)continue;const s=kr(r,e);s&&vo(i,s)}}function St(t,e){const n=bt(),r=Date.now()+3600*1e3;for(const s of t||[]){const o=Ge(s?.ticker);if(!o)continue;const l=Tr(),a=s?.divergence_states||{};for(const d of $e)l[String(d)]=wr(a[String(d)]);Er(n,{ticker:o,tradeDate:typeof s?.divergence_trade_date=="string"?s.divergence_trade_date:null,states:l,expiresAtMs:r})}}const qi=new Map,Lr=1440*60*1e3;function So(t){const e=`${t}|date`,n=qi.get(e);if(n)return n;const i=new Intl.DateTimeFormat("en-CA",{timeZone:t,year:"numeric",month:"2-digit",day:"2-digit"});return qi.set(e,i),i}function Wn(t,e){const n=Number(t.find(i=>i.type===e)?.value);return Number.isFinite(n)?n:0}function hi(t,e){const n=So(e).formatToParts(t);return{year:Wn(n,"year"),month:Wn(n,"month"),day:Wn(n,"day")}}function Qe(t,e,n){return`${t}-${String(e).padStart(2,"0")}-${String(n).padStart(2,"0")}`}function Gi(t,e){const n=Do(t);if(!Number.isFinite(n))return"";const i=new Date(n+e*Lr);return Qe(i.getUTCFullYear(),i.getUTCMonth()+1,i.getUTCDate())}function Do(t){const e=String(t||"").match(/^(\d{4})-(\d{2})-(\d{2})$/);if(!e)return null;const n=Number(e[1]),i=Number(e[2]),r=Number(e[3]);return!Number.isFinite(n)||!Number.isFinite(i)||!Number.isFinite(r)?null:Date.UTC(n,i-1,r)}function wo(t,e){const n=new Date(Date.UTC(t,0,4)),i=n.getUTCDay()||7,r=new Date(n);r.setUTCDate(n.getUTCDate()-i+1);const s=new Date(r);return s.setUTCDate(r.getUTCDate()+(e-1)*7),s}function dn(t=K()){const n=hi(new Date,t),i=new Date(Date.UTC(n.year,n.month-1,n.day)),r=i.getUTCDay()||7;i.setUTCDate(i.getUTCDate()+4-r);const s=new Date(Date.UTC(i.getUTCFullYear(),0,1)),o=Math.ceil(((i.getTime()-s.getTime())/Lr+1)/7);return`${i.getUTCFullYear()}-W${o.toString().padStart(2,"0")}`}function Co(t=K()){const n=hi(new Date,t);return Qe(n.year,n.month,n.day)}function un(t=K()){const n=hi(new Date,t);return`${n.year}-${String(n.month).padStart(2,"0")}`}function ko(t){return t?t<1e3?t.toFixed(0).padEnd(7):(Math.round(t/1e3)+"K").padEnd(7):"0".padEnd(7)}function gi(t,e,n,i=K()){const r=Co(i);if(!r)return{startDate:"",endDate:""};if(t==="today")return{startDate:r,endDate:r};if(t==="yesterday"){const s=Gi(r,-1);return s?{startDate:s,endDate:s}:{startDate:"",endDate:""}}if(t==="30"||t==="7"){const s=Math.max(1,Math.floor(Number(t))),o=Gi(r,-(s-1));return o?{startDate:o,endDate:r}:{startDate:"",endDate:""}}if(t==="week"){const s=String(e||"").trim().match(/^(\d{4})-W(\d{2})$/);if(!s)return{startDate:"",endDate:""};const o=Number(s[1]),l=Number(s[2]);if(!Number.isFinite(o)||!Number.isFinite(l)||l<1||l>53)return{startDate:"",endDate:""};const a=wo(o,l),d=new Date(a);d.setUTCDate(a.getUTCDate()+6);const c=Qe(a.getUTCFullYear(),a.getUTCMonth()+1,a.getUTCDate()),u=Qe(d.getUTCFullYear(),d.getUTCMonth()+1,d.getUTCDate());return{startDate:c,endDate:u}}if(t==="month"){const s=String(n||"").trim().match(/^(\d{4})-(\d{2})$/);if(!s)return{startDate:"",endDate:""};const o=Number(s[1]),l=Number(s[2]);if(!Number.isFinite(o)||!Number.isFinite(l)||l<1||l>12)return{startDate:"",endDate:""};const a=new Date(Date.UTC(o,l,0)).getUTCDate();return{startDate:Qe(o,l,1),endDate:Qe(o,l,a)}}return{startDate:"",endDate:""}}function et(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Oe(t,e="desc"){return(n,i)=>{let r=0;if(t==="time")r=(i.timestamp||"").localeCompare(n.timestamp||"");else{if(t==="favorite")return n.is_favorite===i.is_favorite?(i.timestamp||"").localeCompare(n.timestamp||""):(i.is_favorite?1:0)-(n.is_favorite?1:0);if(t==="volume")r=(i.signal_volume||0)-(n.signal_volume||0);else if(t==="combo"){const s=i.divergence_states?ti(i.divergence_states,i.ma_states):Wi(i.ticker),o=n.divergence_states?ti(n.divergence_states,n.ma_states):Wi(n.ticker);if(s!==o)r=s-o;else{const l=(i.signal_volume||0)-(n.signal_volume||0);l!==0?r=l:r=(i.timestamp||"").localeCompare(n.timestamp||"")}}else r=(i.timestamp||"").localeCompare(n.timestamp||"")}return t!=="favorite"&&e==="asc"?-r:r}}function de(t,e,n){const i=document.querySelector(t);i&&i.querySelectorAll(".tf-btn").forEach(r=>{const s=r,o=s.dataset.sort;if(o===e){s.classList.add("active");const l=s.getAttribute("data-base-text")||s.textContent||"";s.getAttribute("data-base-text")||s.setAttribute("data-base-text",l),o!=="favorite"&&(s.textContent=`${l} ${n==="asc"?"↑":"↓"}`)}else{s.classList.remove("active");const l=s.getAttribute("data-base-text");l&&(s.textContent=l)}})}function Eo(t){return typeof t=="boolean"?t:typeof t=="string"?t.toLowerCase()==="true":typeof t=="number"?t===1:!1}function xr(t){const e=t,n=Number(e.id);if(!Number.isFinite(n))throw new Error("Invalid alert payload: missing/invalid id");return{...e,id:n,is_favorite:Eo(e.is_favorite),source:"TV"}}async function Ir(t=""){try{const e=new URLSearchParams(String(t||"").replace(/^\?/,""));e.set("vd_source_interval",bt());const n=await fetch(`/api/alerts?${e.toString()}`);if(!n.ok)throw new Error("Network response was not ok");const i=await n.json();if(!Array.isArray(i))throw new Error("Invalid alert payload: expected array");return i.map(xr)}catch(e){throw console.error("Error fetching alerts:",e),e}}async function To(t){const e=await fetch(`/api/alerts/${t}/favorite`,{method:"POST"});if(!e.ok)throw new Error("Network response was not ok");return xr(await e.json())}function Lo(t){return typeof t=="boolean"?t:typeof t=="string"?t.toLowerCase()==="true":typeof t=="number"?t===1:!1}function Mr(t){const e=t,n=Number(e.id);if(!Number.isFinite(n))throw new Error("Invalid divergence payload: missing/invalid id");return{...e,id:n,is_favorite:Lo(e.is_favorite),source:"DataAPI"}}async function Ar(t=""){try{const e=new URLSearchParams(String(t||"").replace(/^\?/,""));e.set("vd_source_interval",bt());const n=await fetch(`/api/divergence/signals?${e.toString()}`);if(!n.ok)throw new Error("Network response was not ok");const i=await n.json();if(!Array.isArray(i))throw new Error("Invalid divergence payload: expected array");return i.map(Mr)}catch(e){throw console.error("Error fetching divergence signals:",e),e}}async function Nr(t){const e=await fetch(`/api/divergence/signals/${t}/favorite`,{method:"POST"});if(!e.ok)throw new Error("Network response was not ok");return Mr(await e.json())}async function xo(){const t=await fetch("/api/divergence/fetch-all/run",{method:"POST",headers:{"Content-Type":"application/json"}}),e=await t.json().catch(()=>({}));if(!t.ok){if(t.status===409&&String(e?.status||"")==="running")return{status:"running"};const n=typeof e?.error=="string"&&e.error.trim()?e.error.trim():`Failed to start fetch-all run (HTTP ${t.status})`;throw new Error(n)}return{status:String(e?.status||"started")}}async function Io(){const t=await fetch("/api/divergence/fetch-all/stop",{method:"POST",headers:{"Content-Type":"application/json"}}),e=await t.json().catch(()=>({}));if(!t.ok){if(t.status===409&&typeof e?.status=="string")return{status:e.status};const n=typeof e?.error=="string"&&e.error.trim()?e.error.trim():`Failed to stop fetch-all run (HTTP ${t.status})`;throw new Error(n)}return{status:String(e?.status||"stop-requested")}}async function Mo(){const t=await fetch("/api/divergence/fetch-weekly/run",{method:"POST",headers:{"Content-Type":"application/json"}}),e=await t.json().catch(()=>({}));if(!t.ok){if(t.status===409&&String(e?.status||"")==="running")return{status:"running"};const n=typeof e?.error=="string"&&e.error.trim()?e.error.trim():`Failed to start fetch-weekly run (HTTP ${t.status})`;throw new Error(n)}return{status:String(e?.status||"started")}}async function Ao(){const t=await fetch("/api/divergence/fetch-weekly/stop",{method:"POST",headers:{"Content-Type":"application/json"}}),e=await t.json().catch(()=>({}));if(!t.ok){if(t.status===409&&typeof e?.status=="string")return{status:e.status};const n=typeof e?.error=="string"&&e.error.trim()?e.error.trim():`Failed to stop fetch-weekly run (HTTP ${t.status})`;throw new Error(n)}return{status:String(e?.status||"stop-requested")}}async function Rr(){const t=await fetch("/api/divergence/scan/status"),e=await t.json().catch(()=>null);if(!t.ok||!e){const n=typeof e?.error=="string"&&e.error.trim()?e.error.trim():"Failed to fetch divergence scan status";throw new Error(n)}return{running:!!e.running,lastScanDateEt:e.lastScanDateEt??null,scanControl:e.scanControl??null,tableBuild:e.tableBuild??null,fetchAllData:e.fetchAllData??null,fetchWeeklyData:e.fetchWeeklyData??null,latestJob:e.latestJob??null}}let Br=[];function pi(){return Br}function _r(t){Br=t}let fn=[];function Ut(){return fn}function yi(t){fn=t}function No(t,e){fn=[...fn.filter(i=>(i.timeframe||"").trim()!==t),...e]}function Ro(t){const e=String(t||"").trim();if(!e)return"";const n=e.match(/^(\d{4})-(\d{2})-(\d{2})/);if(n){const r=Number(n[2]),s=Number(n[3]);if(Number.isFinite(r)&&r>0&&Number.isFinite(s)&&s>0)return`${r}/${s}`}const i=new Date(e);return Number.isNaN(i.getTime())?"":`${i.getMonth()+1}/${i.getDate()}`}function Ue(t){const e=Ro(t.signal_trade_date||t.divergence_trade_date||t.timestamp)||"--",n=t.source==="TV"?"TV":"DataAPI",i=t.ma_states||{};let r=!1,s=!1;if(t.signal_direction!==void 0&&t.signal_direction!==null){const S=Number(t.signal_direction);r=S===1,s=S===-1}else r=!!(t.signal_type&&t.signal_type.toLowerCase().includes("bull")),s=!r;const o=r?"bullish-card":s?"bearish-card":"",l=ko(t.signal_volume||0),a=t.is_favorite===!0||String(t.is_favorite).toLowerCase()==="true",d=a?"filled":"",c=a?"visible":"hidden",u=a?"1":"0",m=`
        <svg class="fav-icon ${d}" data-id="${t.id}" data-source="${n}" viewBox="0 0 24 24" width="15" height="15" stroke="currentColor" stroke-width="2.25" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <polyline class="check-mark" points="7.5 12.5 10.5 15.5 16.5 9.5" style="visibility: ${c}; opacity: ${u};"></polyline>
        </svg>
    `,h=$e.map(S=>{const b=String(S),p=String(t.divergence_states?.[b]||"neutral").toLowerCase();return`<span class="divergence-mini-cell ${p==="bullish"?"is-bullish":p==="bearish"?"is-bearish":"is-neutral"}" data-days="${S}">${S}</span>`}).join(""),f=t.divergence_trade_date?`Daily divergence as of ${et(t.divergence_trade_date)}`:"Daily divergence",g=`
        <span class="ma-dot-row" title="8 EMA, 21 EMA, 50 SMA, 200 SMA">
            <span class="ma-dot ${i.ema8?"is-up":"is-down"}"></span>
            <span class="ma-dot ${i.ema21?"is-up":"is-down"}"></span>
            <span class="ma-dot ${i.sma50?"is-up":"is-down"}"></span>
            <span class="ma-dot ${i.sma200?"is-up":"is-down"}"></span>
        </span>
    `;return`
        <div class="alert-card ${o}" data-ticker="${et(t.ticker)}" data-source="${n}">
            ${m}
            <h3>${et(t.ticker)}</h3>
            
            <div class="metrics-container">
                <div class="metric-item" title="Daily divergence summary">
                    <div class="divergence-mini" data-ticker="${et(t.ticker)}" title="${f}">
                        ${h}
                    </div>
                </div>
                <div class="metric-item" title="Signal Volume">
                    <span class="volume-text">${l}</span>
                    ${g}
                </div>
            </div>

            <span class="alert-time">${e}</span>
        </div>
    `}let Pr="today",Be="combo",_e="combo",ve="desc",be="desc";async function mn(t){try{const e=document.getElementById("history-week")?.value||"",n=document.getElementById("history-month")?.value||"",{startDate:i,endDate:r}=gi(Pr,e,n);if(!i||!r)return[];const s=`?start_date=${i}&end_date=${r}`,o=await Ir(s);return St(o),_r(o),o}catch(e){return console.error("Error fetching live alerts:",e),[]}}function He(){const t=pi();St(t),document.getElementById("ticker-view").classList.add("hidden"),document.getElementById("dashboard-view").classList.remove("hidden"),document.getElementById("reset-filter").classList.add("hidden");const e=document.getElementById("daily-container"),n=document.getElementById("weekly-container"),i=t.filter(s=>(s.timeframe||"").trim()==="1d"),r=t.filter(s=>(s.timeframe||"").trim()==="1w");i.sort(Oe(Be,ve)),r.sort(Oe(_e,be)),e.innerHTML=i.map(Ue).join(""),n.innerHTML=r.map(Ue).join(""),Ve(e),Ve(n),de("#dashboard-view .column:first-child .header-sort-controls",Be,ve),de("#dashboard-view .column:last-child .header-sort-controls",_e,be)}function Bo(){const t=document.getElementById("view-live");if(!t)return;t.addEventListener("click",d=>{const c=d.target,u=c.closest(".fav-icon");if(u){d.stopPropagation();const h=u.dataset.id,f=u.dataset.source==="TV"?"TV":"DataAPI";if(h){const g=document.querySelectorAll(`.fav-icon[data-id="${h}"][data-source="${f}"]`),S=u.classList.contains("filled");g.forEach(p=>{const v=p.querySelector(".check-mark");S?(p.classList.remove("filled"),v&&(v.style.visibility="hidden",v.style.opacity="0")):(p.classList.add("filled"),v&&(v.style.visibility="visible",v.style.opacity="1"))}),(f==="DataAPI"?Nr(Number(h)):To(Number(h))).then(p=>{if(f==="DataAPI"){const v=Ut(),D=v.findIndex(L=>L.id===p.id);D!==-1&&(v[D].is_favorite=p.is_favorite,yi(v))}else{const v=pi(),D=v.findIndex(L=>L.id===p.id);D!==-1&&(v[D].is_favorite=p.is_favorite,_r(v))}g.forEach(v=>{const D=v.querySelector(".check-mark");p.is_favorite?(v.classList.add("filled"),D&&(D.style.visibility="visible",D.style.opacity="1")):(v.classList.remove("filled"),D&&(D.style.visibility="hidden",D.style.opacity="0"))})}).catch(()=>{g.forEach(p=>{const v=p.querySelector(".check-mark");S?(p.classList.add("filled"),v&&(v.style.visibility="visible",v.style.opacity="1")):(p.classList.remove("filled"),v&&(v.style.visibility="hidden",v.style.opacity="0"))})})}return}const m=c.closest(".alert-card");if(m){const h=m.dataset.ticker;if(h&&window.showTickerView){let f=null;m.closest("#daily-container")?f="daily":m.closest("#weekly-container")&&(f="weekly"),window.showTickerView(h,"live",f)}}});const e=document.getElementById("btn-t"),n=document.getElementById("btn-y"),i=document.getElementById("btn-30"),r=document.getElementById("btn-7"),s=document.getElementById("btn-week"),o=document.getElementById("btn-month");e?.addEventListener("click",()=>Ie("today")),n?.addEventListener("click",()=>Ie("yesterday")),i?.addEventListener("click",()=>Ie("30")),r?.addEventListener("click",()=>Ie("7")),s?.addEventListener("click",()=>Ie("week")),o?.addEventListener("click",()=>Ie("month"));const l=document.getElementById("history-week"),a=document.getElementById("history-month");l?.addEventListener("change",()=>mn().then(He)),a?.addEventListener("change",()=>mn().then(He)),document.querySelectorAll("#dashboard-view .column:first-child .header-sort-controls .tf-btn").forEach(d=>{d.addEventListener("click",()=>{const c=d.dataset.sort;Fr(c)})}),document.querySelectorAll("#dashboard-view .column:last-child .header-sort-controls .tf-btn").forEach(d=>{d.addEventListener("click",()=>{const c=d.dataset.sort;$r(c)})})}function Fr(t){t===Be&&t!=="favorite"?ve=ve==="desc"?"asc":"desc":(Be=t,ve="desc"),de("#dashboard-view .column:first-child .header-sort-controls",Be,ve),He()}function $r(t){t===_e&&t!=="favorite"?be=be==="desc"?"asc":"desc":(_e=t,be="desc"),de("#dashboard-view .column:last-child .header-sort-controls",_e,be),He()}function _o(){Be="combo",ve="desc",_e="combo",be="desc",de("#dashboard-view .column:first-child .header-sort-controls",Be,ve),de("#dashboard-view .column:last-child .header-sort-controls",_e,be)}function Ie(t){Pr=t;const e=document.getElementById("btn-t"),n=document.getElementById("btn-y"),i=document.getElementById("btn-30"),r=document.getElementById("btn-7"),s=document.getElementById("btn-week"),o=document.getElementById("btn-month"),l=document.getElementById("history-week"),a=document.getElementById("history-month");[e,n,i,r,s,o].forEach(d=>d?.classList.remove("active")),l?.classList.add("hidden"),a?.classList.add("hidden"),t==="today"?e?.classList.add("active"):t==="yesterday"?n?.classList.add("active"):t==="30"?i?.classList.add("active"):t==="7"?r?.classList.add("active"):t==="week"?(s?.classList.add("active"),l?.classList.remove("hidden")):t==="month"&&(o?.classList.add("active"),a?.classList.remove("hidden")),mn().then(()=>{const d=document.getElementById("ticker-view"),c=d?.dataset.ticker;c&&!d?.classList.contains("hidden")&&window.renderTickerView?window.renderTickerView(c,{refreshCharts:!1}):He()})}async function vi(){const t=document.querySelector("#leaderboard-controls .tf-btn.active"),e=t?t.dataset.days:"30";try{const n=await Ir(`?days=${e}`);Po(n)}catch(n){console.error("Error fetching leaderboard:",n)}}function Po(t){const e={};t.forEach(r=>{e[r.ticker]||(e[r.ticker]={dailyBullSum:0,dailyBullCount:0,dailyBearSum:0,dailyBearCount:0,weeklyBullSum:0,weeklyBullCount:0,weeklyBearSum:0,weeklyBearCount:0});const s=r.combo_score||0,o=r.signal_type&&r.signal_type.toLowerCase().includes("bull");r.timeframe==="1w"?o?(e[r.ticker].weeklyBullSum+=s,e[r.ticker].weeklyBullCount++):(e[r.ticker].weeklyBearSum+=s,e[r.ticker].weeklyBearCount++):o?(e[r.ticker].dailyBullSum+=s,e[r.ticker].dailyBullCount++):(e[r.ticker].dailyBearSum+=s,e[r.ticker].dailyBearCount++)});const n=Object.keys(e),i=(r,s)=>n.filter(o=>e[o][s]>0).map(o=>({ticker:o,avgScore:Math.round(e[o][r]/e[o][s])})).sort((o,l)=>l.avgScore-o.avgScore).slice(0,10);jt("lb-daily-bull",i("dailyBullSum","dailyBullCount")),jt("lb-daily-bear",i("dailyBearSum","dailyBearCount")),jt("lb-weekly-bull",i("weeklyBullSum","weeklyBullCount")),jt("lb-weekly-bear",i("weeklyBearSum","weeklyBearCount"))}function jt(t,e){const n=document.getElementById(t);if(n){if(e.length===0){n.innerHTML='<tr><td colspan="2" style="text-align:center; color:#8b949e">No signals found</td></tr>';return}n.innerHTML=`
        <tbody>
            ${e.map(i=>`
                <tr class="clickable-row" data-ticker="${et(i.ticker)}">
                    <td>${et(i.ticker)}</td>
                    <td>${i.avgScore}</td>
                </tr>
            `).join("")}
        </tbody>
    `}}function Fo(){const t=document.getElementById("view-leaderboard");t&&t.addEventListener("click",e=>{const i=e.target.closest(".clickable-row");i&&i.dataset.ticker&&window.showTickerView&&window.showTickerView(i.dataset.ticker)})}function $o(t){if(!t)return t;const e=l=>({time:l[0],open:l[1],high:l[2],low:l[3],close:l[4],volume:l[5]}),n=(l,a="value")=>({time:l[0],[a]:l[1]}),i=Array.isArray(t.bars)&&t.bars.length>0&&Array.isArray(t.bars[0])?t.bars.map(e):t.bars,r=Array.isArray(t.rsi)&&t.rsi.length>0&&Array.isArray(t.rsi[0])?t.rsi.map(l=>n(l)):t.rsi,s=t.volumeDeltaRsi&&Array.isArray(t.volumeDeltaRsi.rsi)&&t.volumeDeltaRsi.rsi.length>0&&Array.isArray(t.volumeDeltaRsi.rsi[0])?t.volumeDeltaRsi.rsi.map(l=>n(l)):t.volumeDeltaRsi?.rsi||[],o=Array.isArray(t.volumeDelta)&&t.volumeDelta.length>0&&Array.isArray(t.volumeDelta[0])?t.volumeDelta.map(l=>n(l,"delta")):t.volumeDelta;return{...t,bars:i,rsi:r,volumeDeltaRsi:{rsi:s},volumeDelta:o}}function Vo(t){if(!t)return t;const e=l=>({time:l[0],open:l[1],high:l[2],low:l[3],close:l[4],volume:l[5]}),n=(l,a="value")=>({time:l[0],[a]:l[1]}),i=Array.isArray(t.latestBar)?e(t.latestBar):t.latestBar,r=Array.isArray(t.latestRsi)?n(t.latestRsi):t.latestRsi,s=Array.isArray(t.latestVolumeDeltaRsi)?n(t.latestVolumeDeltaRsi):t.latestVolumeDeltaRsi,o=Array.isArray(t.latestVolumeDelta)?n(t.latestVolumeDelta,"delta"):t.latestVolumeDelta;return{...t,latestBar:i,latestRsi:r,latestVolumeDeltaRsi:s,latestVolumeDelta:o}}async function bi(t,e,n={}){const i=new URLSearchParams;i.set("format","tuple"),Number.isFinite(n.vdRsiLength)&&i.set("vdRsiLength",String(Math.max(1,Math.floor(Number(n.vdRsiLength))))),typeof n.vdSourceInterval=="string"&&n.vdSourceInterval&&i.set("vdSourceInterval",n.vdSourceInterval),typeof n.vdRsiSourceInterval=="string"&&n.vdRsiSourceInterval&&i.set("vdRsiSourceInterval",n.vdRsiSourceInterval);const r=i.toString(),s=`/api/chart?ticker=${encodeURIComponent(t)}&interval=${e}${r?`&${r}`:""}`,o=await fetch(s,{signal:n.signal});if(typeof n.onResponseMeta=="function"&&n.onResponseMeta({status:o.status,chartCacheHeader:o.headers.get("x-chart-cache")}),!o.ok){const a=await o.json().catch(()=>({error:"Failed to fetch chart data"}));throw new Error(a.error||`HTTP ${o.status}`)}const l=await o.json();return $o(l)}async function Oo(t,e,n={}){const i=new URLSearchParams;i.set("format","tuple"),Number.isFinite(n.vdRsiLength)&&i.set("vdRsiLength",String(Math.max(1,Math.floor(Number(n.vdRsiLength))))),typeof n.vdSourceInterval=="string"&&n.vdSourceInterval&&i.set("vdSourceInterval",n.vdSourceInterval),typeof n.vdRsiSourceInterval=="string"&&n.vdRsiSourceInterval&&i.set("vdRsiSourceInterval",n.vdRsiSourceInterval);const r=i.toString(),s=`/api/chart/latest?ticker=${encodeURIComponent(t)}&interval=${e}${r?`&${r}`:""}`,o=await fetch(s,{signal:n.signal});if(typeof n.onResponseMeta=="function"&&n.onResponseMeta({status:o.status,chartCacheHeader:o.headers.get("x-chart-cache")}),!o.ok){const a=await o.json().catch(()=>({error:"Failed to fetch latest chart data"}));throw new Error(a.error||`HTTP ${o.status}`)}const l=await o.json();return Vo(l)}class O{static SCALE_LABEL_CHARS=4;static SCALE_MIN_WIDTH_PX=56;static RSI_DATA_MIN=0;static RSI_DATA_MAX=100;static RSI_AXIS_MIN=20;static RSI_AXIS_MAX=80;static MIDLINE_VALUE=50;container;chart;series;lineTools;displayMode;lineColor="#58a6ff";midlineColor="#ffffff";midlineStyle="dotted";data;seriesData=[];referenceLines=[];midlinePriceLine=null;priceData=[];priceByTime=new Map;indexByTime=new Map;divergencePointTimeKeys=new Set;divergenceToolActive=!1;highlightSeries=null;firstPoint=null;divergencePoints=[];static MAX_HIGHLIGHT_POINTS=2e3;static FUTURE_TIMELINE_TRADING_DAYS=252;trendLineSeriesList=[];trendlineCrossLabels=[];trendlineDefinitions=[];timelineSeries=null;suppressExternalSync=!1;onTrendLineDrawn;constructor(e){this.container=e.container,this.displayMode=e.displayMode,this.lineColor=e.lineColor||this.lineColor,this.midlineColor=e.midlineColor||this.midlineColor,this.midlineStyle=e.midlineStyle||this.midlineStyle,this.data=this.normalizeRSIData(e.data),this.priceData=e.priceData||[],this.rebuildLookupMaps(),this.seriesData=this.buildSeriesData(this.data,this.priceData),this.onTrendLineDrawn=e.onTrendLineDrawn,this.chart=LightweightCharts.createChart(e.container,{height:400,layout:{background:{color:"#0d1117"},textColor:"#c9d1d9",fontFamily:"'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",attributionLogo:!1},grid:{vertLines:{visible:!1},horzLines:{visible:!1}},timeScale:{visible:!0,timeVisible:!0,secondsVisible:!1,borderVisible:!0,ticksVisible:!0,fixRightEdge:!1,rightBarStaysOnScroll:!1,rightOffset:10,tickMarkFormatter:(n,i)=>this.formatTickMark(n,i),borderColor:"#21262d"},rightPriceScale:{borderColor:"#21262d",minimumWidth:O.SCALE_MIN_WIDTH_PX,entireTextOnly:!0,scaleMargins:{top:.2,bottom:.2}},crosshair:{mode:1},handleScroll:{pressedMouseMove:!0,horzTouchDrag:!0,vertTouchDrag:!1,mouseWheel:!0},handleScale:{mouseWheel:!0,pinch:!0,axisPressedMouseMove:{time:!0,price:!1},axisDoubleClickReset:{time:!0,price:!1}}}),this.addReferenceLine(50,"Midline",this.midlineColor,this.midlineStyleToLineStyle(this.midlineStyle)),this.updateSeries(),this.updateTimelineSeriesData(),this.chart.subscribeCrosshairMove(n=>{this.divergenceToolActive&&n&&n.time}),this.chart.subscribeClick(n=>{this.divergenceToolActive&&n&&n.time&&this.detectAndHighlightDivergence(n.time)}),this.chart.timeScale().subscribeVisibleLogicalRangeChange(()=>{this.refreshTrendlineCrossLabels()})}normalizeRSIData(e){return e.filter(n=>n&&(typeof n.time=="string"||typeof n.time=="number")&&Number.isFinite(Number(n.value))).map(n=>({...n,value:Math.max(O.RSI_DATA_MIN,Math.min(O.RSI_DATA_MAX,Number(n.value)))}))}formatRSIScaleLabel(e){if(!Number.isFinite(e))return"";const n=Number(e).toFixed(1);return n.length>=O.SCALE_LABEL_CHARS?n:n.padEnd(O.SCALE_LABEL_CHARS," ")}fixedRSIAutoscaleInfoProvider(){return{priceRange:{minValue:O.RSI_AXIS_MIN,maxValue:O.RSI_AXIS_MAX}}}timeKey(e){return typeof e=="number"?String(e):e}rebuildLookupMaps(){this.priceByTime.clear(),this.indexByTime.clear();for(let e=0;e<this.data.length;e++){const n=this.data[e];this.indexByTime.set(this.timeKey(n.time),e)}for(const e of this.priceData){const n=Number(e.close);Number.isFinite(n)&&this.priceByTime.set(this.timeKey(e.time),n)}}toDateFromScaleTime(e){if(typeof e=="number"&&Number.isFinite(e))return new Date(e*1e3);if(typeof e=="string"&&e.trim()){const n=e.includes("T")?e:`${e.replace(" ","T")}Z`,i=new Date(n);return Number.isFinite(i.getTime())?i:null}return e&&typeof e=="object"&&Number.isFinite(e.year)&&Number.isFinite(e.month)&&Number.isFinite(e.day)?new Date(Date.UTC(Number(e.year),Number(e.month)-1,Number(e.day),0,0,0)):null}toUnixSeconds(e){if(typeof e=="number"&&Number.isFinite(e))return e;if(typeof e!="string"||!e.trim())return null;const n=e.includes("T")?e:`${e.replace(" ","T")}Z`,r=new Date(n).getTime();return Number.isFinite(r)?Math.floor(r/1e3):null}formatTickMark(e,n){const i=this.toDateFromScaleTime(e);return i?n===0?i.toLocaleDateString("en-US",{year:"numeric",timeZone:K()}):n===1?i.toLocaleDateString("en-US",{month:"short",timeZone:K()}):i.toLocaleDateString("en-US",{day:"numeric",timeZone:K()}):""}midlineStyleToLineStyle(e){return e==="solid"?0:1}isSyncSuppressed(){return this.suppressExternalSync}inferBarStepSeconds(){if(this.data.length<2)return 1800;const e=[];for(let n=1;n<this.data.length;n++){const i=this.data[n-1]?.time,r=this.data[n]?.time;if(typeof i!="number"||typeof r!="number")continue;const s=r-i;Number.isFinite(s)&&s>0&&s<=8*3600&&e.push(s)}return e.length===0?1800:(e.sort((n,i)=>n-i),e[Math.floor(e.length/2)])}barsPerTradingDayFromStep(e){return e<=300?78:e<=900?26:e<=1800?13:e<=3600?7:2}futureBarsForOneYear(){const e=this.inferBarStepSeconds();return this.barsPerTradingDayFromStep(e)*252}ensureTimelineSeries(){this.timelineSeries||(this.timelineSeries=this.chart.addLineSeries({color:"rgba(0, 0, 0, 0)",lineVisible:!1,pointMarkersVisible:!1,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1}))}updateTimelineSeriesData(){if(this.ensureTimelineSeries(),!this.timelineSeries||this.data.length===0)return;const e=this.toUnixSeconds(this.data[this.data.length-1]?.time);if(e===null)return;const n=[{time:e}];let i=e,r=0;for(;r<O.FUTURE_TIMELINE_TRADING_DAYS;){i+=86400;const s=new Date(i*1e3).getUTCDay();s===0||s===6||(n.push({time:i}),r+=1)}this.timelineSeries.setData(n)}buildSeriesData(e,n){if(!n||n.length===0)return e;const i=new Map;for(const r of e)i.set(String(r.time),Number(r.value));return n.map(r=>{const s=i.get(String(r.time));return Number.isFinite(s)?{time:r.time,value:s}:{time:r.time}})}addReferenceLine(e,n,i,r=2){if(this.referenceLines.push({value:e,label:n,color:i,lineStyle:r}),this.series){const s=this.series.createPriceLine({price:e,color:i,lineWidth:1,lineStyle:r,axisLabelVisible:!1,title:n});n==="Midline"&&(this.midlinePriceLine=s)}}updateSeries(){this.series&&this.chart.removeSeries(this.series),this.midlinePriceLine=null,this.displayMode==="line"?this.series=this.chart.addLineSeries({color:this.lineColor,lineWidth:1,priceFormat:{type:"custom",minMove:1,formatter:e=>this.formatRSIScaleLabel(Number(e))},autoscaleInfoProvider:()=>this.fixedRSIAutoscaleInfoProvider(),priceLineVisible:!1,lastValueVisible:!1}):this.series=this.chart.addHistogramSeries({color:this.lineColor,priceFormat:{type:"custom",minMove:1,formatter:e=>this.formatRSIScaleLabel(Number(e))},autoscaleInfoProvider:()=>this.fixedRSIAutoscaleInfoProvider(),priceLineVisible:!1,lastValueVisible:!1}),this.displayMode==="line"?this.series.setData(this.seriesData):this.series.setData(this.seriesData.map(e=>Number.isFinite(Number(e.value))?{time:e.time,value:e.value,color:this.lineColor}:{time:e.time})),this.referenceLines.forEach(e=>{const n=this.series.createPriceLine({price:e.value,color:e.color,lineWidth:1,lineStyle:e.lineStyle,axisLabelVisible:!1,title:e.label});e.label==="Midline"&&(this.midlinePriceLine=n)})}setDisplayMode(e){this.displayMode!==e&&(this.displayMode=e,this.updateSeries(),this.refreshTrendlineCrossLabels())}setLineColor(e){e&&(this.lineColor=e,this.displayMode==="line"&&this.series?this.series.applyOptions({color:e}):this.displayMode!=="line"&&this.series&&(this.series.applyOptions({color:e}),this.series.setData(this.seriesData.map(n=>Number.isFinite(Number(n.value))?{time:n.time,value:n.value,color:this.lineColor}:{time:n.time}))))}setMidlineOptions(e,n){e&&(this.midlineColor=e),n&&(this.midlineStyle=n);const i=this.midlineStyleToLineStyle(this.midlineStyle);this.referenceLines=this.referenceLines.map(r=>r.label!=="Midline"?r:{...r,color:this.midlineColor,lineStyle:i}),this.midlinePriceLine&&this.midlinePriceLine.applyOptions({color:this.midlineColor,lineStyle:i})}setData(e,n){this.clearDivergence(),this.data=this.normalizeRSIData(e),n&&(this.priceData=n),this.rebuildLookupMaps(),this.seriesData=this.buildSeriesData(this.data,this.priceData),this.series&&(this.displayMode==="line"?this.series.setData(this.seriesData):this.series.setData(this.seriesData.map(i=>Number.isFinite(Number(i.value))?{time:i.time,value:i.value,color:this.lineColor}:{time:i.time}))),this.updateTimelineSeriesData(),this.refreshTrendlineCrossLabels()}updateLatestPoint(e,n){if(!e||typeof e.time!="string"&&typeof e.time!="number")return!1;const i=Number(e.value);if(!Number.isFinite(i)||this.data.length===0)return!1;const r=this.data.length-1,s=this.data[r]?.time,o=this.timeKey(s),l=this.timeKey(e.time);if(o!==l)return!1;const a=Math.max(O.RSI_DATA_MIN,Math.min(O.RSI_DATA_MAX,i));if(this.data[r]={...this.data[r],value:a},n&&this.timeKey(n.time)===o){const d=Number(n.close);Number.isFinite(d)&&(this.priceData.length>0&&this.timeKey(this.priceData[this.priceData.length-1].time)===o&&(this.priceData[this.priceData.length-1]={...this.priceData[this.priceData.length-1],close:d}),this.priceByTime.set(o,d))}return this.seriesData.length>0&&this.timeKey(this.seriesData[this.seriesData.length-1].time)===o?this.seriesData[this.seriesData.length-1]={time:s,value:a}:this.seriesData=this.buildSeriesData(this.data,this.priceData),this.series&&(this.displayMode==="line"?this.series.update({time:s,value:a}):this.series.update({time:s,value:a,color:this.lineColor})),this.refreshTrendlineCrossLabels(),!0}getChart(){return this.chart}getSeries(){return this.series}getPersistedTrendlines(){return this.trendlineDefinitions.map(e=>({...e}))}restorePersistedTrendlines(e){if(this.clearDivergence(),!(!Array.isArray(e)||e.length===0))for(const n of e){if(!n)continue;const i=n.time1,r=n.time2,s=Number(n.value1),o=Number(n.value2);typeof i!="string"&&typeof i!="number"||typeof r!="string"&&typeof r!="number"||!Number.isFinite(s)||!Number.isFinite(o)||this.drawTrendLine(i,s,r,o,!0)}}refreshTrendlineLabels(){this.refreshTrendlineCrossLabels()}getLineTools(){return this.lineTools}activateDivergenceTool(){this.divergenceToolActive=!0;const e=this.chart.chartElement();e&&(e.style.cursor="crosshair")}deactivateDivergenceTool(){this.divergenceToolActive=!1;const e=this.chart.chartElement();e&&(e.style.cursor="default"),this.clearHighlights(),this.firstPoint=null,this.divergencePoints=[],this.divergencePointTimeKeys.clear()}detectAndHighlightDivergence(e){const n=this.timeKey(e),i=this.indexByTime.get(n);if(i===void 0){console.log("Clicked point not found in RSI data");return}const r=this.data[i].value,s=this.priceByTime.get(n);if(!Number.isFinite(s)){console.log("Corresponding price data not found");return}const o=Number(s);if(this.firstPoint){if(!this.divergencePointTimeKeys.has(n)){console.log("Second point must be one of the highlighted divergence points");return}console.log(`Drawing trend line from (RSI: ${this.firstPoint.rsi.toFixed(2)}) to (RSI: ${r.toFixed(2)})`),this.drawTrendLine(this.firstPoint.time,this.firstPoint.rsi,e,r),this.clearHighlights(),this.deactivateDivergenceTool(),this.onTrendLineDrawn?.()}else{this.firstPoint={time:e,rsi:r,price:o,index:i},this.divergencePoints=[],this.divergencePointTimeKeys.clear();for(let l=i+1;l<this.data.length;l++){const a=this.data[l].value,d=this.data[l].time,c=this.priceByTime.get(this.timeKey(d));if(Number.isFinite(c)){const u=Number(c),m=a<r&&u>o,h=a>r&&u<o;(m||h)&&(this.divergencePoints.push({time:d,value:a}),this.divergencePointTimeKeys.add(this.timeKey(d)))}}console.log(`Found ${this.divergencePoints.length} divergence points from origin (RSI: ${r.toFixed(2)}, Price: ${o.toFixed(2)})`),this.highlightPoints(this.divergencePoints)}}highlightPoints(e){if(this.clearHighlights(),e.length===0)return;this.highlightSeries=this.chart.addLineSeries({color:"#ff6b6b",lineVisible:!1,pointMarkersVisible:!0,pointMarkersRadius:2,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1,autoscaleInfoProvider:()=>this.fixedRSIAutoscaleInfoProvider()});const n=Math.max(1,Math.ceil(e.length/O.MAX_HIGHLIGHT_POINTS)),i=n===1?e:e.filter((r,s)=>s%n===0);this.highlightSeries.setData(i)}clearHighlights(){this.highlightSeries&&(this.chart.removeSeries(this.highlightSeries),this.highlightSeries=null)}formatMmDdYyFromUnixSeconds(e){return Number.isFinite(e)?Ot("en-US",{month:"2-digit",day:"2-digit",year:"2-digit"}).format(new Date(Math.round(Number(e))*1e3)):"N/A"}createTrendlineCrossLabelElement(e){const n=document.createElement("div");return n.className="trendline-cross-label",n.textContent=e,n.style.position="absolute",n.style.zIndex="29",n.style.minHeight="24px",n.style.display="inline-flex",n.style.alignItems="center",n.style.padding="0 8px",n.style.borderRadius="4px",n.style.border="1px solid #30363d",n.style.background="#161b22",n.style.color="#c9d1d9",n.style.fontSize="12px",n.style.fontFamily="'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",n.style.pointerEvents="none",n.style.whiteSpace="nowrap",n.style.transform="translate(-50%, calc(-100% - 6px))",n}refreshTrendlineCrossLabels(){if(!this.chart||!this.series||!this.container)return;const e=this.container.clientWidth,n=this.container.clientHeight;for(const i of this.trendlineCrossLabels){const r=this.chart.timeScale().timeToCoordinate(i.anchorTime),s=this.series.priceToCoordinate(i.anchorValue);if(!Number.isFinite(r)||!Number.isFinite(s)||r<0||r>e||s<0||s>n){i.element.style.display="none";continue}i.element.style.display="inline-flex",i.element.style.left=`${Math.round(r)}px`,i.element.style.top=`${Math.round(Math.max(8,s))}px`}}clearTrendlineCrossLabels(){for(const e of this.trendlineCrossLabels)e.element.remove();this.trendlineCrossLabels=[]}addTrendlineCrossLabel(e,n,i){const r=this.createTrendlineCrossLabelElement(i);this.container.appendChild(r),this.trendlineCrossLabels.push({element:r,anchorTime:e,anchorValue:n}),this.refreshTrendlineCrossLabels()}indexToUnixSeconds(e,n,i,r,s){if(!Number.isFinite(e))return null;if(e>n)return r===null?null:r+(e-n)*s;if(e<0)return i===null?null:i+e*s;const o=Math.max(0,Math.floor(e)),l=Math.min(n,Math.ceil(e)),a=this.toUnixSeconds(this.data[o]?.time),d=this.toUnixSeconds(this.data[l]?.time);if(o===l)return a;if(Number.isFinite(a)&&Number.isFinite(d)){const c=e-o;return Number(a)+(Number(d)-Number(a))*c}return Number.isFinite(a)?Number(a)+(e-o)*s:i===null?null:i+e*s}computeTrendlineMidlineCrossUnixSeconds(e,n,i,r,s,o,l){if(!Number.isFinite(i)||Math.abs(i)<1e-12)return null;const a=e+(O.MIDLINE_VALUE-n)/i;return Number.isFinite(a)?this.indexToUnixSeconds(a,r,s,o,l):null}drawTrendLine(e,n,i,r,s=!0){const o=this.chart.timeScale().getVisibleLogicalRange?.();this.suppressExternalSync=!0;try{const l=this.indexByTime.get(this.timeKey(e)),a=this.indexByTime.get(this.timeKey(i));if(l===void 0||a===void 0){console.error("Could not find indices for trend line points");return}if(a===l)return;const d=(r-n)/(a-l),c=[],u=this.futureBarsForOneYear(),m=this.data.length-1,h=m+u,f=this.inferBarStepSeconds(),g=this.toUnixSeconds(this.data[0]?.time),S=this.data[m]?.time,b=this.toUnixSeconds(S);for(let D=l;D<=h;D++){const L=n+d*(D-l);if(L<O.RSI_DATA_MIN||L>O.RSI_DATA_MAX)break;let J=null;D<=m?J=this.data[D]?.time??null:b!==null&&(J=b+(D-m)*f),J!=null&&c.push({time:J,value:L})}if(!c.length)return;const p=this.chart.addLineSeries({color:"#ffa500",lineWidth:1,lineStyle:0,autoscaleInfoProvider:()=>this.fixedRSIAutoscaleInfoProvider(),priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1});this.trendLineSeriesList.push(p),p.setData(c);const v=this.computeTrendlineMidlineCrossUnixSeconds(l,n,d,m,g,b,f);this.addTrendlineCrossLabel(e,n,this.formatMmDdYyFromUnixSeconds(v)),s&&this.trendlineDefinitions.push({time1:e,value1:Number(n),time2:i,value2:Number(r)})}finally{if(o)try{this.chart.timeScale().setVisibleLogicalRange(o)}catch{}this.suppressExternalSync=!1}}clearDivergence(e=!1){const n=e?this.chart.timeScale().getVisibleLogicalRange?.():null;e&&(this.suppressExternalSync=!0);try{this.clearHighlights(),this.clearTrendlineCrossLabels();for(const i of this.trendLineSeriesList)try{this.chart.removeSeries(i)}catch{}this.trendLineSeriesList=[],this.trendlineDefinitions=[],this.firstPoint=null,this.divergencePoints=[],this.divergencePointTimeKeys.clear()}finally{if(e&&n)try{this.chart.timeScale().setVisibleLogicalRange(n)}catch{}e&&(this.suppressExternalSync=!1)}}resize(){this.chart&&(this.chart.resize(this.chart.options().width,400),this.refreshTrendlineCrossLabels())}destroy(){this.chart&&(this.clearTrendlineCrossLabels(),this.chart.remove())}}let N=null,Q="4hour",x=null,G=null,ni=null,k=null,I=null,Z=null,ii=null,ri=null,z=null,ke=null,si=null,A=[],ct=new Map,It=null,Tt=[],hn=[],gn=[],ln=new Set,Lt=null,Le=!1,ae=!1,it=!1,Ke=null,ji=!1,qn=0,B=null,Nt=null,Rt=new Map,ze=new Map,Dt=new Map,We=new Map,Ht=new Map,Bt=new Map,y=[],pn=[],yn=null,vn=null,bn=null,Sn=null,_=null,$=null,V=null,U=null,F=null,ue=!1,fe=!1,dt=!1,ut=!1,ft=null,mt=null,oi=null,li=null,Vr=null,Or=null,Ki=!1,Ye=null,Ct=null,Zi=null,Gn=!1,j=new Map,Yi=!1,jn=null,Kn=null,Ne=new Map;const Ur="✎",Uo="⌫",Hr="D",Ho=120,zo=900*1e3,Wo=900*1e3,qo=16,zr="custom_chart_session_cache_v1",Go=6,jo=9e5,zt=10,Ko=252,ee=4,_t=56,Zo="Invalid symbol",Wr="#21262d",Yo="⚙",qr="custom_chart_settings_v1",Gr="custom_chart_trendlines_v1",Zn="top-pane-ticker-label",Si="top-pane-badge",Xi=38,jr=6,Di=8,wi=8,ie=24,Dn=6,Xo="#2962FF",Jo=50,Qo=50,el=20,tl=80,Kr=0,Zr=100,nl=2e3,il="#ff6b6b",rl="#ffa500",Yr="#089981",Xr="#f23645",Jr=[{value:"1min",label:"1 min"},{value:"5min",label:"5 min"},{value:"15min",label:"15 min"},{value:"30min",label:"30 min"},{value:"1hour",label:"1 hour"},{value:"4hour",label:"4 hour"}],Qr=180,sl={"5min":[],"15min":[],"30min":[],"1hour":[],"4hour":["1day"],"1day":["4hour","1week"],"1week":["1day"]},xt={length:14,lineColor:"#58a6ff",midlineColor:"#ffffff",midlineStyle:"dotted"},Xe={length:14,lineColor:Xo,midlineColor:"#ffffff",midlineStyle:"dotted",sourceInterval:"1min"},se={sourceInterval:"1min",divergenceTable:!0,divergentPriceBars:!0,bullishDivergentColor:"#26a69a",bearishDivergentColor:"#ef5350",neutralDivergentColor:"#8b949e"},Se={maSourceMode:"daily",verticalGridlines:!1,horizontalGridlines:!1,ma:[{enabled:!0,type:"EMA",length:8,color:"#ffa500"},{enabled:!0,type:"EMA",length:21,color:"#8a2be2"},{enabled:!0,type:"SMA",length:50,color:"#00bcd4"},{enabled:!1,type:"SMA",length:200,color:"#90ee90"}]},ce=["vd-chart-container","price-chart-container","rsi-chart-container","vd-rsi-chart-container"];let Y=[...ce],kt=null;const T={...xt},C={...Xe},w={...se},E={maSourceMode:Se.maSourceMode,verticalGridlines:Se.verticalGridlines,horizontalGridlines:Se.horizontalGridlines,ma:Se.ma.map(t=>({...t,series:null,values:[]}))};function Kt(t,e){const n=e==="price"?yn:e==="volumeDeltaRsi"?vn:e==="volumeDelta"?bn:Sn;if(n&&n.parentElement===t)return n;const i=document.createElement("div"),r=e==="price"?"month-grid-overlay-price":e==="volumeDeltaRsi"?"month-grid-overlay-volume-delta-rsi":e==="volumeDelta"?"month-grid-overlay-volume-delta":"month-grid-overlay-rsi";return i.className=`month-grid-overlay ${r}`,i.style.position="absolute",i.style.top="0",i.style.right="0",i.style.bottom="0",i.style.left="0",i.style.pointerEvents="none",i.style.zIndex="6",t.appendChild(i),e==="price"?yn=i:e==="volumeDeltaRsi"?vn=i:e==="volumeDelta"?bn=i:Sn=i,i}function Ee(t){if(typeof t=="number"&&Number.isFinite(t))return t;if(typeof t=="string"&&t.trim()){const e=Date.parse(t.includes("T")?t:`${t.replace(" ","T")}Z`);if(Number.isFinite(e))return Math.floor(e/1e3)}return null}function ol(t){if(typeof t=="number"&&Number.isFinite(t))return new Date(t*1e3);if(typeof t=="string"&&t.trim()){const e=new Date(t.includes("T")?t:`${t.replace(" ","T")}Z`);return Number.isFinite(e.getTime())?e:null}return t&&typeof t=="object"&&Number.isFinite(t.year)&&Number.isFinite(t.month)&&Number.isFinite(t.day)?new Date(Date.UTC(Number(t.year),Number(t.month)-1,Number(t.day),0,0,0)):null}function Ci(t,e){const n=ol(t);if(!n)return"";const i=K();return e===0?n.toLocaleDateString("en-US",{year:"numeric",timeZone:i}):e===1?n.toLocaleDateString("en-US",{month:"short",timeZone:i}):n.toLocaleDateString("en-US",{day:"numeric",timeZone:i})}function ll(t){const e=Ot("en-US",{year:"numeric",month:"2-digit"}).formatToParts(new Date(t*1e3)),n=e.find(r=>r.type==="year")?.value||"",i=e.find(r=>r.type==="month")?.value||"";return`${n}-${i}`}function al(t){const e=[];let n="";for(const i of t){const r=Ee(i?.time);if(r===null)continue;const s=ll(r);s!==n&&(e.push(r),n=s)}return e}function Ji(t){return Ot("en-CA",{year:"numeric",month:"2-digit",day:"2-digit"}).format(new Date(t*1e3))}function cl(t){if(!Array.isArray(t)||t.length===0)return[];const e=Ee(t[t.length-1]?.time);if(!Number.isFinite(e))return[];const n=[{time:Number(e)}];let i=Number(e),r=0;for(;r<Ko;){i+=86400;const s=new Date(i*1e3).getUTCDay();s===0||s===6||(n.push({time:i}),r+=1)}return n}function es(t){const e=cl(t);ni&&ni.setData(e),ii&&ii.setData(e),si&&si.setData(e)}function dl(t,e){if(!Array.isArray(t)||t.length===0)return[];if(t.length===1)return[50];const n=Math.max(1,Math.floor(e||14)),i=new Array(t.length).fill(50),r=[],s=[];let o=0,l=0;for(let a=1;a<t.length;a++){const d=t[a]-t[a-1],c=d>0?d:0,u=d<0?Math.abs(d):0;if(r.push(c),s.push(u),a<n){const f=a;let g=0,S=0;for(let b=0;b<f;b++)g+=r[b],S+=s[b];o=g/f,l=S/f}else if(a===n){let f=0,g=0;for(let S=a-n;S<a;S++)f+=r[S],g+=s[S];o=f/n,l=g/n}else o=(o*(n-1)+c)/n,l=(l*(n-1)+u)/n;const h=100-100/(1+(l===0?100:o/l));i[a]=Number.isFinite(h)?h:i[a-1]}return i[0]=i[1]??50,i}function ts(t,e){if(!t||t.length===0)return[];const n=t.map(s=>Number(s.close)).filter(s=>Number.isFinite(s)),i=dl(n,e),r=[];for(let s=0;s<t.length;s++){const o=i[s];Number.isFinite(o)&&r.push({time:t[s].time,value:Math.round(o*100)/100})}return r}function ns(t){return Array.isArray(t)?t.filter(e=>e&&(typeof e.time=="string"||typeof e.time=="number")&&Number.isFinite(Number(e.value))).map(e=>({time:e.time,value:Number(e.value)})):[]}function ki(t,e){return[String(t||"").trim().toUpperCase(),e,String(C.length),w.sourceInterval,C.sourceInterval].join("|")}function ul(t){if(!t||typeof t!="object")return!1;const e=t;return!(!Array.isArray(e.bars)||e.bars.length===0)}function Ei(){for(;j.size>qo;){const t=j.keys().next().value;if(!t)break;j.delete(t)}}function is(){if(!Yi&&(Yi=!0,!(typeof window>"u")))try{const t=window.sessionStorage.getItem(zr);if(!t)return;const e=JSON.parse(t);if(!e||e.version!==1||!Array.isArray(e.entries))return;const n=[...e.entries].filter(i=>i&&typeof i.key=="string"&&Number.isFinite(i.updatedAt)&&ul(i.data)).sort((i,r)=>Number(i.updatedAt)-Number(r.updatedAt));for(const i of n)j.set(i.key,{data:i.data,updatedAt:Number(i.updatedAt)});Ei()}catch{}}function rs(){typeof window>"u"||jn===null&&(jn=window.setTimeout(()=>{jn=null;try{const t=Array.from(j.entries()).reverse(),e=[];let n=0;for(const[r,s]of t){if(!s||!s.data||!Number.isFinite(s.updatedAt))continue;const o={key:r,updatedAt:s.updatedAt,data:s.data},l=JSON.stringify(o);if(l&&!(n+l.length>jo)&&(e.push(o),n+=l.length,e.length>=Go))break}const i=JSON.stringify({version:1,entries:e});window.sessionStorage.setItem(zr,i)}catch{}},180))}function fl(){is();const t=Date.now();let e=!1;for(const[i,r]of j.entries())(!r||!r.updatedAt||t-r.updatedAt>Wo)&&(j.delete(i),e=!0);const n=j.size;Ei(),j.size!==n&&(e=!0),e&&rs()}function Ti(t){fl();const e=j.get(t);return e&&(j.delete(t),j.set(t,e)),e?e.data:null}function Li(t,e){is(),j.delete(t),j.set(t,{data:e,updatedAt:Date.now()}),Ei(),rs()}function Qi(t){const e=Array.isArray(t?.bars)?t.bars:[];if(!e.length)return"none";const n=e[e.length-1];return[e.length,M(n.time),Number(n.open),Number(n.high),Number(n.low),Number(n.close),Number(n.volume)].join("|")}const ss={"5min":{fetchMs:[],renderMs:[]},"15min":{fetchMs:[],renderMs:[]},"30min":{fetchMs:[],renderMs:[]},"1hour":{fetchMs:[],renderMs:[]},"4hour":{fetchMs:[],renderMs:[]},"1day":{fetchMs:[],renderMs:[]},"1week":{fetchMs:[],renderMs:[]}},xi={"5min":{fetchCount:0,renderCount:0,fetchP95Ms:0,renderP95Ms:0,responseCacheHit:0,responseCacheMiss:0,responseCacheUnknown:0},"15min":{fetchCount:0,renderCount:0,fetchP95Ms:0,renderP95Ms:0,responseCacheHit:0,responseCacheMiss:0,responseCacheUnknown:0},"30min":{fetchCount:0,renderCount:0,fetchP95Ms:0,renderP95Ms:0,responseCacheHit:0,responseCacheMiss:0,responseCacheUnknown:0},"1hour":{fetchCount:0,renderCount:0,fetchP95Ms:0,renderP95Ms:0,responseCacheHit:0,responseCacheMiss:0,responseCacheUnknown:0},"4hour":{fetchCount:0,renderCount:0,fetchP95Ms:0,renderP95Ms:0,responseCacheHit:0,responseCacheMiss:0,responseCacheUnknown:0},"1day":{fetchCount:0,renderCount:0,fetchP95Ms:0,renderP95Ms:0,responseCacheHit:0,responseCacheMiss:0,responseCacheUnknown:0},"1week":{fetchCount:0,renderCount:0,fetchP95Ms:0,renderP95Ms:0,responseCacheHit:0,responseCacheMiss:0,responseCacheUnknown:0}};function os(t){if(!t.length)return 0;const e=[...t].sort((i,r)=>i-r),n=Math.min(e.length-1,Math.max(0,Math.ceil(e.length*.95)-1));return Math.round(e[n]*100)/100}function ls(t,e){!Number.isFinite(e)||e<0||(t.push(Math.round(e*100)/100),t.length>Qr&&t.shift())}function as(t,e,n){const i=ss[t],r=xi[t];ls(i.fetchMs,e),r.fetchCount+=1,r.fetchP95Ms=os(i.fetchMs),n==="hit"?r.responseCacheHit+=1:n==="miss"?r.responseCacheMiss+=1:r.responseCacheUnknown+=1}function er(t,e){const n=ss[t],i=xi[t];ls(n.renderMs,e),i.renderCount+=1,i.renderP95Ms=os(n.renderMs)}function ml(){typeof window>"u"||(window.__chartPerfMetrics={getSnapshot:()=>({byInterval:xi,sampleMax:Qr})})}async function tr(t,e){const n=String(t||"").trim().toUpperCase();if(!n)return;const i=sl[e]||[],r=[];for(const s of i){const o=ki(n,s);if(Ti(o))continue;if(Ne.has(o)){r.push(Ne.get(o));continue}const l=bi(n,s,{vdRsiLength:C.length,vdSourceInterval:w.sourceInterval,vdRsiSourceInterval:C.sourceInterval}).then(a=>{Li(o,a)}).catch(()=>{}).finally(()=>{Ne.delete(o)});Ne.set(o,l),r.push(l)}await Promise.allSettled(r),_a(e).catch(()=>{})}ml();function je(t){if(!Array.isArray(t))return[...ce];const e=new Set(ce),n=[];for(const i of t){if(typeof i!="string"||!e.has(i))continue;const r=i;n.includes(r)||n.push(r)}for(const i of ce)n.includes(i)||n.push(i);return n}function hl(t){if(!Number.isFinite(t))return"";const e=Math.max(0,Math.min(100,Number(t)));let n="";return Math.abs(e)>=100?n=String(Math.round(e)):n=e.toFixed(1),n.length>=ee?n:n.padEnd(ee," ")}function gl(t){return Array.isArray(t)?t.filter(e=>e&&(typeof e.time=="string"||typeof e.time=="number")&&Number.isFinite(Number(e.delta))).map(e=>({time:e.time,delta:Number(e.delta)})):[]}function pl(t){if(!Number.isFinite(t))return"";const e=t<0?"-":"",n=Math.abs(t),i=ee-e.length;if(i<=0)return e.slice(0,ee);const r=(d,c)=>{if(c<=0)return Math.trunc(d);const u=10**c;return Math.trunc(d*u)/u},s=d=>d.replace(/\.0+$/,"").replace(/(\.\d*?)0+$/,"$1"),o=(d,c)=>{const u=n/d;if(d!==1&&u<1)return null;const m=i-c.length;if(m<=0)return null;let h=0;for(c?u<10&&(h=1):u>=10&&u<100?h=1:u<10&&(h=2);h>=0;){const f=s(r(u,h).toFixed(h));if(f.length<=m)return`${e}${f}${c}`;h-=1}return null},l=[{divisor:1e9,suffix:"B"},{divisor:1e6,suffix:"M"},{divisor:1e3,suffix:"K"},{divisor:1,suffix:""}];for(const d of l){const c=o(d.divisor,d.suffix);if(c)return c.length>=ee?c:c.padEnd(ee," ")}const a=[{divisor:1e3,suffix:"K"},{divisor:1e6,suffix:"M"},{divisor:1e9,suffix:"B"}];for(const d of a){const c=i-d.suffix.length;if(c<=0)continue;const u=n/d.divisor,m=String(Math.max(1,Math.trunc(u)));if(m.length>c)continue;const h=`${e}${m}${d.suffix}`;return h.length>=ee?h:h.padEnd(ee," ")}return e?`${e}0`.padEnd(ee," "):"0".padEnd(ee," ")}function wn(t){if(!Array.isArray(t))return[];const e=[];for(const n of t){if(!n||typeof n!="object")continue;const i=n,r=i.time1,s=i.time2,o=Number(i.value1),l=Number(i.value2);typeof r!="string"&&typeof r!="number"||typeof s!="string"&&typeof s!="number"||!Number.isFinite(o)||!Number.isFinite(l)||e.push({time1:r,value1:o,time2:s,value2:l})}return e}function cs(t,e){return`${t.toUpperCase()}|${e}`}function ds(){if(typeof window>"u")return{};try{const t=window.localStorage.getItem(Gr);if(!t)return{};const e=JSON.parse(t),n={};for(const[i,r]of Object.entries(e||{}))n[i]={rsi:wn(r?.rsi),volumeDeltaRsi:wn(r?.volumeDeltaRsi)};return n}catch{return{}}}function yl(t){if(!(typeof window>"u"))try{window.localStorage.setItem(Gr,JSON.stringify(t))}catch{}}function vl(t,e){const i=ds()[cs(t,e)];return{rsi:wn(i?.rsi),volumeDeltaRsi:wn(i?.volumeDeltaRsi)}}function Pn(){if(!N)return;const t=ds(),e=cs(N,Q);t[e]={rsi:k?.getPersistedTrendlines()??[],volumeDeltaRsi:gn.map(n=>({...n}))},yl(t)}function R(){if(!(typeof window>"u"))try{const t={price:{maSourceMode:E.maSourceMode,verticalGridlines:E.verticalGridlines,horizontalGridlines:E.horizontalGridlines,ma:E.ma.map(e=>({enabled:e.enabled,type:e.type,length:e.length,color:e.color}))},rsi:{length:T.length,lineColor:T.lineColor,midlineColor:T.midlineColor,midlineStyle:T.midlineStyle},volumeDelta:{sourceInterval:w.sourceInterval,divergenceTable:w.divergenceTable,divergentPriceBars:w.divergentPriceBars,bullishDivergentColor:w.bullishDivergentColor,bearishDivergentColor:w.bearishDivergentColor,neutralDivergentColor:w.neutralDivergentColor},volumeDeltaRsi:{length:C.length,lineColor:C.lineColor,midlineColor:C.midlineColor,midlineStyle:C.midlineStyle,sourceInterval:C.sourceInterval},paneOrder:[...Y]};window.localStorage.setItem(qr,JSON.stringify(t))}catch{}}function bl(){if(!(Ki||typeof window>"u")){Ki=!0;try{const t=window.localStorage.getItem(qr);if(!t)return;const e=JSON.parse(t),n=e?.price;if(n&&(E.maSourceMode=n.maSourceMode==="timeframe"?"timeframe":"daily",typeof n.verticalGridlines=="boolean"&&(E.verticalGridlines=n.verticalGridlines),typeof n.horizontalGridlines=="boolean"&&(E.horizontalGridlines=n.horizontalGridlines),Array.isArray(n.ma)))for(let o=0;o<E.ma.length;o++){const l=n.ma[o];l&&(E.ma[o].enabled=!!l.enabled,E.ma[o].type=l.type==="EMA"?"EMA":"SMA",E.ma[o].length=Math.max(1,Math.floor(Number(l.length)||E.ma[o].length)),typeof l.color=="string"&&l.color.trim()&&(E.ma[o].color=l.color))}const i=e?.rsi;i&&(T.length=Math.max(1,Math.floor(Number(i.length)||T.length)),typeof i.lineColor=="string"&&i.lineColor.trim()&&(T.lineColor=i.lineColor),typeof i.midlineColor=="string"&&i.midlineColor.trim()&&(T.midlineColor=i.midlineColor),T.midlineStyle=i.midlineStyle==="solid"?"solid":"dotted");const r=e?.volumeDelta;if(r){const o=String(r.sourceInterval||"");(o==="1min"||o==="5min"||o==="15min"||o==="30min"||o==="1hour"||o==="4hour")&&(w.sourceInterval=o),typeof r.divergenceTable=="boolean"&&(w.divergenceTable=r.divergenceTable),typeof r.divergentPriceBars=="boolean"&&(w.divergentPriceBars=r.divergentPriceBars),typeof r.bullishDivergentColor=="string"&&r.bullishDivergentColor.trim()&&(w.bullishDivergentColor=r.bullishDivergentColor),typeof r.bearishDivergentColor=="string"&&r.bearishDivergentColor.trim()&&(w.bearishDivergentColor=r.bearishDivergentColor),typeof r.neutralDivergentColor=="string"&&r.neutralDivergentColor.trim()&&(w.neutralDivergentColor=r.neutralDivergentColor)}const s=e?.volumeDeltaRsi;if(s){C.length=Math.max(1,Math.floor(Number(s.length)||C.length)),typeof s.lineColor=="string"&&s.lineColor.trim()&&(C.lineColor=s.lineColor),typeof s.midlineColor=="string"&&s.midlineColor.trim()&&(C.midlineColor=s.midlineColor),C.midlineStyle=s.midlineStyle==="solid"?"solid":"dotted";const o=String(s.sourceInterval||"");(o==="1min"||o==="5min"||o==="15min"||o==="30min"||o==="1hour"||o==="4hour")&&(C.sourceInterval=o)}Y=je(e?.paneOrder)}catch{}}}function us(t,e){const n=Math.max(1,Math.floor(e)),i=new Array(t.length).fill(null);let r=0;for(let s=0;s<t.length;s++){const o=t[s];if(Number.isFinite(o)){if(r+=o,s>=n){const l=t[s-n];Number.isFinite(l)&&(r-=l)}s>=n-1&&(i[s]=r/n)}}return i}function Sl(t,e,n){const i=[],r=new Map,s=new Set;for(const d of t){const c=Ee(d?.time),u=Number(d?.close);if(c===null||!Number.isFinite(u))continue;const m=Ji(c);s.has(m)||(s.add(m),i.push(m)),r.set(m,u)}const o=i.map(d=>Number(r.get(d))),l=e==="EMA"?fs(o,n):us(o,n),a=new Map;for(let d=0;d<i.length;d++)a.set(i[d],l[d]??null);return t.map(d=>{const c=Ee(d?.time);return c===null?null:a.get(Ji(c))??null})}function fs(t,e){const n=Math.max(1,Math.floor(e)),i=new Array(t.length).fill(null);if(t.length===0)return i;const r=2/(n+1);let s=null;for(let o=0;o<t.length;o++){const l=t[o];Number.isFinite(l)&&(s===null?s=l:s=l*r+s*(1-r),i[o]=s)}return i}function ai(t){const e=typeof t=="number"?t:Number.NaN;return Number.isFinite(e)&&e>0}function Ii(){for(const t of E.ma)t.series&&x&&(x.removeSeries(t.series),t.series=null),x||(t.series=null),t.values=[]}function De(){if(!x||!y.length){Ii();return}for(const t of E.ma){const e=Math.max(1,Math.floor(Number(t.length)||1));if(t.length=e,!t.enabled){t.series&&(x.removeSeries(t.series),t.series=null),t.values=[];continue}t.series?t.series.applyOptions({color:t.color}):t.series=x.addLineSeries({color:t.color,lineWidth:1,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1});const n=E.maSourceMode==="daily"?Sl(y,t.type,e):t.type==="EMA"?fs(y.map(r=>Number(r.close)),e):us(y.map(r=>Number(r.close)),e);t.values=n;const i=y.map((r,s)=>{const o=n[s];return ai(o)?{time:r.time,value:o}:{time:r.time}});t.series.setData(i)}}function Dl(){if(!x||!Array.isArray(y)||y.length===0)return;if(E.maSourceMode==="daily"){De();return}const t=y.length-1,e=y[t],n=Number(e?.close);if(!Number.isFinite(n)){De();return}for(const i of E.ma){if(!i.enabled||!i.series)continue;const r=Math.max(1,Math.floor(Number(i.length)||1));let s=null;if(i.type==="EMA")if(t===0)s=n;else{const o=Number(i.values[t-1]);if(!Number.isFinite(o)){De();return}const l=2/(r+1);s=n*l+o*(1-l)}else if(t<r-1)s=null;else{let o=0;for(let l=t-r+1;l<=t;l++){const a=Number(y[l]?.close);if(!Number.isFinite(a)){De();return}o+=a}s=o/r}i.values.length!==y.length&&(i.values=new Array(y.length).fill(null)),i.values[t]=ai(s)?s:null,ai(s)?i.series.update({time:e.time,value:s}):i.series.update({time:e.time})}}function Zt(t){t&&(t.innerHTML="")}function Yt(t,e){if(!t||!e||(e.innerHTML="",!E.verticalGridlines)||!pn.length)return;const n=e.clientWidth||e.offsetWidth;if(!(!Number.isFinite(n)||n<=0))for(const i of pn){const r=t.timeScale().timeToCoordinate(i);if(!Number.isFinite(r)||r<0||r>n)continue;const s=document.createElement("div");s.style.position="absolute",s.style.top="0",s.style.bottom="0",s.style.left=`${Math.round(r)}px`,s.style.width="1px",s.style.background=Wr,e.appendChild(s)}}function wl(){Yt(x,yn),Yt(I,vn),Yt(z,bn),Yt(k?.getChart(),Sn),Ls()}function xe(){Kn===null&&(Kn=requestAnimationFrame(()=>{Kn=null,wl()}))}function Mi(){x&&(x.applyOptions({grid:{vertLines:{visible:!1},horzLines:{visible:E.horizontalGridlines,color:Wr}}}),xe())}function ms(){if(!_)return;const t=_.querySelector('[data-price-setting="ma-source"]'),e=_.querySelector('[data-price-setting="v-grid"]'),n=_.querySelector('[data-price-setting="h-grid"]');t&&(t.value=E.maSourceMode),e&&(e.checked=E.verticalGridlines),n&&(n.checked=E.horizontalGridlines);for(let i=0;i<E.ma.length;i++){const r=E.ma[i],s=_.querySelector(`[data-price-setting="ma-enabled-${i}"]`),o=_.querySelector(`[data-price-setting="ma-type-${i}"]`),l=_.querySelector(`[data-price-setting="ma-length-${i}"]`),a=_.querySelector(`[data-price-setting="ma-color-${i}"]`);s&&(s.checked=r.enabled),o&&(o.value=r.type),l&&(l.value=String(r.length)),a&&(a.value=r.color)}}function hs(){if(!U)return;const t=U.querySelector('[data-rsi-setting="length"]'),e=U.querySelector('[data-rsi-setting="line-color"]'),n=U.querySelector('[data-rsi-setting="midline-color"]'),i=U.querySelector('[data-rsi-setting="midline-style"]');t&&(t.value=String(T.length)),e&&(e.value=T.lineColor),n&&(n.value=T.midlineColor),i&&(i.value=T.midlineStyle)}function gs(){if(!$)return;const t=$.querySelector('[data-vd-setting="source-interval"]'),e=$.querySelector('[data-vd-setting="divergence-table"]'),n=$.querySelector('[data-vd-setting="divergent-price-bars"]'),i=$.querySelector('[data-vd-setting="divergent-bullish-color"]'),r=$.querySelector('[data-vd-setting="divergent-bearish-color"]'),s=$.querySelector('[data-vd-setting="divergent-neutral-color"]');t&&(t.value=w.sourceInterval),e&&(e.checked=w.divergenceTable),n&&(n.checked=w.divergentPriceBars),i&&(i.value=w.bullishDivergentColor),r&&(r.value=w.bearishDivergentColor),s&&(s.value=w.neutralDivergentColor)}function ps(){if(!V)return;const t=V.querySelector('[data-vd-rsi-setting="length"]'),e=V.querySelector('[data-vd-rsi-setting="line-color"]'),n=V.querySelector('[data-vd-rsi-setting="midline-color"]'),i=V.querySelector('[data-vd-rsi-setting="midline-style"]'),r=V.querySelector('[data-vd-rsi-setting="source-interval"]');t&&(t.value=String(C.length)),e&&(e.value=C.lineColor),n&&(n.value=C.midlineColor),i&&(i.value=C.midlineStyle),r&&(r.value=C.sourceInterval)}function Et(){_&&(_.style.display="none"),$&&($.style.display="none"),V&&(V.style.display="none"),U&&(U.style.display="none")}function Cl(){return je(Y)[0]}function kl(t){const e=String(t.dataset.topPaneBadgeRole||"");return e==="ticker"?0:e==="price-change"?1:100}function Ai(t){const e=Array.from(t.querySelectorAll(".pane-settings-btn, .pane-trendline-btn"));if(!e.length)return Xi;const i=e.reduce((r,s)=>{const o=s.offsetLeft+s.offsetWidth;return o>r?o:r},0)+jr;return Math.max(Xi,i)}function Mt(t){const e=Array.from(t.querySelectorAll(`.${Si}`)).filter(r=>r.style.display!=="none");if(!e.length)return;const n=e.map((r,s)=>({badge:r,index:s,priority:kl(r)})).sort((r,s)=>r.priority-s.priority||r.index-s.index).map(r=>r.badge);let i=Ai(t);for(const r of n){r.style.left=`${i}px`,r.style.top="8px",r.style.maxWidth=`calc(100% - ${i+30}px)`;const s=Math.ceil(r.getBoundingClientRect().width||r.offsetWidth||0);i+=Math.max(0,s)+jr}}function nr(t){const e=String(t||"").trim().toUpperCase();if(!e)return;const n=`https://www.tradingview.com/symbols/${encodeURIComponent(e)}/`;window.open(n,"_blank","noopener,noreferrer")}function Ni(){const t=Cl();for(const r of ce){const s=document.getElementById(r);if(!s||!(s instanceof HTMLElement))continue;const o=s.querySelector(`.${Zn}`);o&&r!==t&&o.remove()}if(!t)return;const e=document.getElementById(t);if(!e||!(e instanceof HTMLElement))return;const n=String(N||"").trim().toUpperCase();let i=e.querySelector(`.${Zn}`);if(!n){i&&i.remove();for(const r of ce){const s=document.getElementById(r);!s||!(s instanceof HTMLElement)||Mt(s)}return}if(!i){const r=Ai(e);i=document.createElement("div"),i.className=`${Zn} ${Si}`,i.dataset.topPaneBadgeRole="ticker",i.style.position="absolute",i.style.left=`${r}px`,i.style.top="8px",i.style.zIndex="32",i.style.minHeight="24px",i.style.maxWidth=`calc(100% - ${r+30}px)`,i.style.display="inline-flex",i.style.alignItems="center",i.style.padding="0 8px",i.style.borderRadius="4px",i.style.border="1px solid #30363d",i.style.background="#161b22",i.style.color="#c9d1d9",i.style.fontSize="12px",i.style.fontWeight="600",i.style.fontFamily="'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",i.style.whiteSpace="nowrap",i.style.overflow="hidden",i.style.textOverflow="ellipsis",i.style.pointerEvents="auto",i.style.cursor="pointer",i.title="Open on TradingView",i.setAttribute("role","link"),i.tabIndex=0,i.dataset.clickBound||(i.addEventListener("click",s=>{s.stopPropagation();const o=s.currentTarget;nr(String(o.dataset.tickerSymbol||""))}),i.addEventListener("keydown",s=>{if(s.key!=="Enter"&&s.key!==" ")return;s.preventDefault();const o=s.currentTarget;nr(String(o.dataset.tickerSymbol||""))}),i.dataset.clickBound="1"),e.appendChild(i)}i.dataset.tickerSymbol=n,i.textContent=n;for(const r of ce){const s=document.getElementById(r);!s||!(s instanceof HTMLElement)||Mt(s)}}function ys(t){for(const e of Y){const n=document.getElementById(e);!n||n.parentElement!==t||t.appendChild(n)}}function El(t,e,n){if(t===e)return;const i=Y.filter(o=>o!==t),r=i.indexOf(e);if(r<0)return;const s=n?r+1:r;i.splice(s,0,t),Y=je(i)}function ir(){for(const t of ce){const e=document.getElementById(t);e&&e.classList.remove("pane-drag-over")}}function vs(t){ys(t);const e=document.getElementById("price-chart-container"),n=document.getElementById("vd-rsi-chart-container"),i=document.getElementById("rsi-chart-container"),r=document.getElementById("vd-chart-container");e&&n&&i&&r&&On(e,n,i,r),Fn(),Ni()}function Xt(t){const n=je(Y).indexOf(t);return n===1||n===3}function Jt(t,e){t&&t.applyOptions({rightPriceScale:{visible:!0},timeScale:{visible:e,borderVisible:e,ticksVisible:e}})}function Fn(){Jt(x,Xt("price-chart-container")),Jt(I,Xt("vd-rsi-chart-container")),Jt(k?.getChart(),Xt("rsi-chart-container")),Jt(z,Xt("vd-chart-container"))}function Tl(t,e,n){t.dataset.paneId||(t.dataset.paneId=e);let i=t.querySelector(".pane-order-handle");i||(i=document.createElement("button"),i.type="button",i.className="pane-order-handle",i.title="Drag to reorder panes",i.textContent="",i.setAttribute("aria-label","Reorder pane"),t.appendChild(i)),i.dataset.bound||(i.setAttribute("draggable","true"),i.addEventListener("dragstart",r=>{kt=e,r.dataTransfer&&(r.dataTransfer.effectAllowed="move",r.dataTransfer.setData("text/plain",e)),ir()}),i.addEventListener("dragend",()=>{kt=null,ir()}),i.dataset.bound="1"),t.dataset.dropBound||(t.addEventListener("dragover",r=>{kt&&(r.preventDefault(),t.classList.add("pane-drag-over"),r.dataTransfer&&(r.dataTransfer.dropEffect="move"))}),t.addEventListener("dragleave",()=>{t.classList.remove("pane-drag-over")}),t.addEventListener("drop",r=>{r.preventDefault(),t.classList.remove("pane-drag-over");const s=kt;if(kt=null,!s||s===e)return;const o=Y.indexOf(s),l=Y.indexOf(e),a=o>=0&&l>=0?o<l:!0;El(s,e,a),vs(n),R()}),t.dataset.dropBound="1")}function Ll(t){Y=je(Y),ys(t);for(const e of ce){const n=document.getElementById(e);!n||!(n instanceof HTMLElement)||n.parentElement!==t||Tl(n,e,t)}Ni()}function Ri(){if(!k)return;const t=ts(y,T.length);Dt=new Map(t.filter(e=>Number.isFinite(Number(e.value))).map(e=>[M(e.time),Number(e.value)])),k.setData(t,y.map(e=>({time:e.time,close:e.close}))),k.setLineColor(T.lineColor),k.setMidlineOptions(T.midlineColor,T.midlineStyle),$n()}function bs(t){return t==="solid"?0:1}function Bi(){Z&&Z.applyOptions({color:C.lineColor,lineWidth:1}),ri&&ri.applyOptions({color:C.midlineColor,lineStyle:bs(C.midlineStyle)}),$n()}function Je(t){Bi(),t&&N&&me(N,Q)}function xl(){Ii(),E.maSourceMode=Se.maSourceMode,E.verticalGridlines=Se.verticalGridlines,E.horizontalGridlines=Se.horizontalGridlines;for(let e=0;e<E.ma.length;e++){const n=Se.ma[e];n&&(E.ma[e].enabled=n.enabled,E.ma[e].type=n.type,E.ma[e].length=n.length,E.ma[e].color=n.color,E.ma[e].series=null,E.ma[e].values=[])}Y=[...ce];const t=document.getElementById("chart-content");t&&t instanceof HTMLElement&&vs(t),Mi(),De(),ms(),R()}function Il(){T.length=xt.length,T.lineColor=xt.lineColor,T.midlineColor=xt.midlineColor,T.midlineStyle=xt.midlineStyle,Ri(),hs(),R()}function Ml(){w.sourceInterval=se.sourceInterval,w.divergenceTable=se.divergenceTable,w.divergentPriceBars=se.divergentPriceBars,w.bullishDivergentColor=se.bullishDivergentColor,w.bearishDivergentColor=se.bearishDivergentColor,w.neutralDivergentColor=se.neutralDivergentColor,N&&me(N,Q),Re(),gs(),R()}function Al(){C.length=Xe.length,C.lineColor=Xe.lineColor,C.midlineColor=Xe.midlineColor,C.midlineStyle=Xe.midlineStyle,C.sourceInterval=Xe.sourceInterval,Je(!0),ps(),R()}function Qt(t,e){const n=t.querySelector(`.pane-settings-btn[data-pane="${e}"]`);if(n)return n;const i=document.createElement("button");return i.className="pane-settings-btn",i.dataset.pane=e,i.type="button",i.title=e==="price"?"Price settings":e==="volumeDelta"?"Volume Delta settings":e==="volumeDeltaRsi"?"Volume Delta RSI settings":"RSI settings",i.textContent=Yo,i.style.position="absolute",i.style.left=`${Di}px`,i.style.top=`${wi}px`,i.style.zIndex="30",i.style.width=`${ie}px`,i.style.height=`${ie}px`,i.style.borderRadius="4px",i.style.border="1px solid #30363d",i.style.background="#161b22",i.style.color="#c9d1d9",i.style.cursor="pointer",i.style.padding="0",t.appendChild(i),i}function Nl(t){return t==="volumeDelta"?"VD":t==="volumeDeltaRsi"?"VD-RSI":t==="rsi"?"RSI":"Price"}function en(t,e){const n=t.querySelector(`.pane-name-badge[data-pane="${e}"]`);if(n)return n;const i=document.createElement("div");return i.className="pane-name-badge",i.dataset.pane=e,i.textContent=Nl(e),i.style.position="absolute",i.style.left=`${Di}px`,i.style.top=`${wi+ie+Dn}px`,i.style.zIndex="30",i.style.minWidth=`${ie}px`,i.style.height=`${ie}px`,i.style.padding="0 8px",i.style.borderRadius="4px",i.style.border="1px solid #30363d",i.style.background="#161b22",i.style.color="#c9d1d9",i.style.display="inline-flex",i.style.alignItems="center",i.style.justifyContent="center",i.style.fontSize="12px",i.style.fontWeight="600",i.style.fontFamily="'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",i.style.pointerEvents="none",i.style.userSelect="none",t.appendChild(i),i}function Ze(t,e,n,i){const r=t.querySelector(`.pane-trendline-btn[data-pane="${e}"][data-action="${n}"]`);if(r)return r;const s=document.createElement("button");return s.className="pane-trendline-btn",s.dataset.pane=e,s.dataset.action=n,s.type="button",s.title=n==="trend"?"Draw Trendline":n==="erase"?"Erase Trendline":"Divergence",s.textContent=n==="trend"?Ur:n==="erase"?Uo:Hr,s.style.position="absolute",s.style.left=`${Di+(i+1)*(ie+Dn)}px`,s.style.top=`${wi}px`,s.style.zIndex="30",s.style.width=`${ie}px`,s.style.height=`${ie}px`,s.style.borderRadius="4px",s.style.border="1px solid #30363d",s.style.background="#161b22",s.style.color="#c9d1d9",s.style.cursor="pointer",s.style.padding="0",t.appendChild(s),s}function Rl(t,e){return document.querySelector(`.pane-trendline-btn[data-pane="${t}"][data-action="${e}"]`)}function qe(t,e,n){const i=Rl(t,e);i&&(i.classList.toggle("active",n),i.style.background=n?"#1f6feb":"#161b22",i.style.color="#ffffff",i.textContent=e==="trend"?Ur:Hr)}function X(t,e){qe(t,"trend",e)}function Ss(){if(!Array.isArray(y)||y.length===0)return null;const t=y[y.length-1]?.time;if(typeof t!="string"&&typeof t!="number")return null;if(!x)return t;try{const e=x.timeScale().getVisibleLogicalRange?.(),n=Number(e?.from),i=Number(e?.to);if(!Number.isFinite(n)||!Number.isFinite(i))return t;const r=Math.round((n+i)/2),s=Math.max(0,Math.min(y.length-1,r)),o=y[s]?.time;if(typeof o=="string"||typeof o=="number")return o}catch{}return t}function Bl(){if(!k)return;const t=Ss();if(t===null)return;const e=tt(t,Dt),n=k.getChart?.(),i=k.getSeries?.();if(!(!n||!i||!Number.isFinite(e)))try{n.setCrosshairPosition(Number(e),t,i)}catch{}}function _l(){if(!I||!Z)return;const t=Ss();if(t===null)return;const e=tt(t,We);if(Number.isFinite(e))try{I.setCrosshairPosition(Number(e),t,Z)}catch{}}function Pl(){if(k){if(ae){k.deactivateDivergenceTool(),ae=!1,X("rsi",!1);return}ue&&Pt(),k.activateDivergenceTool(),ae=!0,X("rsi",!0),Bl()}}function Fl(){k?.clearDivergence(!0),k?.deactivateDivergenceTool(),ae=!1,X("rsi",!1),Pn()}function $l(){if(I){if(Le){Wt(),X("volumeDeltaRsi",!1);return}fe&&Ft(),ca(),X("volumeDeltaRsi",!0),_l()}}function Vl(){Pi(!0),Wt(),X("volumeDeltaRsi",!1),Pn()}function Ol(t){const e=Ee(t);if(e===null)return"";const n=new Date(e*1e3);return Q==="1day"||Q==="1week"?Ot("en-US",{month:"2-digit",day:"2-digit",year:"2-digit"}).format(n):n.toLocaleString("en-US",{timeZone:K(),month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1})}function Ul(t,e){const n=e==="rsi"?oi:li;if(n&&n.parentElement===t)return n.style.top="0",n.style.right="0",n.style.maxWidth="100%",n;const i=document.createElement("div");i.className=`divergence-plot-overlay divergence-plot-overlay-${e}`,i.style.position="absolute",i.style.top="0",i.style.right="0",i.style.width="468px",i.style.maxWidth="100%",i.style.height="286px",i.style.border="1px solid #30363d",i.style.borderRadius="6px",i.style.background="rgba(13, 17, 23, 0.95)",i.style.backdropFilter="blur(4px)",i.style.zIndex="35",i.style.pointerEvents="none",i.style.display="none",i.style.padding="8px",i.style.boxSizing="border-box";const r=document.createElement("div");r.style.position="relative",r.style.width="100%",r.style.height="100%";const s=document.createElement("canvas");return s.className="divergence-plot-overlay-canvas",r.appendChild(s),i.appendChild(r),t.appendChild(i),e==="rsi"?oi=i:li=i,i}function Ds(t){return t==="rsi"?Vr:Or}function ws(t,e){t==="rsi"?Vr=e:Or=e}function ht(t){const e=t==="rsi"?oi:li;e&&(e.style.display="none");const n=Ds(t);if(n){try{n.destroy()}catch{}ws(t,null)}}function Cs(t){if(!Array.isArray(y)||y.length===0)return null;const e=Bt.get(M(t));if(e!==void 0)return e;const n=Ee(t);if(n===null)return null;let i=0,r=Number.POSITIVE_INFINITY;for(let s=0;s<y.length;s++){const o=Ee(y[s]?.time);if(o===null)continue;const l=Math.abs(o-n);l<r&&(r=l,i=s)}return Number.isFinite(r)?i:null}function Hl(t){const e=[],n=[],i=[];for(let r=t;r<y.length;r++){const s=y[r],o=M(s.time),l=Number(Dt.get(o)),a=Number(We.get(o));!Number.isFinite(l)||!Number.isFinite(a)||(e.push(Ol(s.time)),n.push(l),i.push(a))}return{labels:e,rsiValues:n,volumeDeltaRsiValues:i}}function Cn(t,e){const n=t==="rsi"?document.getElementById("rsi-chart-container"):document.getElementById("vd-rsi-chart-container");if(!n||!(n instanceof HTMLElement))return;const i=Ul(n,t),r=i.querySelector(".divergence-plot-overlay-canvas");if(!r)return;if(!y.length||e<0||e>=y.length){ht(t);return}const s=Hl(e);if(s.rsiValues.length<2){ht(t);return}i.style.display="block";const o=Ds(t);if(o){o.data.labels=s.labels,o.data.datasets[0].data=s.rsiValues,o.data.datasets[0].borderColor=T.lineColor,o.data.datasets[1].data=s.volumeDeltaRsiValues,o.data.datasets[1].borderColor=C.lineColor,o.update("none");return}const l=new Chart(r,{type:"line",data:{labels:s.labels,datasets:[{label:"RSI",data:s.rsiValues,borderColor:T.lineColor,backgroundColor:"transparent",borderWidth:1,pointRadius:s.rsiValues.length>24?0:2,tension:.2},{label:"VD RSI",data:s.volumeDeltaRsiValues,borderColor:C.lineColor,backgroundColor:"transparent",borderWidth:1,pointRadius:s.volumeDeltaRsiValues.length>24?0:2,tension:.2}]},options:{responsive:!0,maintainAspectRatio:!1,animation:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!1},tooltip:{backgroundColor:"rgba(22, 27, 34, 0.95)",borderColor:"#30363d",borderWidth:1,titleColor:"#c9d1d9",bodyColor:"#8b949e"}},scales:{x:{display:!1,ticks:{color:"#8b949e",maxRotation:0,autoSkip:!0,maxTicksLimit:6,font:{size:10}},grid:{color:"rgba(48, 54, 61, 0.22)"}},y:{display:!1,min:0,max:100,ticks:{color:"#8b949e",font:{size:10}},grid:{color:"rgba(48, 54, 61, 0.22)"}}}}});ws(t,l)}function Pt(){ue=!1,dt=!1,ft=null,qe("rsi","divergence",!1),ht("rsi")}function Ft(){fe=!1,ut=!1,mt=null,qe("volumeDeltaRsi","divergence",!1),ht("volumeDeltaRsi")}function rr(t,e){if(!ue||e&&!dt)return;const n=Cs(t);n!==null&&(dt=!0,ft=n,Cn("rsi",n))}function ks(t,e){if(!fe||e&&!ut)return;const n=Cs(t);n!==null&&(ut=!0,mt=n,Cn("volumeDeltaRsi",n))}function zl(){if(ue){Pt();return}ae&&(k?.deactivateDivergenceTool(),ae=!1,X("rsi",!1)),ue=!0,dt=!1,ft=null,qe("rsi","divergence",!0)}function Wl(){if(fe){Ft();return}Le&&(Wt(),X("volumeDeltaRsi",!1)),fe=!0,ut=!1,mt=null,qe("volumeDeltaRsi","divergence",!0)}function $n(){ue&&dt&&ft!==null&&Cn("rsi",ft),fe&&ut&&mt!==null&&Cn("volumeDeltaRsi",mt)}function ql(){ae&&(k?.deactivateDivergenceTool(),ae=!1,X("rsi",!1)),Le&&(Wt(),X("volumeDeltaRsi",!1)),ue&&Pt(),fe&&Ft()}function Vn(t){t.style.fontFamily='-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',t.style.fontSize="12px",t.style.fontWeight="500",t.style.lineHeight="1.2",t.querySelectorAll("div, span, label, input, select, button").forEach(e=>{e.style.fontFamily="inherit",e.style.fontSize="inherit",e.style.fontWeight="inherit",e.style.fontStyle="normal",e.style.letterSpacing="normal"}),t.querySelectorAll("label").forEach(e=>{e.style.display="flex",e.style.justifyContent="space-between",e.style.alignItems="center",e.style.gap="8px",e.style.minHeight="26px"}),t.querySelectorAll('input[type="checkbox"]').forEach(e=>{e.style.width="14px",e.style.height="14px",e.style.margin="0"}),t.querySelectorAll("input, select, button").forEach(e=>{e.style.boxSizing="border-box",e.style.lineHeight="1.2"})}function Gl(t){const e=document.createElement("div");return e.className="pane-settings-panel price-settings-panel",e.style.position="absolute",e.style.left="8px",e.style.top="38px",e.style.zIndex="31",e.style.width="280px",e.style.maxWidth="calc(100% - 16px)",e.style.background="rgba(22, 27, 34, 0.95)",e.style.border="1px solid #30363d",e.style.borderRadius="6px",e.style.padding="10px",e.style.display="none",e.style.color="#c9d1d9",e.style.backdropFilter="blur(6px)",e.innerHTML=`
    <div style="display:flex; justify-content:space-between; align-items:center; min-height:26px; margin-bottom:8px;">
      <div style="font-weight:600;">Chart</div>
      <button type="button" data-price-setting="reset" style="background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:4px; padding:4px 8px; font-size:12px; cursor:pointer;">Reset</button>
    </div>
    <label style="margin-bottom:6px;">
      <span>Vertical gridlines</span>
      <input type="checkbox" data-price-setting="v-grid" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Horizontal gridlines</span>
      <input type="checkbox" data-price-setting="h-grid" />
    </label>
    <label style="margin-bottom:4px;">
      <span>MA source</span>
      <select data-price-setting="ma-source" style="background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:4px; padding:2px 4px;">
        <option value="daily">Daily</option>
        <option value="timeframe">Chart</option>
      </select>
    </label>
    ${E.ma.map((n,i)=>`
      <div style="display:grid; grid-template-columns: 20px 64px 58px 1fr; gap:6px; align-items:center; min-height:26px; margin-bottom:6px;">
        <input type="checkbox" data-price-setting="ma-enabled-${i}" title="Enable MA ${i+1}" />
        <select data-price-setting="ma-type-${i}" style="background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:4px; padding:2px 4px;">
          <option value="SMA">SMA</option>
          <option value="EMA">EMA</option>
        </select>
        <input data-price-setting="ma-length-${i}" type="number" min="1" max="500" step="1" style="width:58px; background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:4px; padding:2px 4px;" />
        <input data-price-setting="ma-color-${i}" type="color" style="width:100%; height:24px; border:none; background:transparent; padding:0;" />
      </div>
    `).join("")}
  `,Vn(e),e.addEventListener("input",n=>{const i=n.target;if(!i)return;const r=i.dataset.priceSetting||"";if(r==="ma-source"){E.maSourceMode=i.value==="timeframe"?"timeframe":"daily",De(),R();return}if(r==="v-grid"){E.verticalGridlines=i.checked,xe(),R();return}if(r==="h-grid"){E.horizontalGridlines=i.checked,Mi(),R();return}const s=r.match(/^ma-(enabled|type|length|color)-(\d)$/);if(!s)return;const o=s[1],l=Number(s[2]),a=E.ma[l];a&&(o==="enabled"?a.enabled=i.checked:o==="type"?a.type=i.value==="EMA"?"EMA":"SMA":o==="length"?a.length=Math.max(1,Math.floor(Number(i.value)||14)):o==="color"&&(a.color=i.value||a.color),De(),R())}),e.addEventListener("click",n=>{const i=n.target;i&&i.dataset.priceSetting==="reset"&&(n.preventDefault(),xl())}),t.appendChild(e),e}function jl(t){const e=document.createElement("div");return e.className="pane-settings-panel rsi-settings-panel",e.style.position="absolute",e.style.left="8px",e.style.top="38px",e.style.zIndex="31",e.style.width="230px",e.style.maxWidth="calc(100% - 16px)",e.style.background="rgba(22, 27, 34, 0.95)",e.style.border="1px solid #30363d",e.style.borderRadius="6px",e.style.padding="10px",e.style.display="none",e.style.color="#c9d1d9",e.style.backdropFilter="blur(6px)",e.innerHTML=`
    <div style="display:flex; justify-content:space-between; align-items:center; min-height:26px; margin-bottom:8px;">
      <div style="font-weight:600;">RSI</div>
      <button type="button" data-rsi-setting="reset" style="background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:4px; padding:4px 8px; font-size:12px; cursor:pointer;">Reset</button>
    </div>
    <label style="margin-bottom:6px;">
      <span>Length</span>
      <input data-rsi-setting="length" type="number" min="1" max="200" step="1" style="width:64px; background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:4px; padding:2px 4px;" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Line color</span>
      <input data-rsi-setting="line-color" type="color" style="width:64px; height:24px; border:none; background:transparent; padding:0;" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Midline color</span>
      <input data-rsi-setting="midline-color" type="color" style="width:64px; height:24px; border:none; background:transparent; padding:0;" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Midline style</span>
      <select data-rsi-setting="midline-style" style="background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:4px; padding:2px 4px;">
        <option value="dotted">Dotted</option>
        <option value="solid">Solid</option>
      </select>
    </label>
  `,Vn(e),e.addEventListener("input",n=>{const i=n.target;if(!i)return;const r=i.dataset.rsiSetting||"";if(r==="length"){T.length=Math.max(1,Math.floor(Number(i.value)||14)),Ri(),R();return}if(r==="line-color"){T.lineColor=i.value||T.lineColor,k?.setLineColor(T.lineColor),R();return}if(r==="midline-color"){T.midlineColor=i.value||T.midlineColor,k?.setMidlineOptions(T.midlineColor,T.midlineStyle),R();return}if(r==="midline-style"){T.midlineStyle=i.value==="solid"?"solid":"dotted",k?.setMidlineOptions(T.midlineColor,T.midlineStyle),R();return}}),e.addEventListener("click",n=>{const i=n.target;i&&i.dataset.rsiSetting==="reset"&&(n.preventDefault(),Il())}),t.appendChild(e),e}function Kl(t){const e=document.createElement("div");return e.className="pane-settings-panel volume-delta-settings-panel",e.style.position="absolute",e.style.left="8px",e.style.top="38px",e.style.zIndex="31",e.style.width="230px",e.style.maxWidth="calc(100% - 16px)",e.style.background="rgba(22, 27, 34, 0.95)",e.style.border="1px solid #30363d",e.style.borderRadius="6px",e.style.padding="10px",e.style.display="none",e.style.color="#c9d1d9",e.style.backdropFilter="blur(6px)",e.innerHTML=`
    <div style="display:flex; justify-content:space-between; align-items:center; min-height:26px; margin-bottom:8px;">
      <div style="font-weight:600;">Volume Delta</div>
      <button type="button" data-vd-setting="reset" style="background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:4px; padding:4px 8px; font-size:12px; cursor:pointer;">Reset</button>
    </div>
    <label style="margin-bottom:6px;">
      <span>Source</span>
      <select data-vd-setting="source-interval" style="background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:4px; padding:2px 4px;">
        ${Jr.map(n=>`<option value="${n.value}">${n.label}</option>`).join("")}
      </select>
    </label>
    <label style="margin-bottom:6px;">
      <span>Divergence table</span>
      <input type="checkbox" data-vd-setting="divergence-table" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Divergent price bars</span>
      <input type="checkbox" data-vd-setting="divergent-price-bars" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Bullish</span>
      <input type="color" data-vd-setting="divergent-bullish-color" style="width:64px; height:24px; border:none; background:transparent; padding:0;" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Bearish</span>
      <input type="color" data-vd-setting="divergent-bearish-color" style="width:64px; height:24px; border:none; background:transparent; padding:0;" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Neutral</span>
      <input type="color" data-vd-setting="divergent-neutral-color" style="width:64px; height:24px; border:none; background:transparent; padding:0;" />
    </label>
  `,Vn(e),e.addEventListener("input",n=>{const i=n.target;if(!i)return;const r=i.dataset.vdSetting||"";if(r==="source-interval"){const s=String(i.value||"");if(s!=="1min"&&s!=="5min"&&s!=="15min"&&s!=="30min"&&s!=="1hour"&&s!=="4hour")return;w.sourceInterval=s,N&&me(N,Q),R();return}if(r==="divergence-table"){w.divergenceTable=i.checked,Nt&&Fi(Nt,y),R();return}if(r==="divergent-price-bars"){w.divergentPriceBars=i.checked,Re(),R();return}if(r==="divergent-bullish-color"){w.bullishDivergentColor=i.value||w.bullishDivergentColor,Re(),R();return}if(r==="divergent-bearish-color"){w.bearishDivergentColor=i.value||w.bearishDivergentColor,Re(),R();return}if(r==="divergent-neutral-color"){w.neutralDivergentColor=i.value||w.neutralDivergentColor,Re(),R();return}}),e.addEventListener("click",n=>{const i=n.target;i&&i.dataset.vdSetting==="reset"&&(n.preventDefault(),Ml())}),t.appendChild(e),e}function Zl(t){const e=document.createElement("div");return e.className="pane-settings-panel volume-delta-rsi-settings-panel",e.style.position="absolute",e.style.left="8px",e.style.top="38px",e.style.zIndex="31",e.style.width="230px",e.style.maxWidth="calc(100% - 16px)",e.style.background="rgba(22, 27, 34, 0.95)",e.style.border="1px solid #30363d",e.style.borderRadius="6px",e.style.padding="10px",e.style.display="none",e.style.color="#c9d1d9",e.style.backdropFilter="blur(6px)",e.innerHTML=`
    <div style="display:flex; justify-content:space-between; align-items:center; min-height:26px; margin-bottom:8px;">
      <div style="font-weight:600;">Volume Delta RSI</div>
      <button type="button" data-vd-rsi-setting="reset" style="background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:4px; padding:4px 8px; font-size:12px; cursor:pointer;">Reset</button>
    </div>
    <label style="margin-bottom:6px;">
      <span>Length</span>
      <input data-vd-rsi-setting="length" type="number" min="1" max="200" step="1" style="width:64px; background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:4px; padding:2px 4px;" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Source</span>
      <select data-vd-rsi-setting="source-interval" style="background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:4px; padding:2px 4px;">
        ${Jr.map(n=>`<option value="${n.value}">${n.label}</option>`).join("")}
      </select>
    </label>
    <label style="margin-bottom:6px;">
      <span>Line color</span>
      <input data-vd-rsi-setting="line-color" type="color" style="width:64px; height:24px; border:none; background:transparent; padding:0;" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Midline color</span>
      <input data-vd-rsi-setting="midline-color" type="color" style="width:64px; height:24px; border:none; background:transparent; padding:0;" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Midline style</span>
      <select data-vd-rsi-setting="midline-style" style="background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:4px; padding:2px 4px;">
        <option value="dotted">Dotted</option>
        <option value="solid">Solid</option>
      </select>
    </label>
  `,Vn(e),e.addEventListener("input",n=>{const i=n.target;if(!i)return;const r=i.dataset.vdRsiSetting||"";if(r==="length"){C.length=Math.max(1,Math.floor(Number(i.value)||14)),Je(!0),R();return}if(r==="source-interval"){const s=String(i.value||"");if(s!=="1min"&&s!=="5min"&&s!=="15min"&&s!=="30min"&&s!=="1hour"&&s!=="4hour")return;C.sourceInterval=s,Je(!0),R();return}if(r==="line-color"){C.lineColor=i.value||C.lineColor,Je(!1),R();return}if(r==="midline-color"){C.midlineColor=i.value||C.midlineColor,Je(!1),R();return}if(r==="midline-style"){C.midlineStyle=i.value==="solid"?"solid":"dotted",Je(!1),R();return}}),e.addEventListener("click",n=>{const i=n.target;i&&i.dataset.vdRsiSetting==="reset"&&(n.preventDefault(),Al())}),t.appendChild(e),e}function Yl(t,e,n,i){const r=Qt(t,"price"),s=Qt(e,"volumeDeltaRsi"),o=Qt(n,"rsi"),l=Qt(i,"volumeDelta");en(t,"price"),en(e,"volumeDeltaRsi"),en(n,"rsi"),en(i,"volumeDelta");const a=Ze(e,"volumeDeltaRsi","trend",0),d=Ze(e,"volumeDeltaRsi","erase",1),c=Ze(e,"volumeDeltaRsi","divergence",2),u=Ze(n,"rsi","trend",0),m=Ze(n,"rsi","erase",1),h=Ze(n,"rsi","divergence",2);(!_||_.parentElement!==t)&&(_?.parentElement&&_.parentElement.removeChild(_),_=Gl(t)),(!U||U.parentElement!==n)&&(U?.parentElement&&U.parentElement.removeChild(U),U=jl(n)),(!V||V.parentElement!==e)&&(V?.parentElement&&V.parentElement.removeChild(V),V=Zl(e)),(!$||$.parentElement!==i)&&($?.parentElement&&$.parentElement.removeChild($),$=Kl(i)),ms(),gs(),ps(),hs(),r.dataset.bound||(r.addEventListener("click",f=>{f.stopPropagation();const g=_?.style.display==="block"?"none":"block";Et(),_&&(_.style.display=g)}),r.dataset.bound="1"),s.dataset.bound||(s.addEventListener("click",f=>{f.stopPropagation();const g=V?.style.display==="block"?"none":"block";Et(),V&&(V.style.display=g)}),s.dataset.bound="1"),l.dataset.bound||(l.addEventListener("click",f=>{f.stopPropagation();const g=$?.style.display==="block"?"none":"block";Et(),$&&($.style.display=g)}),l.dataset.bound="1"),o.dataset.bound||(o.addEventListener("click",f=>{f.stopPropagation();const g=U?.style.display==="block"?"none":"block";Et(),U&&(U.style.display=g)}),o.dataset.bound="1"),a.dataset.bound||(a.addEventListener("click",f=>{f.preventDefault(),f.stopPropagation(),$l()}),a.dataset.bound="1"),d.dataset.bound||(d.addEventListener("click",f=>{f.preventDefault(),f.stopPropagation(),Vl()}),d.dataset.bound="1"),c.dataset.bound||(c.addEventListener("click",f=>{f.preventDefault(),f.stopPropagation(),Wl()}),c.dataset.bound="1"),u.dataset.bound||(u.addEventListener("click",f=>{f.preventDefault(),f.stopPropagation(),Pl()}),u.dataset.bound="1"),m.dataset.bound||(m.addEventListener("click",f=>{f.preventDefault(),f.stopPropagation(),Fl()}),m.dataset.bound="1"),h.dataset.bound||(h.addEventListener("click",f=>{f.preventDefault(),f.stopPropagation(),zl()}),h.dataset.bound="1"),X("rsi",ae),X("volumeDeltaRsi",Le),qe("rsi","divergence",ue),qe("volumeDeltaRsi","divergence",fe),document.body.dataset.chartSettingsBound||(document.addEventListener("click",f=>{const g=f.target;g&&(g.closest(".pane-settings-panel")||g.closest(".pane-settings-btn")||Et())}),document.addEventListener("keydown",f=>{f.key==="Escape"&&ql()}),document.body.dataset.chartSettingsBound="1")}function Xl(t){let e=t.querySelector(".price-pane-change");if(e)return e;const n=Ai(t);return e=document.createElement("div"),e.className=`price-pane-change ${Si}`,e.dataset.topPaneBadgeRole="price-change",e.style.position="absolute",e.style.left=`${n}px`,e.style.top="8px",e.style.zIndex="30",e.style.minHeight="24px",e.style.display="inline-flex",e.style.alignItems="center",e.style.padding="0 8px",e.style.borderRadius="4px",e.style.border="1px solid #30363d",e.style.background="#161b22",e.style.color="#c9d1d9",e.style.fontSize="12px",e.style.fontFamily="'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",e.style.pointerEvents="none",e.style.display="none",t.appendChild(e),e}function Jl(t){if(ze=new Map,!(!Array.isArray(t)||t.length<2))for(let e=1;e<t.length;e++){const n=Number(t[e]?.close),i=Number(t[e-1]?.close);if(!Number.isFinite(n)||!Number.isFinite(i)||i===0)continue;const r=(n-i)/i*100;ze.set(M(t[e].time),r)}}function te(t,e){const n=Xl(t);if(!y.length||ze.size===0){n.style.display="none",n.textContent="",Mt(t);return}const i=y[y.length-1]?.time,r=e!=null?M(e):M(i),s=Number(ze.get(r));if(!Number.isFinite(s)){n.style.display="none",n.textContent="",Mt(t);return}const o=s>0?"+":"";n.textContent=`${o}${s.toFixed(2)}%`,n.style.color=s>0?"#26a69a":s<0?"#ef5350":"#c9d1d9",n.style.display="inline-flex",Mt(t)}function Ql(t){let e=t.querySelector(".price-pane-message");return e||(e=document.createElement("div"),e.className="price-pane-message",e.style.position="absolute",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.color="#8b949e",e.style.fontSize="1rem",e.style.fontWeight="600",e.style.pointerEvents="none",e.style.zIndex="20",e.style.display="none",t.appendChild(e),e)}function sr(t,e){const n=Ql(t);if(!e){n.style.display="none",n.textContent="";return}n.textContent=e,n.style.display="block"}function ea(t){const e=String(t?.message||t||"");return/No .*data available for this ticker|No valid chart bars/i.test(e)}function ta(t){if(!Number.isFinite(t))return"";const e=Math.abs(t);let n="";if(e>=100)n=String(Math.round(t));else if(e>=10){const i=Math.round(t*10)/10;Math.abs(i)>=100?n=String(Math.round(i)):n=i.toFixed(1)}else n=(Math.round(t*100)/100).toFixed(2);return n.length>=ee?n:n.padEnd(ee," ")}function M(t){return typeof t=="number"?String(t):t}function _i(){return{priceRange:{minValue:el,maxValue:tl}}}function Es(t){return Math.max(Kr,Math.min(Zr,Number(t)))}function Ts(t){const e=document.getElementById("vd-rsi-chart-container");e&&(e.style.cursor=t?"crosshair":"default")}function Te(t){return Ee(t)}function na(t){return Number.isFinite(t)?Ot("en-US",{month:"2-digit",day:"2-digit",year:"2-digit"}).format(new Date(Math.round(Number(t))*1e3)):"N/A"}function ia(t){const e=document.createElement("div");return e.className="trendline-cross-label",e.textContent=t,e.style.position="absolute",e.style.zIndex="29",e.style.minHeight="24px",e.style.display="inline-flex",e.style.alignItems="center",e.style.padding="0 8px",e.style.borderRadius="4px",e.style.border="1px solid #30363d",e.style.background="#161b22",e.style.color="#c9d1d9",e.style.fontSize="12px",e.style.fontFamily="'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",e.style.pointerEvents="none",e.style.whiteSpace="nowrap",e.style.transform="translate(-50%, calc(-100% - 6px))",e}function Ls(){const t=document.getElementById("vd-rsi-chart-container");if(!t||!I||!Z)return;const e=t.clientWidth,n=t.clientHeight;for(const i of hn){const r=I.timeScale().timeToCoordinate(i.anchorTime),s=Z.priceToCoordinate(i.anchorValue);if(!Number.isFinite(r)||!Number.isFinite(s)||r<0||r>e||s<0||s>n){i.element.style.display="none";continue}i.element.style.display="inline-flex",i.element.style.left=`${Math.round(r)}px`,i.element.style.top=`${Math.round(Math.max(8,s))}px`}}function or(){for(const t of hn)t.element.remove();hn=[]}function ra(t,e,n){const i=document.getElementById("vd-rsi-chart-container");if(!i)return;const r=ia(n);i.appendChild(r),hn.push({element:r,anchorTime:t,anchorValue:e}),Ls()}function sa(t,e,n,i,r){if(!Number.isFinite(t))return null;if(t>e)return i===null?null:i+(t-e)*r;if(t<0)return n===null?null:n+t*r;const s=Math.max(0,Math.floor(t)),o=Math.min(e,Math.ceil(t)),l=Te(A[s]?.time),a=Te(A[o]?.time);if(s===o)return l;if(Number.isFinite(l)&&Number.isFinite(a)){const d=t-s;return Number(l)+(Number(a)-Number(l))*d}return Number.isFinite(l)?Number(l)+(t-s)*r:n===null?null:n+t*r}function oa(t,e,n,i,r,s,o){if(!Number.isFinite(n)||Math.abs(n)<1e-12)return null;const l=t+(Qo-e)/n;return Number.isFinite(l)?sa(l,i,r,s,o):null}function xs(){if(A.length<2)return 1800;const t=[];for(let e=1;e<A.length;e++){const n=Te(A[e-1].time),i=Te(A[e].time);if(n===null||i===null)continue;const r=i-n;Number.isFinite(r)&&r>0&&r<=8*3600&&t.push(r)}return t.length===0?1800:(t.sort((e,n)=>e-n),t[Math.floor(t.length/2)])}function la(t){return t<=300?78:t<=900?26:t<=1800?13:t<=3600?7:2}function aa(){const t=xs();return la(t)*252}function Is(){if(!(!It||!I)){try{I.removeSeries(It)}catch{}It=null}}function Ms(t=!1){const e=t&&I?I.timeScale().getVisibleLogicalRange?.():null;if(t&&(it=!0),!I||Tt.length===0){Tt=[],gn=[],or(),t&&(it=!1);return}try{for(const n of Tt)try{I.removeSeries(n)}catch{}Tt=[],gn=[],or()}finally{if(t&&e)try{I.timeScale().setVisibleLogicalRange(e)}catch{}t&&(it=!1)}}function As(){Is(),Lt=null,ln.clear()}function Wt(){Le=!1,As(),Ts(!1)}function ca(){Le=!0,Ts(!0)}function Pi(t=!1){As(),Ms(t)}function da(t){if(Is(),!I||t.length===0)return;It=I.addLineSeries({color:il,lineVisible:!1,pointMarkersVisible:!0,pointMarkersRadius:2,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1,autoscaleInfoProvider:()=>_i()});const e=Math.max(1,Math.ceil(t.length/nl)),n=e===1?t:t.filter((i,r)=>r%e===0);It.setData(n)}function Ns(t,e,n,i,r=!0){if(!I||!A.length)return;const s=ct.get(M(t)),o=ct.get(M(n));if(s===void 0||o===void 0||s===o)return;const l=(i-e)/(o-s),a=A.length-1,d=aa(),c=a+d,u=xs(),m=Te(A[0]?.time),h=Te(A[a]?.time),f=I.timeScale().getVisibleLogicalRange?.(),g=[];it=!0;try{for(let p=s;p<=c;p++){const v=e+l*(p-s);if(!Number.isFinite(v)||v<Kr||v>Zr)break;let D=null;p<=a?D=A[p]?.time??null:h!==null&&(D=h+(p-a)*u),D!=null&&g.push({time:D,value:v})}if(!g.length)return;const S=I.addLineSeries({color:rl,lineWidth:1,lineStyle:0,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1,autoscaleInfoProvider:()=>_i()});S.setData(g),Tt.push(S);const b=oa(s,e,l,a,m,h,u);ra(t,e,na(b)),r&&gn.push({time1:t,value1:Number(e),time2:n,value2:Number(i)})}finally{if(f)try{I.timeScale().setVisibleLogicalRange(f)}catch{}it=!1}}function ua(t){if(!Le)return;const e=M(t),n=ct.get(e);if(n===void 0)return;const i=A[n];if(!i)return;const r=Number(i.value),s=Rt.get(e);if(!Number.isFinite(r)||!Number.isFinite(s))return;const o=Number(s);if(!Lt){Lt={time:t,rsi:r,price:o,index:n};const l=[];ln.clear();for(let a=n+1;a<A.length;a++){const d=A[a],c=Number(d?.value);if(!Number.isFinite(c))continue;const u=Rt.get(M(d.time));if(!Number.isFinite(u))continue;const m=Number(u),h=c<r&&m>o,f=c>r&&m<o;!h&&!f||(l.push({time:d.time,value:c}),ln.add(M(d.time)))}da(l);return}ln.has(e)&&(Ns(Lt.time,Lt.rsi,t,r),Wt(),X("volumeDeltaRsi",!1),Pn())}function fa(t,e){return!t||!e?!1:Math.abs(Number(t.from)-Number(e.from))<1e-6&&Math.abs(Number(t.to)-Number(e.to))<1e-6}function ma(t){const e=typeof window<"u"&&window.matchMedia("(max-width: 768px)").matches||typeof window<"u"&&("ontouchstart"in window||navigator.maxTouchPoints>0),n=fi(t,{layout:{background:{color:"#0d1117"},textColor:"#d1d4dc",fontFamily:"'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",attributionLogo:!1},grid:{vertLines:{visible:!1},horzLines:{visible:!1}},crosshair:{mode:mi.Normal},handleScroll:{pressedMouseMove:!0,horzTouchDrag:!0,vertTouchDrag:e,mouseWheel:!0},handleScale:{mouseWheel:!0,pinch:!0,axisPressedMouseMove:!0,axisDoubleClickReset:!0},rightPriceScale:{borderColor:"#2b2b43",minimumWidth:_t,entireTextOnly:!0},timeScale:{visible:!1,timeVisible:!0,secondsVisible:!1,borderVisible:!1,fixRightEdge:!1,rightBarStaysOnScroll:!1,rightOffset:zt,tickMarkFormatter:Ci}}),i=n.addCandlestickSeries({upColor:"#26a69a",downColor:"#ef5350",borderVisible:!1,wickUpColor:"#26a69a",wickDownColor:"#ef5350",priceFormat:{type:"custom",minMove:.01,formatter:s=>ta(Number(s))}}),r=n.addLineSeries({color:"rgba(0, 0, 0, 0)",lineVisible:!1,pointMarkersVisible:!1,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1});return{chart:n,series:i,timelineSeries:r}}function ha(t){const e=fi(t,{layout:{background:{color:"#0d1117"},textColor:"#c9d1d9",fontFamily:"'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",attributionLogo:!1},grid:{vertLines:{visible:!1},horzLines:{visible:!1}},crosshair:{mode:mi.Normal},handleScroll:{pressedMouseMove:!0,horzTouchDrag:!0,vertTouchDrag:!1,mouseWheel:!0},handleScale:{mouseWheel:!0,pinch:!0,axisPressedMouseMove:{time:!0,price:!1},axisDoubleClickReset:{time:!0,price:!1}},rightPriceScale:{borderColor:"#21262d",minimumWidth:_t,entireTextOnly:!0,scaleMargins:{top:.2,bottom:.2}},timeScale:{visible:!1,timeVisible:!0,secondsVisible:!1,borderVisible:!1,fixRightEdge:!1,rightBarStaysOnScroll:!1,rightOffset:zt,tickMarkFormatter:Ci}}),n=e.addLineSeries({color:C.lineColor,lineWidth:1,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1,priceFormat:{type:"custom",minMove:.1,formatter:r=>hl(Number(r))},autoscaleInfoProvider:()=>_i()}),i=e.addLineSeries({color:"rgba(0, 0, 0, 0)",lineVisible:!1,pointMarkersVisible:!1,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1});return ri=n.createPriceLine({price:Jo,color:C.midlineColor,lineWidth:1,lineStyle:bs(C.midlineStyle),axisLabelVisible:!1,title:"Midline"}),e.subscribeClick(r=>{if(!(!r||!r.time)){if(fe){ks(r.time,!1);return}Le&&ua(r.time)}}),{chart:e,rsiSeries:n,timelineSeries:i}}function ga(t){const e=fi(t,{layout:{background:{color:"#0d1117"},textColor:"#c9d1d9",fontFamily:"'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",attributionLogo:!1},grid:{vertLines:{visible:!1},horzLines:{visible:!1}},crosshair:{mode:mi.Normal},handleScroll:{pressedMouseMove:!0,horzTouchDrag:!0,vertTouchDrag:!1,mouseWheel:!0},handleScale:{mouseWheel:!0,pinch:!0,axisPressedMouseMove:{time:!0,price:!0},axisDoubleClickReset:{time:!0,price:!0}},rightPriceScale:{borderColor:"#21262d",minimumWidth:_t,entireTextOnly:!0},timeScale:{visible:!1,timeVisible:!0,secondsVisible:!1,borderVisible:!1,fixRightEdge:!1,rightBarStaysOnScroll:!1,rightOffset:zt,tickMarkFormatter:Ci}}),n=e.addHistogramSeries({base:0,priceLineVisible:!1,lastValueVisible:!1,priceFormat:{type:"custom",minMove:1,formatter:r=>pl(Number(r))}}),i=e.addLineSeries({color:"rgba(0, 0, 0, 0)",lineVisible:!1,pointMarkersVisible:!1,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1});return n.createPriceLine({price:0,color:"#8b949e",lineWidth:1,lineStyle:2,axisLabelVisible:!1,title:""}),z=e,{chart:e,histogramSeries:n,timelineSeries:i}}function pa(t,e){if(!Z)return;Pi(),A=ns(e?.rsi||[]).map(s=>({time:s.time,value:Es(Number(s.value))})),ct=new Map;for(let s=0;s<A.length;s++)ct.set(M(A[s].time),s);const i=new Map;for(const s of A)i.set(M(s.time),Number(s.value));const r=t.map(s=>{const o=i.get(M(s.time));return Number.isFinite(o)?{time:s.time,value:Number(o)}:{time:s.time}});Z.setData(r),We=new Map;for(const s of t){const o=M(s.time),l=i.get(o);Number.isFinite(l)&&We.set(o,Number(l))}$n()}function ya(t){if(Ms(),!(!Array.isArray(t)||t.length===0))for(const e of t){const n=e?.time1,i=e?.time2,r=Number(e?.value1),s=Number(e?.value2);typeof n!="string"&&typeof n!="number"||typeof i!="string"&&typeof i!="number"||!Number.isFinite(r)||!Number.isFinite(s)||Ns(n,r,i,s,!0)}}function va(){if(!N)return;const t=vl(N,Q);k?.restorePersistedTrendlines(t.rsi),ya(t.volumeDeltaRsi)}function ba(t,e){if(!ke)return;const n=new Map;for(const r of e){const s=Number(r.delta);Number.isFinite(s)&&n.set(M(r.time),s)}const i=t.map(r=>{const s=n.get(M(r.time))??0,o=Number.isFinite(Number(s))?Number(s):0;return{time:r.time,value:o,color:o>=0?Yr:Xr}});ke.setData(i),Ht=new Map(i.map(r=>[M(r.time),Number(r.value)||0])),Re()}function Sa(t){if(F&&F.parentElement===t)return F.style.top="8px",F.style.transform="none",F.style.right=`${_t+8}px`,F.style.display="flex",F.style.flexDirection="row",F.style.alignItems="center",F.style.gap=`${Dn}px`,F.style.background="transparent",F.style.border="none",F.style.borderRadius="0",F.style.overflow="visible",F;const e=document.createElement("div");return e.className="volume-delta-divergence-summary",e.style.position="absolute",e.style.top="8px",e.style.transform="none",e.style.right=`${_t+8}px`,e.style.zIndex="34",e.style.display="flex",e.style.flexDirection="row",e.style.alignItems="center",e.style.gap=`${Dn}px`,e.style.background="transparent",e.style.border="none",e.style.borderRadius="0",e.style.overflow="visible",e.style.pointerEvents="auto",t.appendChild(e),F=e,e}function ci(){F&&(F.style.display="none",F.innerHTML="")}function Fi(t,e,n){if(!w.divergenceTable){ci();return}const i=Sa(t);i.innerHTML="",i.style.display="flex",i.style.flexDirection="row",i.style.alignItems="center";const r=String(N||"").trim().toUpperCase(),s=w.sourceInterval,o=`${r}|${s}|${Date.now()}`;i.dataset.requestToken=o;let l=!1,a=null;const d=(m,h,f)=>{const g=document.createElement("div");return g.textContent=m,g.title=f,g.style.display="inline-flex",g.style.alignItems="center",g.style.justifyContent="center",g.style.width=`${ie}px`,g.style.height=`${ie}px`,g.style.padding="0",g.style.borderRadius="4px",g.style.border="1px solid #30363d",g.style.background="#161b22",g.style.fontSize="12px",g.style.fontWeight="600",g.style.lineHeight="1",g.style.fontFamily="'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",g.style.color=h,g.style.pointerEvents="none",g},c=()=>{l||(l=!0,u(a,!0),zi(r,s,{forceRefresh:!0}).then(m=>{i.dataset.requestToken===o&&String(N||"").trim().toUpperCase()===r&&(a=m||null,u(a,!1))}).catch(()=>{i.dataset.requestToken===o&&String(N||"").trim().toUpperCase()===r&&u(a,!1)}).finally(()=>{l=!1}))},u=(m,h=!1)=>{if(i.dataset.requestToken!==o||String(N||"").trim().toUpperCase()!==r)return;i.innerHTML="";const f=document.createElement("button");f.type="button",f.title=h?"Refreshing divergence table...":"Refresh divergence table",f.style.display="inline-flex",f.style.alignItems="center",f.style.justifyContent="center",f.style.width=`${ie}px`,f.style.height=`${ie}px`,f.style.padding="0",f.style.borderRadius="4px",f.style.border="none",f.style.background="transparent",f.style.color="#c9d1d9",f.style.cursor=h?"wait":"pointer",f.style.pointerEvents=h?"none":"auto",f.style.userSelect="none",f.style.flex="0 0 auto",f.style.verticalAlign="middle",f.setAttribute("aria-disabled",h?"true":"false"),f.disabled=!1;const g="http://www.w3.org/2000/svg",S=document.createElementNS(g,"svg");S.setAttribute("width","14"),S.setAttribute("height","14"),S.setAttribute("viewBox","0 0 24 24"),S.setAttribute("fill","none"),S.setAttribute("stroke","currentColor"),S.setAttribute("stroke-width","2.5"),S.setAttribute("stroke-linecap","round"),S.setAttribute("stroke-linejoin","round"),S.style.display="block";const b=document.createElementNS(g,"path");b.setAttribute("d","M21.5 2v6h-6");const p=document.createElementNS(g,"path");p.setAttribute("d","M21.5 8A10 10 0 0 0 5.6 5.6");const v=document.createElementNS(g,"path");v.setAttribute("d","M2.5 22v-6h6");const D=document.createElementNS(g,"path");D.setAttribute("d","M2.5 16A10 10 0 0 0 18.4 18.4"),S.appendChild(b),S.appendChild(p),S.appendChild(v),S.appendChild(D),h&&S.animate([{transform:"rotate(0deg)"},{transform:"rotate(360deg)"}],{duration:800,iterations:1/0,easing:"linear"}),f.appendChild(S),f.addEventListener("click",L=>{L.preventDefault(),L.stopPropagation(),c()}),i.appendChild(f);for(let L=0;L<$e.length;L++){const J=$e[L],he=m?.states?.[String(J)]||"neutral",wt=he==="bullish"?"#26a69a":he==="bearish"?"#ef5350":"#ffffff",ro=d(String(J),wt,`Last ${J} day${J===1?"":"s"}${m?.tradeDate?` (as of ${m.tradeDate})`:""}`);i.appendChild(ro)}};u(null,!1),!(!r||!Array.isArray(e)||e.length<2)&&zi(r,s,{forceRefresh:!0}).then(m=>{a=m||null,u(a,!1)}).catch(()=>{u(a,!1)})}function Re(){if(!G)return;if(!Array.isArray(y)||y.length===0){G.setData([]);return}if(!w.divergentPriceBars){G.setData(y);return}const t=w.bullishDivergentColor||se.bullishDivergentColor,e=w.bearishDivergentColor||se.bearishDivergentColor,i=String(w.neutralDivergentColor||"").trim().toLowerCase()==="#c9d1d9"?se.neutralDivergentColor:w.neutralDivergentColor||se.neutralDivergentColor,r=y.map((s,o)=>{const l=Number(s?.close),a=Number(y[o-1]?.close),d=Number(Ht.get(M(s.time))),c=o>0&&Number.isFinite(l)&&Number.isFinite(a),u=Number.isFinite(d);let m=i;if(c&&u){const h=d>0&&l<a,f=d<0&&l>a;h?m=t:f&&(m=e)}return{...s,color:m}});G.setData(r)}function Da(t){return t.filter(e=>e&&(typeof e.time=="string"||typeof e.time=="number")&&Number.isFinite(Number(e.open))&&Number.isFinite(Number(e.high))&&Number.isFinite(Number(e.low))&&Number.isFinite(Number(e.close)))}function On(t,e,n,i){if(!x)return;const r=t.getBoundingClientRect(),s=e.getBoundingClientRect(),o=n.getBoundingClientRect(),l=i.getBoundingClientRect(),a=Math.max(1,Math.floor(r.width)),d=Math.max(1,Math.floor(r.height)),c=Math.max(1,Math.floor(s.width)),u=Math.max(1,Math.floor(s.height)),m=Math.max(1,Math.floor(o.width)),h=Math.max(1,Math.floor(o.height)),f=Math.max(1,Math.floor(l.width)),g=Math.max(1,Math.floor(l.height));x.applyOptions({width:a,height:d}),I&&I.applyOptions({width:c,height:u}),k&&(k.getChart().applyOptions({width:m,height:h}),k.refreshTrendlineLabels()),z&&z.applyOptions({width:f,height:g}),xe()}function wa(t,e,n,i){Ke||(Ke=new ResizeObserver(()=>{On(t,e,n,i)}),Ke.observe(t),Ke.observe(e),Ke.observe(n),Ke.observe(i))}function ge(t){const e=t.querySelector(".chart-loading-overlay");e&&e.remove();const n=document.createElement("div");n.className="chart-loading-overlay",n.style.cssText=`
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(13, 17, 23, 0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    pointer-events: none;
  `;const i=document.createElement("div");i.innerHTML=`
    <svg width="40" height="40" viewBox="0 0 40 40" style="animation: spin 1s linear infinite;">
      <circle cx="20" cy="20" r="16" fill="none" stroke="#58a6ff" stroke-width="3"
              stroke-dasharray="80" stroke-dashoffset="60" stroke-linecap="round" opacity="0.8"/>
    </svg>
    <style>
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    </style>
  `,n.appendChild(i),t.appendChild(n)}function tn(t,e){const n=t.querySelector(".chart-loading-overlay");n&&n.remove();const i=document.createElement("div");i.className="chart-loading-overlay",i.style.cssText=`
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(13, 17, 23, 0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    pointer-events: auto;
  `;const r=document.createElement("button");r.type="button",r.textContent="Try Refreshing",r.style.background="#161b22",r.style.color="#c9d1d9",r.style.border="1px solid #30363d",r.style.borderRadius="6px",r.style.padding="8px 12px",r.style.fontSize="12px",r.style.fontWeight="600",r.style.cursor="pointer",r.style.fontFamily="'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",r.addEventListener("click",s=>{s.preventDefault(),e()}),i.appendChild(r),t.appendChild(i)}function pe(t){const e=t.querySelector(".chart-loading-overlay");e&&e.remove()}function Ca(t){const e=N;e&&(Ct!==null&&(window.clearTimeout(Ct),Ct=null),Ct=window.setTimeout(()=>{Ct=null,!(!N||N!==e)&&me(e,t)},Ho))}function ka(){return!(document.visibilityState!=="visible"||document.getElementById("view-live")?.classList.contains("hidden")||document.getElementById("ticker-view")?.classList.contains("hidden"))}function Ea(t){if(!G||!k||!Z||!ke||!Array.isArray(y)||y.length===0)return!1;const e=y.length-1,n=y[e],i=t.latestBar;if(!i||M(n?.time)!==M(i.time))return!1;const r=n.time,s=M(r);y[e]={...n,...i};const o=Number(y[e].close);if(Number.isFinite(o)&&Rt.set(s,o),Bt.set(s,e),e>0){const c=Number(y[e-1]?.close);if(Number.isFinite(c)&&c!==0&&Number.isFinite(o)){const u=(o-c)/c*100;ze.set(s,u)}}const l=Number(t.latestRsi?.value);if(Number.isFinite(l)&&(Dt.set(s,Number(l)),!k.updateLatestPoint({time:r,value:Number(l)},Number.isFinite(o)?{time:r,close:o}:void 0)))return!1;const a=Number(t.latestVolumeDeltaRsi?.value);if(Number.isFinite(a)){const c=Es(Number(a));We.set(s,c),A.length>0&&M(A[A.length-1].time)===s&&(A[A.length-1]={...A[A.length-1],value:c}),Z.update({time:r,value:c})}const d=Number(t.latestVolumeDelta?.delta);if(Number.isFinite(d)){const c=Number(d);Ht.set(s,c),ke.update({time:r,value:c,color:c>=0?Yr:Xr})}return w.divergentPriceBars?Re():G.update(y[e]),Dl(),B&&te(B,null),Nt&&Fi(Nt,y),$n(),!0}async function Ta(t,e){const n=performance.now();let i=null;const r=await Oo(t,e,{vdRsiLength:C.length,vdSourceInterval:w.sourceInterval,vdRsiSourceInterval:C.sourceInterval,onResponseMeta:c=>{i=c.chartCacheHeader}});if(as(e,performance.now()-n,i),!N||N!==t||Q!==e||!Array.isArray(y)||y.length===0)return;const s=y[y.length-1]?.time,o=r.latestBar;if(s==null||!o){await me(t,e,{silent:!0});return}const l=M(s),a=M(o.time);if(l!==a){await me(t,e,{silent:!0});return}Ea(r)||await me(t,e,{silent:!0})}function lr(t,e,n,i,r){const s=Da(t.bars||[]);if(s.length===0)throw new Error("No valid chart bars returned for this ticker/interval");pn=al(s),es(s);const o=ts(s,T.length),l={rsi:ns(t.volumeDeltaRsi?.rsi||[])},a=gl(t.volumeDelta||[]);y=s,Bt=new Map;for(let d=0;d<s.length;d++)Bt.set(M(s[d].time),d);Jl(s),Rt=new Map(s.map(d=>[M(d.time),Number(d.close)])),Dt=new Map(o.filter(d=>Number.isFinite(Number(d.value))).map(d=>[M(d.time),Number(d.value)])),G&&G.setData(s),te(e,null),pa(s,l),ba(s,a),Fi(r,s),Bi(),!k&&i?(k=new O({container:i,data:o,displayMode:"line",lineColor:T.lineColor,midlineColor:T.midlineColor,midlineStyle:T.midlineStyle,priceData:s.map(d=>({time:d.time,close:d.close})),onTrendLineDrawn:()=>{k?.deactivateDivergenceTool(),ae=!1,X("rsi",!1),Pn()}}),On(e,n,i,r),Fn()):k&&k.setData(o,s.map(d=>({time:d.time,close:d.close}))),Ri(),va(),Ia(),De(),xa(),Rs(),xe()}function La(){Zi===null&&(Zi=window.setInterval(()=>{if(Gn||Ye||!N||!ka())return;const t=N,e=Q;Gn=!0,Ta(t,e).catch(()=>{}).finally(()=>{Gn=!1})},zo))}async function me(t,e=Q,n={}){const i=n.silent===!0;bl();const r=N,s=Q,o=++qn,l=typeof r=="string"&&(r!==t||s!==e),a=e==="1week"&&(typeof r!="string"||l);Q=e,N=t;const d=ki(t,e);l&&(dt=!1,ut=!1,ft=null,mt=null,ht("rsi"),ht("volumeDeltaRsi"));const c=document.getElementById("chart-content");if(!c||!(c instanceof HTMLElement)){console.error("Chart content container not found");return}Ll(c);const u=document.getElementById("price-chart-container"),m=document.getElementById("vd-rsi-chart-container"),h=document.getElementById("rsi-chart-container"),f=document.getElementById("vd-chart-container"),g=document.getElementById("chart-error");if(!u||!m||!h||!f||!g){console.error("Chart containers not found");return}if(B=u,Nt=f,g.style.display="none",g.textContent="",sr(u,null),Kt(u,"price"),Kt(m,"volumeDeltaRsi"),Kt(h,"rsi"),Kt(f,"volumeDelta"),Yl(u,m,h,f),Ni(),!x){const{chart:v,series:D,timelineSeries:L}=ma(u);x=v,G=D,ni=L,Mi()}if(!I){const{chart:v,rsiSeries:D,timelineSeries:L}=ha(m);I=v,Z=D,ii=L,Bi()}if(!z){const{chart:v,histogramSeries:D,timelineSeries:L}=ga(f);z=v,ke=D,si=L}wa(u,m,h,f),On(u,m,h,f),Fn();const S=i?null:Ti(d),b=!!S;if(S){const v=performance.now();lr(S,u,m,h,f),er(e,performance.now()-v),a&&ar(),tr(t,e)}else i||(ge(u),ge(m),ge(h),ge(f));if(Ye)try{Ye.abort()}catch{}const p=new AbortController;Ye=p;try{const v=performance.now();let D=null;const L=await bi(t,e,{vdRsiLength:C.length,vdSourceInterval:w.sourceInterval,vdRsiSourceInterval:C.sourceInterval,signal:p.signal,onResponseMeta:he=>{D=he.chartCacheHeader}});if(as(e,performance.now()-v,D),o!==qn)return;if(!b||Qi(S)!==Qi(L)){const he=performance.now();lr(L,u,m,h,f),er(e,performance.now()-he),a&&ar()}Li(d,L),tr(t,e),i||(pe(u),pe(m),pe(h),pe(f))}catch(v){if(o!==qn||v?.name==="AbortError"||(console.error("Failed to load chart:",v),i)||b)return;if(ea(v)){pe(u),pe(m),pe(h),pe(f),G&&G.setData([]),ze=new Map,te(u,null),k&&k.setData([],[]),I&&Z?.setData([]),z&&ke?.setData([]),es([]),Pi(),A=[],ct=new Map,We=new Map,Ht=new Map,ci(),y=[],Bt=new Map,Ii(),pn=[],Zt(yn),Zt(vn),Zt(bn),Zt(Sn),sr(u,Zo),Pt(),Ft(),g.style.display="none",g.textContent="";return}ze=new Map,te(u,null),ci(),Pt(),Ft(),g.style.display="none",g.textContent="";const D=()=>{ge(u),ge(m),ge(h),ge(f),me(t,e)};tn(u,D),tn(m,D),tn(h,D),tn(f,D)}finally{Ye===p&&(Ye=null)}}function Rs(){if(!x)return;const t=x.timeScale().getVisibleLogicalRange();if(t)try{I&&I.timeScale().setVisibleLogicalRange(t),k&&k.getChart().timeScale().setVisibleLogicalRange(t),z&&z.timeScale().setVisibleLogicalRange(t),xe()}catch{}}function xa(){if(!x)return;const t=zt;x.timeScale().applyOptions({rightOffset:t}),I&&I.timeScale().applyOptions({rightOffset:t}),k&&k.getChart().timeScale().applyOptions({rightOffset:t}),z&&z.timeScale().applyOptions({rightOffset:t}),xe()}function ar(){if(!x||Q!=="1week"||!Array.isArray(y)||y.length===0)return;const t=y.length-1,e=Math.min(y.length,78),n=Math.max(0,t-e+1),i=t+zt;try{x.timeScale().setVisibleLogicalRange({from:n,to:i}),Rs(),xe()}catch{}}function tt(t,e){const n=Number(e.get(M(t)));if(Number.isFinite(n))return n;if(!Array.isArray(y)||y.length===0)return null;const i=Te(t);for(let r=y.length-1;r>=0;r--){const s=y[r];if(!s)continue;const o=s.time;if(i!==null){const a=Te(o);if(a!==null&&a>i)continue}const l=Number(e.get(M(o)));if(Number.isFinite(l))return l}return null}function Ia(){if(ji||!x||!I||!k||!z||!G||!Z||!ke)return;ji=!0;const t=I,e=k.getChart(),n=z;let i=null;const r=c=>{requestAnimationFrame(()=>{i===c&&(i=null)})},s=(c,u)=>{if(!u)return;const m=[{owner:"price",chart:x},{owner:"volumeDeltaRsi",chart:t},{owner:"rsi",chart:e},{owner:"volumeDelta",chart:n}];for(const h of m){if(h.owner===c)continue;const f=h.chart.timeScale().getVisibleLogicalRange();fa(f,u)||h.chart.timeScale().setVisibleLogicalRange(u)}xe()};x.timeScale().subscribeVisibleLogicalRangeChange(c=>{if(!(!c||i==="volumeDeltaRsi"||i==="rsi"||i==="volumeDelta")){i="price";try{s("price",c)}finally{r("price")}}}),t.timeScale().subscribeVisibleLogicalRangeChange(c=>{if(!it&&!(!c||i==="price"||i==="rsi"||i==="volumeDelta")){i="volumeDeltaRsi";try{s("volumeDeltaRsi",c)}finally{r("volumeDeltaRsi")}}}),e.timeScale().subscribeVisibleLogicalRangeChange(c=>{if(!k?.isSyncSuppressed?.()&&!(!c||i==="price"||i==="volumeDeltaRsi"||i==="volumeDelta")){i="rsi";try{s("rsi",c)}finally{r("rsi")}}}),n.timeScale().subscribeVisibleLogicalRangeChange(c=>{if(!(!c||i==="price"||i==="volumeDeltaRsi"||i==="rsi")){i="volumeDelta";try{s("volumeDelta",c)}finally{r("volumeDelta")}}});const o=c=>{const u=tt(c,Rt);if(Number.isFinite(u)&&G)try{x.setCrosshairPosition(Number(u),c,G)}catch{x.clearCrosshairPosition()}else x.clearCrosshairPosition()},l=c=>{const u=tt(c,We);if(Number.isFinite(u))try{t.setCrosshairPosition(Number(u),c,Z)}catch{t.clearCrosshairPosition()}else t.clearCrosshairPosition()},a=c=>{const u=tt(c,Dt),m=k?.getSeries();if(Number.isFinite(u)&&m)try{e.setCrosshairPosition(Number(u),c,m)}catch{e.clearCrosshairPosition()}else e.clearCrosshairPosition()},d=c=>{const u=tt(c,Ht);if(Number.isFinite(u))try{n.setCrosshairPosition(Number(u),c,ke)}catch{n.clearCrosshairPosition()}else n.clearCrosshairPosition()};x.subscribeCrosshairMove(c=>{if(!c||!c.time){t.clearCrosshairPosition(),e.clearCrosshairPosition(),n.clearCrosshairPosition(),B&&te(B,null);return}B&&te(B,c.time),l(c.time),a(c.time),d(c.time)}),t.subscribeCrosshairMove(c=>{if(!c||!c.time){x.clearCrosshairPosition(),e.clearCrosshairPosition(),n.clearCrosshairPosition(),B&&te(B,null);return}fe&&ks(c.time,!0),B&&te(B,c.time),o(c.time),a(c.time),d(c.time)}),e.subscribeCrosshairMove(c=>{if(!c||!c.time){x.clearCrosshairPosition(),t.clearCrosshairPosition(),n.clearCrosshairPosition(),B&&te(B,null);return}ue&&rr(c.time,!0),B&&te(B,c.time),o(c.time),l(c.time),d(c.time)}),n.subscribeCrosshairMove(c=>{if(!c||!c.time){x.clearCrosshairPosition(),t.clearCrosshairPosition(),e.clearCrosshairPosition(),B&&te(B,null);return}B&&te(B,c.time),o(c.time),l(c.time),a(c.time)}),e.subscribeClick(c=>{!c||!c.time||ue&&rr(c.time,!1)})}function Ma(){const t=document.getElementById("chart-controls");t&&(La(),t.querySelectorAll("button[data-interval]").forEach(e=>{e.addEventListener("click",n=>{const i=n.currentTarget,r=i.getAttribute("data-interval");r&&(t.querySelectorAll("button[data-interval]").forEach(s=>s.classList.remove("active")),i.classList.add("active"),N&&Ca(r))})}),t.querySelectorAll("button[data-mode]").forEach(e=>{e.addEventListener("click",n=>{const i=n.currentTarget,r=i.getAttribute("data-mode");r&&(t.querySelectorAll("button[data-mode]").forEach(s=>s.classList.remove("active")),i.classList.add("active"),k&&k.setDisplayMode(r))})}),Ra())}const Aa=`<svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
  <polyline points="5.5 1 1 1 1 5.5"/>
  <polyline points="10.5 1 15 1 15 5.5"/>
  <polyline points="10.5 15 15 15 15 10.5"/>
  <polyline points="5.5 15 1 15 1 10.5"/>
</svg>`,Na=`<svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
  <polyline points="1 5.5 5.5 5.5 5.5 1"/>
  <polyline points="15 5.5 10.5 5.5 10.5 1"/>
  <polyline points="15 10.5 10.5 10.5 10.5 15"/>
  <polyline points="1 10.5 5.5 10.5 5.5 15"/>
</svg>`;function Ra(){const t=document.getElementById("chart-fullscreen-btn"),e=document.getElementById("custom-chart-container"),n=document.getElementById("chart-nav-prev"),i=document.getElementById("chart-nav-next");if(!t||!e)return;n&&n.addEventListener("click",()=>nt(-1)),i&&i.addEventListener("click",()=>nt(1)),Ba();const r=()=>{const o=e.classList.contains("chart-fullscreen");t.innerHTML=o?Na:Aa,t.title=o?"Exit fullscreen (Space)":"Fullscreen (Space)";const a=je(Y)[3];let d=null;a==="price-chart-container"?d=x:a==="vd-rsi-chart-container"?d=I:a==="rsi-chart-container"?d=k?.getChart():a==="vd-chart-container"&&(d=z),d&&d.applyOptions({timeScale:{visible:!o}}),o||Fn()},s=()=>{e.classList.toggle("chart-fullscreen"),r()};t.addEventListener("click",s),document.addEventListener("keydown",o=>{const l=document.getElementById("ticker-view");!l||l.classList.contains("hidden")||(o.key==="Escape"&&e.classList.contains("chart-fullscreen")&&(e.classList.remove("chart-fullscreen"),r()),o.code==="Space"&&document.activeElement?.tagName!=="INPUT"&&(o.preventDefault(),s()),o.key==="ArrowLeft"?nt(-1):o.key==="ArrowRight"&&nt(1))})}function nt(t){const e=to(),n=no(),i=document.getElementById("ticker-view")?.dataset.ticker;if(!e||!i)return;let r="";n==="divergence"?r=e==="daily"?"divergence-daily-container":"divergence-weekly-container":r=e==="daily"?"daily-container":"weekly-container";const s=document.getElementById(r);if(!s)return;const o=Array.from(s.querySelectorAll(".alert-card")),l=o.findIndex(d=>d.dataset.ticker===i);if(l===-1)return;const a=l+t;if(a>=0&&a<o.length){const c=o[a].dataset.ticker;c&&window.showTickerView&&window.showTickerView(c,n,e)}}function Ba(){const t=document.getElementById("custom-chart-container");t&&t.addEventListener("dblclick",e=>{const n=t.getBoundingClientRect();if(!(e.clientX-n.left>n.width-60))return;const s=je(Y),o=s[2],l=s[3],a=u=>{const m=document.getElementById(u);return!m||m.style.display==="none"?null:m.getBoundingClientRect()},d=a(o);if(d&&e.clientY>=d.top&&e.clientY<=d.bottom){nt(1);return}const c=a(l);if(c&&e.clientY>=c.top&&e.clientY<=c.bottom){nt(-1);return}})}function cr(t){const e=to(),n=no(),i=document.getElementById("ticker-view")?.dataset.ticker;if(!e||!i)return null;let r="";n==="divergence"?r=e==="daily"?"divergence-daily-container":"divergence-weekly-container":r=e==="daily"?"daily-container":"weekly-container";const s=document.getElementById(r);if(!s)return null;const o=Array.from(s.querySelectorAll(".alert-card")),l=o.findIndex(d=>d.dataset.ticker===i);if(l===-1)return null;const a=l+t;return a>=0&&a<o.length&&o[a].dataset.ticker||null}async function _a(t){const e=cr(1),n=cr(-1),i=async r=>{const s=ki(r,t);if(Ti(s)||Ne.has(s))return;const o=bi(r,t,{vdRsiLength:C.length,vdSourceInterval:w.sourceInterval,vdRsiSourceInterval:C.sourceInterval}).then(l=>Li(s,l)).catch(()=>{}).finally(()=>Ne.delete(s));return Ne.set(s,o),o};e&&await i(e),n&&await i(n)}let Bs="time",_s="time",dr=null,ur=null;function Ps(t){Bs=t,$s(".ticker-daily-sort",t);const e=document.getElementById("ticker-view");if(!e)return;const n=e.dataset.ticker;n&&Un(n,{refreshCharts:!1})}function Fs(t){_s=t,$s(".ticker-weekly-sort",t);const e=document.getElementById("ticker-view");if(!e)return;const n=e.dataset.ticker;n&&Un(n,{refreshCharts:!1})}function $s(t,e){document.querySelectorAll(`${t} .tf-btn`).forEach(n=>{const i=n;i.classList.toggle("active",i.dataset.sort===e)})}function Un(t,e={}){const n=e.refreshCharts!==!1,i=[...pi(),...Ut()];St(i);const r=i.filter(d=>d.ticker===t),s=r.filter(d=>(d.timeframe||"").trim()==="1d"),o=r.filter(d=>(d.timeframe||"").trim()==="1w");s.sort(Oe(Bs)),o.sort(Oe(_s)),fr("ticker-daily-avg",s),fr("ticker-weekly-avg",o);const l=document.getElementById("ticker-daily-container");l&&(s.length===0?l.innerHTML='<div style="text-align:center; padding:20px; color:var(--text-secondary)">No daily alerts</div>':(l.innerHTML=s.map(Ue).join(""),Ve(l)));const a=document.getElementById("ticker-weekly-container");a&&(o.length===0?a.innerHTML='<div style="text-align:center; padding:20px; color:var(--text-secondary)">No weekly alerts</div>':(a.innerHTML=o.map(Ue).join(""),Ve(a))),n&&(Pa(t),me(t))}function fr(t,e){const n=document.getElementById(t);if(!n)return;const i=e.filter(u=>(u.source||"TV")==="TV");if(i.length===0){n.innerHTML="";return}let r=0;i.forEach(u=>{const m=u.combo_score||0,f=(u.signal_type||"").toLowerCase().includes("bull");r+=f?m:-m});const s=Math.round(r/i.length),o=Math.abs(s),c=`background: conic-gradient(${s>=0?"#3fb950":"#f85149"} ${o}%, #0d1117 0%);`;n.innerHTML=`
        <div class="metric-item" title="Average Score: ${s}">
            <div class="score-circle" style="${c}"></div>
        </div>
    `}function Pa(t){if(typeof TradingView>"u")return;const e=K();if(dr===t&&ur===e)return;dr=t,ur=e;const n=document.getElementById("tradingview_chart");n&&(n.innerHTML=""),new TradingView.widget({width:"100%",height:600,symbol:t,interval:"D",timezone:e,theme:"dark",style:"1",locale:"en",toolbar_bg:"#f1f3f6",enable_publishing:!1,allow_symbol_change:!1,studies:["MASimple@tv-basicstudies"],studies_overrides:{"moving average.length":50,"moving average.source":"close","moving average.plot.color":"#ff9800","moving average.plot.linewidth":2},container_id:"tradingview_chart"})}let nn=null,Vs=5,di="SVIX";async function Fa(t,e){const n=await fetch(`/api/breadth?ticker=${t}&days=${e}`);if(!n.ok)throw new Error("Failed to fetch breadth data");return n.json()}function mr(t){if(t.length===0)return[];const e=t[0];return e===0?t.map(()=>100):t.map(n=>n/e*100)}function $a(t,e,n){const i=document.getElementById("breadth-chart");if(!i)return;const r=K();nn&&(nn.destroy(),nn=null);const s=n?new Set(t.map(u=>new Date(u.date).toLocaleDateString("en-US",{timeZone:r}))).size:0,o=t.map(u=>{if(n){const h=new Date(u.date);return s>1?h.toLocaleDateString("en-US",{month:"numeric",day:"numeric",timeZone:r}):h.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",timeZone:r})}return new Date(u.date+"T00:00:00").toLocaleDateString("en-US",{month:"short",day:"numeric",timeZone:r})}),l=t.map(u=>u.spy),a=t.map(u=>u.comparison),d=mr(l),c=mr(a);nn=new Chart(i,{type:"line",data:{labels:o,datasets:[{label:"SPY",data:d,borderColor:"#58a6ff",backgroundColor:"transparent",borderWidth:2.5,pointRadius:d.length>15?0:3,pointHoverRadius:5,tension:.3,order:1,fill:!1},{label:e,data:c,borderColor:"#d2a8ff",backgroundColor:"transparent",borderWidth:2.5,pointRadius:c.length>15?0:3,pointHoverRadius:5,tension:.3,order:2,fill:{target:0,above:"rgba(63, 185, 80, 0.18)",below:"rgba(248, 81, 73, 0.18)"}}]},options:{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{labels:{color:"#c9d1d9",font:{size:12},usePointStyle:!0,pointStyle:"line"}},tooltip:{backgroundColor:"rgba(22, 27, 34, 0.95)",borderColor:"#30363d",borderWidth:1,titleColor:"#c9d1d9",bodyColor:"#8b949e",padding:12,callbacks:{label:function(u){const m=u.parsed.y.toFixed(2);return`${u.dataset.label}: ${m}`}}},filler:{propagate:!0}},scales:{x:{ticks:{color:"#8b949e",maxRotation:0,autoSkip:!0,maxTicksLimit:10,font:{size:11}},grid:{color:"rgba(48, 54, 61, 0.3)"}},y:{ticks:{color:"#8b949e",font:{size:11},callback:function(u){return u.toFixed(1)}},grid:{color:"rgba(48, 54, 61, 0.3)"}}}}})}async function $i(){const t=document.getElementById("breadth-error");t&&(t.style.display="none");try{const e=await Fa(di,Vs);if(e.points.length===0){t&&(t.textContent="No data available for this timeframe",t.style.display="block");return}$a(e.points,di,e.intraday)}catch(e){console.error("Breadth load error:",e),t&&(t.textContent="Failed to load breadth data",t.style.display="block")}}function Va(t){Vs=t,document.querySelectorAll("#breadth-tf-btns .tf-btn").forEach(e=>{e.classList.toggle("active",Number(e.dataset.days)===t)}),$i()}function Oa(t){di=t,document.querySelectorAll("#breadth-metric-btns .tf-btn").forEach(e=>{e.classList.toggle("active",e.dataset.metric===t)}),$i()}function Os(){$i()}let At=null,Yn=!1;function ne(t){return String(t??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function H(t,e=0){const n=Number(t);return Number.isFinite(n)?n.toFixed(Math.max(0,e)):"--"}function Us(t){const e=String(t||"").trim();return e||"idle"}function Ua(t){const e=String(t||"").trim();if(!e)return"--";const n=new Date(e);return Number.isNaN(n.getTime())?"--":n.toLocaleString()}function hr(t,e,n){const i=Us(e?.status||n?.status||(n?.running?"running":"idle")),r=Number(e?.tickers?.processed??n?.processed_tickers??0),s=Number(e?.tickers?.total??n?.total_tickers??0),o=Number(e?.tickers?.errors??0),l=H(e?.api?.p95LatencyMs,1),a=H(e?.api?.avgLatencyMs,1),d=H(e?.api?.calls,0),c=H(e?.api?.failures,0),u=H(e?.api?.rateLimited,0),m=H(e?.db?.flushCount,0),h=H(e?.db?.summaryRows,0),f=H(e?.db?.signalRows,0),g=H(e?.durationSeconds,1),S=ne(e?.phase||"--"),b=Array.isArray(e?.failedTickers)?e.failedTickers:[],p=Array.isArray(e?.retryRecovered)?e.retryRecovered:[],v=b.length,D=p.length;let L="";if(v>0||D>0){const J=b.map(wt=>`<span class="log-failed-ticker">${ne(wt)}</span>`).join(""),he=p.map(wt=>`<span class="log-recovered-ticker">${ne(wt)}</span>`).join("");L=`
          <details class="log-failed-details">
            <summary class="log-failed-summary">
              ${v>0?`${v} failed`:""}${v>0&&D>0?", ":""}${D>0?`${D} recovered via retry`:""}
            </summary>
            <div class="log-failed-body">
              ${v>0?`<div class="log-failed-label">Failed:</div><div class="log-failed-list">${J}</div>`:""}
              ${D>0?`<div class="log-recovered-label">Recovered:</div><div class="log-failed-list">${he}</div>`:""}
            </div>
          </details>
        `}return`
      <article class="log-run-card">
        <div class="log-run-card-title">
          <span>${ne(t)}</span>
          <span class="log-run-card-status">${ne(i)}</span>
        </div>
        <div class="log-run-metrics">
          <span class="log-metric-key">Tickers</span><span class="log-metric-val">${r}/${s||0}</span>
          <span class="log-metric-key">Errors</span><span class="log-metric-val">${o}</span>
          <span class="log-metric-key">API calls</span><span class="log-metric-val">${d}</span>
          <span class="log-metric-key">API fail</span><span class="log-metric-val">${c}</span>
          <span class="log-metric-key">429 count</span><span class="log-metric-val">${u}</span>
          <span class="log-metric-key">API p95 ms</span><span class="log-metric-val">${l}</span>
          <span class="log-metric-key">API avg ms</span><span class="log-metric-val">${a}</span>
          <span class="log-metric-key">DB flushes</span><span class="log-metric-val">${m}</span>
          <span class="log-metric-key">Summary rows</span><span class="log-metric-val">${h}</span>
          <span class="log-metric-key">Signal rows</span><span class="log-metric-val">${f}</span>
          <span class="log-metric-key">Duration s</span><span class="log-metric-val">${g}</span>
          <span class="log-metric-key">Phase</span><span class="log-metric-val">${S}</span>
        </div>
        ${L}
      </article>
    `}function Ha(t){const e=t.config||{},n=ne(e.divergenceSourceInterval||"--"),i=H(e.divergenceLookbackDays,0),r=H(e.divergenceConcurrencyConfigured,0),s=H(e.divergenceFlushSize,0),o=H(e.dataApiMaxRequestsPerSecond,0),l=H(e.dataApiRateBucketCapacity,0),a=H(e.dataApiTimeoutMs,0),d=t.schedulerEnabled?"on":"off";return`
      <article class="log-run-card">
        <div class="log-run-card-title">
          <span>Runtime Config</span>
          <span class="log-run-card-status">${ne(d)}</span>
        </div>
        <div class="log-run-metrics">
          <span class="log-metric-key">Source</span><span class="log-metric-val">${n}</span>
          <span class="log-metric-key">Lookback d</span><span class="log-metric-val">${i}</span>
          <span class="log-metric-key">Concurrency</span><span class="log-metric-val">${r}</span>
          <span class="log-metric-key">Flush size</span><span class="log-metric-val">${s}</span>
          <span class="log-metric-key">API max rps</span><span class="log-metric-val">${o}</span>
          <span class="log-metric-key">Bucket cap</span><span class="log-metric-val">${l}</span>
          <span class="log-metric-key">Timeout ms</span><span class="log-metric-val">${a}</span>
        </div>
      </article>
    `}function za(t){const e=document.getElementById("logs-run-cards");if(!e)return;const n=[hr("Fetch Daily",t.runs?.fetchDaily,t.statuses?.fetchDaily),hr("Fetch Weekly",t.runs?.fetchWeekly,t.statuses?.fetchWeekly),Ha(t)];e.innerHTML=n.join("")}function Wa(t){const e=document.getElementById("logs-history-container");if(!e)return;const n=Array.isArray(t.history)?t.history:[];if(n.length===0){e.innerHTML='<div class="loading">No run history yet</div>';return}e.innerHTML=n.slice(0,15).map(i=>{const r=Number(i?.tickers?.processed||0),s=Number(i?.tickers?.total||0),o=Number(i?.tickers?.errors||0),l=Number(i?.api?.calls||0),a=H(i?.api?.p95LatencyMs,1),d=Array.isArray(i?.failedTickers)?i.failedTickers:[],c=Array.isArray(i?.retryRecovered)?i.retryRecovered:[],u=d.length,m=c.length;let h="";if(u>0||m>0){const f=d.map(S=>`<span class="log-failed-ticker">${ne(S)}</span>`).join(""),g=c.map(S=>`<span class="log-recovered-ticker">${ne(S)}</span>`).join("");h=`
              <details class="log-failed-details">
                <summary class="log-failed-summary">
                  ${u>0?`${u} failed`:""}${u>0&&m>0?", ":""}${m>0?`${m} recovered`:""}
                </summary>
                <div class="log-failed-body">
                  ${u>0?`<div class="log-failed-label">Failed:</div><div class="log-failed-list">${f}</div>`:""}
                  ${m>0?`<div class="log-recovered-label">Recovered:</div><div class="log-failed-list">${g}</div>`:""}
                </div>
              </details>
            `}return`
          <article class="log-history-entry">
            <div class="log-history-header">
              <span>${ne(String(i?.runType||"run"))}</span>
              <span>${ne(Us(i?.status))}</span>
            </div>
            <div class="log-history-sub">
              ${ne(Ua(i?.startedAt))} |
              tickers ${r}/${s}${o>0?` (${o} err)`:""} |
              api ${l} |
              p95 ${a}ms
            </div>
            ${h}
          </article>
        `}).join("")}async function qa(){const t=await fetch("/api/logs/run-metrics",{cache:"no-store"});if(!t.ok)throw new Error(`Failed to fetch run metrics (HTTP ${t.status})`);return t.json()}async function Hn(){if(!Yn){Yn=!0;try{const t=await qa();za(t),Wa(t)}catch(t){const e=document.getElementById("logs-history-container");e&&(e.innerHTML='<div class="loading">Failed to load logs</div>'),console.error("Failed to refresh logs view:",t)}finally{Yn=!1}}}function Ga(){At===null&&(At=window.setInterval(()=>{Hn().catch(()=>{})},5e3))}function ja(){At!==null&&(window.clearInterval(At),At=null)}function Ka(){document.getElementById("logs-refresh-btn")?.addEventListener("click",()=>{Hn().catch(()=>{})})}let Vi="today",Pe="combo",Fe="combo",we="desc",Ce="desc",an=null,Xn=!1,rn=0;const gr=3;let rt=-1,st=-1,kn=0;const Za=8e3;let ot=!1,lt=!1,at=!1,W=!1,q=!1;function Ya(t){Vi=t}function Hs(){return{button:document.getElementById("divergence-run-btn"),status:document.getElementById("divergence-run-status")}}function zs(){return{button:document.getElementById("divergence-run-table-btn"),status:document.getElementById("divergence-table-run-status")}}function Ws(){return{button:document.getElementById("divergence-fetch-all-btn"),status:document.getElementById("divergence-fetch-all-status")}}function qs(){return{button:document.getElementById("divergence-fetch-weekly-btn"),status:document.getElementById("divergence-fetch-weekly-status")}}function Xa(){return{pauseResumeButton:document.getElementById("divergence-run-pause-resume-btn"),stopButton:document.getElementById("divergence-run-stop-btn")}}function Ja(){return{pauseResumeButton:document.getElementById("divergence-table-pause-resume-btn"),stopButton:document.getElementById("divergence-table-stop-btn"),manualUpdateButton:document.getElementById("divergence-manual-update-btn")}}function Qa(){return{stopButton:document.getElementById("divergence-fetch-all-stop-btn")}}function ec(){return{stopButton:document.getElementById("divergence-fetch-weekly-stop-btn")}}function En(t,e=!1){const{button:n}=Hs();n&&(n.disabled=t||e,n.classList.toggle("active",t),n.textContent=t?"Running":"Run Fetch")}function Tn(t){const{status:e}=Hs();e&&(e.textContent=t)}function Ln(t,e=!1){const{button:n}=zs();n&&(n.disabled=t||e,n.classList.toggle("active",t),n.textContent=t?"Running":"Run Table")}function xn(t){const{status:e}=zs();e&&(e.textContent=t)}function gt(t,e=!1){const{button:n}=Ws();n&&(n.disabled=t,n.classList.toggle("active",t),e&&!t?n.textContent="Resume Fetch":n.textContent="Fetch Daily")}function oe(t){const{status:e}=Ws();e&&(e.textContent=t)}function pt(t,e=!1){const{button:n}=qs();n&&(n.disabled=t,n.classList.toggle("active",t),e&&!t?n.textContent="Resume Fetch":n.textContent="Fetch Weekly")}function le(t){const{status:e}=qs();e&&(e.textContent=t)}function In(t){const{pauseResumeButton:e,stopButton:n}=Xa(),i=t?.scanControl||null,r=!!(i?.running||t?.running),s=!!i?.pause_requested,o=!!i?.can_resume,l=!!i?.stop_requested;e&&(e.textContent=o&&!r?"▶":"⏸",e.disabled=r?s:!o,e.classList.toggle("active",r||o),e.setAttribute("aria-label",o&&!r?"Resume Run Fetch":"Pause Run Fetch"),e.title=o&&!r?"Resume Run Fetch":"Pause Run Fetch"),n&&(n.textContent="⏹",n.disabled=!r||l,n.classList.toggle("active",r),n.setAttribute("aria-label","Stop Run Fetch"),n.title="Stop Run Fetch")}function Mn(t){const{pauseResumeButton:e,stopButton:n,manualUpdateButton:i}=Ja(),r=t?.tableBuild||null,s=!!r?.running,o=!!r?.pause_requested,l=!!r?.stop_requested,a=!!r?.can_resume;e&&(e.textContent=a&&!s?"▶":"⏸",e.disabled=s?o:!a,e.classList.toggle("active",s||a),e.setAttribute("aria-label",a&&!s?"Resume Run Table":"Pause Run Table"),e.title=a&&!s?"Resume Run Table":"Pause Run Table"),n&&(n.textContent="⏹",n.disabled=!s||l,n.classList.toggle("active",s),n.setAttribute("aria-label","Stop Run Table"),n.title="Stop Run Table"),i&&(i.disabled=!1)}function An(t){const{stopButton:e}=Qa(),n=t?.fetchAllData||null,i=!!n?.running,r=!!n?.stop_requested;e&&(e.textContent="⏹",e.disabled=!i||r,e.classList.toggle("active",i),e.setAttribute("aria-label","Stop Fetch Daily"),e.title="Stop Fetch Daily")}function Nn(t){const{stopButton:e}=ec(),n=t?.fetchWeeklyData||null,i=!!n?.running,r=!!n?.stop_requested;e&&(e.textContent="⏹",e.disabled=!i||r,e.classList.toggle("active",i),e.setAttribute("aria-label","Stop Fetch Weekly"),e.title="Stop Fetch Weekly")}function re(t){const e=String(t?.message||t||"").trim();return e?/not configured/i.test(e)?"DB not configured":/unauthorized/i.test(e)?"Unauthorized":/already running|running/i.test(e)?"Already running":e.length>56?`${e.slice(0,56)}...`:e:"Run failed"}function P(t){const e=String(t||"").trim();if(!e)return null;const n=e.match(/^(\d{4})-(\d{2})-(\d{2})/);return n?`${n[1]}-${n[2]}-${n[3]}`:null}function $t(t){const e=t.split("-");if(e.length!==3)return"";const n=Number(e[1]),i=Number(e[2]);return!Number.isFinite(n)||n<=0||!Number.isFinite(i)||i<=0?"":`${n}/${i}`}function pr(t){const e=t.latestJob,n=P(t.lastScanDateEt)||P(e?.scanned_trade_date)||P(e?.run_for_date)||P(e?.finished_at)||P(e?.started_at);if(!n)return"Fetched";const i=$t(n);return i?`Fetched ${i}`:"Fetched"}function Gs(t){const e=t.latestJob,n=t.scanControl||null;if(t.running){const i=Number(e?.processed_symbols||0),r=Number(e?.total_symbols||0);return n?.stop_requested?r>0?`Stopping ${i}/${r}`:"Stopping":n?.pause_requested?r>0?`Pausing ${i}/${r}`:"Pausing":r>0?`Running ${i}/${r}`:"Running"}if(e?.status==="paused"){const i=Number(e?.processed_symbols||0),r=Number(e?.total_symbols||0);return r>0?`Paused ${i}/${r}`:"Paused"}return e?.status==="stopped"?"Stopped":e?.status==="completed"?pr(t):e?.status==="failed"?"Last run failed":t.lastScanDateEt||e?.run_for_date||e?.finished_at||e?.started_at?pr(t):"Idle"}function js(t){const e=t.tableBuild;if(!e)return"Table idle";const n=String(e.status||"").toLowerCase(),i=Number(e.error_tickers||0);if(n==="stopped")return"Table stopped";if(n==="paused"){const r=Number(e.processed_tickers||0),s=Number(e.total_tickers||0);return s>0?`Paused ${r}/${s}`:"Table paused"}if(e.running){const r=Number(e.processed_tickers||0),s=Number(e.total_tickers||0);return e.stop_requested?s>0?`Stopping ${r}/${s}`:"Stopping":e.pause_requested?s>0?`Pausing ${r}/${s}`:"Pausing":s>0?`Table ${r}/${s}`:"Table running"}if(n==="completed"){const r=P(e.last_published_trade_date||null),s=r?$t(r):"";return s?`Table ${s}`:"Table fetched"}if(n==="completed-with-errors"){const r=P(e.last_published_trade_date||null),s=r?$t(r):"";return s&&i>0?`Table ${s} (${i} errors)`:i>0?`Table done (${i} errors)`:s?`Table ${s}`:"Table fetched"}return n==="failed"?"Table failed":"Table idle"}function Ks(t){const e=t.fetchAllData,n=t.latestJob,i=P(e?.last_published_trade_date||null)||P(t.lastScanDateEt)||P(n?.scanned_trade_date)||P(n?.run_for_date)||P(n?.finished_at)||P(n?.started_at),r=i?$t(i):"",s=r?`Ran ${r}`:"Ran --";if(!e)return s;const o=String(e.status||"").toLowerCase();if(o==="stopping")return"Stopping";if(o==="stopped"){if(e.can_resume){const l=Number(e.processed_tickers||0),a=Number(e.total_tickers||0);return a>0?`Stopped ${l}/${a} (resumable)`:"Stopped (resumable)"}return"Stopped"}if(e.running){const l=Number(e.processed_tickers||0),a=Number(e.total_tickers||0),d=Number(e.error_tickers||0);return e.stop_requested?"Stopping":o==="running-retry"?`Retrying ${d} failed (${l}/${a})`:o==="running-ma"?`MA ${l}/${a}`:o==="running-ma-retry"?`Retrying failed MA (${l}/${a})`:`${l} / ${a}`}return s}function Zs(t){const e=t.fetchWeeklyData,n=t.latestJob,i=P(e?.last_published_trade_date||null)||P(t.lastScanDateEt)||P(n?.scanned_trade_date)||P(n?.run_for_date)||P(n?.finished_at)||P(n?.started_at),r=i?$t(i):"",s=r?`Ran ${r}`:"Ran --";if(!e)return s;const o=String(e.status||"").toLowerCase();if(o==="stopping")return"Stopping";if(o==="stopped"){if(e.can_resume){const l=Number(e.processed_tickers||0),a=Number(e.total_tickers||0);return a>0?`Stopped ${l}/${a} (resumable)`:"Stopped (resumable)"}return"Stopped"}if(e.running){const l=Number(e.processed_tickers||0),a=Number(e.total_tickers||0),d=Number(e.error_tickers||0);return e.stop_requested?"Stopping":o==="running-retry"?`Retrying ${d} failed (${l}/${a})`:o==="running-ma"?`MA ${l}/${a}`:o==="running-ma-retry"?`Retrying failed MA (${l}/${a})`:`${l} / ${a}`}return s}function Rn(){an!==null&&(window.clearInterval(an),an=null)}function Bn(t=!1,e){const n=Date.now();!t&&n-kn<Za||(kn=n,e?ui(e).then(()=>Vt(e)).catch(()=>{}):yt().then(vt).catch(()=>{}))}async function Oi(t){if(!Xn){Xn=!0;try{const e=await Rr();rn=0,ot=!!e.tableBuild?.running,lt=!!e.fetchAllData?.running,at=!!e.fetchWeeklyData?.running,En(e.running,!!e.scanControl?.can_resume),Tn(Gs(e)),In(e);const n=ot;Ln(n,!!e.tableBuild?.can_resume),xn(js(e)),Mn(e);const i=lt,r=!!e.fetchAllData?.can_resume;gt(i,r),oe(Ks(e)),An(e);const s=at,o=!!e.fetchWeeklyData?.can_resume;if(pt(s,o),le(Zs(e)),Nn(e),i?(W=!0,q=!1):s&&(q=!0,W=!1),i&&W){const l=Number(e.fetchAllData?.processed_tickers||0),a=l!==rt;rt=l,Bn(a,"1d")}else rt=-1;if(s&&q){const l=Number(e.fetchWeeklyData?.processed_tickers||0),a=l!==st;st=l,Bn(a,"1w")}else st=-1;!i&&!s&&(kn=0),!e.running&&!n&&!i&&!s&&(Rn(),t&&(W&&(await ui("1d"),Vt("1d")),q&&(await ui("1w"),Vt("1w"))),W=!1,q=!1)}catch(e){rn+=1,rn<gr?console.warn(`Scan status poll failed (${rn}/${gr}), retrying next cycle`):(console.error("Failed to poll divergence scan status:",e),ot=!1,lt=!1,at=!1,Tn(re(e)),xn(re(e)),oe(re(e)),le(re(e)),Rn(),En(!1,!1),In(null),Ln(!1,!1),Mn(null),gt(!1,!1),An(null),pt(!1,!1),Nn(null),W=!1,q=!1)}finally{Xn=!1}}}function Ui(t){Rn(),an=window.setInterval(()=>{Oi(t)},2500)}async function qt(){try{const t=await Rr();ot=!!t.tableBuild?.running,lt=!!t.fetchAllData?.running,at=!!t.fetchWeeklyData?.running,En(t.running,!!t.scanControl?.can_resume),Tn(Gs(t)),In(t);const e=ot;Ln(e,!!t.tableBuild?.can_resume),xn(js(t)),Mn(t);const n=lt,i=!!t.fetchAllData?.can_resume;gt(n,i),oe(Ks(t)),An(t);const r=at,s=!!t.fetchWeeklyData?.can_resume;if(pt(r,s),le(Zs(t)),Nn(t),n?(W=!0,q=!1):r&&(q=!0,W=!1),n&&W){const o=Number(t.fetchAllData?.processed_tickers||0),l=o!==rt;rt=o,Bn(l,"1d")}else rt=-1;if(r&&q){const o=Number(t.fetchWeeklyData?.processed_tickers||0),l=o!==st;st=o,Bn(l,"1w")}else st=-1;!n&&!r&&(kn=0),t.running||e||n||r?Ui(!0):(Rn(),W=!1,q=!1)}catch(t){console.error("Failed to sync divergence scan UI state:",t),ot=!1,lt=!1,at=!1,En(!1,!1),In(null),Tn(re(t)),Ln(!1,!1),xn(re(t)),Mn(null),gt(!1,!1),oe(re(t)),An(null),pt(!1,!1),le(re(t)),Nn(null),W=!1,q=!1}}async function tc(){gt(!0),oe("Starting..."),W=!0,q=!1;try{const t=await xo();t.status==="running"?oe("Already running"):t.status==="resumed"&&oe("Resuming..."),Ui(!0),await Oi(!1)}catch(t){console.error("Failed to start fetch-all run:",t),gt(!1),oe(re(t))}}async function nc(){pt(!0),le("Starting..."),q=!0,W=!1;try{const t=await Mo();t.status==="running"?le("Already running"):t.status==="resumed"&&le("Resuming..."),Ui(!0),await Oi(!1)}catch(t){console.error("Failed to start fetch-weekly run:",t),pt(!1),le(re(t))}}async function ic(){try{(await Io()).status==="stop-requested"&&oe("Stopping"),W=!1,await qt()}catch(t){console.error("Failed to stop fetch-all run:",t),oe(re(t))}}async function rc(){try{(await Ao()).status==="stop-requested"&&le("Stopping"),q=!1,await qt()}catch(t){console.error("Failed to stop fetch-weekly run:",t),le(re(t))}}async function yt(t){try{const e=document.getElementById("divergence-history-week")?.value||"",n=document.getElementById("divergence-history-month")?.value||"",{startDate:i,endDate:r}=gi(Vi,e,n);if(!i||!r)return[];const s=`?start_date=${i}&end_date=${r}`,o=await Ar(s);return St(o),yi(o),o}catch(e){return console.error("Error fetching divergence signals:",e),[]}}function vt(){const t=Ut();St(t);const e=document.getElementById("divergence-daily-container"),n=document.getElementById("divergence-weekly-container");if(!e||!n)return;const i=t.filter(s=>(s.timeframe||"").trim()==="1d"),r=t.filter(s=>(s.timeframe||"").trim()==="1w");i.sort(Oe(Pe,we)),r.sort(Oe(Fe,Ce)),e.innerHTML=i.map(Ue).join(""),n.innerHTML=r.map(Ue).join(""),Ve(e),Ve(n)}async function ui(t){try{const e=document.getElementById("divergence-history-week")?.value||"",n=document.getElementById("divergence-history-month")?.value||"",{startDate:i,endDate:r}=gi(Vi,e,n);if(!i||!r)return[];const s=`?start_date=${i}&end_date=${r}&timeframe=${t}`,o=await Ar(s);return St(o),No(t,o),o}catch(e){return console.error(`Error fetching divergence signals for ${t}:`,e),[]}}function Vt(t){const e=Ut(),n=t==="1d"?"divergence-daily-container":"divergence-weekly-container",i=document.getElementById(n);if(!i)return;const r=t==="1d"?Pe:Fe,s=t==="1d"?we:Ce,o=e.filter(l=>(l.timeframe||"").trim()===t);o.sort(Oe(r,s)),i.innerHTML=o.map(Ue).join(""),Ve(i)}function sc(){const t=document.getElementById("view-divergence");if(!t)return;t.addEventListener("click",d=>{const c=d.target,u=c.closest(".fav-icon");if(u){d.stopPropagation();const h=u.dataset.id,f=u.dataset.source==="TV"?"TV":"DataAPI";if(!h)return;const g=document.querySelectorAll(`.fav-icon[data-id="${h}"][data-source="${f}"]`),S=u.classList.contains("filled");g.forEach(b=>{const p=b.querySelector(".check-mark");S?(b.classList.remove("filled"),p&&(p.style.visibility="hidden",p.style.opacity="0")):(b.classList.add("filled"),p&&(p.style.visibility="visible",p.style.opacity="1"))}),Nr(Number(h)).then(b=>{const p=Ut(),v=p.findIndex(D=>D.id===b.id);v!==-1&&(p[v].is_favorite=b.is_favorite,yi(p)),g.forEach(D=>{const L=D.querySelector(".check-mark");b.is_favorite?(D.classList.add("filled"),L&&(L.style.visibility="visible",L.style.opacity="1")):(D.classList.remove("filled"),L&&(L.style.visibility="hidden",L.style.opacity="0"))})}).catch(()=>{g.forEach(b=>{const p=b.querySelector(".check-mark");S?(b.classList.add("filled"),p&&(p.style.visibility="visible",p.style.opacity="1")):(b.classList.remove("filled"),p&&(p.style.visibility="hidden",p.style.opacity="0"))})});return}const m=c.closest(".alert-card");if(m){const h=m.dataset.ticker;if(h&&window.showTickerView){let f=null;m.closest("#divergence-daily-container")?f="daily":m.closest("#divergence-weekly-container")&&(f="weekly"),window.showTickerView(h,"divergence",f)}}});const e=document.getElementById("divergence-btn-t"),n=document.getElementById("divergence-btn-y"),i=document.getElementById("divergence-btn-30"),r=document.getElementById("divergence-btn-7"),s=document.getElementById("divergence-btn-week"),o=document.getElementById("divergence-btn-month");e?.addEventListener("click",()=>Me("today")),n?.addEventListener("click",()=>Me("yesterday")),i?.addEventListener("click",()=>Me("30")),r?.addEventListener("click",()=>Me("7")),s?.addEventListener("click",()=>Me("week")),o?.addEventListener("click",()=>Me("month"));const l=document.getElementById("divergence-history-week"),a=document.getElementById("divergence-history-month");l?.addEventListener("change",()=>yt().then(vt)),a?.addEventListener("change",()=>yt().then(vt)),document.querySelectorAll("#view-divergence .divergence-daily-sort").forEach(d=>{d.addEventListener("click",()=>{const c=d.dataset.sort;oc(c)})}),document.querySelectorAll("#view-divergence .divergence-weekly-sort").forEach(d=>{d.addEventListener("click",()=>{const c=d.dataset.sort;lc(c)})})}function oc(t){t===Pe&&t!=="favorite"?we=we==="desc"?"asc":"desc":(Pe=t,we="desc"),de("#view-divergence .divergence-daily-sort",Pe,we),Vt("1d")}function lc(t){t===Fe&&t!=="favorite"?Ce=Ce==="desc"?"asc":"desc":(Fe=t,Ce="desc"),de("#view-divergence .divergence-weekly-sort",Fe,Ce),Vt("1w")}function ac(){Pe="combo",we="desc",Fe="combo",Ce="desc",de("#view-divergence .divergence-daily-sort",Pe,we),de("#view-divergence .divergence-weekly-sort",Fe,Ce)}function Me(t,e=!0){Ya(t);const n=document.getElementById("divergence-btn-t"),i=document.getElementById("divergence-btn-y"),r=document.getElementById("divergence-btn-30"),s=document.getElementById("divergence-btn-7"),o=document.getElementById("divergence-btn-week"),l=document.getElementById("divergence-btn-month"),a=document.getElementById("divergence-history-week"),d=document.getElementById("divergence-history-month");[n,i,r,s,o,l].forEach(c=>c?.classList.remove("active")),a?.classList.add("hidden"),d?.classList.add("hidden"),t==="today"?n?.classList.add("active"):t==="yesterday"?i?.classList.add("active"):t==="30"?r?.classList.add("active"):t==="7"?s?.classList.add("active"):t==="week"?(o?.classList.add("active"),a?.classList.remove("hidden")):t==="month"&&(l?.classList.add("active"),d?.classList.remove("hidden")),e&&yt().then(vt)}let Ae="divergence",Ys=0,Xs=0,Hi="live",Js=null,yr=!1;const Qs="catvue_unlock_v1",eo="46110603",vr=eo.length;window.setDailySort=Fr;window.setWeeklySort=$r;window.setTickerDailySort=Ps;window.setTickerWeeklySort=Fs;function to(){return Js}function no(){return Hi}window.showTickerView=function(t,e="live",n=null){Hi=e,Js=n,e==="divergence"?Xs=window.scrollY:Ys=window.scrollY,Ae!=="live"&&ye("live"),io(e==="divergence"?"divergence":"live");const i=document.getElementById("ticker-view");i&&(i.dataset.ticker=t,document.getElementById("reset-filter")?.classList.remove("hidden"),document.getElementById("dashboard-view")?.classList.add("hidden"),i.classList.remove("hidden"),Un(t),window.scrollTo(0,0))};window.showOverview=function(){const t=document.getElementById("ticker-view");if(t&&delete t.dataset.ticker,Hi==="divergence"){document.getElementById("reset-filter")?.classList.add("hidden"),ye("divergence"),window.scrollTo(0,Xs);return}He(),window.scrollTo(0,Ys)};function ye(t){Ae=t,io(t),document.getElementById("view-logs")?.classList.add("hidden"),document.getElementById("view-live")?.classList.add("hidden"),document.getElementById("view-divergence")?.classList.add("hidden"),document.getElementById("view-leaderboard")?.classList.add("hidden"),document.getElementById("view-breadth")?.classList.add("hidden"),document.getElementById("live-controls")?.classList.add("hidden"),document.getElementById("divergence-controls")?.classList.add("hidden"),document.getElementById("leaderboard-controls")?.classList.add("hidden"),document.getElementById("breadth-controls")?.classList.add("hidden"),ja(),t==="logs"?(document.getElementById("view-logs")?.classList.remove("hidden"),Hn().catch(()=>{}),Ga()):t==="live"?(document.getElementById("view-live")?.classList.remove("hidden"),document.getElementById("live-controls")?.classList.remove("hidden")):t==="divergence"?(document.getElementById("view-divergence")?.classList.remove("hidden"),document.getElementById("divergence-controls")?.classList.remove("hidden"),yt().then(vt),qt()):t==="leaderboard"?(document.getElementById("view-leaderboard")?.classList.remove("hidden"),document.getElementById("leaderboard-controls")?.classList.remove("hidden"),vi()):t==="breadth"&&(document.getElementById("view-breadth")?.classList.remove("hidden"),document.getElementById("breadth-controls")?.classList.remove("hidden"),Os())}function io(t){document.querySelectorAll(".nav-btn").forEach(e=>e.classList.remove("active")),document.getElementById(`nav-${t}`)?.classList.add("active")}function cc(){const t=document.getElementById("search-toggle"),e=document.getElementById("search-input"),n=document.getElementById("search-container");!t||!e||!n||(t.addEventListener("click",i=>{i.stopPropagation(),e.classList.contains("active")?(e.classList.remove("active"),e.blur()):(e.classList.add("active"),e.focus())}),n.addEventListener("click",()=>{e.classList.contains("active")||(e.classList.add("active"),e.focus())}),e.addEventListener("keydown",i=>{if(i.key==="Enter"){const r=e.value.trim().toUpperCase();r&&(window.showTickerView(r),e.value="",e.blur(),e.classList.remove("active"))}}),document.addEventListener("keydown",i=>{document.activeElement instanceof HTMLInputElement||document.activeElement instanceof HTMLTextAreaElement||document.activeElement.isContentEditable||i.ctrlKey||i.altKey||i.metaKey||i.key.length>1||/^[a-zA-Z0-9]$/.test(i.key)&&(e.classList.contains("active")||e.classList.add("active"),e.focus())}))}function dc(t,e){const n=dn(e),i=un(e),r=dn(t),s=un(t),o=document.getElementById("history-week"),l=document.getElementById("history-month"),a=document.getElementById("divergence-history-week"),d=document.getElementById("divergence-history-month");o&&(!o.value||o.value===n)&&(o.value=r),a&&(!a.value||a.value===n)&&(a.value=r),l&&(!l.value||l.value===i)&&(l.value=s),d&&(!d.value||d.value===i)&&(d.value=s)}async function uc(){if(Ae==="live"){await mn();const t=document.getElementById("ticker-view"),e=t?.dataset.ticker;e&&!t?.classList.contains("hidden")?Un(e,{refreshCharts:!0}):He();return}if(Ae==="divergence"){await yt(),vt();return}if(Ae==="leaderboard"){vi();return}if(Ae==="breadth"){Os();return}Ae==="logs"&&await Hn()}function fc(){const t=document.getElementById("global-settings-container"),e=document.getElementById("global-settings-toggle"),n=document.getElementById("global-settings-panel");let i=document.getElementById("global-timezone-select");if(!t||!e||!n)return;const r=()=>{n.querySelectorAll(".global-settings-toggle-row").forEach(m=>m.remove());const c=n.querySelector("#global-enable-v3-fetch, #enable-v3-fetch");c&&(c.closest(".global-settings-row")||c).remove(),n.querySelectorAll("label, span, div").forEach(m=>{String(m.textContent||"").trim().toLowerCase()==="enable v3 fetch"&&(m.closest(".global-settings-row")||m).remove()})},s=()=>{if(i)return i;const c=document.createElement("div");c.className="global-settings-row global-settings-timezone-row";const u=document.createElement("label");u.className="global-settings-label",u.htmlFor="global-timezone-select",u.textContent="Timezone";const m=document.createElement("select");return m.id="global-timezone-select",m.className="glass-input global-settings-select",m.setAttribute("aria-label","Timezone"),c.append(u,m),n.append(c),i=m,m};r(),i=s();const o=i,l=()=>{n.classList.add("hidden"),e.classList.remove("active")},a=()=>{n.classList.remove("hidden"),e.classList.add("active"),o.value=K()},d=uo();o.innerHTML=d.map(c=>`<option value="${c.value}">${c.label}</option>`).join(""),o.value=K(),o.addEventListener("change",()=>{fo(o.value)}),mo((c,u)=>{dc(c,u),o.value=c,uc().catch(m=>{console.error("Failed to refresh UI after timezone change:",m)})}),e.addEventListener("click",c=>{c.stopPropagation(),n.classList.contains("hidden")?(a(),qt().catch(()=>{})):l()}),n.addEventListener("click",c=>{c.stopPropagation()}),document.addEventListener("click",c=>{const u=c.target;u&&(u.closest("#global-settings-container")||l())})}function mc(){try{return window.localStorage.getItem(Qs)==="1"}catch{return!1}}function hc(){try{window.localStorage.setItem(Qs,"1")}catch{}}function gc(t){const e=document.getElementById("site-lock-overlay");if(!e){t();return}e.dataset.doubleTapBound||(e.addEventListener("dblclick",b=>{b.preventDefault()}),e.dataset.doubleTapBound="1");const n=e.querySelector(".site-lock-panel"),i=document.getElementById("site-lock-status"),r=Array.from(e.querySelectorAll(".site-lock-dot")),s=Array.from(e.querySelectorAll("[data-lock-digit]")),o=Array.from(e.querySelectorAll("[data-lock-action]"));if(mc()){e.classList.add("hidden"),document.body.classList.remove("site-locked"),t();return}document.body.classList.add("site-locked"),e.classList.remove("hidden");let l="";const a=()=>{for(let b=0;b<r.length;b++)r[b].classList.toggle("filled",b<l.length)},d=b=>{i&&(i.textContent=b)},c=()=>{l="",a()},u=()=>{hc(),e.classList.add("hidden"),document.body.classList.remove("site-locked"),window.removeEventListener("keydown",S,!0),t()},m=()=>{d(""),c(),n&&(n.classList.remove("shake"),n.offsetWidth,n.classList.add("shake")),window.setTimeout(()=>{n&&n.classList.remove("shake")},320)},h=()=>{if(!(l.length<vr)){if(l===eo){u();return}m()}},f=b=>{/^[0-9]$/.test(b)&&(l.length>=vr||(l+=b,d(""),a(),h()))},g=()=>{l.length&&(l=l.slice(0,-1),d(""),a())};s.forEach(b=>{b.addEventListener("click",()=>{f(String(b.dataset.lockDigit||""))})}),o.forEach(b=>{b.addEventListener("click",()=>{const p=String(b.dataset.lockAction||"");if(p==="clear"){c(),d("");return}p==="back"&&g()})});const S=b=>{if(e.classList.contains("hidden"))return;const p=b.key;if(/^[0-9]$/.test(p)){b.preventDefault(),f(p);return}if(p==="Backspace"){b.preventDefault(),g();return}p==="Escape"&&(b.preventDefault(),c(),d(""))};window.addEventListener("keydown",S,!0),a()}function pc(){if(yr)return;yr=!0,document.getElementById("nav-logs")?.addEventListener("click",()=>ye("logs")),document.getElementById("nav-live")?.addEventListener("click",()=>ye("live")),document.getElementById("nav-divergence")?.addEventListener("click",()=>ye("divergence")),document.getElementById("nav-leaderboard")?.addEventListener("click",()=>{ye("leaderboard")}),document.getElementById("nav-breadth")?.addEventListener("click",()=>ye("breadth")),document.getElementById("reset-filter")?.addEventListener("click",window.showOverview),document.getElementById("divergence-fetch-all-btn")?.addEventListener("click",()=>{tc()}),document.getElementById("divergence-fetch-all-stop-btn")?.addEventListener("click",()=>{ic()}),document.getElementById("divergence-fetch-weekly-btn")?.addEventListener("click",()=>{nc()}),document.getElementById("divergence-fetch-weekly-stop-btn")?.addEventListener("click",()=>{rc()});const t=document.getElementById("history-week"),e=document.getElementById("history-month"),n=document.getElementById("divergence-history-week"),i=document.getElementById("divergence-history-month");document.querySelectorAll(".ticker-daily-sort .tf-btn").forEach(r=>{r.addEventListener("click",()=>{const s=r.dataset.sort;Ps(s)})}),document.querySelectorAll(".ticker-weekly-sort .tf-btn").forEach(r=>{r.addEventListener("click",()=>{const s=r.dataset.sort;Fs(s)})}),t&&(t.value=dn()),e&&(e.value=un()),n&&(n.value=dn()),i&&(i.value=un()),document.querySelectorAll("#leaderboard-controls .tf-btn").forEach(r=>{r.addEventListener("click",s=>{document.querySelectorAll("#leaderboard-controls .tf-btn").forEach(o=>o.classList.remove("active")),s.target.classList.add("active"),vi()})}),document.querySelectorAll("#breadth-tf-btns .tf-btn").forEach(r=>{r.addEventListener("click",()=>{const s=Number(r.dataset.days);Va(s)})}),document.querySelectorAll("#breadth-metric-btns .tf-btn").forEach(r=>{r.addEventListener("click",()=>{const s=r.dataset.metric;Oa(s);const o=document.getElementById("breadth-subtitle");o&&(o.textContent=`SPY vs ${s} — Normalized`)})}),_o(),ac(),Ie("today"),Me("today",!1),qt().catch(()=>{}),ye("divergence"),fc(),cc(),Ka(),Bo(),sc(),Fo(),yc(),Ma()}document.addEventListener("DOMContentLoaded",()=>{gc(()=>{pc()})});function yc(){const t=(e,n)=>{e&&e.addEventListener("click",i=>{if(window.innerWidth>768)return;const r=i.target;if(!r)return;const s=r.closest("h2");if(!s||!(s.closest(".column-header")||s.closest(".header-title-group")))return;const l=s.closest(".column");l&&l.closest(n)&&l.classList.toggle("collapsed")})};t(document.getElementById("view-live"),"#dashboard-view"),t(document.getElementById("view-divergence"),"#divergence-dashboard-view")}
