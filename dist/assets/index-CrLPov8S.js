import{V as pi,a as ht}from"./vendor-charts-C-3zq_q_.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}})();let Ko=[];function Zo(){return Ko}let Wn=[];function hi(){return Wn}function Yo(t){Wn=t}function Xo(t,e){Wn=[...Wn.filter(i=>(i.timeframe||"").trim()!==t),...e]}const ls="catvue_app_timezone_v1",$i="America/Los_Angeles",cs=[{value:"America/Los_Angeles",label:"Los Angeles (US Pacific time)"},{value:"America/Denver",label:"Denver (US Mountain time)"},{value:"America/Chicago",label:"Chicago (US Central time)"},{value:"America/New_York",label:"New York (US Eastern time)"},{value:"UTC",label:"UTC"}],Jo=new Set(cs.map(t=>t.value)),Ui=new Set;let qn=ea(),Wi=qn;const Rn=new Map;function Qo(t){if(!t)return!1;try{return new Intl.DateTimeFormat("en-US",{timeZone:t}),!0}catch{return!1}}function us(t){const e=String(t||"").trim();return!e||!Jo.has(e)||!Qo(e)?$i:e}function ea(){let t="";try{t=typeof window<"u"?String(window.localStorage.getItem(ls)||""):""}catch{t=""}return us(t)}function ta(t){try{if(typeof window>"u")return;window.localStorage.setItem(ls,t)}catch{}}function na(t,e){const n=Array.isArray(t)?t.join("|"):t,i=Object.entries(e).sort(([r],[s])=>r.localeCompare(s)).map(([r,s])=>`${r}:${String(s)}`);return`${n}|${i.join(",")}`}function ia(){return cs.map(t=>({...t}))}function ue(){return qn}function fn(t="en-US",e={}){const n=ue();Wi!==n&&(Rn.clear(),Wi=n);const i=na(t,e),r=Rn.get(i);if(r)return r;const s=new Intl.DateTimeFormat(t,{...e,timeZone:n});return Rn.set(i,s),s}function ra(t){const e=us(t),n=qn;return e===n||(qn=e,ta(e),Rn.clear(),Wi=e,Ui.forEach(i=>{try{i(e,n)}catch{}})),e}function sa(t){return Ui.add(t),()=>{Ui.delete(t)}}const de=[1,3,7,14,28],qi=new Map,Sn=new Map,oa="custom_chart_settings_v1",$n="1min",aa=new Set(["1min","5min","15min","30min","1hour","4hour"]);function ds(t){const e=String(t||"").trim().toLowerCase();return e==="bullish"||e==="bearish"?e:"neutral"}function Je(t){return String(t||"").trim().toUpperCase()}function gi(t){const e=String(t||"").trim();return aa.has(e)?e:$n}function mn(){try{if(typeof window>"u")return $n;const t=window.localStorage.getItem(oa);if(!t)return $n;const e=JSON.parse(t);return gi(e?.volumeDelta?.sourceInterval)}catch{return $n}}function fs(t,e){return`${Je(t)}|${gi(e)}`}function cr(t,e){const n=fs(t,e),i=qi.get(n);return i?!Number.isFinite(i.expiresAtMs)||i.expiresAtMs<=Date.now()?(qi.delete(n),null):i:null}function ms(t,e){const n=fs(e.ticker,t);qi.set(n,e)}function ps(){const t={};for(const e of de)t[String(e)]="neutral";return t}function la(t){const e=Je(t?.ticker);if(!e)return null;const n=ps(),i=t?.states||{};for(const o of de)n[String(o)]=ds(i[String(o)]);const r=Number(t?.expiresAtMs),s=Number.isFinite(r)&&r>Date.now()?r:Date.now()+3600*1e3;return{ticker:e,tradeDate:typeof t?.tradeDate=="string"?t.tradeDate:null,states:n,expiresAtMs:s}}async function ca(t,e,n){const i=gi(e),r=n?.forceRefresh===!0,s=n?.noCache===!0,o=Array.from(new Set(t.map(d=>Je(d)).filter(Boolean)));if(o.length===0)return new Map;const a=`${i}|${r?"refresh":"cached"}|${s?"nocache":"cache"}|${o.join(",")}`;if(Sn.has(a))return await Sn.get(a);const l=(async()=>{const d=new Map,c=new URLSearchParams;c.set("tickers",o.join(",")),c.set("vdSourceInterval",i),r&&c.set("refresh","1"),s&&c.set("nocache","1");const u=await fetch(`/api/chart/divergence-summary?${c.toString()}`,{cache:"no-store"});if(!u.ok)throw new Error(`Failed to fetch divergence summary (HTTP ${u.status})`);const f=await u.json(),p=Array.isArray(f?.summaries)?f.summaries:[];for(const h of p){const m=la(h);m&&(d.set(m.ticker,m),ms(i,m))}return d})().catch(()=>new Map).finally(()=>{Sn.delete(a)});return Sn.set(a,l),await l}async function Dn(t,e,n){const i=Je(t),r=e?gi(e):mn(),s=n?.forceRefresh===!0,o=n?.noCache===!0;if(!i)return null;if(!s&&!o){const l=cr(i,r);if(l)return l}return(await ca([i],r,{forceRefresh:s,noCache:o})).get(i)||null}function ua(t,e){t.querySelectorAll(".div-dot, .divergence-mini-cell").forEach(r=>{const s=String(r.dataset.days||"").trim(),o=e?.states?.[s]||"neutral";r.classList.remove("is-bullish","is-bearish","is-neutral"),o==="bullish"?r.classList.add("is-bullish"):o==="bearish"?r.classList.add("is-bearish"):r.classList.add("is-neutral")});const i=(t instanceof HTMLElement,t);i instanceof HTMLElement&&(e?.tradeDate?(i.dataset.tradeDate=e.tradeDate,i.title=`Daily divergence as of ${e.tradeDate} (${de.join(", ")}d)`):(i.removeAttribute("data-trade-date"),i.title=`Daily divergence (${de.join(", ")}d)`))}const da={1:3,3:3,7:2,14:2,28:1};function ji(t,e){let n=0;for(const i of de){const r=String(i),s=String(t?.[r]||"").trim().toLowerCase(),o=Number(da[r]||0);s==="bullish"?n+=o:s==="bearish"&&(n-=o)}return e&&(n+=e.ema8===!0?1:e.ema8===!1?-1:0,n+=e.ema21===!0?1:e.ema21===!1?-1:0,n+=e.sma50===!0?1:e.sma50===!1?-1:0,n+=e.sma200===!0?1:e.sma200===!1?-1:0),n}function $r(t,e){const n=Je(t);if(!n)return 0;const i=mn(),r=cr(n,i);return r?ji(r.states):0}function Jt(t){const e=mn(),n=Array.from(t.querySelectorAll(".div-dot-row[data-ticker], .divergence-mini[data-ticker]"));for(const i of n){const r=Je(i.dataset.ticker);if(!r)continue;const s=cr(r,e);s&&ua(i,s)}}function yi(t,e){const n=mn(),r=Date.now()+3600*1e3;for(const s of t||[]){const o=Je(s?.ticker);if(!o)continue;const a=ps(),l=s?.divergence_states||{};for(const d of de)a[String(d)]=ds(l[String(d)]);ms(n,{ticker:o,tradeDate:typeof s?.divergence_trade_date=="string"?s.divergence_trade_date:null,states:a,expiresAtMs:r})}}const Fr=new Map,fa=1440*60*1e3;function ma(t){const e=`${t}|date`,n=Fr.get(e);if(n)return n;const i=new Intl.DateTimeFormat("en-CA",{timeZone:t,year:"numeric",month:"2-digit",day:"2-digit"});return Fr.set(e,i),i}function Fi(t,e){const n=Number(t.find(i=>i.type===e)?.value);return Number.isFinite(n)?n:0}function pa(t,e){const n=ma(e).formatToParts(t);return{year:Fi(n,"year"),month:Fi(n,"month"),day:Fi(n,"day")}}function hs(t,e,n){return`${t}-${String(e).padStart(2,"0")}-${String(n).padStart(2,"0")}`}function ha(t,e){const n=ga(t);if(!Number.isFinite(n))return"";const i=new Date(n+e*fa);return hs(i.getUTCFullYear(),i.getUTCMonth()+1,i.getUTCDate())}function ga(t){const e=String(t||"").match(/^(\d{4})-(\d{2})-(\d{2})$/);if(!e)return null;const n=Number(e[1]),i=Number(e[2]),r=Number(e[3]);return!Number.isFinite(n)||!Number.isFinite(i)||!Number.isFinite(r)?null:Date.UTC(n,i-1,r)}function ya(t=ue()){const n=pa(new Date,t);return hs(n.year,n.month,n.day)}function ba(t){return t?t<1e3?t.toFixed(0).padEnd(7):(Math.round(t/1e3)+"K").padEnd(7):"0".padEnd(7)}function va(t,e="",n="",i=ue()){const r=ya(i);if(!r)return{startDate:"",endDate:""};if(t==="1"||t==="2"||t==="5"){const s=ha(r,-29);return s?{startDate:s,endDate:r}:{startDate:"",endDate:""}}if(t==="custom"){const s=String(e||"").trim(),o=String(n||"").trim();return/^\d{4}-\d{2}-\d{2}$/.test(s)&&/^\d{4}-\d{2}-\d{2}$/.test(o)?{startDate:s,endDate:o}:{startDate:"",endDate:""}}return{startDate:"",endDate:""}}function Se(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Qt(t,e="desc"){return(n,i)=>{let r=0;if(t==="time")r=(i.timestamp||"").localeCompare(n.timestamp||"");else{if(t==="favorite")return n.is_favorite===i.is_favorite?(i.timestamp||"").localeCompare(n.timestamp||""):(i.is_favorite?1:0)-(n.is_favorite?1:0);if(t==="volume")r=(i.signal_volume||0)-(n.signal_volume||0);else if(t==="score"){let s=i.divergence_states?ji(i.divergence_states,i.ma_states):$r(i.ticker),o=n.divergence_states?ji(n.divergence_states,n.ma_states):$r(n.ticker);if(i.vdf_score&&(s+=Math.round(i.vdf_score/10)),n.vdf_score&&(o+=Math.round(n.vdf_score/10)),s!==o)r=s-o;else{const a=(i.signal_volume||0)-(n.signal_volume||0);a!==0?r=a:r=(i.timestamp||"").localeCompare(n.timestamp||"")}}else r=(i.timestamp||"").localeCompare(n.timestamp||"")}return t!=="favorite"&&e==="asc"?-r:r}}function gt(t,e,n){const i=document.querySelector(t);i&&i.querySelectorAll(".tf-btn").forEach(r=>{const s=r,o=s.dataset.sort;o===e?(s.classList.add("active"),o!=="favorite"&&s.setAttribute("data-sort-dir",n==="asc"?"↑":"↓")):(s.classList.remove("active"),s.removeAttribute("data-sort-dir"))})}function Sa(t){const e=String(t||"").trim();if(!e)return"";const n=e.match(/^(\d{4})-(\d{2})-(\d{2})/);if(n){const r=Number(n[2]),s=Number(n[3]);if(Number.isFinite(r)&&r>0&&Number.isFinite(s)&&s>0)return`${r}/${s}`}const i=new Date(e);return Number.isNaN(i.getTime())?"":`${i.getMonth()+1}/${i.getDate()}`}function en(t){const e=Sa(t.signal_trade_date||t.divergence_trade_date||t.timestamp)||"--",n="DataAPI",i=t.ma_states||{};let r=!1,s=!1;if(t.signal_direction!==void 0&&t.signal_direction!==null){const g=Number(t.signal_direction);r=g===1,s=g===-1}else r=!!(t.signal_type&&t.signal_type.toLowerCase().includes("bull")),s=!r;const o=r?"bullish-card":s?"bearish-card":"",a=ba(t.signal_volume||0),l=t.is_favorite===!0||String(t.is_favorite).toLowerCase()==="true",d=l?"filled":"",c=l?"visible":"hidden",u=l?"1":"0",f=`
        <svg class="fav-icon ${d}" data-id="${t.id}" data-source="${n}" viewBox="0 0 24 24" width="15" height="15" stroke="currentColor" stroke-width="2.25" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <polyline class="check-mark" points="7.5 12.5 10.5 15.5 16.5 9.5" style="visibility: ${c}; opacity: ${u};"></polyline>
        </svg>
    `,p=de.map(g=>{const w=String(g),y=String(t.divergence_states?.[w]||"neutral").toLowerCase();return`<span class="div-dot ${y==="bullish"?"is-bullish":y==="bearish"?"is-bearish":"is-neutral"}" data-days="${g}"></span>`}).join(""),h=t.divergence_trade_date?`Daily divergence as of ${Se(t.divergence_trade_date)} (${de.join(", ")}d)`:`Daily divergence (${de.join(", ")}d)`,m=`
        <span class="ma-dot-row" title="8 EMA, 21 EMA, 50 SMA, 200 SMA">
            <span class="ma-dot ${i.ema8?"is-up":"is-down"}"></span>
            <span class="ma-dot ${i.ema21?"is-up":"is-down"}"></span>
            <span class="ma-dot ${i.sma50?"is-up":"is-down"}"></span>
            <span class="ma-dot ${i.sma200?"is-up":"is-down"}"></span>
        </span>
    `;return`
        <div class="alert-card ${o}" data-ticker="${Se(t.ticker)}" data-source="${n}">
            ${f}
            <h3>${Se(t.ticker)}</h3>
            
            <div class="metrics-container">
                <div class="metric-item" title="Daily divergence summary">
                    <span class="div-dot-row" data-ticker="${Se(t.ticker)}" title="${h}">
                        ${p}
                    </span>
                </div>
                <div class="metric-item" title="Signal Volume">
                    <span class="volume-text">${a}</span>
                    ${t.vdf_detected&&t.vdf_score?`<span class="vdf-score-badge${t.vdf_proximity==="imminent"?" vdf-imminent":t.vdf_proximity==="high"?" vdf-high":""}" title="VD Accumulation Score: ${t.vdf_score}">${t.vdf_score}</span>`:t.vdf_detected?'<span class="vdf-tag" title="VD Accumulation detected">VDF</span>':""}
                    ${m}
                </div>
            </div>

            <span class="alert-time">${e}</span>
        </div>
    `}function Da(t){if(!t)return t;const e=a=>({time:a[0],open:a[1],high:a[2],low:a[3],close:a[4],volume:a[5]}),n=(a,l="value")=>({time:a[0],[l]:a[1]}),i=Array.isArray(t.bars)&&t.bars.length>0&&Array.isArray(t.bars[0])?t.bars.map(e):t.bars,r=Array.isArray(t.rsi)&&t.rsi.length>0&&Array.isArray(t.rsi[0])?t.rsi.map(a=>n(a)):t.rsi,s=t.volumeDeltaRsi&&Array.isArray(t.volumeDeltaRsi.rsi)&&t.volumeDeltaRsi.rsi.length>0&&Array.isArray(t.volumeDeltaRsi.rsi[0])?t.volumeDeltaRsi.rsi.map(a=>n(a)):t.volumeDeltaRsi?.rsi||[],o=Array.isArray(t.volumeDelta)&&t.volumeDelta.length>0&&Array.isArray(t.volumeDelta[0])?t.volumeDelta.map(a=>n(a,"delta")):t.volumeDelta;return{...t,bars:i,rsi:r,volumeDeltaRsi:{rsi:s},volumeDelta:o}}function xa(t){if(!t)return t;const e=a=>({time:a[0],open:a[1],high:a[2],low:a[3],close:a[4],volume:a[5]}),n=(a,l="value")=>({time:a[0],[l]:a[1]}),i=Array.isArray(t.latestBar)?e(t.latestBar):t.latestBar,r=Array.isArray(t.latestRsi)?n(t.latestRsi):t.latestRsi,s=Array.isArray(t.latestVolumeDeltaRsi)?n(t.latestVolumeDeltaRsi):t.latestVolumeDeltaRsi,o=Array.isArray(t.latestVolumeDelta)?n(t.latestVolumeDelta,"delta"):t.latestVolumeDelta;return{...t,latestBar:i,latestRsi:r,latestVolumeDeltaRsi:s,latestVolumeDelta:o}}async function ur(t,e,n={}){const i=new URLSearchParams;i.set("format","tuple"),Number.isFinite(n.vdRsiLength)&&i.set("vdRsiLength",String(Math.max(1,Math.floor(Number(n.vdRsiLength))))),typeof n.vdSourceInterval=="string"&&n.vdSourceInterval&&i.set("vdSourceInterval",n.vdSourceInterval),typeof n.vdRsiSourceInterval=="string"&&n.vdRsiSourceInterval&&i.set("vdRsiSourceInterval",n.vdRsiSourceInterval);const r=i.toString(),s=`/api/chart?ticker=${encodeURIComponent(t)}&interval=${e}${r?`&${r}`:""}`,o=await fetch(s,{signal:n.signal});if(typeof n.onResponseMeta=="function"&&n.onResponseMeta({status:o.status,chartCacheHeader:o.headers.get("x-chart-cache")}),!o.ok){const l=await o.json().catch(()=>({error:"Failed to fetch chart data"}));throw new Error(l.error||`HTTP ${o.status}`)}const a=await o.json();return Da(a)}async function Ca(t,e,n={}){const i=new URLSearchParams;i.set("format","tuple"),Number.isFinite(n.vdRsiLength)&&i.set("vdRsiLength",String(Math.max(1,Math.floor(Number(n.vdRsiLength))))),typeof n.vdSourceInterval=="string"&&n.vdSourceInterval&&i.set("vdSourceInterval",n.vdSourceInterval),typeof n.vdRsiSourceInterval=="string"&&n.vdRsiSourceInterval&&i.set("vdRsiSourceInterval",n.vdRsiSourceInterval);const r=i.toString(),s=`/api/chart/latest?ticker=${encodeURIComponent(t)}&interval=${e}${r?`&${r}`:""}`,o=await fetch(s,{signal:n.signal});if(typeof n.onResponseMeta=="function"&&n.onResponseMeta({status:o.status,chartCacheHeader:o.headers.get("x-chart-cache")}),!o.ok){const l=await o.json().catch(()=>({error:"Failed to fetch latest chart data"}));throw new Error(l.error||`HTTP ${o.status}`)}const a=await o.json();return xa(a)}class q{static SCALE_LABEL_CHARS=4;static SCALE_MIN_WIDTH_PX=56;static RSI_DATA_MIN=0;static RSI_DATA_MAX=100;static RSI_AXIS_MIN=20;static RSI_AXIS_MAX=80;static MIDLINE_VALUE=50;container;chart;series;lineTools;displayMode;lineColor="#58a6ff";midlineColor="#ffffff";midlineStyle="dotted";data;seriesData=[];referenceLines=[];midlinePriceLine=null;priceData=[];priceByTime=new Map;indexByTime=new Map;divergencePointTimeKeys=new Set;divergenceToolActive=!1;highlightSeries=null;firstPoint=null;divergencePoints=[];static MAX_HIGHLIGHT_POINTS=2e3;static FUTURE_TIMELINE_TRADING_DAYS=252;trendLineSeriesList=[];trendlineCrossLabels=[];trendlineDefinitions=[];timelineSeries=null;suppressExternalSync=!1;onTrendLineDrawn;constructor(e){this.container=e.container,this.displayMode=e.displayMode,this.lineColor=e.lineColor||this.lineColor,this.midlineColor=e.midlineColor||this.midlineColor,this.midlineStyle=e.midlineStyle||this.midlineStyle,this.data=this.normalizeRSIData(e.data),this.priceData=e.priceData||[],this.rebuildLookupMaps(),this.seriesData=this.buildSeriesData(this.data,this.priceData),this.onTrendLineDrawn=e.onTrendLineDrawn,this.chart=LightweightCharts.createChart(e.container,{height:400,layout:{background:{color:"#0d1117"},textColor:"#c9d1d9",fontFamily:"'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",attributionLogo:!1},grid:{vertLines:{visible:!1},horzLines:{visible:!1}},timeScale:{visible:!0,timeVisible:!0,secondsVisible:!1,borderVisible:!0,ticksVisible:!0,fixRightEdge:!1,rightBarStaysOnScroll:!1,rightOffset:10,tickMarkFormatter:(n,i)=>this.formatTickMark(n,i),borderColor:"#21262d"},rightPriceScale:{borderColor:"#21262d",minimumWidth:q.SCALE_MIN_WIDTH_PX,entireTextOnly:!0,scaleMargins:{top:.2,bottom:.2}},crosshair:{mode:1},kineticScroll:{touch:!1,mouse:!1},handleScroll:{pressedMouseMove:!0,horzTouchDrag:!0,vertTouchDrag:_e,mouseWheel:!0},handleScale:{mouseWheel:!0,pinch:!0,axisPressedMouseMove:{time:!0,price:!1},axisDoubleClickReset:{time:!0,price:!1}}}),this.addReferenceLine(50,"Midline",this.midlineColor,this.midlineStyleToLineStyle(this.midlineStyle)),this.updateSeries(),this.updateTimelineSeriesData(),this.chart.subscribeCrosshairMove(n=>{this.divergenceToolActive&&n&&n.time}),this.chart.subscribeClick(n=>{this.divergenceToolActive&&n&&n.time&&this.detectAndHighlightDivergence(n.time)}),this.chart.timeScale().subscribeVisibleLogicalRangeChange(()=>{this.refreshTrendlineCrossLabels()})}normalizeRSIData(e){return e.filter(n=>n&&(typeof n.time=="string"||typeof n.time=="number")&&Number.isFinite(Number(n.value))).map(n=>({...n,value:Math.max(q.RSI_DATA_MIN,Math.min(q.RSI_DATA_MAX,Number(n.value)))}))}formatRSIScaleLabel(e){if(!Number.isFinite(e))return"";const n=Number(e).toFixed(1);return n.length>=q.SCALE_LABEL_CHARS?n:n.padEnd(q.SCALE_LABEL_CHARS," ")}fixedRSIAutoscaleInfoProvider(){return{priceRange:{minValue:q.RSI_AXIS_MIN,maxValue:q.RSI_AXIS_MAX}}}timeKey(e){return typeof e=="number"?String(e):e}rebuildLookupMaps(){this.priceByTime.clear(),this.indexByTime.clear();for(let e=0;e<this.data.length;e++){const n=this.data[e];this.indexByTime.set(this.timeKey(n.time),e)}for(const e of this.priceData){const n=Number(e.close);Number.isFinite(n)&&this.priceByTime.set(this.timeKey(e.time),n)}}toDateFromScaleTime(e){if(typeof e=="number"&&Number.isFinite(e))return new Date(e*1e3);if(typeof e=="string"&&e.trim()){const n=e.includes("T")?e:`${e.replace(" ","T")}Z`,i=new Date(n);return Number.isFinite(i.getTime())?i:null}return e&&typeof e=="object"&&Number.isFinite(e.year)&&Number.isFinite(e.month)&&Number.isFinite(e.day)?new Date(Date.UTC(Number(e.year),Number(e.month)-1,Number(e.day),0,0,0)):null}toUnixSeconds(e){if(typeof e=="number"&&Number.isFinite(e))return e;if(typeof e!="string"||!e.trim())return null;const n=e.includes("T")?e:`${e.replace(" ","T")}Z`,r=new Date(n).getTime();return Number.isFinite(r)?Math.floor(r/1e3):null}formatTickMark(e,n){const i=this.toDateFromScaleTime(e);return i?n===0?i.toLocaleDateString("en-US",{year:"numeric",timeZone:ue()}):n===1?i.toLocaleDateString("en-US",{month:"short",timeZone:ue()}):i.toLocaleDateString("en-US",{day:"numeric",timeZone:ue()}):""}midlineStyleToLineStyle(e){return e==="solid"?0:1}isSyncSuppressed(){return this.suppressExternalSync}inferBarStepSeconds(){if(this.data.length<2)return 1800;const e=[];for(let n=1;n<this.data.length;n++){const i=this.data[n-1]?.time,r=this.data[n]?.time;if(typeof i!="number"||typeof r!="number")continue;const s=r-i;Number.isFinite(s)&&s>0&&s<=8*3600&&e.push(s)}return e.length===0?1800:(e.sort((n,i)=>n-i),e[Math.floor(e.length/2)])}barsPerTradingDayFromStep(e){return e<=300?78:e<=900?26:e<=1800?13:e<=3600?7:2}futureBarsForOneYear(){const e=this.inferBarStepSeconds();return this.barsPerTradingDayFromStep(e)*252}ensureTimelineSeries(){this.timelineSeries||(this.timelineSeries=this.chart.addLineSeries({color:"rgba(0, 0, 0, 0)",lineVisible:!1,pointMarkersVisible:!1,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1}))}updateTimelineSeriesData(){if(this.ensureTimelineSeries(),!this.timelineSeries||this.data.length===0)return;const e=this.toUnixSeconds(this.data[this.data.length-1]?.time);if(e===null)return;const n=[{time:e}];let i=e,r=0;for(;r<q.FUTURE_TIMELINE_TRADING_DAYS;){i+=86400;const s=new Date(i*1e3).getUTCDay();s===0||s===6||(n.push({time:i}),r+=1)}this.timelineSeries.setData(n)}buildSeriesData(e,n){if(!n||n.length===0)return e;const i=new Map;for(const r of e)i.set(String(r.time),Number(r.value));return n.map(r=>{const s=i.get(String(r.time));return Number.isFinite(s)?{time:r.time,value:s}:{time:r.time}})}addReferenceLine(e,n,i,r=2){if(this.referenceLines.push({value:e,label:n,color:i,lineStyle:r}),this.series){const s=this.series.createPriceLine({price:e,color:i,lineWidth:1,lineStyle:r,axisLabelVisible:!1,title:n});n==="Midline"&&(this.midlinePriceLine=s)}}updateSeries(){this.series&&this.chart.removeSeries(this.series),this.midlinePriceLine=null,this.displayMode==="line"?this.series=this.chart.addLineSeries({color:this.lineColor,lineWidth:1,priceFormat:{type:"custom",minMove:1,formatter:e=>this.formatRSIScaleLabel(Number(e))},autoscaleInfoProvider:()=>this.fixedRSIAutoscaleInfoProvider(),priceLineVisible:!1,lastValueVisible:!1}):this.series=this.chart.addHistogramSeries({color:this.lineColor,priceFormat:{type:"custom",minMove:1,formatter:e=>this.formatRSIScaleLabel(Number(e))},autoscaleInfoProvider:()=>this.fixedRSIAutoscaleInfoProvider(),priceLineVisible:!1,lastValueVisible:!1}),this.displayMode==="line"?this.series.setData(this.seriesData):this.series.setData(this.seriesData.map(e=>Number.isFinite(Number(e.value))?{time:e.time,value:e.value,color:this.lineColor}:{time:e.time})),this.referenceLines.forEach(e=>{const n=this.series.createPriceLine({price:e.value,color:e.color,lineWidth:1,lineStyle:e.lineStyle,axisLabelVisible:!1,title:e.label});e.label==="Midline"&&(this.midlinePriceLine=n)})}setDisplayMode(e){this.displayMode!==e&&(this.displayMode=e,this.updateSeries(),this.refreshTrendlineCrossLabels())}setLineColor(e){e&&(this.lineColor=e,this.displayMode==="line"&&this.series?this.series.applyOptions({color:e}):this.displayMode!=="line"&&this.series&&(this.series.applyOptions({color:e}),this.series.setData(this.seriesData.map(n=>Number.isFinite(Number(n.value))?{time:n.time,value:n.value,color:this.lineColor}:{time:n.time}))))}setMidlineOptions(e,n){e&&(this.midlineColor=e),n&&(this.midlineStyle=n);const i=this.midlineStyleToLineStyle(this.midlineStyle);this.referenceLines=this.referenceLines.map(r=>r.label!=="Midline"?r:{...r,color:this.midlineColor,lineStyle:i}),this.midlinePriceLine&&this.midlinePriceLine.applyOptions({color:this.midlineColor,lineStyle:i})}setData(e,n){this.clearDivergence(),this.data=this.normalizeRSIData(e),n&&(this.priceData=n),this.rebuildLookupMaps(),this.seriesData=this.buildSeriesData(this.data,this.priceData),this.series&&(this.displayMode==="line"?this.series.setData(this.seriesData):this.series.setData(this.seriesData.map(i=>Number.isFinite(Number(i.value))?{time:i.time,value:i.value,color:this.lineColor}:{time:i.time}))),this.updateTimelineSeriesData(),this.refreshTrendlineCrossLabels()}updateLatestPoint(e,n){if(!e||typeof e.time!="string"&&typeof e.time!="number")return!1;const i=Number(e.value);if(!Number.isFinite(i)||this.data.length===0)return!1;const r=this.data.length-1,s=this.data[r]?.time,o=this.timeKey(s),a=this.timeKey(e.time);if(o!==a)return!1;const l=Math.max(q.RSI_DATA_MIN,Math.min(q.RSI_DATA_MAX,i));if(this.data[r]={...this.data[r],value:l},n&&this.timeKey(n.time)===o){const d=Number(n.close);Number.isFinite(d)&&(this.priceData.length>0&&this.timeKey(this.priceData[this.priceData.length-1].time)===o&&(this.priceData[this.priceData.length-1]={...this.priceData[this.priceData.length-1],close:d}),this.priceByTime.set(o,d))}return this.seriesData.length>0&&this.timeKey(this.seriesData[this.seriesData.length-1].time)===o?this.seriesData[this.seriesData.length-1]={time:s,value:l}:this.seriesData=this.buildSeriesData(this.data,this.priceData),this.series&&(this.displayMode==="line"?this.series.update({time:s,value:l}):this.series.update({time:s,value:l,color:this.lineColor})),this.refreshTrendlineCrossLabels(),!0}getChart(){return this.chart}getSeries(){return this.series}getPersistedTrendlines(){return this.trendlineDefinitions.map(e=>({...e}))}restorePersistedTrendlines(e){if(this.clearDivergence(),!(!Array.isArray(e)||e.length===0))for(const n of e){if(!n)continue;const i=n.time1,r=n.time2,s=Number(n.value1),o=Number(n.value2);typeof i!="string"&&typeof i!="number"||typeof r!="string"&&typeof r!="number"||!Number.isFinite(s)||!Number.isFinite(o)||this.drawTrendLine(i,s,r,o,!0)}}refreshTrendlineLabels(){this.refreshTrendlineCrossLabels()}getLineTools(){return this.lineTools}activateDivergenceTool(){this.divergenceToolActive=!0;const e=this.chart.chartElement();e&&(e.style.cursor="crosshair")}deactivateDivergenceTool(){this.divergenceToolActive=!1;const e=this.chart.chartElement();e&&(e.style.cursor="default"),this.clearHighlights(),this.firstPoint=null,this.divergencePoints=[],this.divergencePointTimeKeys.clear()}detectAndHighlightDivergence(e){const n=this.timeKey(e),i=this.indexByTime.get(n);if(i===void 0){console.log("Clicked point not found in RSI data");return}const r=this.data[i].value,s=this.priceByTime.get(n);if(!Number.isFinite(s)){console.log("Corresponding price data not found");return}const o=Number(s);if(this.firstPoint){if(!this.divergencePointTimeKeys.has(n)){console.log("Second point must be one of the highlighted divergence points");return}console.log(`Drawing trend line from (RSI: ${this.firstPoint.rsi.toFixed(2)}) to (RSI: ${r.toFixed(2)})`),this.drawTrendLine(this.firstPoint.time,this.firstPoint.rsi,e,r),this.clearHighlights(),this.deactivateDivergenceTool(),this.onTrendLineDrawn?.()}else{this.firstPoint={time:e,rsi:r,price:o,index:i},this.divergencePoints=[],this.divergencePointTimeKeys.clear();for(let a=i+1;a<this.data.length;a++){const l=this.data[a].value,d=this.data[a].time,c=this.priceByTime.get(this.timeKey(d));if(Number.isFinite(c)){const u=Number(c),f=l<r&&u>o,p=l>r&&u<o;(f||p)&&(this.divergencePoints.push({time:d,value:l}),this.divergencePointTimeKeys.add(this.timeKey(d)))}}console.log(`Found ${this.divergencePoints.length} divergence points from origin (RSI: ${r.toFixed(2)}, Price: ${o.toFixed(2)})`),this.highlightPoints(this.divergencePoints)}}highlightPoints(e){if(this.clearHighlights(),e.length===0)return;this.highlightSeries=this.chart.addLineSeries({color:"#ff6b6b",lineVisible:!1,pointMarkersVisible:!0,pointMarkersRadius:2,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1,autoscaleInfoProvider:()=>this.fixedRSIAutoscaleInfoProvider()});const n=Math.max(1,Math.ceil(e.length/q.MAX_HIGHLIGHT_POINTS)),i=n===1?e:e.filter((r,s)=>s%n===0);this.highlightSeries.setData(i)}clearHighlights(){this.highlightSeries&&(this.chart.removeSeries(this.highlightSeries),this.highlightSeries=null)}formatMmDdYyFromUnixSeconds(e){return Number.isFinite(e)?fn("en-US",{month:"2-digit",day:"2-digit",year:"2-digit"}).format(new Date(Math.round(Number(e))*1e3)):"N/A"}createTrendlineCrossLabelElement(e){const n=document.createElement("div");return n.className="trendline-cross-label",n.textContent=e,n.style.position="absolute",n.style.zIndex="29",n.style.minHeight="24px",n.style.display="inline-flex",n.style.alignItems="center",n.style.padding="0 8px",n.style.borderRadius="4px",n.style.border="1px solid #30363d",n.style.background="#161b22",n.style.color="#c9d1d9",n.style.fontSize="12px",n.style.fontFamily="'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",n.style.pointerEvents="none",n.style.whiteSpace="nowrap",n.style.transform="translate(-50%, calc(-100% - 6px))",n}refreshTrendlineCrossLabels(){if(!this.chart||!this.series||!this.container)return;const e=this.container.clientWidth,n=this.container.clientHeight;for(const i of this.trendlineCrossLabels){const r=this.chart.timeScale().timeToCoordinate(i.anchorTime),s=this.series.priceToCoordinate(i.anchorValue);if(!Number.isFinite(r)||!Number.isFinite(s)||r<0||r>e||s<0||s>n){i.element.style.display="none";continue}i.element.style.display="inline-flex",i.element.style.left=`${Math.round(r)}px`,i.element.style.top=`${Math.round(Math.max(8,s))}px`}}clearTrendlineCrossLabels(){for(const e of this.trendlineCrossLabels)e.element.remove();this.trendlineCrossLabels=[]}addTrendlineCrossLabel(e,n,i){const r=this.createTrendlineCrossLabelElement(i);this.container.appendChild(r),this.trendlineCrossLabels.push({element:r,anchorTime:e,anchorValue:n}),this.refreshTrendlineCrossLabels()}indexToUnixSeconds(e,n,i,r,s){if(!Number.isFinite(e))return null;if(e>n)return r===null?null:r+(e-n)*s;if(e<0)return i===null?null:i+e*s;const o=Math.max(0,Math.floor(e)),a=Math.min(n,Math.ceil(e)),l=this.toUnixSeconds(this.data[o]?.time),d=this.toUnixSeconds(this.data[a]?.time);if(o===a)return l;if(Number.isFinite(l)&&Number.isFinite(d)){const c=e-o;return Number(l)+(Number(d)-Number(l))*c}return Number.isFinite(l)?Number(l)+(e-o)*s:i===null?null:i+e*s}computeTrendlineMidlineCrossUnixSeconds(e,n,i,r,s,o,a){if(!Number.isFinite(i)||Math.abs(i)<1e-12)return null;const l=e+(q.MIDLINE_VALUE-n)/i;return Number.isFinite(l)?this.indexToUnixSeconds(l,r,s,o,a):null}drawTrendLine(e,n,i,r,s=!0){const o=this.chart.timeScale().getVisibleLogicalRange?.();this.suppressExternalSync=!0;try{const a=this.indexByTime.get(this.timeKey(e)),l=this.indexByTime.get(this.timeKey(i));if(a===void 0||l===void 0){console.error("Could not find indices for trend line points");return}if(l===a)return;const d=(r-n)/(l-a),c=[],u=this.futureBarsForOneYear(),f=this.data.length-1,p=f+u,h=this.inferBarStepSeconds(),m=this.toUnixSeconds(this.data[0]?.time),g=this.data[f]?.time,w=this.toUnixSeconds(g);for(let C=a;C<=p;C++){const M=n+d*(C-a);if(M<q.RSI_DATA_MIN||M>q.RSI_DATA_MAX)break;let H=null;C<=f?H=this.data[C]?.time??null:w!==null&&(H=w+(C-f)*h),H!=null&&c.push({time:H,value:M})}if(!c.length)return;const y=this.chart.addLineSeries({color:"#ffa500",lineWidth:1,lineStyle:0,autoscaleInfoProvider:()=>this.fixedRSIAutoscaleInfoProvider(),priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1});this.trendLineSeriesList.push(y),y.setData(c);const v=this.computeTrendlineMidlineCrossUnixSeconds(a,n,d,f,m,w,h);this.addTrendlineCrossLabel(e,n,this.formatMmDdYyFromUnixSeconds(v)),s&&this.trendlineDefinitions.push({time1:e,value1:Number(n),time2:i,value2:Number(r)})}finally{if(o)try{this.chart.timeScale().setVisibleLogicalRange(o)}catch{}this.suppressExternalSync=!1}}clearDivergence(e=!1){const n=e?this.chart.timeScale().getVisibleLogicalRange?.():null;e&&(this.suppressExternalSync=!0);try{this.clearHighlights(),this.clearTrendlineCrossLabels();for(const i of this.trendLineSeriesList)try{this.chart.removeSeries(i)}catch{}this.trendLineSeriesList=[],this.trendlineDefinitions=[],this.firstPoint=null,this.divergencePoints=[],this.divergencePointTimeKeys.clear()}finally{if(e&&n)try{this.chart.timeScale().setVisibleLogicalRange(n)}catch{}e&&(this.suppressExternalSync=!1)}}resize(){this.chart&&(this.chart.resize(this.chart.options().width,400),this.refreshTrendlineCrossLabels())}destroy(){this.chart&&(this.clearTrendlineCrossLabels(),this.chart.remove())}}let A=null,ie="1day",T=null,X=null,Gi=null,x=null,L=null,ee=null,Ki=null,Zi=null,W=null,Pe=null,Yi=null,I=[],yt=new Map,zt=null,Pt=[],jn=[],Gn=[],Fn=new Set,_t=null,Me=!1,fe=!1,st=!1,Qe=null,Xi=!1,Pn=0,P=null,tn=null,nn=new Map,Ke=new Map,Mt=new Map,Ze=new Map,pn=new Map,rn=new Map,b=[],Kn=[],Zn=null,Yn=null,Xn=null,Jn=null,_=null,O=null,z=null,j=null,V=null,me=!1,pe=!1,bt=!1,vt=!1,St=null,Dt=null,Ji=null,Qi=null,gs=null,ys=null,Pr=!1,ve=null,_n=null,Qn=!1,Rt=null,Ut=null,Bn=!1,J=new Map,_r=!1,Pi=null,_i=null,We=new Map,F=null,Y=null,xn=null,Ue=new Map,$=null,xe=null;const wa=200,bs="✎",ka="⌫",vs="D",Ta=120,Ea=900*1e3,Ma=900*1e3,La=16,Ss="custom_chart_session_cache_v1",Aa=6,Na=9e5,hn=10,Ia=252,se=4,Ye=56,Ra="Invalid symbol",Ds="#21262d",$a="⚙",xs="custom_chart_settings_v1",_e=typeof window<"u"&&(window.matchMedia("(max-width: 768px)").matches||"ontouchstart"in window||navigator.maxTouchPoints>0),Cs="custom_chart_trendlines_v1",Bi="top-pane-ticker-label",dr="top-pane-badge",Br=38,ws=6,fr=8,gn=8,U=24,sn=6,Fa="#2962FF",Pa=50,_a=50,Ba=20,Va=80,ks=0,Ts=100,Oa=2e3,Ha="#ff6b6b",za="#ffa500",Es="#089981",Ms="#f23645",Ls=[{value:"1min",label:"1 min"},{value:"5min",label:"5 min"},{value:"15min",label:"15 min"},{value:"30min",label:"30 min"},{value:"1hour",label:"1 hour"},{value:"4hour",label:"4 hour"}],As=180,Ua={"5min":[],"15min":[],"30min":[],"1hour":[],"4hour":["1day"],"1day":["4hour","1week"],"1week":["1day"]},Bt={length:14,lineColor:"#58a6ff",midlineColor:"#ffffff",midlineStyle:"dotted"},tt={length:14,lineColor:Fa,midlineColor:"#ffffff",midlineStyle:"dotted",sourceInterval:"1min"},ce={sourceInterval:"1min",divergenceTable:!0,divergentPriceBars:!0,bullishDivergentColor:"#26a69a",bearishDivergentColor:"#ef5350",neutralDivergentColor:"#8b949e"},Ne={maSourceMode:"daily",verticalGridlines:!1,horizontalGridlines:!1,ma:[{enabled:!0,type:"EMA",length:8,color:"#ffa500"},{enabled:!0,type:"EMA",length:21,color:"#8a2be2"},{enabled:!0,type:"SMA",length:50,color:"#00bcd4"},{enabled:!1,type:"SMA",length:200,color:"#90ee90"}]},be=["vd-chart-container","price-chart-container","rsi-chart-container","vd-rsi-chart-container"];let re=[...be],$t=null;const mr=120,pr=600,Wa={"vd-chart-container":240,"price-chart-container":400,"rsi-chart-container":400,"vd-rsi-chart-container":400};let on={},Vr=!1,De=!1;const E={...Bt},D={...tt},S={...ce},k={maSourceMode:Ne.maSourceMode,verticalGridlines:Ne.verticalGridlines,horizontalGridlines:Ne.horizontalGridlines,ma:Ne.ma.map(t=>({...t,series:null,values:[]}))};function Cn(t,e){const n=e==="price"?Zn:e==="volumeDeltaRsi"?Yn:e==="volumeDelta"?Xn:Jn;if(n&&n.parentElement===t)return n;const i=document.createElement("div"),r=e==="price"?"month-grid-overlay-price":e==="volumeDeltaRsi"?"month-grid-overlay-volume-delta-rsi":e==="volumeDelta"?"month-grid-overlay-volume-delta":"month-grid-overlay-rsi";return i.className=`month-grid-overlay ${r}`,i.style.position="absolute",i.style.top="0",i.style.right="0",i.style.bottom="0",i.style.left="0",i.style.pointerEvents="none",i.style.zIndex="6",t.appendChild(i),e==="price"?Zn=i:e==="volumeDeltaRsi"?Yn=i:e==="volumeDelta"?Xn=i:Jn=i,i}function Te(t){if(typeof t=="number"&&Number.isFinite(t))return t;if(typeof t=="string"&&t.trim()){const e=Date.parse(t.includes("T")?t:`${t.replace(" ","T")}Z`);if(Number.isFinite(e))return Math.floor(e/1e3)}return null}function qa(t){if(typeof t=="number"&&Number.isFinite(t))return new Date(t*1e3);if(typeof t=="string"&&t.trim()){const e=new Date(t.includes("T")?t:`${t.replace(" ","T")}Z`);return Number.isFinite(e.getTime())?e:null}return t&&typeof t=="object"&&Number.isFinite(t.year)&&Number.isFinite(t.month)&&Number.isFinite(t.day)?new Date(Date.UTC(Number(t.year),Number(t.month)-1,Number(t.day),0,0,0)):null}function hr(t,e){const n=qa(t);if(!n)return"";const i=ue();return e===0?n.toLocaleDateString("en-US",{year:"numeric",timeZone:i}):e===1?n.toLocaleDateString("en-US",{month:"short",timeZone:i}):n.toLocaleDateString("en-US",{day:"numeric",timeZone:i})}function ja(t){const e=fn("en-US",{year:"numeric",month:"2-digit"}).formatToParts(new Date(t*1e3)),n=e.find(r=>r.type==="year")?.value||"",i=e.find(r=>r.type==="month")?.value||"";return`${n}-${i}`}function Ga(t){const e=[];let n="";for(const i of t){const r=Te(i?.time);if(r===null)continue;const s=ja(r);s!==n&&(e.push(r),n=s)}return e}function Or(t){return fn("en-CA",{year:"numeric",month:"2-digit",day:"2-digit"}).format(new Date(t*1e3))}function Ka(t){if(!Array.isArray(t)||t.length===0)return[];const e=Te(t[t.length-1]?.time);if(!Number.isFinite(e))return[];const n=[{time:Number(e)}];let i=Number(e),r=0;for(;r<Ia;){i+=86400;const s=new Date(i*1e3).getUTCDay();s===0||s===6||(n.push({time:i}),r+=1)}return n}function Ns(t){const e=Ka(t);Gi&&Gi.setData(e),Ki&&Ki.setData(e),Yi&&Yi.setData(e)}function Za(t,e){if(!Array.isArray(t)||t.length===0)return[];if(t.length===1)return[50];const n=Math.max(1,Math.floor(e||14)),i=new Array(t.length).fill(50),r=[],s=[];let o=0,a=0;for(let l=1;l<t.length;l++){const d=t[l]-t[l-1],c=d>0?d:0,u=d<0?Math.abs(d):0;if(r.push(c),s.push(u),l<n){const h=l;let m=0,g=0;for(let w=0;w<h;w++)m+=r[w],g+=s[w];o=m/h,a=g/h}else if(l===n){let h=0,m=0;for(let g=l-n;g<l;g++)h+=r[g],m+=s[g];o=h/n,a=m/n}else o=(o*(n-1)+c)/n,a=(a*(n-1)+u)/n;const p=100-100/(1+(a===0?100:o/a));i[l]=Number.isFinite(p)?p:i[l-1]}return i[0]=i[1]??50,i}function Is(t,e){if(!t||t.length===0)return[];const n=t.map(s=>Number(s.close)),i=Za(n,e),r=[];for(let s=0;s<t.length;s++){const o=i[s];Number.isFinite(o)&&r.push({time:t[s].time,value:Math.round(o*100)/100})}return r}function Rs(t){return Array.isArray(t)?t.filter(e=>e&&(typeof e.time=="string"||typeof e.time=="number")&&Number.isFinite(Number(e.value))).map(e=>({time:e.time,value:Number(e.value)})):[]}function gr(t,e){return[String(t||"").trim().toUpperCase(),e,String(D.length),S.sourceInterval,D.sourceInterval].join("|")}function Ya(t){if(!t||typeof t!="object")return!1;const e=t;return!(!Array.isArray(e.bars)||e.bars.length===0)}function yr(){for(;J.size>La;){const t=J.keys().next().value;if(!t)break;J.delete(t)}}function $s(){if(!_r&&(_r=!0,!(typeof window>"u")))try{const t=window.sessionStorage.getItem(Ss);if(!t)return;const e=JSON.parse(t);if(!e||e.version!==1||!Array.isArray(e.entries))return;const n=[...e.entries].filter(i=>i&&typeof i.key=="string"&&Number.isFinite(i.updatedAt)&&Ya(i.data)).sort((i,r)=>Number(i.updatedAt)-Number(r.updatedAt));for(const i of n)J.set(i.key,{data:i.data,updatedAt:Number(i.updatedAt)});yr()}catch{}}function Fs(){typeof window>"u"||Pi===null&&(Pi=window.setTimeout(()=>{Pi=null;try{const t=Array.from(J.entries()).reverse(),e=[];let n=0;for(const[r,s]of t){if(!s||!s.data||!Number.isFinite(s.updatedAt))continue;const o={key:r,updatedAt:s.updatedAt,data:s.data},a=JSON.stringify(o);if(a&&!(n+a.length>Na)&&(e.push(o),n+=a.length,e.length>=Aa))break}const i=JSON.stringify({version:1,entries:e});window.sessionStorage.setItem(Ss,i)}catch{}},180))}function Xa(){$s();const t=Date.now();let e=!1;for(const[i,r]of J.entries())(!r||!r.updatedAt||t-r.updatedAt>Ma)&&(J.delete(i),e=!0);const n=J.size;yr(),J.size!==n&&(e=!0),e&&Fs()}function br(t){Xa();const e=J.get(t);return e&&(J.delete(t),J.set(t,e)),e?e.data:null}function vr(t,e){$s(),J.delete(t),J.set(t,{data:e,updatedAt:Date.now()}),yr(),Fs()}function Hr(t){const e=Array.isArray(t?.bars)?t.bars:[];if(!e.length)return"none";const n=e[e.length-1];return[e.length,N(n.time),Number(n.open),Number(n.high),Number(n.low),Number(n.close),Number(n.volume)].join("|")}const Ps={"5min":{fetchMs:[],renderMs:[]},"15min":{fetchMs:[],renderMs:[]},"30min":{fetchMs:[],renderMs:[]},"1hour":{fetchMs:[],renderMs:[]},"4hour":{fetchMs:[],renderMs:[]},"1day":{fetchMs:[],renderMs:[]},"1week":{fetchMs:[],renderMs:[]}},Sr={"5min":{fetchCount:0,renderCount:0,fetchP95Ms:0,renderP95Ms:0,responseCacheHit:0,responseCacheMiss:0,responseCacheUnknown:0},"15min":{fetchCount:0,renderCount:0,fetchP95Ms:0,renderP95Ms:0,responseCacheHit:0,responseCacheMiss:0,responseCacheUnknown:0},"30min":{fetchCount:0,renderCount:0,fetchP95Ms:0,renderP95Ms:0,responseCacheHit:0,responseCacheMiss:0,responseCacheUnknown:0},"1hour":{fetchCount:0,renderCount:0,fetchP95Ms:0,renderP95Ms:0,responseCacheHit:0,responseCacheMiss:0,responseCacheUnknown:0},"4hour":{fetchCount:0,renderCount:0,fetchP95Ms:0,renderP95Ms:0,responseCacheHit:0,responseCacheMiss:0,responseCacheUnknown:0},"1day":{fetchCount:0,renderCount:0,fetchP95Ms:0,renderP95Ms:0,responseCacheHit:0,responseCacheMiss:0,responseCacheUnknown:0},"1week":{fetchCount:0,renderCount:0,fetchP95Ms:0,renderP95Ms:0,responseCacheHit:0,responseCacheMiss:0,responseCacheUnknown:0}};function _s(t){if(!t.length)return 0;const e=[...t].sort((i,r)=>i-r),n=Math.min(e.length-1,Math.max(0,Math.ceil(e.length*.95)-1));return Math.round(e[n]*100)/100}function Bs(t,e){!Number.isFinite(e)||e<0||(t.push(Math.round(e*100)/100),t.length>As&&t.shift())}function Vs(t,e,n){const i=Ps[t],r=Sr[t];Bs(i.fetchMs,e),r.fetchCount+=1,r.fetchP95Ms=_s(i.fetchMs),n==="hit"?r.responseCacheHit+=1:n==="miss"?r.responseCacheMiss+=1:r.responseCacheUnknown+=1}function zr(t,e){const n=Ps[t],i=Sr[t];Bs(n.renderMs,e),i.renderCount+=1,i.renderP95Ms=_s(n.renderMs)}function Ja(){typeof window>"u"||(window.__chartPerfMetrics={getSnapshot:()=>({byInterval:Sr,sampleMax:As})})}async function Ur(t,e){const n=String(t||"").trim().toUpperCase();if(!n)return;const i=Ua[e]||[];Ar();const r=new AbortController;_n=r;const s=[];for(const o of i){if(r.signal.aborted)break;const a=gr(n,o);if(br(a))continue;if(We.has(a)){s.push(We.get(a));continue}const l=ur(n,o,{vdRsiLength:D.length,vdSourceInterval:S.sourceInterval,vdRsiSourceInterval:D.sourceInterval,signal:r.signal}).then(d=>{vr(a,d)}).catch(()=>{}).finally(()=>{We.delete(a)});We.set(a,l),s.push(l)}await Promise.allSettled(s),r.signal.aborted||Oc(e,r.signal).catch(()=>{})}Ja();function Lt(t){if(!Array.isArray(t))return[...be];const e=new Set(be),n=[];for(const i of t){if(typeof i!="string"||!e.has(i))continue;const r=i;n.includes(r)||n.push(r)}for(const i of be)n.includes(i)||n.push(i);return n}function Qa(t){if(!Number.isFinite(t))return"";const e=Math.max(0,Math.min(100,Number(t)));let n="";return Math.abs(e)>=100?n=String(Math.round(e)):n=e.toFixed(1),n.length>=se?n:n.padEnd(se," ")}function el(t){return Array.isArray(t)?t.filter(e=>e&&(typeof e.time=="string"||typeof e.time=="number")&&Number.isFinite(Number(e.delta))).map(e=>({time:e.time,delta:Number(e.delta)})):[]}function tl(t){if(!Number.isFinite(t))return"";const e=t<0?"-":"",n=Math.abs(t),i=se-e.length;if(i<=0)return e.slice(0,se);const r=(d,c)=>{if(c<=0)return Math.trunc(d);const u=10**c;return Math.trunc(d*u)/u},s=d=>d.replace(/\.0+$/,"").replace(/(\.\d*?)0+$/,"$1"),o=(d,c)=>{const u=n/d;if(d!==1&&u<1)return null;const f=i-c.length;if(f<=0)return null;let p=0;for(c?u<10&&(p=1):u>=10&&u<100?p=1:u<10&&(p=2);p>=0;){const h=s(r(u,p).toFixed(p));if(h.length<=f)return`${e}${h}${c}`;p-=1}return null},a=[{divisor:1e9,suffix:"B"},{divisor:1e6,suffix:"M"},{divisor:1e3,suffix:"K"},{divisor:1,suffix:""}];for(const d of a){const c=o(d.divisor,d.suffix);if(c)return c.length>=se?c:c.padEnd(se," ")}const l=[{divisor:1e3,suffix:"K"},{divisor:1e6,suffix:"M"},{divisor:1e9,suffix:"B"}];for(const d of l){const c=i-d.suffix.length;if(c<=0)continue;const u=n/d.divisor,f=String(Math.max(1,Math.trunc(u)));if(f.length>c)continue;const p=`${e}${f}${d.suffix}`;return p.length>=se?p:p.padEnd(se," ")}return e?`${e}0`.padEnd(se," "):"0".padEnd(se," ")}function ei(t){if(!Array.isArray(t))return[];const e=[];for(const n of t){if(!n||typeof n!="object")continue;const i=n,r=i.time1,s=i.time2,o=Number(i.value1),a=Number(i.value2);typeof r!="string"&&typeof r!="number"||typeof s!="string"&&typeof s!="number"||!Number.isFinite(o)||!Number.isFinite(a)||e.push({time1:r,value1:o,time2:s,value2:a})}return e}function Os(t,e){return`${t.toUpperCase()}|${e}`}function Hs(){if(typeof window>"u")return{};try{const t=window.localStorage.getItem(Cs);if(!t)return{};const e=JSON.parse(t),n={};for(const[i,r]of Object.entries(e||{}))n[i]={rsi:ei(r?.rsi),volumeDeltaRsi:ei(r?.volumeDeltaRsi)};return n}catch{return{}}}function nl(t){if(!(typeof window>"u"))try{window.localStorage.setItem(Cs,JSON.stringify(t))}catch{}}function il(t,e){const i=Hs()[Os(t,e)];return{rsi:ei(i?.rsi),volumeDeltaRsi:ei(i?.volumeDeltaRsi)}}function bi(){if(!A)return;const t=Hs(),e=Os(A,ie);t[e]={rsi:x?.getPersistedTrendlines()??[],volumeDeltaRsi:Gn.map(n=>({...n}))},nl(t)}function R(){if(!(typeof window>"u"))try{const t={price:{maSourceMode:k.maSourceMode,verticalGridlines:k.verticalGridlines,horizontalGridlines:k.horizontalGridlines,ma:k.ma.map(e=>({enabled:e.enabled,type:e.type,length:e.length,color:e.color}))},rsi:{length:E.length,lineColor:E.lineColor,midlineColor:E.midlineColor,midlineStyle:E.midlineStyle},volumeDelta:{sourceInterval:S.sourceInterval,divergenceTable:S.divergenceTable,divergentPriceBars:S.divergentPriceBars,bullishDivergentColor:S.bullishDivergentColor,bearishDivergentColor:S.bearishDivergentColor,neutralDivergentColor:S.neutralDivergentColor},volumeDeltaRsi:{length:D.length,lineColor:D.lineColor,midlineColor:D.midlineColor,midlineStyle:D.midlineStyle,sourceInterval:D.sourceInterval},paneOrder:[...re],paneHeights:{...on}};window.localStorage.setItem(xs,JSON.stringify(t))}catch{}}function rl(){if(!(Pr||typeof window>"u")){Pr=!0;try{const t=window.localStorage.getItem(xs);if(!t)return;const e=JSON.parse(t),n=e?.price;if(n&&(k.maSourceMode=n.maSourceMode==="timeframe"?"timeframe":"daily",typeof n.verticalGridlines=="boolean"&&(k.verticalGridlines=n.verticalGridlines),typeof n.horizontalGridlines=="boolean"&&(k.horizontalGridlines=n.horizontalGridlines),Array.isArray(n.ma)))for(let o=0;o<k.ma.length;o++){const a=n.ma[o];a&&(k.ma[o].enabled=!!a.enabled,k.ma[o].type=a.type==="EMA"?"EMA":"SMA",k.ma[o].length=Math.max(1,Math.floor(Number(a.length)||k.ma[o].length)),typeof a.color=="string"&&a.color.trim()&&(k.ma[o].color=a.color))}const i=e?.rsi;i&&(E.length=Math.max(1,Math.floor(Number(i.length)||E.length)),typeof i.lineColor=="string"&&i.lineColor.trim()&&(E.lineColor=i.lineColor),typeof i.midlineColor=="string"&&i.midlineColor.trim()&&(E.midlineColor=i.midlineColor),E.midlineStyle=i.midlineStyle==="solid"?"solid":"dotted");const r=e?.volumeDelta;if(r){const o=String(r.sourceInterval||"");(o==="1min"||o==="5min"||o==="15min"||o==="30min"||o==="1hour"||o==="4hour")&&(S.sourceInterval=o),typeof r.divergenceTable=="boolean"&&(S.divergenceTable=r.divergenceTable),typeof r.divergentPriceBars=="boolean"&&(S.divergentPriceBars=r.divergentPriceBars),typeof r.bullishDivergentColor=="string"&&r.bullishDivergentColor.trim()&&(S.bullishDivergentColor=r.bullishDivergentColor),typeof r.bearishDivergentColor=="string"&&r.bearishDivergentColor.trim()&&(S.bearishDivergentColor=r.bearishDivergentColor),typeof r.neutralDivergentColor=="string"&&r.neutralDivergentColor.trim()&&(S.neutralDivergentColor=r.neutralDivergentColor)}const s=e?.volumeDeltaRsi;if(s){D.length=Math.max(1,Math.floor(Number(s.length)||D.length)),typeof s.lineColor=="string"&&s.lineColor.trim()&&(D.lineColor=s.lineColor),typeof s.midlineColor=="string"&&s.midlineColor.trim()&&(D.midlineColor=s.midlineColor),D.midlineStyle=s.midlineStyle==="solid"?"solid":"dotted";const o=String(s.sourceInterval||"");(o==="1min"||o==="5min"||o==="15min"||o==="30min"||o==="1hour"||o==="4hour")&&(D.sourceInterval=o)}if(re=Lt(e?.paneOrder),e?.paneHeights&&typeof e.paneHeights=="object")for(const[o,a]of Object.entries(e.paneHeights))typeof a=="number"&&a>=mr&&a<=pr&&(on[o]=a)}catch{}}}function zs(t,e){const n=Math.max(1,Math.floor(e)),i=new Array(t.length).fill(null),r=t.slice();let s=null;for(let a=0;a<r.length;a++)Number.isFinite(r[a])?s=r[a]:s!==null&&(r[a]=s);let o=0;for(let a=0;a<r.length;a++){const l=r[a];Number.isFinite(l)&&(o+=l,a>=n&&(o-=r[a-n]),a>=n-1&&(i[a]=o/n))}return i}function sl(t,e,n){const i=[],r=new Map,s=new Set;for(const d of t){const c=Te(d?.time),u=Number(d?.close);if(c===null||!Number.isFinite(u))continue;const f=Or(c);s.has(f)||(s.add(f),i.push(f)),r.set(f,u)}const o=i.map(d=>Number(r.get(d))),a=e==="EMA"?Us(o,n):zs(o,n),l=new Map;for(let d=0;d<i.length;d++)l.set(i[d],a[d]??null);return t.map(d=>{const c=Te(d?.time);return c===null?null:l.get(Or(c))??null})}function Us(t,e){const n=Math.max(1,Math.floor(e)),i=new Array(t.length).fill(null);if(t.length===0)return i;const r=t.slice();let s=null;for(let l=0;l<r.length;l++)Number.isFinite(r[l])?s=r[l]:s!==null&&(r[l]=s);const o=2/(n+1);let a=null;for(let l=0;l<r.length;l++){const d=r[l];if(Number.isFinite(d)){if(a===null){let c=0,u=0;for(let f=l;f<r.length&&u<n;f++)Number.isFinite(r[f])&&(c+=r[f],u++);a=u>0?c/u:d}else a=d*o+a*(1-o);i[l]=a}}return i}function er(t){const e=typeof t=="number"?t:Number.NaN;return Number.isFinite(e)&&e>0}function Dr(){for(const t of k.ma)t.series&&T&&(T.removeSeries(t.series),t.series=null),T||(t.series=null),t.values=[]}function Ie(){if(!T||!b.length){Dr();return}for(const t of k.ma){const e=Math.max(1,Math.floor(Number(t.length)||1));if(t.length=e,!t.enabled){t.series&&(T.removeSeries(t.series),t.series=null),t.values=[];continue}t.series?t.series.applyOptions({color:t.color}):t.series=T.addLineSeries({color:t.color,lineWidth:1,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1});const n=k.maSourceMode==="daily"?sl(b,t.type,e):t.type==="EMA"?Us(b.map(r=>Number(r.close)),e):zs(b.map(r=>Number(r.close)),e);t.values=n;const i=b.map((r,s)=>{const o=n[s];return er(o)?{time:r.time,value:o}:{time:r.time}});t.series.setData(i)}}function ol(){if(!T||!Array.isArray(b)||b.length===0)return;if(k.maSourceMode==="daily"){Ie();return}const t=b.length-1,e=b[t],n=Number(e?.close);if(!Number.isFinite(n)){Ie();return}for(const i of k.ma){if(!i.enabled||!i.series)continue;const r=Math.max(1,Math.floor(Number(i.length)||1));let s=null;if(i.type==="EMA")if(t===0)s=n;else{const o=Number(i.values[t-1]);if(!Number.isFinite(o)){Ie();return}const a=2/(r+1);s=n*a+o*(1-a)}else if(t<r-1)s=null;else{let o=0;for(let a=t-r+1;a<=t;a++){const l=Number(b[a]?.close);if(!Number.isFinite(l)){Ie();return}o+=l}s=o/r}i.values.length!==b.length&&(i.values=new Array(b.length).fill(null)),i.values[t]=er(s)?s:null,er(s)?i.series.update({time:e.time,value:s}):i.series.update({time:e.time})}}function wn(t){t&&(t.innerHTML="")}function kn(t,e){if(!t||!e||(e.innerHTML="",!k.verticalGridlines)||!Kn.length)return;const n=e.clientWidth||e.offsetWidth;if(!(!Number.isFinite(n)||n<=0))for(const i of Kn){const r=t.timeScale().timeToCoordinate(i);if(!Number.isFinite(r)||r<0||r>n)continue;const s=document.createElement("div");s.style.position="absolute",s.style.top="0",s.style.bottom="0",s.style.left=`${Math.round(r)}px`,s.style.width="1px",s.style.background=Ds,e.appendChild(s)}}function al(){kn(T,Zn),kn(L,Yn),kn(W,Xn),kn(x?.getChart(),Jn),ro()}function Oe(){_i===null&&(_i=requestAnimationFrame(()=>{_i=null,al(),mc()}))}function xr(){T&&(T.applyOptions({grid:{vertLines:{visible:!1},horzLines:{visible:k.horizontalGridlines,color:Ds}}}),Oe())}function Ws(){if(!_)return;const t=_.querySelector('[data-price-setting="ma-source"]'),e=_.querySelector('[data-price-setting="v-grid"]'),n=_.querySelector('[data-price-setting="h-grid"]');t&&(t.value=k.maSourceMode),e&&(e.checked=k.verticalGridlines),n&&(n.checked=k.horizontalGridlines);for(let i=0;i<k.ma.length;i++){const r=k.ma[i],s=_.querySelector(`[data-price-setting="ma-enabled-${i}"]`),o=_.querySelector(`[data-price-setting="ma-type-${i}"]`),a=_.querySelector(`[data-price-setting="ma-length-${i}"]`),l=_.querySelector(`[data-price-setting="ma-color-${i}"]`);s&&(s.checked=r.enabled),o&&(o.value=r.type),a&&(a.value=String(r.length)),l&&(l.value=r.color)}}function qs(){if(!j)return;const t=j.querySelector('[data-rsi-setting="length"]'),e=j.querySelector('[data-rsi-setting="line-color"]'),n=j.querySelector('[data-rsi-setting="midline-color"]'),i=j.querySelector('[data-rsi-setting="midline-style"]');t&&(t.value=String(E.length)),e&&(e.value=E.lineColor),n&&(n.value=E.midlineColor),i&&(i.value=E.midlineStyle)}function js(){if(!O)return;const t=O.querySelector('[data-vd-setting="source-interval"]'),e=O.querySelector('[data-vd-setting="divergence-table"]'),n=O.querySelector('[data-vd-setting="divergent-price-bars"]'),i=O.querySelector('[data-vd-setting="divergent-bullish-color"]'),r=O.querySelector('[data-vd-setting="divergent-bearish-color"]'),s=O.querySelector('[data-vd-setting="divergent-neutral-color"]');t&&(t.value=S.sourceInterval),e&&(e.checked=S.divergenceTable),n&&(n.checked=S.divergentPriceBars),i&&(i.value=S.bullishDivergentColor),r&&(r.value=S.bearishDivergentColor),s&&(s.value=S.neutralDivergentColor)}function Gs(){if(!z)return;const t=z.querySelector('[data-vd-rsi-setting="length"]'),e=z.querySelector('[data-vd-rsi-setting="line-color"]'),n=z.querySelector('[data-vd-rsi-setting="midline-color"]'),i=z.querySelector('[data-vd-rsi-setting="midline-style"]'),r=z.querySelector('[data-vd-rsi-setting="source-interval"]');t&&(t.value=String(D.length)),e&&(e.value=D.lineColor),n&&(n.value=D.midlineColor),i&&(i.value=D.midlineStyle),r&&(r.value=D.sourceInterval)}function Ft(){_&&(_.style.display="none"),O&&(O.style.display="none"),z&&(z.style.display="none"),j&&(j.style.display="none")}function ll(){return Lt(re)[0]}function cl(t){const e=String(t.dataset.topPaneBadgeRole||"");return e==="ticker"?0:e==="price-change"?1:100}function Cr(t){const e=Array.from(t.querySelectorAll(".pane-settings-btn, .pane-trendline-btn"));if(!e.length)return Br;const i=e.reduce((r,s)=>{const o=s.offsetLeft+s.offsetWidth;return o>r?o:r},0)+ws;return Math.max(Br,i)}function Wt(t){const e=Array.from(t.querySelectorAll(`.${dr}`)).filter(r=>r.style.display!=="none");if(!e.length)return;const n=e.map((r,s)=>({badge:r,index:s,priority:cl(r)})).sort((r,s)=>r.priority-s.priority||r.index-s.index).map(r=>r.badge);let i=Cr(t);for(const r of n){r.style.left=`${i}px`,r.style.top="8px",r.style.maxWidth=`calc(100% - ${i+30}px)`;const s=Math.ceil(r.getBoundingClientRect().width||r.offsetWidth||0);i+=Math.max(0,s)+ws}}function Wr(t){const e=String(t||"").trim().toUpperCase();if(!e)return;const n=`https://www.tradingview.com/symbols/${encodeURIComponent(e)}/`;window.open(n,"_blank","noopener,noreferrer")}function wr(){const t=ll();for(const r of be){const s=document.getElementById(r);if(!s||!(s instanceof HTMLElement))continue;const o=s.querySelector(`.${Bi}`);o&&r!==t&&o.remove()}if(!t)return;const e=document.getElementById(t);if(!e||!(e instanceof HTMLElement))return;const n=String(A||"").trim().toUpperCase();let i=e.querySelector(`.${Bi}`);if(!n){i&&i.remove();for(const r of be){const s=document.getElementById(r);!s||!(s instanceof HTMLElement)||Wt(s)}return}if(!i){const r=Cr(e);i=document.createElement("div"),i.className=`${Bi} ${dr}`,i.dataset.topPaneBadgeRole="ticker",i.style.position="absolute",i.style.left=`${r}px`,i.style.top="8px",i.style.zIndex="32",i.style.minHeight="24px",i.style.maxWidth=`calc(100% - ${r+30}px)`,i.style.display="inline-flex",i.style.alignItems="center",i.style.padding="0 8px",i.style.borderRadius="4px",i.style.border="1px solid #30363d",i.style.background="#161b22",i.style.color="#c9d1d9",i.style.fontSize="12px",i.style.fontWeight="600",i.style.fontFamily="'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",i.style.whiteSpace="nowrap",i.style.overflow="hidden",i.style.textOverflow="ellipsis",i.style.pointerEvents="auto",i.style.cursor="pointer",i.title="Open on TradingView",i.setAttribute("role","link"),i.tabIndex=0,i.dataset.clickBound||(i.addEventListener("click",s=>{s.stopPropagation();const o=s.currentTarget;Wr(String(o.dataset.tickerSymbol||""))}),i.addEventListener("keydown",s=>{if(s.key!=="Enter"&&s.key!==" ")return;s.preventDefault();const o=s.currentTarget;Wr(String(o.dataset.tickerSymbol||""))}),i.dataset.clickBound="1"),e.appendChild(i)}i.dataset.tickerSymbol=n,i.textContent=n;for(const r of be){const s=document.getElementById(r);!s||!(s instanceof HTMLElement)||Wt(s)}}function Ks(t){for(const e of re){const n=document.getElementById(e);!n||n.parentElement!==t||t.appendChild(n)}}function ul(t,e,n){if(t===e)return;const i=re.filter(o=>o!==t),r=i.indexOf(e);if(r<0)return;const s=n?r+1:r;i.splice(s,0,t),re=Lt(i)}function qr(){for(const t of be){const e=document.getElementById(t);e&&e.classList.remove("pane-drag-over")}}function Zs(t){Ks(t);const e=document.getElementById("price-chart-container"),n=document.getElementById("vd-rsi-chart-container"),i=document.getElementById("rsi-chart-container"),r=document.getElementById("vd-chart-container");e&&n&&i&&r&&xi(e,n,i,r),vi(),wr()}function dl(){return document.getElementById("custom-chart-container")?.classList.contains("chart-fullscreen")===!0}function Tn(t){const n=Lt(re).indexOf(t);return n===3&&dl()?!1:n===1||n===3}function En(t,e){t&&t.applyOptions({rightPriceScale:{visible:!0},timeScale:{visible:e,borderVisible:e,ticksVisible:e}})}function vi(){En(T,Tn("price-chart-container")),En(L,Tn("vd-rsi-chart-container")),En(x?.getChart(),Tn("rsi-chart-container")),En(W,Tn("vd-chart-container"))}function fl(t,e,n){t.dataset.paneId||(t.dataset.paneId=e);let i=t.querySelector(".pane-order-handle");i||(i=document.createElement("button"),i.type="button",i.className="pane-order-handle",i.title="Drag to reorder panes",i.textContent="",i.setAttribute("aria-label","Reorder pane"),t.appendChild(i)),i.dataset.bound||(i.setAttribute("draggable","true"),i.addEventListener("dragstart",r=>{$t=e,r.dataTransfer&&(r.dataTransfer.effectAllowed="move",r.dataTransfer.setData("text/plain",e)),qr()}),i.addEventListener("dragend",()=>{$t=null,qr()}),i.dataset.bound="1"),t.dataset.dropBound||(t.addEventListener("dragover",r=>{$t&&(r.preventDefault(),t.classList.add("pane-drag-over"),r.dataTransfer&&(r.dataTransfer.dropEffect="move"))}),t.addEventListener("dragleave",()=>{t.classList.remove("pane-drag-over")}),t.addEventListener("drop",r=>{r.preventDefault(),t.classList.remove("pane-drag-over");const s=$t;if($t=null,!s||s===e)return;const o=re.indexOf(s),a=re.indexOf(e),l=o>=0&&a>=0?o<a:!0;ul(s,e,l),Zs(n),R()}),t.dataset.dropBound="1")}function ml(t){re=Lt(re),Ks(t);for(const e of be){const n=document.getElementById(e);!n||!(n instanceof HTMLElement)||n.parentElement!==t||fl(n,e,t)}wr()}function kr(){if(!x)return;const t=Is(b,E.length);Mt=new Map(t.filter(e=>Number.isFinite(Number(e.value))).map(e=>[N(e.time),Number(e.value)])),x.setData(t,b.map(e=>({time:e.time,close:e.close}))),x.setLineColor(E.lineColor),x.setMidlineOptions(E.midlineColor,E.midlineStyle),Si()}function Ys(t){return t==="solid"?0:1}function Tr(){ee&&ee.applyOptions({color:D.lineColor,lineWidth:1}),Zi&&Zi.applyOptions({color:D.midlineColor,lineStyle:Ys(D.midlineStyle)}),Si()}function nt(t){Tr(),t&&A&&Ce(A,ie)}function pl(){Dr(),k.maSourceMode=Ne.maSourceMode,k.verticalGridlines=Ne.verticalGridlines,k.horizontalGridlines=Ne.horizontalGridlines;for(let e=0;e<k.ma.length;e++){const n=Ne.ma[e];n&&(k.ma[e].enabled=n.enabled,k.ma[e].type=n.type,k.ma[e].length=n.length,k.ma[e].color=n.color,k.ma[e].series=null,k.ma[e].values=[])}re=[...be];const t=document.getElementById("chart-content");t&&t instanceof HTMLElement&&Zs(t),xr(),Ie(),Ws(),R()}function hl(){E.length=Bt.length,E.lineColor=Bt.lineColor,E.midlineColor=Bt.midlineColor,E.midlineStyle=Bt.midlineStyle,kr(),qs(),R()}function gl(){S.sourceInterval=ce.sourceInterval,S.divergenceTable=ce.divergenceTable,S.divergentPriceBars=ce.divergentPriceBars,S.bullishDivergentColor=ce.bullishDivergentColor,S.bearishDivergentColor=ce.bearishDivergentColor,S.neutralDivergentColor=ce.neutralDivergentColor,A&&Ce(A,ie),qe(),js(),R()}function yl(){D.length=tt.length,D.lineColor=tt.lineColor,D.midlineColor=tt.midlineColor,D.midlineStyle=tt.midlineStyle,D.sourceInterval=tt.sourceInterval,nt(!0),Gs(),R()}function Mn(t,e){const n=t.querySelector(`.pane-settings-btn[data-pane="${e}"]`);if(n)return n;const i=document.createElement("button");return i.className="pane-settings-btn settings-icon-btn",i.dataset.pane=e,i.type="button",i.title=e==="price"?"Price settings":e==="volumeDelta"?"Volume Delta settings":e==="volumeDeltaRsi"?"Volume Delta RSI settings":"RSI settings",i.textContent=$a,i.style.position="absolute",i.style.left=`${fr}px`,i.style.top=`${gn}px`,i.style.zIndex="30",i.style.width=`${U}px`,i.style.height=`${U}px`,i.style.borderRadius="4px",t.appendChild(i),i}function bl(t){return t==="volumeDelta"?"VD":t==="volumeDeltaRsi"?"VD-RSI":t==="rsi"?"RSI":"Price"}function Ln(t,e){const n=t.querySelector(`.pane-name-badge[data-pane="${e}"]`);if(n)return n;const i=document.createElement("div");return i.className="pane-name-badge",i.dataset.pane=e,i.textContent=bl(e),i.style.position="absolute",i.style.left=`${fr}px`,i.style.top=`${gn+U+sn}px`,i.style.zIndex="30",i.style.minWidth=`${U}px`,i.style.height=`${U}px`,i.style.padding="0 8px",i.style.borderRadius="4px",i.style.border="1px solid #30363d",i.style.background="#161b22",i.style.color="#c9d1d9",i.style.display="inline-flex",i.style.alignItems="center",i.style.justifyContent="center",i.style.fontSize="12px",i.style.fontWeight="600",i.style.fontFamily="'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",i.style.pointerEvents="none",i.style.userSelect="none",t.appendChild(i),i}function et(t,e,n,i){const r=t.querySelector(`.pane-trendline-btn[data-pane="${e}"][data-action="${n}"]`);if(r)return r;const s=document.createElement("button");return s.className="pane-trendline-btn",s.dataset.pane=e,s.dataset.action=n,s.type="button",s.title=n==="trend"?"Draw Trendline":n==="erase"?"Erase Trendline":"Divergence",s.textContent=n==="trend"?bs:n==="erase"?ka:vs,s.style.position="absolute",s.style.left=`${fr+(i+1)*(U+sn)}px`,s.style.top=`${gn}px`,s.style.zIndex="30",s.style.width=`${U}px`,s.style.height=`${U}px`,s.style.borderRadius="4px",s.style.border="1px solid #30363d",s.style.background="#161b22",s.style.color="#c9d1d9",s.style.cursor="pointer",s.style.padding="0",t.appendChild(s),s}function vl(t,e){return document.querySelector(`.pane-trendline-btn[data-pane="${t}"][data-action="${e}"]`)}function Xe(t,e,n){const i=vl(t,e);i&&(i.classList.toggle("active",n),i.style.background=n?"#1f6feb":"#161b22",i.style.color="#ffffff",i.textContent=e==="trend"?bs:vs)}function te(t,e){Xe(t,"trend",e)}function Xs(){if(!Array.isArray(b)||b.length===0)return null;const t=b[b.length-1]?.time;if(typeof t!="string"&&typeof t!="number")return null;if(!T)return t;try{const e=T.timeScale().getVisibleLogicalRange?.(),n=Number(e?.from),i=Number(e?.to);if(!Number.isFinite(n)||!Number.isFinite(i))return t;const r=Math.round((n+i)/2),s=Math.max(0,Math.min(b.length-1,r)),o=b[s]?.time;if(typeof o=="string"||typeof o=="number")return o}catch{}return t}function Sl(){if(!x)return;const t=Xs();if(t===null)return;const e=it(t,Mt),n=x.getChart?.(),i=x.getSeries?.();if(!(!n||!i||!Number.isFinite(e)))try{n.setCrosshairPosition(Number(e),t,i)}catch{}}function Dl(){if(!L||!ee)return;const t=Xs();if(t===null)return;const e=it(t,Ze);if(Number.isFinite(e))try{L.setCrosshairPosition(Number(e),t,ee)}catch{}}function xl(){if(x){if(fe){x.deactivateDivergenceTool(),fe=!1,te("rsi",!1);return}me&&an(),x.activateDivergenceTool(),fe=!0,te("rsi",!0),Sl()}}function Cl(){x?.clearDivergence(!0),x?.deactivateDivergenceTool(),fe=!1,te("rsi",!1),bi()}function wl(){if(L){if(Me){yn(),te("volumeDeltaRsi",!1);return}pe&&ln(),Zl(),te("volumeDeltaRsi",!0),Dl()}}function kl(){Mr(!0),yn(),te("volumeDeltaRsi",!1),bi()}function Tl(t){const e=Te(t);if(e===null)return"";const n=new Date(e*1e3);return ie==="1day"||ie==="1week"?fn("en-US",{month:"2-digit",day:"2-digit",year:"2-digit"}).format(n):n.toLocaleString("en-US",{timeZone:ue(),month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1})}function El(t,e){const n=e==="rsi"?Ji:Qi;if(n&&n.parentElement===t)return n.style.top="0",n.style.right="0",n.style.maxWidth="100%",n;const i=document.createElement("div");i.className=`divergence-plot-overlay divergence-plot-overlay-${e}`,i.style.position="absolute",i.style.top="0",i.style.right="0",i.style.width="468px",i.style.maxWidth="100%",i.style.height="286px",i.style.border="1px solid #30363d",i.style.borderRadius="6px",i.style.background="rgba(13, 17, 23, 0.95)",i.style.backdropFilter="blur(4px)",i.style.zIndex="35",i.style.pointerEvents="none",i.style.display="none",i.style.padding="8px",i.style.boxSizing="border-box";const r=document.createElement("div");r.style.position="relative",r.style.width="100%",r.style.height="100%";const s=document.createElement("canvas");return s.className="divergence-plot-overlay-canvas",r.appendChild(s),i.appendChild(r),t.appendChild(i),e==="rsi"?Ji=i:Qi=i,i}function Js(t){return t==="rsi"?gs:ys}function Qs(t,e){t==="rsi"?gs=e:ys=e}function xt(t){const e=t==="rsi"?Ji:Qi;e&&(e.style.display="none");const n=Js(t);if(n){try{n.destroy()}catch{}Qs(t,null)}}function eo(t){if(!Array.isArray(b)||b.length===0)return null;const e=rn.get(N(t));if(e!==void 0)return e;const n=Te(t);if(n===null)return null;let i=0,r=Number.POSITIVE_INFINITY;for(let s=0;s<b.length;s++){const o=Te(b[s]?.time);if(o===null)continue;const a=Math.abs(o-n);a<r&&(r=a,i=s)}return Number.isFinite(r)?i:null}function Ml(t){const e=[],n=[],i=[];for(let r=t;r<b.length;r++){const s=b[r],o=N(s.time),a=Number(Mt.get(o)),l=Number(Ze.get(o));!Number.isFinite(a)||!Number.isFinite(l)||(e.push(Tl(s.time)),n.push(a),i.push(l))}return{labels:e,rsiValues:n,volumeDeltaRsiValues:i}}function ti(t,e){const n=t==="rsi"?document.getElementById("rsi-chart-container"):document.getElementById("vd-rsi-chart-container");if(!n||!(n instanceof HTMLElement))return;const i=El(n,t),r=i.querySelector(".divergence-plot-overlay-canvas");if(!r)return;if(!b.length||e<0||e>=b.length){xt(t);return}const s=Ml(e);if(s.rsiValues.length<2){xt(t);return}i.style.display="block";const o=Js(t);if(o){o.data.labels=s.labels,o.data.datasets[0].data=s.rsiValues,o.data.datasets[0].borderColor=E.lineColor,o.data.datasets[1].data=s.volumeDeltaRsiValues,o.data.datasets[1].borderColor=D.lineColor,o.update("none");return}const a=new Chart(r,{type:"line",data:{labels:s.labels,datasets:[{label:"RSI",data:s.rsiValues,borderColor:E.lineColor,backgroundColor:"transparent",borderWidth:1,pointRadius:s.rsiValues.length>24?0:2,tension:.2},{label:"VD RSI",data:s.volumeDeltaRsiValues,borderColor:D.lineColor,backgroundColor:"transparent",borderWidth:1,pointRadius:s.volumeDeltaRsiValues.length>24?0:2,tension:.2}]},options:{responsive:!0,maintainAspectRatio:!1,animation:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!1},tooltip:{backgroundColor:"rgba(22, 27, 34, 0.95)",borderColor:"#30363d",borderWidth:1,titleColor:"#c9d1d9",bodyColor:"#8b949e"}},scales:{x:{display:!1,ticks:{color:"#8b949e",maxRotation:0,autoSkip:!0,maxTicksLimit:6,font:{size:10}},grid:{color:"rgba(48, 54, 61, 0.22)"}},y:{display:!1,min:0,max:100,ticks:{color:"#8b949e",font:{size:10}},grid:{color:"rgba(48, 54, 61, 0.22)"}}}}});Qs(t,a)}function an(){me=!1,bt=!1,St=null,Xe("rsi","divergence",!1),xt("rsi")}function ln(){pe=!1,vt=!1,Dt=null,Xe("volumeDeltaRsi","divergence",!1),xt("volumeDeltaRsi")}function jr(t,e){if(!me||e&&!bt)return;const n=eo(t);n!==null&&(bt=!0,St=n,ti("rsi",n))}function to(t,e){if(!pe||e&&!vt)return;const n=eo(t);n!==null&&(vt=!0,Dt=n,ti("volumeDeltaRsi",n))}function Ll(){if(me){an();return}fe&&(x?.deactivateDivergenceTool(),fe=!1,te("rsi",!1)),me=!0,bt=!1,St=null,Xe("rsi","divergence",!0)}function Al(){if(pe){ln();return}Me&&(yn(),te("volumeDeltaRsi",!1)),pe=!0,vt=!1,Dt=null,Xe("volumeDeltaRsi","divergence",!0)}function Si(){me&&bt&&St!==null&&ti("rsi",St),pe&&vt&&Dt!==null&&ti("volumeDeltaRsi",Dt)}function Nl(){fe&&(x?.deactivateDivergenceTool(),fe=!1,te("rsi",!1)),Me&&(yn(),te("volumeDeltaRsi",!1)),me&&an(),pe&&ln()}function Di(t){t.style.fontFamily='-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',t.style.fontSize="12px",t.style.fontWeight="500",t.style.lineHeight="1.2",t.querySelectorAll("div, span, label, input, select, button").forEach(e=>{e.style.fontFamily="inherit",e.style.fontSize="inherit",e.style.fontWeight="inherit",e.style.fontStyle="normal",e.style.letterSpacing="normal"}),t.querySelectorAll("label").forEach(e=>{e.style.display="flex",e.style.justifyContent="space-between",e.style.alignItems="center",e.style.gap="8px",e.style.minHeight="26px"}),t.querySelectorAll('input[type="checkbox"]').forEach(e=>{e.style.width="14px",e.style.height="14px",e.style.margin="0"}),t.querySelectorAll("input, select, button").forEach(e=>{e.style.boxSizing="border-box",e.style.lineHeight="1.2"})}function Il(t){const e=document.createElement("div");return e.className="pane-settings-panel price-settings-panel",e.style.position="absolute",e.style.left="8px",e.style.top="38px",e.style.zIndex="31",e.style.width="280px",e.style.maxWidth="calc(100% - 16px)",e.style.background="rgba(22, 27, 34, 0.95)",e.style.border="1px solid #30363d",e.style.borderRadius="6px",e.style.padding="10px",e.style.display="none",e.style.color="#c9d1d9",e.style.backdropFilter="blur(6px)",e.innerHTML=`
    <div style="display:flex; justify-content:space-between; align-items:center; min-height:26px; margin-bottom:8px;">
      <div style="font-weight:600;">Chart</div>
      <button type="button" data-price-setting="reset" style="background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:4px; padding:4px 8px; font-size:12px; cursor:pointer;">Reset</button>
    </div>
    <label style="margin-bottom:6px;">
      <span>Vertical gridlines</span>
      <input type="checkbox" data-price-setting="v-grid" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Horizontal gridlines</span>
      <input type="checkbox" data-price-setting="h-grid" />
    </label>
    <label style="margin-bottom:4px;">
      <span>MA source</span>
      <select data-price-setting="ma-source" style="background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:4px; padding:2px 4px;">
        <option value="daily">Daily</option>
        <option value="timeframe">Chart</option>
      </select>
    </label>
    ${k.ma.map((n,i)=>`
      <div style="display:grid; grid-template-columns: 20px 64px 58px 1fr; gap:6px; align-items:center; min-height:26px; margin-bottom:6px;">
        <input type="checkbox" data-price-setting="ma-enabled-${i}" title="Enable MA ${i+1}" />
        <select data-price-setting="ma-type-${i}" style="background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:4px; padding:2px 4px;">
          <option value="SMA">SMA</option>
          <option value="EMA">EMA</option>
        </select>
        <input data-price-setting="ma-length-${i}" type="number" min="1" max="500" step="1" style="width:58px; background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:4px; padding:2px 4px;" />
        <input data-price-setting="ma-color-${i}" type="color" style="width:100%; height:24px; border:none; background:transparent; padding:0;" />
      </div>
    `).join("")}
  `,Di(e),e.addEventListener("input",n=>{const i=n.target;if(!i)return;const r=i.dataset.priceSetting||"";if(r==="ma-source"){k.maSourceMode=i.value==="timeframe"?"timeframe":"daily",Ie(),R();return}if(r==="v-grid"){k.verticalGridlines=i.checked,Oe(),R();return}if(r==="h-grid"){k.horizontalGridlines=i.checked,xr(),R();return}const s=r.match(/^ma-(enabled|type|length|color)-(\d)$/);if(!s)return;const o=s[1],a=Number(s[2]),l=k.ma[a];l&&(o==="enabled"?l.enabled=i.checked:o==="type"?l.type=i.value==="EMA"?"EMA":"SMA":o==="length"?l.length=Math.max(1,Math.floor(Number(i.value)||14)):o==="color"&&(l.color=i.value||l.color),Ie(),R())}),e.addEventListener("click",n=>{const i=n.target;i&&i.dataset.priceSetting==="reset"&&(n.preventDefault(),pl())}),t.appendChild(e),e}function Rl(t){const e=document.createElement("div");return e.className="pane-settings-panel rsi-settings-panel",e.style.position="absolute",e.style.left="8px",e.style.top="38px",e.style.zIndex="31",e.style.width="230px",e.style.maxWidth="calc(100% - 16px)",e.style.background="rgba(22, 27, 34, 0.95)",e.style.border="1px solid #30363d",e.style.borderRadius="6px",e.style.padding="10px",e.style.display="none",e.style.color="#c9d1d9",e.style.backdropFilter="blur(6px)",e.innerHTML=`
    <div style="display:flex; justify-content:space-between; align-items:center; min-height:26px; margin-bottom:8px;">
      <div style="font-weight:600;">RSI</div>
      <button type="button" data-rsi-setting="reset" style="background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:4px; padding:4px 8px; font-size:12px; cursor:pointer;">Reset</button>
    </div>
    <label style="margin-bottom:6px;">
      <span>Length</span>
      <input data-rsi-setting="length" type="number" min="1" max="200" step="1" style="width:64px; background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:4px; padding:2px 4px;" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Line color</span>
      <input data-rsi-setting="line-color" type="color" style="width:64px; height:24px; border:none; background:transparent; padding:0;" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Midline color</span>
      <input data-rsi-setting="midline-color" type="color" style="width:64px; height:24px; border:none; background:transparent; padding:0;" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Midline style</span>
      <select data-rsi-setting="midline-style" style="background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:4px; padding:2px 4px;">
        <option value="dotted">Dotted</option>
        <option value="solid">Solid</option>
      </select>
    </label>
  `,Di(e),e.addEventListener("input",n=>{const i=n.target;if(!i)return;const r=i.dataset.rsiSetting||"";if(r==="length"){E.length=Math.max(1,Math.floor(Number(i.value)||14)),kr(),R();return}if(r==="line-color"){E.lineColor=i.value||E.lineColor,x?.setLineColor(E.lineColor),R();return}if(r==="midline-color"){E.midlineColor=i.value||E.midlineColor,x?.setMidlineOptions(E.midlineColor,E.midlineStyle),R();return}if(r==="midline-style"){E.midlineStyle=i.value==="solid"?"solid":"dotted",x?.setMidlineOptions(E.midlineColor,E.midlineStyle),R();return}}),e.addEventListener("click",n=>{const i=n.target;i&&i.dataset.rsiSetting==="reset"&&(n.preventDefault(),hl())}),t.appendChild(e),e}function $l(t){const e=document.createElement("div");return e.className="pane-settings-panel volume-delta-settings-panel",e.style.position="absolute",e.style.left="8px",e.style.top="38px",e.style.zIndex="31",e.style.width="230px",e.style.maxWidth="calc(100% - 16px)",e.style.background="rgba(22, 27, 34, 0.95)",e.style.border="1px solid #30363d",e.style.borderRadius="6px",e.style.padding="10px",e.style.display="none",e.style.color="#c9d1d9",e.style.backdropFilter="blur(6px)",e.innerHTML=`
    <div style="display:flex; justify-content:space-between; align-items:center; min-height:26px; margin-bottom:8px;">
      <div style="font-weight:600;">Volume Delta</div>
      <button type="button" data-vd-setting="reset" style="background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:4px; padding:4px 8px; font-size:12px; cursor:pointer;">Reset</button>
    </div>
    <label style="margin-bottom:6px;">
      <span>Source</span>
      <select data-vd-setting="source-interval" style="background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:4px; padding:2px 4px;">
        ${Ls.map(n=>`<option value="${n.value}">${n.label}</option>`).join("")}
      </select>
    </label>
    <label style="margin-bottom:6px;">
      <span>Divergence table</span>
      <input type="checkbox" data-vd-setting="divergence-table" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Divergent price bars</span>
      <input type="checkbox" data-vd-setting="divergent-price-bars" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Bullish</span>
      <input type="color" data-vd-setting="divergent-bullish-color" style="width:64px; height:24px; border:none; background:transparent; padding:0;" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Bearish</span>
      <input type="color" data-vd-setting="divergent-bearish-color" style="width:64px; height:24px; border:none; background:transparent; padding:0;" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Neutral</span>
      <input type="color" data-vd-setting="divergent-neutral-color" style="width:64px; height:24px; border:none; background:transparent; padding:0;" />
    </label>
  `,Di(e),e.addEventListener("input",n=>{const i=n.target;if(!i)return;const r=i.dataset.vdSetting||"";if(r==="source-interval"){const s=String(i.value||"");if(s!=="1min"&&s!=="5min"&&s!=="15min"&&s!=="30min"&&s!=="1hour"&&s!=="4hour")return;S.sourceInterval=s,A&&Ce(A,ie),R();return}if(r==="divergence-table"){S.divergenceTable=i.checked,tn&&Lr(tn,b),R();return}if(r==="divergent-price-bars"){S.divergentPriceBars=i.checked,qe(),R();return}if(r==="divergent-bullish-color"){S.bullishDivergentColor=i.value||S.bullishDivergentColor,qe(),R();return}if(r==="divergent-bearish-color"){S.bearishDivergentColor=i.value||S.bearishDivergentColor,qe(),R();return}if(r==="divergent-neutral-color"){S.neutralDivergentColor=i.value||S.neutralDivergentColor,qe(),R();return}}),e.addEventListener("click",n=>{const i=n.target;i&&i.dataset.vdSetting==="reset"&&(n.preventDefault(),gl())}),t.appendChild(e),e}function Fl(t){const e=document.createElement("div");return e.className="pane-settings-panel volume-delta-rsi-settings-panel",e.style.position="absolute",e.style.left="8px",e.style.top="38px",e.style.zIndex="31",e.style.width="230px",e.style.maxWidth="calc(100% - 16px)",e.style.background="rgba(22, 27, 34, 0.95)",e.style.border="1px solid #30363d",e.style.borderRadius="6px",e.style.padding="10px",e.style.display="none",e.style.color="#c9d1d9",e.style.backdropFilter="blur(6px)",e.innerHTML=`
    <div style="display:flex; justify-content:space-between; align-items:center; min-height:26px; margin-bottom:8px;">
      <div style="font-weight:600;">Volume Delta RSI</div>
      <button type="button" data-vd-rsi-setting="reset" style="background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:4px; padding:4px 8px; font-size:12px; cursor:pointer;">Reset</button>
    </div>
    <label style="margin-bottom:6px;">
      <span>Length</span>
      <input data-vd-rsi-setting="length" type="number" min="1" max="200" step="1" style="width:64px; background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:4px; padding:2px 4px;" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Source</span>
      <select data-vd-rsi-setting="source-interval" style="background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:4px; padding:2px 4px;">
        ${Ls.map(n=>`<option value="${n.value}">${n.label}</option>`).join("")}
      </select>
    </label>
    <label style="margin-bottom:6px;">
      <span>Line color</span>
      <input data-vd-rsi-setting="line-color" type="color" style="width:64px; height:24px; border:none; background:transparent; padding:0;" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Midline color</span>
      <input data-vd-rsi-setting="midline-color" type="color" style="width:64px; height:24px; border:none; background:transparent; padding:0;" />
    </label>
    <label style="margin-bottom:6px;">
      <span>Midline style</span>
      <select data-vd-rsi-setting="midline-style" style="background:#0d1117; color:#c9d1d9; border:1px solid #30363d; border-radius:4px; padding:2px 4px;">
        <option value="dotted">Dotted</option>
        <option value="solid">Solid</option>
      </select>
    </label>
  `,Di(e),e.addEventListener("input",n=>{const i=n.target;if(!i)return;const r=i.dataset.vdRsiSetting||"";if(r==="length"){D.length=Math.max(1,Math.floor(Number(i.value)||14)),nt(!0),R();return}if(r==="source-interval"){const s=String(i.value||"");if(s!=="1min"&&s!=="5min"&&s!=="15min"&&s!=="30min"&&s!=="1hour"&&s!=="4hour")return;D.sourceInterval=s,nt(!0),R();return}if(r==="line-color"){D.lineColor=i.value||D.lineColor,nt(!1),R();return}if(r==="midline-color"){D.midlineColor=i.value||D.midlineColor,nt(!1),R();return}if(r==="midline-style"){D.midlineStyle=i.value==="solid"?"solid":"dotted",nt(!1),R();return}}),e.addEventListener("click",n=>{const i=n.target;i&&i.dataset.vdRsiSetting==="reset"&&(n.preventDefault(),yl())}),t.appendChild(e),e}function Pl(t,e,n,i){const r=Mn(t,"price");cc(t);const s=uc(t),o=Mn(e,"volumeDeltaRsi"),a=Mn(n,"rsi"),l=Mn(i,"volumeDelta");Ln(t,"price"),Ln(e,"volumeDeltaRsi"),Ln(n,"rsi"),Ln(i,"volumeDelta");const d=et(e,"volumeDeltaRsi","trend",0),c=et(e,"volumeDeltaRsi","erase",1),u=et(e,"volumeDeltaRsi","divergence",2),f=et(n,"rsi","trend",0),p=et(n,"rsi","erase",1),h=et(n,"rsi","divergence",2);(!_||_.parentElement!==t)&&(_?.parentElement&&_.parentElement.removeChild(_),_=Il(t)),(!j||j.parentElement!==n)&&(j?.parentElement&&j.parentElement.removeChild(j),j=Rl(n)),(!z||z.parentElement!==e)&&(z?.parentElement&&z.parentElement.removeChild(z),z=Fl(e)),(!O||O.parentElement!==i)&&(O?.parentElement&&O.parentElement.removeChild(O),O=$l(i)),Ws(),js(),Gs(),qs(),r.dataset.bound||(r.addEventListener("click",m=>{m.stopPropagation();const g=_?.style.display==="block"?"none":"block";Ft(),_&&(_.style.display=g)}),r.dataset.bound="1"),o.dataset.bound||(o.addEventListener("click",m=>{m.stopPropagation();const g=z?.style.display==="block"?"none":"block";Ft(),z&&(z.style.display=g)}),o.dataset.bound="1"),l.dataset.bound||(l.addEventListener("click",m=>{m.stopPropagation();const g=O?.style.display==="block"?"none":"block";Ft(),O&&(O.style.display=g)}),l.dataset.bound="1"),a.dataset.bound||(a.addEventListener("click",m=>{m.stopPropagation();const g=j?.style.display==="block"?"none":"block";Ft(),j&&(j.style.display=g)}),a.dataset.bound="1"),d.dataset.bound||(d.addEventListener("click",m=>{m.preventDefault(),m.stopPropagation(),wl()}),d.dataset.bound="1"),c.dataset.bound||(c.addEventListener("click",m=>{m.preventDefault(),m.stopPropagation(),kl()}),c.dataset.bound="1"),u.dataset.bound||(u.addEventListener("click",m=>{m.preventDefault(),m.stopPropagation(),Al()}),u.dataset.bound="1"),f.dataset.bound||(f.addEventListener("click",m=>{m.preventDefault(),m.stopPropagation(),xl()}),f.dataset.bound="1"),p.dataset.bound||(p.addEventListener("click",m=>{m.preventDefault(),m.stopPropagation(),Cl()}),p.dataset.bound="1"),h.dataset.bound||(h.addEventListener("click",m=>{m.preventDefault(),m.stopPropagation(),Ll()}),h.dataset.bound="1"),s.dataset.bound||(s.addEventListener("click",m=>{m.preventDefault(),m.stopPropagation(),A&&(nr(!0),fo(A,!0).finally(()=>{nr(!1)}))}),s.dataset.bound="1"),te("rsi",fe),te("volumeDeltaRsi",Me),Xe("rsi","divergence",me),Xe("volumeDeltaRsi","divergence",pe),document.body.dataset.chartSettingsBound||(document.addEventListener("click",m=>{const g=m.target;g&&(g.closest(".pane-settings-panel")||g.closest(".pane-settings-btn")||Ft())}),document.addEventListener("keydown",m=>{m.key==="Escape"&&Nl()}),document.body.dataset.chartSettingsBound="1")}function _l(t){let e=t.querySelector(".price-pane-change");if(e)return e;const n=Cr(t);return e=document.createElement("div"),e.className=`price-pane-change ${dr}`,e.dataset.topPaneBadgeRole="price-change",e.style.position="absolute",e.style.left=`${n}px`,e.style.top="8px",e.style.zIndex="30",e.style.minHeight="24px",e.style.display="inline-flex",e.style.alignItems="center",e.style.padding="0 8px",e.style.borderRadius="4px",e.style.border="1px solid #30363d",e.style.background="#161b22",e.style.color="#c9d1d9",e.style.fontSize="12px",e.style.fontFamily="'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",e.style.pointerEvents="none",e.style.display="none",t.appendChild(e),e}function Bl(t){if(Ke=new Map,!(!Array.isArray(t)||t.length<2))for(let e=1;e<t.length;e++){const n=Number(t[e]?.close),i=Number(t[e-1]?.close);if(!Number.isFinite(n)||!Number.isFinite(i)||i===0)continue;const r=(n-i)/i*100;Ke.set(N(t[e].time),r)}}function oe(t,e){const n=_l(t);if(!b.length||Ke.size===0){n.style.display="none",n.textContent="",Wt(t);return}const i=b[b.length-1]?.time,r=e!=null?N(e):N(i),s=Number(Ke.get(r));if(!Number.isFinite(s)){n.style.display="none",n.textContent="",Wt(t);return}const o=s>0?"+":"";n.textContent=`${o}${s.toFixed(2)}%`,n.style.color=s>0?"#26a69a":s<0?"#ef5350":"#c9d1d9",n.style.display="inline-flex",Wt(t)}function Vl(t){let e=t.querySelector(".price-pane-message");return e||(e=document.createElement("div"),e.className="price-pane-message",e.style.position="absolute",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.color="#8b949e",e.style.fontSize="1rem",e.style.fontWeight="600",e.style.pointerEvents="none",e.style.zIndex="20",e.style.display="none",t.appendChild(e),e)}function Gr(t,e){const n=Vl(t);if(!e){n.style.display="none",n.textContent="";return}n.textContent=e,n.style.display="block"}function Ol(t){const e=String(t?.message||t||"");return/No .*data available for this ticker|No valid chart bars/i.test(e)}function Hl(t){if(!Number.isFinite(t))return"";const e=Math.abs(t);let n="";if(e>=100)n=String(Math.round(t));else if(e>=10){const i=Math.round(t*10)/10;Math.abs(i)>=100?n=String(Math.round(i)):n=i.toFixed(1)}else n=(Math.round(t*100)/100).toFixed(2);return n.length>=se?n:n.padEnd(se," ")}function N(t){return typeof t=="number"?String(t):t}function Er(){return{priceRange:{minValue:Ba,maxValue:Va}}}function no(t){return Math.max(ks,Math.min(Ts,Number(t)))}function io(t){const e=document.getElementById("vd-rsi-chart-container");e&&(e.style.cursor=t?"crosshair":"default")}function Be(t){return Te(t)}function zl(t){return Number.isFinite(t)?fn("en-US",{month:"2-digit",day:"2-digit",year:"2-digit"}).format(new Date(Math.round(Number(t))*1e3)):"N/A"}function Ul(t){const e=document.createElement("div");return e.className="trendline-cross-label",e.textContent=t,e.style.position="absolute",e.style.zIndex="29",e.style.minHeight="24px",e.style.display="inline-flex",e.style.alignItems="center",e.style.padding="0 8px",e.style.borderRadius="4px",e.style.border="1px solid #30363d",e.style.background="#161b22",e.style.color="#c9d1d9",e.style.fontSize="12px",e.style.fontFamily="'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",e.style.pointerEvents="none",e.style.whiteSpace="nowrap",e.style.transform="translate(-50%, calc(-100% - 6px))",e}function ro(){const t=document.getElementById("vd-rsi-chart-container");if(!t||!L||!ee)return;const e=t.clientWidth,n=t.clientHeight;for(const i of jn){const r=L.timeScale().timeToCoordinate(i.anchorTime),s=ee.priceToCoordinate(i.anchorValue);if(!Number.isFinite(r)||!Number.isFinite(s)||r<0||r>e||s<0||s>n){i.element.style.display="none";continue}i.element.style.display="inline-flex",i.element.style.left=`${Math.round(r)}px`,i.element.style.top=`${Math.round(Math.max(8,s))}px`}}function Kr(){for(const t of jn)t.element.remove();jn=[]}function Wl(t,e,n){const i=document.getElementById("vd-rsi-chart-container");if(!i)return;const r=Ul(n);i.appendChild(r),jn.push({element:r,anchorTime:t,anchorValue:e}),ro()}function ql(t,e,n,i,r){if(!Number.isFinite(t))return null;if(t>e)return i===null?null:i+(t-e)*r;if(t<0)return n===null?null:n+t*r;const s=Math.max(0,Math.floor(t)),o=Math.min(e,Math.ceil(t)),a=Be(I[s]?.time),l=Be(I[o]?.time);if(s===o)return a;if(Number.isFinite(a)&&Number.isFinite(l)){const d=t-s;return Number(a)+(Number(l)-Number(a))*d}return Number.isFinite(a)?Number(a)+(t-s)*r:n===null?null:n+t*r}function jl(t,e,n,i,r,s,o){if(!Number.isFinite(n)||Math.abs(n)<1e-12)return null;const a=t+(_a-e)/n;return Number.isFinite(a)?ql(a,i,r,s,o):null}function so(){if(I.length<2)return 1800;const t=[];for(let e=1;e<I.length;e++){const n=Be(I[e-1].time),i=Be(I[e].time);if(n===null||i===null)continue;const r=i-n;Number.isFinite(r)&&r>0&&r<=8*3600&&t.push(r)}return t.length===0?1800:(t.sort((e,n)=>e-n),t[Math.floor(t.length/2)])}function Gl(t){return t<=300?78:t<=900?26:t<=1800?13:t<=3600?7:2}function Kl(){const t=so();return Gl(t)*252}function oo(){if(!(!zt||!L)){try{L.removeSeries(zt)}catch{}zt=null}}function ao(t=!1){const e=t&&L?L.timeScale().getVisibleLogicalRange?.():null;if(t&&(st=!0),!L||Pt.length===0){Pt=[],Gn=[],Kr(),t&&(st=!1);return}try{for(const n of Pt)try{L.removeSeries(n)}catch{}Pt=[],Gn=[],Kr()}finally{if(t&&e)try{L.timeScale().setVisibleLogicalRange(e)}catch{}t&&(st=!1)}}function lo(){oo(),_t=null,Fn.clear()}function yn(){Me=!1,lo(),io(!1)}function Zl(){Me=!0,io(!0)}function Mr(t=!1){lo(),ao(t)}function Yl(t){if(oo(),!L||t.length===0)return;zt=L.addLineSeries({color:Ha,lineVisible:!1,pointMarkersVisible:!0,pointMarkersRadius:2,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1,autoscaleInfoProvider:()=>Er()});const e=Math.max(1,Math.ceil(t.length/Oa)),n=e===1?t:t.filter((i,r)=>r%e===0);zt.setData(n)}function co(t,e,n,i,r=!0){if(!L||!I.length)return;const s=yt.get(N(t)),o=yt.get(N(n));if(s===void 0||o===void 0||s===o)return;const a=(i-e)/(o-s),l=I.length-1,d=Kl(),c=l+d,u=so(),f=Be(I[0]?.time),p=Be(I[l]?.time),h=L.timeScale().getVisibleLogicalRange?.(),m=[];st=!0;try{for(let y=s;y<=c;y++){const v=e+a*(y-s);if(!Number.isFinite(v)||v<ks||v>Ts)break;let C=null;y<=l?C=I[y]?.time??null:p!==null&&(C=p+(y-l)*u),C!=null&&m.push({time:C,value:v})}if(!m.length)return;const g=L.addLineSeries({color:za,lineWidth:1,lineStyle:0,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1,autoscaleInfoProvider:()=>Er()});g.setData(m),Pt.push(g);const w=jl(s,e,a,l,f,p,u);Wl(t,e,zl(w)),r&&Gn.push({time1:t,value1:Number(e),time2:n,value2:Number(i)})}finally{if(h)try{L.timeScale().setVisibleLogicalRange(h)}catch{}st=!1}}function Xl(t){if(!Me)return;const e=N(t),n=yt.get(e);if(n===void 0)return;const i=I[n];if(!i)return;const r=Number(i.value),s=nn.get(e);if(!Number.isFinite(r)||!Number.isFinite(s))return;const o=Number(s);if(!_t){_t={time:t,rsi:r,price:o,index:n};const a=[];Fn.clear();for(let l=n+1;l<I.length;l++){const d=I[l],c=Number(d?.value);if(!Number.isFinite(c))continue;const u=nn.get(N(d.time));if(!Number.isFinite(u))continue;const f=Number(u),p=c<r&&f>o,h=c>r&&f<o;!p&&!h||(a.push({time:d.time,value:c}),Fn.add(N(d.time)))}Yl(a);return}Fn.has(e)&&(co(_t.time,_t.rsi,t,r),yn(),te("volumeDeltaRsi",!1),bi())}function Jl(t,e){return!t||!e?!1:Math.abs(Number(t.from)-Number(e.from))<1e-6&&Math.abs(Number(t.to)-Number(e.to))<1e-6}function Ql(t){const e=pi(t,{layout:{background:{color:"#0d1117"},textColor:"#d1d4dc",fontFamily:"'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",attributionLogo:!1},grid:{vertLines:{visible:!1},horzLines:{visible:!1}},crosshair:{mode:_e?ht.Magnet:ht.Normal},kineticScroll:{touch:!1,mouse:!1},handleScroll:{pressedMouseMove:!0,horzTouchDrag:!0,vertTouchDrag:_e,mouseWheel:!0},handleScale:{mouseWheel:!0,pinch:!0,axisPressedMouseMove:!0,axisDoubleClickReset:!0},rightPriceScale:{borderColor:"#2b2b43",minimumWidth:Ye,entireTextOnly:!0},timeScale:{visible:!1,timeVisible:!0,secondsVisible:!1,borderVisible:!1,fixRightEdge:!1,rightBarStaysOnScroll:!1,rightOffset:hn,tickMarkFormatter:hr}}),n=e.addCandlestickSeries({upColor:"#26a69a",downColor:"#ef5350",borderVisible:!1,wickUpColor:"#26a69a",wickDownColor:"#ef5350",priceFormat:{type:"custom",minMove:.01,formatter:r=>Hl(Number(r))}}),i=e.addLineSeries({color:"rgba(0, 0, 0, 0)",lineVisible:!1,pointMarkersVisible:!1,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1});return{chart:e,series:n,timelineSeries:i}}function ec(t){const e=pi(t,{layout:{background:{color:"#0d1117"},textColor:"#c9d1d9",fontFamily:"'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",attributionLogo:!1},grid:{vertLines:{visible:!1},horzLines:{visible:!1}},crosshair:{mode:_e?ht.Magnet:ht.Normal},kineticScroll:{touch:!1,mouse:!1},handleScroll:{pressedMouseMove:!0,horzTouchDrag:!0,vertTouchDrag:_e,mouseWheel:!0},handleScale:{mouseWheel:!0,pinch:!0,axisPressedMouseMove:{time:!0,price:!1},axisDoubleClickReset:{time:!0,price:!1}},rightPriceScale:{borderColor:"#21262d",minimumWidth:Ye,entireTextOnly:!0,scaleMargins:{top:.2,bottom:.2}},timeScale:{visible:!1,timeVisible:!0,secondsVisible:!1,borderVisible:!1,fixRightEdge:!1,rightBarStaysOnScroll:!1,rightOffset:hn,tickMarkFormatter:hr}}),n=e.addLineSeries({color:D.lineColor,lineWidth:1,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1,priceFormat:{type:"custom",minMove:.1,formatter:r=>Qa(Number(r))},autoscaleInfoProvider:()=>Er()}),i=e.addLineSeries({color:"rgba(0, 0, 0, 0)",lineVisible:!1,pointMarkersVisible:!1,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1});return Zi=n.createPriceLine({price:Pa,color:D.midlineColor,lineWidth:1,lineStyle:Ys(D.midlineStyle),axisLabelVisible:!1,title:"Midline"}),e.subscribeClick(r=>{if(!(!r||!r.time)){if(pe){to(r.time,!1);return}Me&&Xl(r.time)}}),{chart:e,rsiSeries:n,timelineSeries:i}}function tc(t){const e=pi(t,{layout:{background:{color:"#0d1117"},textColor:"#c9d1d9",fontFamily:"'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",attributionLogo:!1},grid:{vertLines:{visible:!1},horzLines:{visible:!1}},crosshair:{mode:_e?ht.Magnet:ht.Normal},kineticScroll:{touch:!1,mouse:!1},handleScroll:{pressedMouseMove:!0,horzTouchDrag:!0,vertTouchDrag:_e,mouseWheel:!0},handleScale:{mouseWheel:!0,pinch:!0,axisPressedMouseMove:{time:!0,price:!0},axisDoubleClickReset:{time:!0,price:!0}},rightPriceScale:{borderColor:"#21262d",minimumWidth:Ye,entireTextOnly:!0},timeScale:{visible:!1,timeVisible:!0,secondsVisible:!1,borderVisible:!1,fixRightEdge:!1,rightBarStaysOnScroll:!1,rightOffset:hn,tickMarkFormatter:hr}}),n=e.addHistogramSeries({base:0,priceLineVisible:!1,lastValueVisible:!1,priceFormat:{type:"custom",minMove:1,formatter:r=>tl(Number(r))}}),i=e.addLineSeries({color:"rgba(0, 0, 0, 0)",lineVisible:!1,pointMarkersVisible:!1,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1});return n.createPriceLine({price:0,color:"#8b949e",lineWidth:1,lineStyle:2,axisLabelVisible:!1,title:""}),W=e,{chart:e,histogramSeries:n,timelineSeries:i}}function nc(t,e){if(!ee)return;Mr(),I=Rs(e?.rsi||[]).map(s=>({time:s.time,value:no(Number(s.value))})),yt=new Map;for(let s=0;s<I.length;s++)yt.set(N(I[s].time),s);const i=new Map;for(const s of I)i.set(N(s.time),Number(s.value));const r=t.map(s=>{const o=i.get(N(s.time));return Number.isFinite(o)?{time:s.time,value:Number(o)}:{time:s.time}});ee.setData(r),Ze=new Map;for(const s of t){const o=N(s.time),a=i.get(o);Number.isFinite(a)&&Ze.set(o,Number(a))}Si()}function ic(t){if(ao(),!(!Array.isArray(t)||t.length===0))for(const e of t){const n=e?.time1,i=e?.time2,r=Number(e?.value1),s=Number(e?.value2);typeof n!="string"&&typeof n!="number"||typeof i!="string"&&typeof i!="number"||!Number.isFinite(r)||!Number.isFinite(s)||co(n,r,i,s,!0)}}function rc(){if(!A)return;const t=il(A,ie);x?.restorePersistedTrendlines(t.rsi),ic(t.volumeDeltaRsi)}function sc(t,e){if(!Pe)return;const n=new Map;for(const r of e){const s=Number(r.delta);Number.isFinite(s)&&n.set(N(r.time),s)}const i=t.map(r=>{const s=n.get(N(r.time))??0,o=Number.isFinite(Number(s))?Number(s):0;return{time:r.time,value:o,color:o>=0?Es:Ms}});Pe.setData(i),pn=new Map(i.map(r=>[N(r.time),Number(r.value)||0])),qe()}function oc(t){if(V&&V.parentElement===t)return V.style.top="8px",V.style.transform="none",V.style.right=`${Ye+8}px`,V.style.display="flex",V.style.flexDirection="row",V.style.alignItems="center",V.style.gap=`${sn}px`,V.style.background="transparent",V.style.border="none",V.style.borderRadius="0",V.style.overflow="visible",V;const e=document.createElement("div");return e.className="volume-delta-divergence-summary",e.style.position="absolute",e.style.top="8px",e.style.transform="none",e.style.right=`${Ye+8}px`,e.style.zIndex="34",e.style.display="flex",e.style.flexDirection="row",e.style.alignItems="center",e.style.gap=`${sn}px`,e.style.background="transparent",e.style.border="none",e.style.borderRadius="0",e.style.overflow="visible",e.style.pointerEvents="auto",t.appendChild(e),V=e,e}function tr(){V&&(V.style.display="none",V.innerHTML="")}function Lr(t,e,n){if(!S.divergenceTable){tr();return}const i=oc(t);i.innerHTML="",i.style.display="flex",i.style.flexDirection="row",i.style.alignItems="center";const r=String(A||"").trim().toUpperCase(),s=S.sourceInterval,o=`${r}|${s}|${Date.now()}`;i.dataset.requestToken=o;let a=!1,l=null;const d=(f,p,h)=>{const m=document.createElement("div");return m.textContent=f,m.title=h,m.style.display="inline-flex",m.style.alignItems="center",m.style.justifyContent="center",m.style.width=`${U}px`,m.style.height=`${U}px`,m.style.padding="0",m.style.borderRadius="4px",m.style.border="1px solid #30363d",m.style.background="#161b22",m.style.fontSize="12px",m.style.fontWeight="600",m.style.lineHeight="1",m.style.fontFamily="'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",m.style.color=p,m.style.pointerEvents="none",m},c=()=>{a||(a=!0,u(l,!0),Dn(r,s,{forceRefresh:!0,noCache:!0}).then(f=>{i.dataset.requestToken===o&&String(A||"").trim().toUpperCase()===r&&(l=f||null,u(l,!1))}).catch(()=>{i.dataset.requestToken===o&&String(A||"").trim().toUpperCase()===r&&u(l,!1)}).finally(()=>{a=!1}))},u=(f,p=!1)=>{if(i.dataset.requestToken!==o||String(A||"").trim().toUpperCase()!==r)return;i.innerHTML="";const h=document.createElement("button");h.type="button",h.title=p?"Refreshing divergence table...":"Refresh divergence table",h.style.display="inline-flex",h.style.alignItems="center",h.style.justifyContent="center",h.style.width=`${U}px`,h.style.height=`${U}px`,h.style.padding="0",h.style.borderRadius="4px",h.style.border="none",h.style.background="transparent",h.style.color="#c9d1d9",h.style.cursor=p?"wait":"pointer",h.style.pointerEvents=p?"none":"auto",h.style.userSelect="none",h.style.flex="0 0 auto",h.style.verticalAlign="middle",h.setAttribute("aria-disabled",p?"true":"false"),h.disabled=!1;const m="http://www.w3.org/2000/svg",g=document.createElementNS(m,"svg");g.setAttribute("width","11"),g.setAttribute("height","11"),g.setAttribute("viewBox","0 0 24 24"),g.setAttribute("fill","none"),g.setAttribute("stroke","currentColor"),g.setAttribute("stroke-width","2.5"),g.setAttribute("stroke-linecap","round"),g.setAttribute("stroke-linejoin","round"),g.style.display="block";const w=document.createElementNS(m,"path");w.setAttribute("d","M21.5 2v6h-6");const y=document.createElementNS(m,"path");y.setAttribute("d","M21.5 8A10 10 0 0 0 5.6 5.6");const v=document.createElementNS(m,"path");v.setAttribute("d","M2.5 22v-6h6");const C=document.createElementNS(m,"path");C.setAttribute("d","M2.5 16A10 10 0 0 0 18.4 18.4"),g.appendChild(w),g.appendChild(y),g.appendChild(v),g.appendChild(C),p&&g.animate([{transform:"rotate(0deg)"},{transform:"rotate(360deg)"}],{duration:800,iterations:1/0,easing:"linear"}),h.appendChild(g),h.addEventListener("click",M=>{M.preventDefault(),M.stopPropagation(),c()}),i.appendChild(h);for(let M=0;M<de.length;M++){const H=de[M],ne=f?.states?.[String(H)]||"neutral",He=ne==="bullish"?"#26a69a":ne==="bearish"?"#ef5350":"#ffffff",It=d(String(H),He,`Last ${H} day${H===1?"":"s"}${f?.tradeDate?` (as of ${f.tradeDate})`:""}`);i.appendChild(It)}};u(null,!1),!(!r||!Array.isArray(e)||e.length<2)&&Dn(r,s).then(f=>{if(i.dataset.requestToken!==o)return;l=f||null,u(l,!1),(!f||!Number.isFinite(f.expiresAtMs)||f.expiresAtMs<=Date.now())&&Dn(r,s,{forceRefresh:!0,noCache:!0}).then(h=>{i.dataset.requestToken===o&&(l=h||null,u(l,!1))}).catch(()=>{})}).catch(()=>{Dn(r,s,{forceRefresh:!0,noCache:!0}).then(f=>{i.dataset.requestToken===o&&(l=f||null,u(l,!1))}).catch(()=>{u(l,!1)})})}const uo="#c9d1d9",ac="#484f58",lc="#ef5350";function cc(t){if(F&&F.parentElement===t)return F;F&&F.parentElement&&F.parentElement.removeChild(F);const e=document.createElement("button");return e.className="vdf-indicator-btn",e.type="button",e.title="Volume Divergence Flag Detector",e.textContent="VDF",e.style.position="absolute",e.style.top=`${gn}px`,e.style.right=`${Ye+8}px`,e.style.zIndex="34",e.style.width="auto",e.style.minWidth=`${U}px`,e.style.height=`${U}px`,e.style.padding="0 5px",e.style.borderRadius="4px",e.style.border="1px solid #30363d",e.style.background="#161b22",e.style.color=uo,e.style.cursor="default",e.style.pointerEvents="none",e.style.fontSize="9px",e.style.fontWeight="700",e.style.fontFamily="'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",e.style.letterSpacing="0.5px",e.style.lineHeight=`${U}px`,e.style.textAlign="center",e.style.userSelect="none",t.appendChild(e),F=e,e}function uc(t){if(Y&&Y.parentElement===t)return Y;Y&&Y.parentElement&&Y.parentElement.removeChild(Y);const e=document.createElement("button");return e.className="vdf-refresh-btn",e.type="button",e.title="Refresh VD Analysis",e.style.position="absolute",e.style.top=`${gn}px`,e.style.right=`${Ye+8+36+sn}px`,e.style.zIndex="34",e.style.display="inline-flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.width=`${U}px`,e.style.height=`${U}px`,e.style.padding="0",e.style.borderRadius="4px",e.style.border="none",e.style.background="transparent",e.style.color="#c9d1d9",e.style.cursor="pointer",e.style.userSelect="none",t.appendChild(e),Y=e,nr(!1),e}function nr(t){if(!Y)return;Y.innerHTML="",Y.title=t?"Refreshing VD Analysis...":"Refresh VD Analysis",Y.style.cursor=t?"wait":"pointer",Y.style.pointerEvents=t?"none":"auto";const e="http://www.w3.org/2000/svg",n=document.createElementNS(e,"svg");n.setAttribute("width","11"),n.setAttribute("height","11"),n.setAttribute("viewBox","0 0 24 24"),n.setAttribute("fill","none"),n.setAttribute("stroke","currentColor"),n.setAttribute("stroke-width","2.5"),n.setAttribute("stroke-linecap","round"),n.setAttribute("stroke-linejoin","round"),n.style.display="block";const i=document.createElementNS(e,"path");i.setAttribute("d","M21.5 2v6h-6");const r=document.createElementNS(e,"path");r.setAttribute("d","M21.5 8A10 10 0 0 0 5.6 5.6");const s=document.createElementNS(e,"path");s.setAttribute("d","M2.5 22v-6h6");const o=document.createElementNS(e,"path");o.setAttribute("d","M2.5 16A10 10 0 0 0 18.4 18.4"),n.appendChild(i),n.appendChild(r),n.appendChild(s),n.appendChild(o),t&&n.animate([{transform:"rotate(0deg)"},{transform:"rotate(360deg)"}],{duration:800,iterations:1/0,easing:"linear"}),Y.appendChild(n)}function Zr(t,e){F&&(F.style.color=t,e!==void 0&&(F.title=e))}function dc(t){if(!t.is_detected)return"VD Accumulation: Not detected";let n=`VD Accumulation Score: ${Math.round(t.composite_score*100)}`;const i=t.zones?.[0];if(i){const s=i.startDate.split("-"),o=i.endDate.split("-"),a=s.length>=3?`${Number(s[1])}/${Number(s[2])}`:i.startDate,l=o.length>=3?`${Number(o[1])}/${Number(o[2])}`:i.endDate;n+=`
Zone: ${a}→${l} (${i.windowDays}d)`,i.absorptionPct!=null&&(n+=`
Absorption: ${(i.absorptionPct*100).toFixed(1)}%`)}t.zones?.length>1&&(n+=`
+${t.zones.length-1} more zone(s)`),t.distribution?.length>0&&(n+=`
Distribution: ${t.distribution.length} cluster(s)`);const r=t.proximity;if(r&&r.level!=="none"){n+=`
Proximity: ${r.level.charAt(0).toUpperCase()+r.level.slice(1)} (${r.compositeScore} pts)`;for(const s of r.signals)n+=`
  ✓ ${s.detail} +${s.points}`}return n}function Yr(t){if(F){if(t.is_detected){const e=Math.round(t.composite_score*100);F.textContent=String(e),F.style.color=e>=80?"#26a69a":e>=60?"#8bc34a":"#c9d1d9";const n=t.proximity?.level||"none";n==="imminent"||n==="high"?F.style.borderColor="#ff9800":n==="elevated"?F.style.borderColor="#ffc107":F.style.borderColor="#30363d"}else F.textContent="VDF",F.style.color=ac,F.style.borderColor="#30363d";F.title=dc(t)}}function fc(t){if($&&$.parentElement===t)return $;$?.parentElement&&$.parentElement.removeChild($);const e=document.createElement("div");return e.className="vd-zone-overlay",e.style.position="absolute",e.style.top="0",e.style.right="0",e.style.bottom="0",e.style.left="0",e.style.pointerEvents="none",e.style.zIndex="5",t.appendChild(e),$=e,e}function cn(t){if(!$||($.innerHTML="",!T||!t))return;const e=$.clientWidth||$.offsetWidth,n=$.clientHeight||$.offsetHeight;if(!Number.isFinite(e)||e<=0)return;const i=new Map;for(const f of b){const p=Te(f?.time);if(p===null)continue;const h=new Date(p*1e3).toLocaleDateString("en-CA",{timeZone:"America/New_York",year:"numeric",month:"2-digit",day:"2-digit"});i.has(h)||i.set(h,p)}const r=f=>{const p=i.get(f);if(p===void 0)return null;const h=T.timeScale().timeToCoordinate(p);return Number.isFinite(h)?h:null},s=t.allZones&&t.allZones.length>0?t.allZones:t.zones;if(s)for(const f of s){const p=r(f.startDate),h=r(f.endDate);if(p==null||h==null)continue;const m=Math.min(p,h),g=Math.abs(h-p);if(m>e||m+g<0)continue;const w=.04+f.score*.08,y=document.createElement("div");y.style.cssText=`position:absolute;left:${Math.round(m)}px;top:0;width:${Math.max(Math.round(g),2)}px;height:100%;background:rgba(38,166,154,${w.toFixed(3)});border-left:1px solid rgba(38,166,154,0.3);border-right:1px solid rgba(38,166,154,0.3);`;const v=document.createElement("div");v.style.cssText="position:absolute;top:2px;right:2px;font-size:9px;color:rgba(38,166,154,0.8);font-family:monospace;",v.textContent=(f.score*100).toFixed(0),y.appendChild(v),$.appendChild(y)}if(t.distribution)for(const f of t.distribution){const p=r(f.startDate),h=r(f.endDate);if(p==null||h==null)continue;const m=Math.min(p,h),g=Math.abs(h-p);if(m>e||m+g<0)continue;const w=document.createElement("div");w.style.cssText=`position:absolute;left:${Math.round(m)}px;top:0;width:${Math.max(Math.round(g),2)}px;height:100%;background:rgba(239,83,80,0.06);border-left:1px solid rgba(239,83,80,0.3);border-right:1px solid rgba(239,83,80,0.3);`,$.appendChild(w)}const o=5,a=1,l=2,d=s&&s.length>0,c=t.distribution&&t.distribution.length>0;if(n>60&&(d||c)){const f=n-l-o,p=f-a-o,h=p-a-o;if(s)for(const m of s){const g=r(m.startDate),w=r(m.endDate);if(g==null||w==null)continue;const y=Math.min(g,w),v=Math.abs(w-g);if(y>e||y+v<0)continue;const C=(.4+m.score*.5).toFixed(2),M=document.createElement("div");M.style.cssText=`position:absolute;left:${Math.round(y)}px;top:${h}px;width:${Math.max(Math.round(v),2)}px;height:${o}px;background:rgba(38,166,154,${C});border-radius:1px;`,$.appendChild(M)}if(t.distribution)for(const m of t.distribution){const g=r(m.startDate),w=r(m.endDate);if(g==null||w==null)continue;const y=Math.min(g,w),v=Math.abs(w-g);if(y>e||y+v<0)continue;const C=document.createElement("div");C.style.cssText=`position:absolute;left:${Math.round(y)}px;top:${p}px;width:${Math.max(Math.round(v),2)}px;height:${o}px;background:rgba(239,83,80,0.65);border-radius:1px;`,$.appendChild(C)}if(s)for(const m of s){const g=m.absorptionPct||0;if(g<5)continue;const w=r(m.startDate),y=r(m.endDate);if(w==null||y==null)continue;const v=Math.min(w,y),C=Math.abs(y-w);if(v>e||v+C<0)continue;const M=Math.min(.3+g/100*.6,.9).toFixed(2),H=document.createElement("div");H.style.cssText=`position:absolute;left:${Math.round(v)}px;top:${f}px;width:${Math.max(Math.round(C),2)}px;height:${o}px;background:rgba(255,167,38,${M});border-radius:1px;`,$.appendChild(H)}}if(s)for(const f of s){const p=r(f.startDate),h=r(f.endDate);if(p!=null&&p>=0&&p<=e){const m=document.createElement("div");m.style.cssText=`position:absolute;left:${Math.round(p)}px;top:0;width:0;height:100%;border-left:1px dashed rgba(38,166,154,0.25);`,$.appendChild(m)}if(h!=null&&h>=0&&h<=e){const m=document.createElement("div");m.style.cssText=`position:absolute;left:${Math.round(h)}px;top:0;width:0;height:100%;border-left:1px dashed rgba(38,166,154,0.25);`,$.appendChild(m)}}if(t.distribution)for(const f of t.distribution){const p=r(f.startDate),h=r(f.endDate);if(p!=null&&p>=0&&p<=e){const m=document.createElement("div");m.style.cssText=`position:absolute;left:${Math.round(p)}px;top:0;width:0;height:100%;border-left:1px dashed rgba(239,83,80,0.2);`,$.appendChild(m)}if(h!=null&&h>=0&&h<=e){const m=document.createElement("div");m.style.cssText=`position:absolute;left:${Math.round(h)}px;top:0;width:0;height:100%;border-left:1px dashed rgba(239,83,80,0.2);`,$.appendChild(m)}}const u=t.proximity;if(u&&u.level!=="none"&&u.compositeScore>0){const f=u.level==="imminent"?"244,67,54":u.level==="high"?"255,152,0":"255,193,7",p=u.level==="imminent"?.4:u.level==="high"?.3:.2,h=document.createElement("div");h.style.cssText=`position:absolute;right:0;top:0;width:3px;height:100%;background:rgba(${f},${p});box-shadow:0 0 8px rgba(${f},${(p*1.5).toFixed(2)}),0 0 16px rgba(${f},${p});`,u.level==="imminent"&&(h.className="vdf-prox-pulse"),$.appendChild(h)}}function mc(){if(!$||!A)return;const t=new Date().toLocaleDateString("en-CA",{timeZone:"America/New_York",year:"numeric",month:"2-digit",day:"2-digit"}),e=Ue.get(`${A}|${t}`);cn(e||null)}async function fo(t,e=!1){if(!t||xn===t&&!e)return;const n=new Date().toLocaleDateString("en-CA",{timeZone:"America/New_York",year:"numeric",month:"2-digit",day:"2-digit"}),i=`${t}|${n}`;if(!e&&Ue.has(i)){const r=Ue.get(i);Yr(r),cn(r),ir(r);return}xn=t,Zr(uo,"VDF: Loading...");try{const r=new URLSearchParams({ticker:t,mode:"chart"});e&&r.set("force","1");const s=await fetch(`/api/chart/vdf-status?${r}`);if(!s.ok)throw new Error(`HTTP ${s.status}`);const o=await s.json();if(A!==t)return;const a={is_detected:o.is_detected||!1,composite_score:Number(o.composite_score)||0,status:o.status||"",weeks:Number(o.weeks)||0,zones:Array.isArray(o.zones)?o.zones:[],allZones:Array.isArray(o.allZones)?o.allZones:Array.isArray(o.zones)?o.zones:[],distribution:Array.isArray(o.distribution)?o.distribution:[],proximity:o.proximity||{compositeScore:0,level:"none",signals:[]},details:o.details||void 0};if(Ue.set(i,a),Ue.size>wa){const l=Ue.keys().next().value;l!==void 0&&Ue.delete(l)}Yr(a),cn(a),ir(a)}catch{A===t&&Zr(lc,"VDF: Failed to load")}finally{xn===t&&(xn=null)}}const At=[{key:"s8",label:"Divergence",defaultWeight:35,tooltip:"Overall price-down + delta-up divergence. The PRIMARY thesis signal. Score = 0 when price is rising or delta is negative."},{key:"s6",label:"Absorption",defaultWeight:25,tooltip:"Percentage of days where price fell but delta was positive. Day-by-day divergence confirmation: institutions buying the dip."},{key:"s1",label:"Net Delta",defaultWeight:15,tooltip:"Total net buying as % of total volume. Supporting signal: is there net buying?"},{key:"s2",label:"Delta Slope",defaultWeight:10,tooltip:"Trend of cumulative weekly delta. Supporting signal: is buying building over time?"},{key:"s3",label:"Delta Shift",defaultWeight:5,tooltip:"Is buying stronger now than before? Compares avg daily delta in the zone to the pre-context period."},{key:"s4",label:"Accum Ratio",defaultWeight:5,tooltip:"Fraction of weeks with positive delta. High ratio = persistent buying across multiple weeks."},{key:"s5",label:"Buy vs Sell",defaultWeight:3,tooltip:"Ratio of large buy days to large sell days. Detects if big-volume days lean bullish or bearish."},{key:"s7",label:"Vol Decline",defaultWeight:2,tooltip:"Volume declining from first-third to last-third of the zone. Supply drying up = fewer sellers remain."}],mo={};At.forEach(t=>{mo[t.key]=t.defaultWeight});let bn={...mo};function pc(){try{const t=localStorage.getItem("chart_vdf_weights");if(t){const e=JSON.parse(t);if(e&&typeof e=="object")for(const n of At)typeof e[n.key]=="number"&&(bn[n.key]=e[n.key])}}catch{}}function po(){return At.reduce((t,e)=>t+(bn[e.key]||0),0)}function ho(t){if(!t.components)return t.score;const e=po();if(e<=0)return 0;let n=0;for(const s of At){const o=t.components[s.key]||0;n+=o*((bn[s.key]||0)/e)}const i=t.concordancePenalty??1,r=t.durationMultiplier??1;return n*i*r}function hc(){const t=po();return At.map(e=>{const n=bn[e.key]||0,i=t>0?Math.round(n/t*100):0;return[e.key,e.label,`${i}%`]})}function Re(t){const e=t.split("-");return e.length<3?t:`${Number(e[1])}/${Number(e[2])}`}function gc(t){return t>=80?"Strong":t>=60?"Moderate":t>=40?"Weak":"Marginal"}function go(t){return t>=80?"#26a69a":t>=60?"#8bc34a":"#c9d1d9"}function yo(t){return t==="imminent"?"#f44336":t==="high"?"#ff9800":t==="elevated"?"#ffc107":"#8b949e"}function bo(){if(xe)return xe;const t=document.getElementById("chart-content");if(!t)return document.createElement("div");const e=document.createElement("div");return e.id="vdf-analysis-panel",e.style.cssText='width:100%;border-radius:6px;border:1px solid #30363d;background:#0d1117;color:#c9d1d9;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;font-size:13px;line-height:1.5;overflow:hidden;display:none;',t.appendChild(e),xe=e,e}function yc(){if(!xe)return;const t=xe.querySelector(".vdf-ap-body");if(!t)return;const e=t.style.display==="none";t.style.display=e?"block":"none";const n=xe.querySelector(".vdf-ap-chevron");n&&(n.textContent=e?"▾":"▸");try{localStorage.setItem("chart_vdf_panel_collapsed",e?"0":"1")}catch{}}function bc(t){return hc().map(([e,n,i])=>{const r=Number(t[e])||0,s=Math.max(0,Math.min(100,Math.round(r*100))),o=r>=.7?"#26a69a":r>=.4?"#8bc34a":"#484f58";return`<div style="display:grid;grid-template-columns:130px 1fr 36px;gap:6px;align-items:center;margin:2px 0;">
      <span style="color:#8b949e;font-size:11px;white-space:nowrap;">${Se(n)} (${i})</span>
      <div style="height:4px;background:#21262d;border-radius:2px;overflow:hidden;">
        <div style="height:100%;width:${s}%;background:${o};border-radius:2px;"></div>
      </div>
      <span style="color:#c9d1d9;font-size:11px;font-family:'SF Mono',Menlo,Monaco,Consolas,monospace;text-align:right;">${r.toFixed(2)}</span>
    </div>`}).join("")}function vc(t,e,n){const i=ho(t),r=Math.round(i*100),s=Math.round(t.score*100),o=!At.every(m=>bn[m.key]===m.defaultWeight),a=n?`Zone ${e+1} (Primary)`:`Zone ${e+1}`,l=go(r);let d="";const c=[];t.overallPriceChange!=null&&c.push(`Price: ${t.overallPriceChange>=0?"+":""}${t.overallPriceChange.toFixed(1)}%`),t.netDeltaPct!=null&&c.push(`Net Delta: ${t.netDeltaPct>=0?"+":""}${t.netDeltaPct.toFixed(1)}%`),t.absorptionPct!=null&&c.push(`Absorption: ${t.absorptionPct.toFixed(1)}%`),c.length&&(d=`<div style="margin:4px 0;color:#8b949e;font-size:12px;">${c.join(" &nbsp;|&nbsp; ")}</div>`);let u="";const f=[];t.accumWeeks!=null&&t.weeks&&f.push(`Accum weeks: ${t.accumWeeks}/${t.weeks} (${Math.round(t.accumWeeks/t.weeks*100)}%)`),t.durationMultiplier!=null&&f.push(`Duration: ${t.durationMultiplier.toFixed(3)}x`),t.concordancePenalty!=null&&t.concordancePenalty<1&&f.push(`Concordance: ${t.concordancePenalty.toFixed(3)}x`),f.length&&(u=`<div style="margin:2px 0;color:#8b949e;font-size:12px;">${f.join(" &nbsp;|&nbsp; ")}</div>`);let p="";t.components&&(p=`<div style="margin-top:8px;"><div style="color:#8b949e;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">Components</div>${bc(t.components)}</div>`);const h=o&&s!==r?`<span style="font-size:10px;color:#484f58;margin-left:4px;" title="Server score with default weights">(was ${s})</span>`:"";return`<div style="background:#161b22;border:1px solid #21262d;border-radius:4px;padding:12px;margin-bottom:8px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
      <span style="font-weight:600;font-size:13px;color:#c9d1d9;">${Se(a)}</span>
      <span><span style="font-family:'SF Mono',Menlo,Monaco,Consolas,monospace;font-size:13px;font-weight:700;color:${l};">${r}</span>${h}</span>
    </div>
    <div style="color:#c9d1d9;font-size:12px;">${Re(t.startDate)} → ${Re(t.endDate)} (${t.windowDays} trading days${t.weeks?`, ${t.weeks} wk`:""})</div>
    ${d}
    ${u}
    ${p}
  </div>`}function Sc(t,e){let n="";const i=[];return t.priceChangePct!=null&&i.push(`Price ${t.priceChangePct>=0?"+":""}${t.priceChangePct.toFixed(1)}%`),t.netDeltaPct!=null&&i.push(`Delta ${t.netDeltaPct>=0?"+":""}${t.netDeltaPct.toFixed(1)}%`),i.length&&(n=i.join(" while ")+" — selling into strength."),`<div style="background:rgba(239,83,80,0.06);border:1px solid rgba(239,83,80,0.2);border-radius:4px;padding:10px 12px;margin-bottom:8px;">
    <div style="font-weight:600;font-size:12px;color:#ef5350;margin-bottom:2px;">Cluster ${e+1}: ${Re(t.startDate)} → ${Re(t.endDate)} (${t.spanDays} days)</div>
    ${n?`<div style="color:#8b949e;font-size:12px;">${Se(n)}</div>`:""}
  </div>`}function Dc(t){if(t.level==="none"&&t.compositeScore===0)return"";const e=t.level.charAt(0).toUpperCase()+t.level.slice(1),n=yo(t.level),i=t.signals.map(r=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:2px 0;font-size:12px;">
      <span style="color:#c9d1d9;">✓ ${Se(r.detail)}</span>
      <span style="color:${n};font-family:'SF Mono',Menlo,Monaco,Consolas,monospace;font-weight:600;white-space:nowrap;margin-left:12px;">+${r.points}</span>
    </div>`).join("");return`<div style="margin-top:4px;">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
      <span style="font-family:'SF Mono',Menlo,Monaco,Consolas,monospace;font-size:13px;font-weight:700;color:${n};">${t.compositeScore} pts</span>
      <span style="font-size:11px;font-weight:600;color:${n};border:1px solid ${n};border-radius:3px;padding:0 5px;line-height:16px;">${e}</span>
    </div>
    ${i}
  </div>`}function ir(t){pc();const e=bo();if(!t){e.style.display="none",e.innerHTML="";return}const n=A||"",i=t.zones[0],r=i?Math.round(ho(i)*100):0,s=t.is_detected?r:Math.round(t.composite_score*100),o=gc(s),a=go(s),l=t.details?.metrics;let d=!0;try{d=localStorage.getItem("chart_vdf_panel_collapsed")!=="0"}catch{}t.is_detected&&!localStorage.getItem("chart_vdf_panel_collapsed")&&(d=!1);const c=d?"▸":"▾",u=d?"none":"block",f=`<div class="vdf-ap-header" style="display:flex;justify-content:space-between;align-items:center;padding:10px 14px;cursor:pointer;user-select:none;border-bottom:1px solid #21262d;">
    <div style="display:flex;align-items:center;gap:8px;">
      <span class="vdf-ap-chevron" style="font-size:12px;color:#8b949e;width:12px;">${c}</span>
      <span style="font-weight:600;color:#c9d1d9;">VD Analysis</span>
      <span style="color:#8b949e;font-family:'SF Mono',Menlo,Monaco,Consolas,monospace;font-size:12px;">${Se(n)}</span>
    </div>
    <div style="display:flex;align-items:center;">
      ${t.is_detected?`<span style="font-family:'SF Mono',Menlo,Monaco,Consolas,monospace;font-size:13px;font-weight:700;color:${a};">${s}</span>`:'<span style="font-size:11px;color:#484f58;">Not detected</span>'}
    </div>
  </div>`;let p="";if(t.is_detected){const m=t.zones.length;let g=`Volume-delta accumulation <span style="color:${a};font-weight:600;">${o}</span> (score: ${s}).`;g+=` ${m} accumulation zone${m!==1?"s":""} detected`,t.weeks&&(g+=` spanning up to ${t.weeks} weeks`),g+=".",l?.scanStart&&l?.scanEnd&&(g+=` Scan: ${Re(l.scanStart)} → ${Re(l.scanEnd)}`,l.totalDays&&(g+=` (${l.totalDays} trading days)`),g+="."),t.distribution.length>0&&(g+=` <span style="color:#ef5350;">${t.distribution.length} distribution cluster${t.distribution.length!==1?"s":""}</span> also found.`);const w=`<div style="margin-bottom:16px;font-size:13px;color:#c9d1d9;">${g}</div>`,y="display:inline-block;width:14px;height:5px;border-radius:1px;vertical-align:middle;margin-right:5px;",v="display:inline-block;width:14px;height:0;border-top:1px dashed;vertical-align:middle;margin-right:5px;",C="display:inline-block;width:3px;height:12px;border-radius:1px;vertical-align:middle;margin-right:5px;",M=[];M.push(`<span style="white-space:nowrap;"><span style="${y}background:rgba(38,166,154,0.7);"></span>Accumulation</span>`),t.distribution.length>0&&M.push(`<span style="white-space:nowrap;"><span style="${y}background:rgba(239,83,80,0.65);"></span>Distribution</span>`),t.zones.some(he=>(he.absorptionPct||0)>=5)&&M.push(`<span style="white-space:nowrap;"><span style="${y}background:rgba(255,167,38,0.7);"></span>Absorption</span>`),M.push(`<span style="white-space:nowrap;"><span style="${v}border-color:rgba(38,166,154,0.4);"></span>Zone bounds</span>`);const ne=t.proximity;if(ne&&ne.level!=="none"&&ne.compositeScore>0){const he=yo(ne.level);M.push(`<span style="white-space:nowrap;"><span style="${C}background:${he};box-shadow:0 0 4px ${he};"></span>Proximity</span>`)}const He=`<div style="display:flex;flex-wrap:wrap;gap:12px 16px;padding:8px 12px;background:#161b22;border:1px solid #21262d;border-radius:4px;margin-bottom:16px;font-size:11px;color:#8b949e;">${M.join("")}</div>`,It="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:#8b949e;margin:16px 0 8px;border-bottom:1px solid #21262d;padding-bottom:4px;";let Ni="";t.zones.length>0&&(Ni=`<div style="${It}">Accumulation Zones</div>`,Ni+=t.zones.map((he,vn)=>vc(he,vn,vn===0)).join(""));let Ii="";t.distribution.length>0&&(Ii=`<div style="${It}">Distribution Clusters</div>`,Ii+=t.distribution.map((he,vn)=>Sc(he,vn)).join(""));let Ri="";const ze=t.proximity;if(ze&&(ze.level!=="none"||ze.compositeScore>0)){const he=ze.level.charAt(0).toUpperCase()+ze.level.slice(1);Ri=`<div style="${It}">Proximity Signals (${ze.compositeScore} pts — ${he})</div>`,Ri+=Dc(ze)}p=`<div style="padding:14px;">${w}${He}${Ni}${Ii}${Ri}</div>`}else{let m="";l?.scanStart&&l?.scanEnd&&(m=` Scan: ${Re(l.scanStart)} → ${Re(l.scanEnd)}`,l.totalDays&&(m+=` (${l.totalDays} trading days)`),m+="."),p=`<div style="padding:14px;color:#8b949e;font-size:13px;">No accumulation patterns detected in the scan period.${m}</div>`}e.innerHTML=`${f}<div class="vdf-ap-body" style="display:${u};">${p}</div>`,e.style.display="block";const h=e.querySelector(".vdf-ap-header");h&&h.addEventListener("click",()=>{yc()})}function qe(){if(!X)return;if(!Array.isArray(b)||b.length===0){X.setData([]);return}if(!S.divergentPriceBars){X.setData(b);return}const t=S.bullishDivergentColor||ce.bullishDivergentColor,e=S.bearishDivergentColor||ce.bearishDivergentColor,i=String(S.neutralDivergentColor||"").trim().toLowerCase()==="#c9d1d9"?ce.neutralDivergentColor:S.neutralDivergentColor||ce.neutralDivergentColor,r=b.map((s,o)=>{const a=Number(s?.close),l=Number(b[o-1]?.close),d=Number(pn.get(N(s.time))),c=o>0&&Number.isFinite(a)&&Number.isFinite(l),u=Number.isFinite(d);let f=i;if(c&&u){const p=d>0&&a<l,h=d<0&&a>l;p?f=t:h&&(f=e)}return{...s,color:f}});X.setData(r)}function xc(t){return t.filter(e=>e&&(typeof e.time=="string"||typeof e.time=="number")&&Number.isFinite(Number(e.open))&&Number.isFinite(Number(e.high))&&Number.isFinite(Number(e.low))&&Number.isFinite(Number(e.close)))}function xi(t,e,n,i){if(!T)return;const r=t.getBoundingClientRect(),s=e.getBoundingClientRect(),o=n.getBoundingClientRect(),a=i.getBoundingClientRect(),l=Math.max(1,Math.floor(r.width)),d=Math.max(1,Math.floor(r.height)),c=Math.max(1,Math.floor(s.width)),u=Math.max(1,Math.floor(s.height)),f=Math.max(1,Math.floor(o.width)),p=Math.max(1,Math.floor(o.height)),h=Math.max(1,Math.floor(a.width)),m=Math.max(1,Math.floor(a.height));T.applyOptions({width:l,height:d}),L&&L.applyOptions({width:c,height:u}),x&&(x.getChart().applyOptions({width:f,height:p}),x.refreshTrendlineLabels()),W&&W.applyOptions({width:h,height:m}),Oe()}function Cc(t,e,n,i){Qe||(Qe=new ResizeObserver(()=>{xi(t,e,n,i)}),Qe.observe(t),Qe.observe(e),Qe.observe(n),Qe.observe(i))}function wc(t,e,n,i){const r=[t,e,n,i];for(const s of r){const o=on[s.id];o&&o>=mr&&o<=pr&&(s.style.height=`${o}px`)}}function kc(t,e,n,i){if(Vr)return;Vr=!0;const r=[t,e,n,i];for(const s of r){const o=document.createElement("div");o.className="pane-resize-handle",s.appendChild(o);let a=0,l=0;const d=u=>{const f=u.clientY-a,p=Math.min(pr,Math.max(mr,l+f));s.style.height=`${p}px`},c=u=>{o.classList.remove("active"),o.releasePointerCapture(u.pointerId),o.removeEventListener("pointermove",d),o.removeEventListener("pointerup",c);const f=s.getBoundingClientRect().height;on[s.id]=Math.round(f),R()};o.addEventListener("pointerdown",u=>{u.preventDefault(),u.stopPropagation(),a=u.clientY,l=s.getBoundingClientRect().height,o.classList.add("active"),o.setPointerCapture(u.pointerId),o.addEventListener("pointermove",d),o.addEventListener("pointerup",c)}),o.addEventListener("dblclick",u=>{u.preventDefault(),u.stopPropagation();const f=Wa[s.id];f&&(s.style.height=`${f}px`,delete on[s.id],R())})}}function Le(t){const e=t.querySelector(".chart-loading-overlay");e&&e.remove();const n=document.createElement("div");n.className="chart-loading-overlay",n.style.cssText=`
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(13, 17, 23, 0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    pointer-events: none;
  `;const i=document.createElement("div");i.innerHTML=`
    <svg width="40" height="40" viewBox="0 0 40 40" style="animation: spin 1s linear infinite;">
      <circle cx="20" cy="20" r="16" fill="none" stroke="#58a6ff" stroke-width="3"
              stroke-dasharray="80" stroke-dashoffset="60" stroke-linecap="round" opacity="0.8"/>
    </svg>
    <style>
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    </style>
  `,n.appendChild(i),t.appendChild(n)}function An(t,e){const n=t.querySelector(".chart-loading-overlay");n&&n.remove();const i=document.createElement("div");i.className="chart-loading-overlay",i.style.cssText=`
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(13, 17, 23, 0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    pointer-events: auto;
  `;const r=document.createElement("button");r.type="button",r.textContent="Try Refreshing",r.style.background="#161b22",r.style.color="#c9d1d9",r.style.border="1px solid #30363d",r.style.borderRadius="6px",r.style.padding="8px 12px",r.style.fontSize="12px",r.style.fontWeight="600",r.style.cursor="pointer",r.style.fontFamily="'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",r.addEventListener("click",s=>{s.preventDefault(),e()}),i.appendChild(r),t.appendChild(i)}function Ae(t){const e=t.querySelector(".chart-loading-overlay");e&&e.remove()}function Tc(t){const e=A;e&&(Rt!==null&&(window.clearTimeout(Rt),Rt=null),Rt=window.setTimeout(()=>{Rt=null,!(!A||A!==e)&&Ce(e,t)},Ta))}function Ec(){return!(document.visibilityState!=="visible"||document.getElementById("view-live")?.classList.contains("hidden")||document.getElementById("ticker-view")?.classList.contains("hidden"))}function Mc(t){if(!X||!x||!ee||!Pe||!Array.isArray(b)||b.length===0)return!1;const e=b.length-1,n=b[e],i=t.latestBar;if(!i||N(n?.time)!==N(i.time))return!1;const r=n.time,s=N(r);b[e]={...n,...i};const o=Number(b[e].close);if(Number.isFinite(o)&&nn.set(s,o),rn.set(s,e),e>0){const c=Number(b[e-1]?.close);if(Number.isFinite(c)&&c!==0&&Number.isFinite(o)){const u=(o-c)/c*100;Ke.set(s,u)}}const a=Number(t.latestRsi?.value);if(Number.isFinite(a)&&(Mt.set(s,Number(a)),!x.updateLatestPoint({time:r,value:Number(a)},Number.isFinite(o)?{time:r,close:o}:void 0)))return!1;const l=Number(t.latestVolumeDeltaRsi?.value);if(Number.isFinite(l)){const c=no(Number(l));Ze.set(s,c),I.length>0&&N(I[I.length-1].time)===s&&(I[I.length-1]={...I[I.length-1],value:c}),ee.update({time:r,value:c})}const d=Number(t.latestVolumeDelta?.delta);if(Number.isFinite(d)){const c=Number(d);pn.set(s,c),Pe.update({time:r,value:c,color:c>=0?Es:Ms})}return S.divergentPriceBars?qe():X.update(b[e]),ol(),P&&oe(P,null),tn&&Lr(tn,b),Si(),!0}async function Lc(t,e){const n=performance.now();let i=null;const r=await Ca(t,e,{vdRsiLength:D.length,vdSourceInterval:S.sourceInterval,vdRsiSourceInterval:D.sourceInterval,onResponseMeta:c=>{i=c.chartCacheHeader}});if(Vs(e,performance.now()-n,i),!A||A!==t||ie!==e||!Array.isArray(b)||b.length===0)return;const s=b[b.length-1]?.time,o=r.latestBar;if(s==null||!o){await Ce(t,e,{silent:!0});return}const a=N(s),l=N(o.time);if(a!==l){await Ce(t,e,{silent:!0});return}Mc(r)||await Ce(t,e,{silent:!0})}function Xr(t,e,n,i,r){const s=xc(t.bars||[]);if(s.length===0)throw new Error("No valid chart bars returned for this ticker/interval");Kn=Ga(s),Ns(s);const o=Is(s,E.length),a={rsi:Rs(t.volumeDeltaRsi?.rsi||[])},l=el(t.volumeDelta||[]);b=s,rn=new Map;for(let d=0;d<s.length;d++)rn.set(N(s[d].time),d);Bl(s),nn=new Map(s.map(d=>[N(d.time),Number(d.close)])),Mt=new Map(o.filter(d=>Number.isFinite(Number(d.value))).map(d=>[N(d.time),Number(d.value)])),X&&X.setData(s),oe(e,null),nc(s,a),sc(s,l),Lr(r,s),Tr(),!x&&i?(x=new q({container:i,data:o,displayMode:"line",lineColor:E.lineColor,midlineColor:E.midlineColor,midlineStyle:E.midlineStyle,priceData:s.map(d=>({time:d.time,close:d.close})),onTrendLineDrawn:()=>{x?.deactivateDivergenceTool(),fe=!1,te("rsi",!1),bi()}}),xi(e,n,i,r),vi()):x&&x.setData(o,s.map(d=>({time:d.time,close:d.close}))),kr(),rc(),$c(),Ie(),Ic(),vo(),Oe(),A&&fo(A)}function Ac(){Ut===null&&(Ut=window.setInterval(()=>{if(Bn||ve||!A||!Ec())return;const t=A,e=ie;Bn=!0,Lc(t,e).catch(()=>{}).finally(()=>{Bn=!1})},Ea))}function Nc(){return Qn}function Ar(){if(_n){try{_n.abort()}catch{}_n=null}}function Nr(){if(ve){try{ve.abort()}catch{}ve=null}Ar(),Ut!==null&&(window.clearInterval(Ut),Ut=null),Bn=!1,Qn=!1,Pn++}async function Ce(t,e=ie,n={}){const i=n.silent===!0;rl();const r=A,s=ie,o=++Pn,a=typeof r=="string"&&(r!==t||s!==e),l=e==="1week"&&(typeof r!="string"||a);ie=e,A=t;const d=gr(t,e);a&&(bt=!1,vt=!1,St=null,Dt=null,me=!1,pe=!1,Me=!1,fe=!1,xt("rsi"),xt("volumeDeltaRsi"),Xi=!1,De=!1,xe&&(xe.style.display="none",xe.innerHTML=""));const c=document.getElementById("chart-content");if(!c||!(c instanceof HTMLElement)){console.error("Chart content container not found");return}ml(c);const u=document.getElementById("price-chart-container"),f=document.getElementById("vd-rsi-chart-container"),p=document.getElementById("rsi-chart-container"),h=document.getElementById("vd-chart-container"),m=document.getElementById("chart-error");if(!u||!f||!p||!h||!m){console.error("Chart containers not found");return}if(P=u,tn=h,m.style.display="none",m.textContent="",Gr(u,null),Cn(u,"price"),Cn(f,"volumeDeltaRsi"),Cn(p,"rsi"),Cn(h,"volumeDelta"),fc(u),bo(),Pl(u,f,p,h),wr(),!T){const{chart:v,series:C,timelineSeries:M}=Ql(u);T=v,X=C,Gi=M,xr()}if(!L){const{chart:v,rsiSeries:C,timelineSeries:M}=ec(f);L=v,ee=C,Ki=M,Tr()}if(!W){const{chart:v,histogramSeries:C,timelineSeries:M}=tc(h);W=v,Pe=C,Yi=M}wc(u,f,p,h),Cc(u,f,p,h),kc(u,f,p,h),xi(u,f,p,h),vi();const g=i?null:br(d),w=!!g;if(g){const v=performance.now();Xr(g,u,f,p,h),zr(e,performance.now()-v),l&&Jr(),Ur(t,e)}else i||(Le(u),Le(f),Le(p),Le(h));if(Ar(),ve)try{ve.abort()}catch{}const y=new AbortController;ve=y,i||(Qn=!0);try{const v=performance.now();let C=null;const M=await ur(t,e,{vdRsiLength:D.length,vdSourceInterval:S.sourceInterval,vdRsiSourceInterval:D.sourceInterval,signal:y.signal,onResponseMeta:ne=>{C=ne.chartCacheHeader}});if(Vs(e,performance.now()-v,C),o!==Pn)return;if(!w||Hr(g)!==Hr(M)){const ne=performance.now();Xr(M,u,f,p,h),zr(e,performance.now()-ne),l&&Jr()}vr(d,M),Ur(t,e),i||(Ae(u),Ae(f),Ae(p),Ae(h))}catch(v){if(o!==Pn||v?.name==="AbortError"||(console.error("Failed to load chart:",v),i)||w)return;if(Ol(v)){Ae(u),Ae(f),Ae(p),Ae(h),X&&X.setData([]),Ke=new Map,oe(u,null),x&&x.setData([],[]),L&&ee?.setData([]),W&&Pe?.setData([]),Ns([]),Mr(),I=[],yt=new Map,Ze=new Map,pn=new Map,tr(),b=[],rn=new Map,Dr(),Kn=[],wn(Zn),wn(Yn),wn(Xn),wn(Jn),cn(null),ir(null),Gr(u,Ra),an(),ln(),m.style.display="none",m.textContent="";return}Ke=new Map,oe(u,null),tr(),an(),ln(),m.style.display="none",m.textContent="";const C=()=>{Le(u),Le(f),Le(p),Le(h),Ce(t,e)};An(u,C),An(f,C),An(p,C),An(h,C)}finally{i||(Qn=!1),ve===y&&(ve=null)}}function vo(){if(!T)return;const t=T.timeScale().getVisibleLogicalRange();if(t)try{L&&L.timeScale().setVisibleLogicalRange(t),x&&x.getChart().timeScale().setVisibleLogicalRange(t),W&&W.timeScale().setVisibleLogicalRange(t),Oe()}catch{}}function Ic(){if(!T)return;const t=hn;T.timeScale().applyOptions({rightOffset:t}),L&&L.timeScale().applyOptions({rightOffset:t}),x&&x.getChart().timeScale().applyOptions({rightOffset:t}),W&&W.timeScale().applyOptions({rightOffset:t}),Oe()}function Jr(){if(!T||ie!=="1week"||!Array.isArray(b)||b.length===0)return;const t=b.length-1,e=Math.min(b.length,78),n=Math.max(0,t-e+1),i=t+hn;try{T.timeScale().setVisibleLogicalRange({from:n,to:i}),vo(),Oe()}catch{}}function it(t,e){const n=Number(e.get(N(t)));if(Number.isFinite(n))return n;if(!Array.isArray(b)||b.length===0)return null;const i=Be(t);for(let r=b.length-1;r>=0;r--){const s=b[r];if(!s)continue;const o=s.time;if(i!==null){const l=Be(o);if(l!==null&&l>i)continue}const a=Number(e.get(N(o)));if(Number.isFinite(a))return a}return null}function Rc(){De=!De;const t={visible:!De},e={crosshair:{vertLine:t,horzLine:t}};T&&T.applyOptions(e),L&&L.applyOptions(e),W&&W.applyOptions(e),x&&x.getChart()?.applyOptions(e),De&&(T?.clearCrosshairPosition(),L?.clearCrosshairPosition(),W?.clearCrosshairPosition(),x?.getChart()?.clearCrosshairPosition())}function $c(){if(Xi||!T||!L||!x||!W||!X||!ee||!Pe)return;Xi=!0;const t=L,e=x.getChart(),n=W;let i=null;const r=c=>{requestAnimationFrame(()=>{i===c&&(i=null)})},s=(c,u)=>{if(!u)return;const f=[{owner:"price",chart:T},{owner:"volumeDeltaRsi",chart:t},{owner:"rsi",chart:e},{owner:"volumeDelta",chart:n}];for(const p of f){if(p.owner===c)continue;const h=p.chart.timeScale().getVisibleLogicalRange();Jl(h,u)||p.chart.timeScale().setVisibleLogicalRange(u)}Oe()};T.timeScale().subscribeVisibleLogicalRangeChange(c=>{if(!(!c||i==="volumeDeltaRsi"||i==="rsi"||i==="volumeDelta")){i="price";try{s("price",c)}finally{r("price")}}}),t.timeScale().subscribeVisibleLogicalRangeChange(c=>{if(!st&&!(!c||i==="price"||i==="rsi"||i==="volumeDelta")){i="volumeDeltaRsi";try{s("volumeDeltaRsi",c)}finally{r("volumeDeltaRsi")}}}),e.timeScale().subscribeVisibleLogicalRangeChange(c=>{if(!x?.isSyncSuppressed?.()&&!(!c||i==="price"||i==="volumeDeltaRsi"||i==="volumeDelta")){i="rsi";try{s("rsi",c)}finally{r("rsi")}}}),n.timeScale().subscribeVisibleLogicalRangeChange(c=>{if(!(!c||i==="price"||i==="volumeDeltaRsi"||i==="rsi")){i="volumeDelta";try{s("volumeDelta",c)}finally{r("volumeDelta")}}});const o=c=>{const u=it(c,nn);if(Number.isFinite(u)&&X)try{T.setCrosshairPosition(Number(u),c,X)}catch{T.clearCrosshairPosition()}else T.clearCrosshairPosition()},a=c=>{const u=it(c,Ze);if(Number.isFinite(u))try{t.setCrosshairPosition(Number(u),c,ee)}catch{t.clearCrosshairPosition()}else t.clearCrosshairPosition()},l=c=>{const u=it(c,Mt),f=x?.getSeries();if(Number.isFinite(u)&&f)try{e.setCrosshairPosition(Number(u),c,f)}catch{e.clearCrosshairPosition()}else e.clearCrosshairPosition()},d=c=>{const u=it(c,pn);if(Number.isFinite(u))try{n.setCrosshairPosition(Number(u),c,Pe)}catch{n.clearCrosshairPosition()}else n.clearCrosshairPosition()};if(T.subscribeCrosshairMove(c=>{if(!c||!c.time){t.clearCrosshairPosition(),e.clearCrosshairPosition(),n.clearCrosshairPosition(),P&&oe(P,null);return}De||(P&&oe(P,c.time),a(c.time),l(c.time),d(c.time))}),t.subscribeCrosshairMove(c=>{if(!c||!c.time){T.clearCrosshairPosition(),e.clearCrosshairPosition(),n.clearCrosshairPosition(),P&&oe(P,null);return}De||(pe&&to(c.time,!0),P&&oe(P,c.time),o(c.time),l(c.time),d(c.time))}),e.subscribeCrosshairMove(c=>{if(!c||!c.time){T.clearCrosshairPosition(),t.clearCrosshairPosition(),n.clearCrosshairPosition(),P&&oe(P,null);return}De||(me&&jr(c.time,!0),P&&oe(P,c.time),o(c.time),a(c.time),d(c.time))}),n.subscribeCrosshairMove(c=>{if(!c||!c.time){T.clearCrosshairPosition(),t.clearCrosshairPosition(),e.clearCrosshairPosition(),P&&oe(P,null);return}De||(P&&oe(P,c.time),o(c.time),a(c.time),l(c.time))}),e.subscribeClick(c=>{!c||!c.time||me&&jr(c.time,!1)}),_e){let c=0;const u=()=>{const f=Date.now();f-c<300?(Rc(),c=0):c=f};T.subscribeClick(u),t.subscribeClick(u),e.subscribeClick(u),n.subscribeClick(u)}}function Fc(){const t=document.getElementById("chart-controls");t&&(Ac(),t.querySelectorAll("button[data-interval]").forEach(e=>{e.addEventListener("click",n=>{const i=n.currentTarget,r=i.getAttribute("data-interval");r&&(t.querySelectorAll("button[data-interval]").forEach(s=>s.classList.remove("active")),i.classList.add("active"),A&&Tc(r))})}),t.querySelectorAll("button[data-mode]").forEach(e=>{e.addEventListener("click",n=>{const i=n.currentTarget,r=i.getAttribute("data-mode");r&&(t.querySelectorAll("button[data-mode]").forEach(s=>s.classList.remove("active")),i.classList.add("active"),x&&x.setDisplayMode(r))})}),Bc())}const Pc=`<svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
  <polyline points="5.5 1 1 1 1 5.5"/>
  <polyline points="10.5 1 15 1 15 5.5"/>
  <polyline points="10.5 15 15 15 15 10.5"/>
  <polyline points="5.5 15 1 15 1 10.5"/>
</svg>`,_c=`<svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
  <polyline points="1 5.5 5.5 5.5 5.5 1"/>
  <polyline points="15 5.5 10.5 5.5 10.5 1"/>
  <polyline points="15 10.5 10.5 10.5 10.5 15"/>
  <polyline points="1 10.5 5.5 10.5 5.5 15"/>
</svg>`;function Bc(){const t=document.getElementById("chart-fullscreen-btn"),e=document.getElementById("custom-chart-container"),n=document.getElementById("chart-nav-prev"),i=document.getElementById("chart-nav-next");if(!t||!e)return;n&&n.addEventListener("click",()=>rt(-1)),i&&i.addEventListener("click",()=>rt(1)),Vc();const r=()=>{const o=e.classList.contains("chart-fullscreen");t.innerHTML=o?_c:Pc,t.title=o?"Exit fullscreen (Space)":"Fullscreen (Space)",vi()},s=()=>{e.classList.toggle("chart-fullscreen"),r()};t.addEventListener("click",s),document.addEventListener("keydown",o=>{const a=document.getElementById("ticker-view");!a||a.classList.contains("hidden")||(o.key==="Escape"&&e.classList.contains("chart-fullscreen")&&(e.classList.remove("chart-fullscreen"),r()),o.code==="Space"&&document.activeElement?.tagName!=="INPUT"&&(o.preventDefault(),s()),o.key==="ArrowLeft"?rt(-1):o.key==="ArrowRight"&&rt(1))})}function rt(t){const e=Wo(),n=qo(),i=document.getElementById("ticker-view")?.dataset.ticker;if(!e||!i)return;let r="";n==="divergence"?r=e==="daily"?"divergence-daily-container":"divergence-weekly-container":r=e==="daily"?"daily-container":"weekly-container";const s=document.getElementById(r);if(!s)return;const o=Array.from(s.querySelectorAll(".alert-card")),a=o.findIndex(d=>d.dataset.ticker===i);if(a===-1)return;const l=a+t;if(l>=0&&l<o.length){const c=o[l].dataset.ticker;c&&window.showTickerView&&window.showTickerView(c,n,e)}}function Vc(){const t=document.getElementById("custom-chart-container");t&&t.addEventListener("dblclick",e=>{const n=t.getBoundingClientRect();if(!(e.clientX-n.left>n.width-60))return;const s=Lt(re),o=s[2],a=s[3],l=u=>{const f=document.getElementById(u);return!f||f.style.display==="none"?null:f.getBoundingClientRect()},d=l(o);if(d&&e.clientY>=d.top&&e.clientY<=d.bottom){rt(1);return}const c=l(a);if(c&&e.clientY>=c.top&&e.clientY<=c.bottom){rt(-1);return}})}function Qr(t){const e=Wo(),n=qo(),i=document.getElementById("ticker-view")?.dataset.ticker;if(!e||!i)return null;let r="";n==="divergence"?r=e==="daily"?"divergence-daily-container":"divergence-weekly-container":r=e==="daily"?"daily-container":"weekly-container";const s=document.getElementById(r);if(!s)return null;const o=Array.from(s.querySelectorAll(".alert-card")),a=o.findIndex(d=>d.dataset.ticker===i);if(a===-1)return null;const l=a+t;return l>=0&&l<o.length&&o[l].dataset.ticker||null}async function Oc(t,e){const n=Qr(1),i=Qr(-1),r=async s=>{if(e?.aborted)return;const o=gr(s,t);if(br(o)||We.has(o))return;const a=ur(s,t,{vdRsiLength:D.length,vdSourceInterval:S.sourceInterval,vdRsiSourceInterval:D.sourceInterval,signal:e}).then(l=>vr(o,l)).catch(()=>{}).finally(()=>We.delete(o));return We.set(o,a),a};n&&await r(n),i&&await r(i)}function Hc(t){return typeof t=="boolean"?t:typeof t=="string"?t.toLowerCase()==="true":typeof t=="number"?t===1:!1}function So(t){const e=t,n=Number(e.id);if(!Number.isFinite(n))throw new Error("Invalid divergence payload: missing/invalid id");return{...e,id:n,is_favorite:Hc(e.is_favorite),source:"DataAPI"}}async function zc(t=""){try{const e=new URLSearchParams(String(t||"").replace(/^\?/,""));e.set("vd_source_interval",mn());const n=await fetch(`/api/divergence/signals?${e.toString()}`);if(!n.ok)throw new Error("Network response was not ok");const i=await n.json();if(!Array.isArray(i))throw new Error("Invalid divergence payload: expected array");return i.map(So)}catch(e){throw console.error("Error fetching divergence signals:",e),e}}async function Uc(t){const e=await fetch(`/api/divergence/signals/${t}/favorite`,{method:"POST"});if(!e.ok)throw new Error("Network response was not ok");return So(await e.json())}async function Wc(){const t=await fetch("/api/divergence/fetch-daily/run",{method:"POST",headers:{"Content-Type":"application/json"}}),e=await t.json().catch(()=>({}));if(!t.ok){if(t.status===409&&String(e?.status||"")==="running")return{status:"running"};const n=typeof e?.error=="string"&&e.error.trim()?e.error.trim():`Failed to start fetch-daily run (HTTP ${t.status})`;throw new Error(n)}return{status:String(e?.status||"started")}}async function qc(){const t=await fetch("/api/divergence/fetch-daily/stop",{method:"POST",headers:{"Content-Type":"application/json"}}),e=await t.json().catch(()=>({}));if(!t.ok){if(t.status===409&&typeof e?.status=="string")return{status:e.status};const n=typeof e?.error=="string"&&e.error.trim()?e.error.trim():`Failed to stop fetch-daily run (HTTP ${t.status})`;throw new Error(n)}return{status:String(e?.status||"stop-requested")}}async function jc(){const t=await fetch("/api/divergence/fetch-weekly/run",{method:"POST",headers:{"Content-Type":"application/json"}}),e=await t.json().catch(()=>({}));if(!t.ok){if(t.status===409&&String(e?.status||"")==="running")return{status:"running"};const n=typeof e?.error=="string"&&e.error.trim()?e.error.trim():`Failed to start fetch-weekly run (HTTP ${t.status})`;throw new Error(n)}return{status:String(e?.status||"started")}}async function Gc(){const t=await fetch("/api/divergence/fetch-weekly/stop",{method:"POST",headers:{"Content-Type":"application/json"}}),e=await t.json().catch(()=>({}));if(!t.ok){if(t.status===409&&typeof e?.status=="string")return{status:e.status};const n=typeof e?.error=="string"&&e.error.trim()?e.error.trim():`Failed to stop fetch-weekly run (HTTP ${t.status})`;throw new Error(n)}return{status:String(e?.status||"stop-requested")}}async function Kc(){const t=await fetch("/api/divergence/vdf-scan/run",{method:"POST",headers:{"Content-Type":"application/json"}}),e=await t.json().catch(()=>({}));if(!t.ok){if(t.status===409&&String(e?.status||"")==="running")return{status:"running"};const n=typeof e?.error=="string"&&e.error.trim()?e.error.trim():`Failed to start VDF scan (HTTP ${t.status})`;throw new Error(n)}return{status:String(e?.status||"started")}}async function Zc(){const t=await fetch("/api/divergence/vdf-scan/stop",{method:"POST",headers:{"Content-Type":"application/json"}}),e=await t.json().catch(()=>({}));if(!t.ok){if(t.status===409&&typeof e?.status=="string")return{status:e.status};const n=typeof e?.error=="string"&&e.error.trim()?e.error.trim():`Failed to stop VDF scan (HTTP ${t.status})`;throw new Error(n)}return{status:String(e?.status||"stop-requested")}}async function Do(){const t=await fetch("/api/divergence/scan/status"),e=await t.json().catch(()=>null);if(!t.ok||!e){const n=typeof e?.error=="string"&&e.error.trim()?e.error.trim():"Failed to fetch divergence scan status";throw new Error(n)}return{running:!!e.running,lastScanDateEt:e.lastScanDateEt??null,scanControl:e.scanControl??null,tableBuild:e.tableBuild??null,fetchDailyData:e.fetchDailyData??null,fetchWeeklyData:e.fetchWeeklyData??null,vdfScan:e.vdfScan??null,latestJob:e.latestJob??null}}let Ci="1",wi="1",xo="",Co="",wo="",ko="",we="score",ke="score",$e="desc",Fe="desc";const Ee=100;let un=Ee,dn=Ee,Vn=null,Vi=!1,Nn=0;const es=3;let ot=-1,at=-1,ni=0;const Yc=8e3;let lt=!1,ct=!1,ut=!1,K=!1,Z=!1,qt=!1,Oi=-1,dt=null,On=null,je=null,jt=null,Vt=null,Hn=null;const ts=new Map;function ii(t){return t==="daily"?Ci:wi}function Xc(t,e,n){t==="daily"?(xo=e,Co=n):(wo=e,ko=n)}function Jc(t){return t==="daily"?{from:xo,to:Co}:{from:wo,to:ko}}function ft(t,e){const n=new Set;for(const s of t){const o=s.signal_trade_date||(s.timestamp?s.timestamp.slice(0,10):null);o&&n.add(o)}const i=[...n].sort((s,o)=>o.localeCompare(s)),r=new Set(i.slice(0,e));return t.filter(s=>{const o=s.signal_trade_date||(s.timestamp?s.timestamp.slice(0,10):null);return o?r.has(o):!1})}function rr(t,e){return e==="1"?ft(t,1):e==="2"?ft(t,2):e==="5"?ft(t,5):t}function To(){return{button:document.getElementById("divergence-run-btn"),status:document.getElementById("divergence-run-status")}}function Eo(){return{button:document.getElementById("divergence-run-table-btn"),status:document.getElementById("divergence-table-run-status")}}function Mo(){return{button:document.getElementById("divergence-fetch-daily-btn"),status:document.getElementById("divergence-fetch-daily-status")}}function Lo(){return{button:document.getElementById("divergence-fetch-weekly-btn"),status:document.getElementById("divergence-fetch-weekly-status")}}function Qc(){return{pauseResumeButton:document.getElementById("divergence-run-pause-resume-btn"),stopButton:document.getElementById("divergence-run-stop-btn")}}function eu(){return{pauseResumeButton:document.getElementById("divergence-table-pause-resume-btn"),stopButton:document.getElementById("divergence-table-stop-btn"),manualUpdateButton:document.getElementById("divergence-manual-update-btn")}}function tu(){return{stopButton:document.getElementById("divergence-fetch-daily-stop-btn")}}function nu(){return{stopButton:document.getElementById("divergence-fetch-weekly-stop-btn")}}function ri(t,e=!1){const{button:n}=To();n&&(n.disabled=t||e,n.classList.toggle("active",t),n.textContent=t?"Running":"Run Fetch")}function si(t){const{status:e}=To();e&&(e.textContent=t)}function oi(t,e=!1){const{button:n}=Eo();n&&(n.disabled=t||e,n.classList.toggle("active",t),n.textContent=t?"Running":"Run Table")}function ai(t){const{status:e}=Eo();e&&(e.textContent=t)}function Ct(t,e=!1){const{button:n}=Mo();n&&(n.disabled=t,n.classList.toggle("active",t),e&&!t?n.textContent="Resume Fetch":n.textContent="Fetch Daily")}function ge(t){const{status:e}=Mo();e&&(e.textContent=t)}function wt(t,e=!1){const{button:n}=Lo();n&&(n.disabled=t,n.classList.toggle("active",t),e&&!t?n.textContent="Resume Fetch":n.textContent="Fetch Weekly")}function ye(t){const{status:e}=Lo();e&&(e.textContent=t)}function Ao(){return{button:document.getElementById("divergence-vdf-scan-btn"),status:document.getElementById("divergence-vdf-scan-status")}}function iu(){return{stopButton:document.getElementById("divergence-vdf-scan-stop-btn")}}function kt(t){const{button:e}=Ao();e&&(e.disabled=t,e.classList.toggle("active",t),e.textContent="VDF Scan")}function Ge(t){const{status:e}=Ao();e&&(e.textContent=t)}function li(t){const{stopButton:e}=iu(),n=t?.vdfScan||null,i=!!n?.running,r=!!n?.stop_requested;e&&(e.textContent="⏹",e.disabled=!i||r,e.classList.toggle("active",i),e.setAttribute("aria-label","Stop VDF Scan"),e.title="Stop VDF Scan")}function ci(t){const{pauseResumeButton:e,stopButton:n}=Qc(),i=t?.scanControl||null,r=!!(i?.running||t?.running),s=!!i?.pause_requested,o=!!i?.can_resume,a=!!i?.stop_requested;e&&(e.textContent=o&&!r?"▶":"⏸",e.disabled=r?s:!o,e.classList.toggle("active",r||o),e.setAttribute("aria-label",o&&!r?"Resume Run Fetch":"Pause Run Fetch"),e.title=o&&!r?"Resume Run Fetch":"Pause Run Fetch"),n&&(n.textContent="⏹",n.disabled=!r||a,n.classList.toggle("active",r),n.setAttribute("aria-label","Stop Run Fetch"),n.title="Stop Run Fetch")}function ui(t){const{pauseResumeButton:e,stopButton:n,manualUpdateButton:i}=eu(),r=t?.tableBuild||null,s=!!r?.running,o=!!r?.pause_requested,a=!!r?.stop_requested,l=!!r?.can_resume;e&&(e.textContent=l&&!s?"▶":"⏸",e.disabled=s?o:!l,e.classList.toggle("active",s||l),e.setAttribute("aria-label",l&&!s?"Resume Run Table":"Pause Run Table"),e.title=l&&!s?"Resume Run Table":"Pause Run Table"),n&&(n.textContent="⏹",n.disabled=!s||a,n.classList.toggle("active",s),n.setAttribute("aria-label","Stop Run Table"),n.title="Stop Run Table"),i&&(i.disabled=!1)}function di(t){const{stopButton:e}=tu(),n=t?.fetchDailyData||null,i=!!n?.running,r=!!n?.stop_requested;e&&(e.textContent="⏹",e.disabled=!i||r,e.classList.toggle("active",i),e.setAttribute("aria-label","Stop Fetch Daily"),e.title="Stop Fetch Daily")}function fi(t){const{stopButton:e}=nu(),n=t?.fetchWeeklyData||null,i=!!n?.running,r=!!n?.stop_requested;e&&(e.textContent="⏹",e.disabled=!i||r,e.classList.toggle("active",i),e.setAttribute("aria-label","Stop Fetch Weekly"),e.title="Stop Fetch Weekly")}function Q(t){const e=String(t?.message||t||"").trim();return e?/not configured/i.test(e)?"DB not configured":/unauthorized/i.test(e)?"Unauthorized":/already running|running/i.test(e)?"Already running":e.length>56?`${e.slice(0,56)}...`:e:"Run failed"}function B(t){const e=String(t||"").trim();if(!e)return null;const n=e.match(/^(\d{4})-(\d{2})-(\d{2})/);return n?`${n[1]}-${n[2]}-${n[3]}`:null}function ru(t){const e=String(t||"").trim();if(!e)return null;const n=new Date(e);if(isNaN(n.getTime()))return null;const i=n.toLocaleDateString("en-US",{timeZone:"America/New_York",year:"numeric",month:"2-digit",day:"2-digit"}),[r,s,o]=i.split("/");return!r||!s||!o?null:`${o}-${r.padStart(2,"0")}-${s.padStart(2,"0")}`}function Tt(t){const e=t.split("-");if(e.length!==3)return"";const n=Number(e[1]),i=Number(e[2]);return!Number.isFinite(n)||n<=0||!Number.isFinite(i)||i<=0?"":`${n}/${i}`}function ns(t){const e=t.latestJob,n=B(t.lastScanDateEt)||B(e?.scanned_trade_date)||B(e?.run_for_date)||B(e?.finished_at)||B(e?.started_at);if(!n)return"Fetched";const i=Tt(n);return i?`Fetched ${i}`:"Fetched"}function No(t){const e=t.latestJob,n=t.scanControl||null;if(t.running){const i=Number(e?.processed_symbols||0),r=Number(e?.total_symbols||0);return n?.stop_requested?r>0?`Stopping ${i}/${r}`:"Stopping":n?.pause_requested?r>0?`Pausing ${i}/${r}`:"Pausing":r>0?`Running ${i}/${r}`:"Running"}if(e?.status==="paused"){const i=Number(e?.processed_symbols||0),r=Number(e?.total_symbols||0);return r>0?`Paused ${i}/${r}`:"Paused"}return e?.status==="stopped"?"Stopped":e?.status==="completed"?ns(t):e?.status==="failed"?"Last run failed":t.lastScanDateEt||e?.run_for_date||e?.finished_at||e?.started_at?ns(t):"Idle"}function Io(t){const e=t.tableBuild;if(!e)return"Table idle";const n=String(e.status||"").toLowerCase(),i=Number(e.error_tickers||0);if(n==="stopped")return"Table stopped";if(n==="paused"){const r=Number(e.processed_tickers||0),s=Number(e.total_tickers||0);return s>0?`Paused ${r}/${s}`:"Table paused"}if(e.running){const r=Number(e.processed_tickers||0),s=Number(e.total_tickers||0);return e.stop_requested?s>0?`Stopping ${r}/${s}`:"Stopping":e.pause_requested?s>0?`Pausing ${r}/${s}`:"Pausing":s>0?`Table ${r}/${s}`:"Table running"}if(n==="completed"){const r=B(e.last_published_trade_date||null),s=r?Tt(r):"";return s?`Table ${s}`:"Table fetched"}if(n==="completed-with-errors"){const r=B(e.last_published_trade_date||null),s=r?Tt(r):"";return s&&i>0?`Table ${s} (${i} errors)`:i>0?`Table done (${i} errors)`:s?`Table ${s}`:"Table fetched"}return n==="failed"?"Table failed":"Table idle"}function Ro(t){const e=t.fetchDailyData,n=t.latestJob,i=B(e?.last_published_trade_date||null)||B(t.lastScanDateEt)||B(n?.scanned_trade_date)||B(n?.run_for_date)||B(n?.finished_at)||B(n?.started_at),r=i?Tt(i):"",s=r?`Fetched ${r}`:"Fetched --";if(!e)return s;const o=String(e.status||"").toLowerCase();if(o==="stopping")return"Stopping";if(o==="stopped"){if(e.can_resume){const a=Number(e.processed_tickers||0),l=Number(e.total_tickers||0);return l>0?`Stopped ${a}/${l} (resumable)`:"Stopped (resumable)"}return"Stopped"}if(e.running){const a=Number(e.processed_tickers||0),l=Number(e.total_tickers||0),d=Number(e.error_tickers||0);return e.stop_requested?"Stopping":o==="running-retry"?`Retrying ${d} failed (${a}/${l})`:o==="running-ma"?`MA ${a}/${l}`:o==="running-ma-retry"?`Retrying failed MA (${a}/${l})`:`${a} / ${l}`}return s}function $o(t){const e=t.fetchWeeklyData,n=t.latestJob,i=B(e?.last_published_trade_date||null)||B(t.lastScanDateEt)||B(n?.scanned_trade_date)||B(n?.run_for_date)||B(n?.finished_at)||B(n?.started_at),r=i?Tt(i):"",s=r?`Fetched ${r}`:"Fetched --";if(!e)return s;const o=String(e.status||"").toLowerCase();if(o==="stopping")return"Stopping";if(o==="stopped"){if(e.can_resume){const a=Number(e.processed_tickers||0),l=Number(e.total_tickers||0);return l>0?`Stopped ${a}/${l} (resumable)`:"Stopped (resumable)"}return"Stopped"}if(e.running){const a=Number(e.processed_tickers||0),l=Number(e.total_tickers||0),d=Number(e.error_tickers||0);return e.stop_requested?"Stopping":o==="running-retry"?`Retrying ${d} failed (${a}/${l})`:o==="running-ma"?`MA ${a}/${l}`:o==="running-ma-retry"?`Retrying failed MA (${a}/${l})`:`${a} / ${l}`}return s}function Fo(t){const e=t.vdfScan;if(!e)return"Ran --";const n=String(e.status||"").toLowerCase(),i=ru(e.finished_at||e.started_at||null),r=i?Tt(i):"",s=r?`Ran ${r}`:"Ran --";if(n==="stopping")return"Stopping";if(n==="stopped")return"Stopped";if(e.running){const o=Number(e.processed_tickers||0),a=Number(e.total_tickers||0),l=Number(e.detected_tickers||0);return e.stop_requested?"Stopping":n==="running-retry"?`Retrying (${o}/${a})`:`${o}/${a} (${l} VDF)`}if(n==="completed"||n==="completed-with-errors"){const o=Number(e.detected_tickers||0);return o>0?`${s} (${o} VDF)`:s}return s}function mi(){Vn!==null&&(window.clearInterval(Vn),Vn=null)}function Gt(t=!1,e){if(Nc())return;const n=Date.now();!t&&n-ni<Yc||(ni=n,e?Et(e).then(()=>Ve(e)).catch(()=>{}):Ei().then(Mi).catch(()=>{}))}async function ki(t){if(!Vi){Vi=!0;try{const e=await Do();Nn=0,lt=!!e.tableBuild?.running,ct=!!e.fetchDailyData?.running,ut=!!e.fetchWeeklyData?.running,ri(e.running,!!e.scanControl?.can_resume),si(No(e)),ci(e);const n=lt;oi(n,!!e.tableBuild?.can_resume),ai(Io(e)),ui(e);const i=ct,r=!!e.fetchDailyData?.can_resume;Ct(i,r),ge(Ro(e)),di(e);const s=ut,o=!!e.fetchWeeklyData?.can_resume;wt(s,o),ye($o(e)),fi(e);const a=!!e.vdfScan?.running;if(kt(a),Ge(Fo(e)),li(e),i?(K=!0,Z=!1):s&&(Z=!0,K=!1),i&&K){const l=Number(e.fetchDailyData?.processed_tickers||0),d=l!==ot;ot=l,Gt(d,"1d")}else ot=-1;if(s&&Z){const l=Number(e.fetchWeeklyData?.processed_tickers||0),d=l!==at;at=l,Gt(d,"1w")}else at=-1;if(a&&qt){const l=Number(e.vdfScan?.processed_tickers||0),d=l!==Oi;Oi=l,d&&Gt(!0)}else Oi=-1;!i&&!s&&!a&&(ni=0),!e.running&&!n&&!i&&!s&&!a&&(mi(),t&&(K&&(await Et("1d"),Ve("1d")),Z&&(await Et("1w"),Ve("1w")),qt&&(await Ei(),Mi())),K=!1,Z=!1,qt=!1)}catch(e){Nn+=1,Nn<es?console.warn(`Scan status poll failed (${Nn}/${es}), retrying next cycle`):(console.error("Failed to poll divergence scan status:",e),lt=!1,ct=!1,ut=!1,si(Q(e)),ai(Q(e)),ge(Q(e)),ye(Q(e)),mi(),ri(!1,!1),ci(null),oi(!1,!1),ui(null),Ct(!1,!1),di(null),wt(!1,!1),fi(null),kt(!1),li(null),K=!1,Z=!1)}finally{Vi=!1}}}function Ti(t){mi(),Vn=window.setInterval(()=>{ki(t)},2500)}async function Nt(){try{const t=await Do();lt=!!t.tableBuild?.running,ct=!!t.fetchDailyData?.running,ut=!!t.fetchWeeklyData?.running,ri(t.running,!!t.scanControl?.can_resume),si(No(t)),ci(t);const e=lt;oi(e,!!t.tableBuild?.can_resume),ai(Io(t)),ui(t);const n=ct,i=!!t.fetchDailyData?.can_resume;Ct(n,i),ge(Ro(t)),di(t);const r=ut,s=!!t.fetchWeeklyData?.can_resume;wt(r,s),ye($o(t)),fi(t);const o=!!t.vdfScan?.running;if(kt(o),Ge(Fo(t)),li(t),n?(K=!0,Z=!1):r&&(Z=!0,K=!1),n&&K){const a=Number(t.fetchDailyData?.processed_tickers||0),l=a!==ot;ot=a,Gt(l,"1d")}else ot=-1;if(r&&Z){const a=Number(t.fetchWeeklyData?.processed_tickers||0),l=a!==at;at=a,Gt(l,"1w")}else at=-1;!n&&!r&&(ni=0),t.running||e||n||r||o?Ti(!0):(mi(),K=!1,Z=!1)}catch(t){console.error("Failed to sync divergence scan UI state:",t),lt=!1,ct=!1,ut=!1,ri(!1,!1),ci(null),si(Q(t)),oi(!1,!1),ai(Q(t)),ui(null),Ct(!1,!1),ge(Q(t)),di(null),wt(!1,!1),ye(Q(t)),fi(null),kt(!1),li(null),K=!1,Z=!1}}async function su(){Ct(!0),ge("Starting..."),K=!0,Z=!1;try{const t=await Wc();t.status==="running"?ge("Already running"):t.status==="resumed"&&ge("Resuming..."),Ti(!0),await ki(!1)}catch(t){console.error("Failed to start fetch-daily run:",t),Ct(!1),ge(Q(t))}}async function ou(){wt(!0),ye("Starting..."),Z=!0,K=!1;try{const t=await jc();t.status==="running"?ye("Already running"):t.status==="resumed"&&ye("Resuming..."),Ti(!0),await ki(!1)}catch(t){console.error("Failed to start fetch-weekly run:",t),wt(!1),ye(Q(t))}}async function au(){try{(await qc()).status==="stop-requested"&&ge("Stopping"),K=!1,await Nt()}catch(t){console.error("Failed to stop fetch-daily run:",t),ge(Q(t))}}async function lu(){try{(await Gc()).status==="stop-requested"&&ye("Stopping"),Z=!1,await Nt()}catch(t){console.error("Failed to stop fetch-weekly run:",t),ye(Q(t))}}async function cu(){kt(!0),Ge("Starting..."),qt=!0,K=!1,Z=!1;try{(await Kc()).status==="running"&&Ge("Already running"),Ti(!0),await ki(!1)}catch(t){console.error("Failed to start VDF scan:",t),kt(!1),Ge(Q(t))}}async function uu(){try{(await Zc()).status==="stop-requested"&&Ge("Stopping"),qt=!1,await Nt()}catch(t){console.error("Failed to stop VDF scan:",t),Ge(Q(t))}}async function Ei(t){try{const[e,n]=await Promise.all([Et("1d"),Et("1w")]),i=[...e,...n];return yi(i),i}catch(e){return console.error("Error fetching divergence signals:",e),[]}}function sr(t,e,n){if(t>=e)return"";const i=e-t,r=Math.min(i,Ee);return`<button class="tf-btn show-more-btn" data-timeframe="${n}">▼ Show ${r} more (${t}/${e})</button>`}function Mi(){const t=hi();yi(t),un=Ee,dn=Ee;const e=document.getElementById("divergence-daily-container"),n=document.getElementById("divergence-weekly-container");if(!e||!n)return;let i=t.filter(a=>(a.timeframe||"").trim()==="1d"),r=t.filter(a=>(a.timeframe||"").trim()==="1w");i=rr(i,Ci),r=rr(r,wi),we==="favorite"&&(i=i.filter(a=>a.is_favorite)),ke==="favorite"&&(r=r.filter(a=>a.is_favorite)),i.sort(Qt(we==="favorite"?"time":we,$e)),r.sort(Qt(ke==="favorite"?"time":ke,Fe));const s=i.slice(0,un),o=r.slice(0,dn);e.innerHTML=s.map(en).join("")+sr(s.length,i.length,"1d"),n.innerHTML=o.map(en).join("")+sr(o.length,r.length,"1w"),Jt(e),Jt(n)}async function Et(t){try{const e=t==="1d"?"daily":"weekly",n=ii(e),i=Jc(e),{startDate:r,endDate:s}=va(n,i.from,i.to);if(!r||!s)return[];const o=`?start_date=${r}&end_date=${s}&timeframe=${t}`,a=await zc(o);return yi(a),Xo(t,a),a}catch(e){return console.error(`Error fetching divergence signals for ${t}:`,e),[]}}function Ve(t){const e=hi(),n=t==="1d"?"divergence-daily-container":"divergence-weekly-container",i=document.getElementById(n);if(!i)return;const s=ii(t==="1d"?"daily":"weekly"),o=t==="1d"?we:ke,a=t==="1d"?$e:Fe;let l=e.filter(u=>(u.timeframe||"").trim()===t);l=rr(l,s),o==="favorite"&&(l=l.filter(u=>u.is_favorite)),l.sort(Qt(o==="favorite"?"time":o,a));const d=t==="1d"?un:dn,c=l.slice(0,d);i.innerHTML=c.map(en).join("")+sr(c.length,l.length,t),Jt(i)}function zn(){if(je!==null&&(window.clearTimeout(je),je=null),jt){try{jt.abort()}catch{}jt=null}if(On){try{On.remove()}catch{}On=null}dt&&(dt.remove(),dt=null),Vt=null,Hn=null}async function du(t,e){if(Vt===t&&dt)return;zn(),Vt=t;const n=document.createElement("div");n.className="mini-chart-overlay",n.style.cssText=`
        position: fixed;
        width: 500px;
        height: 300px;
        background: #0d1117;
        border: 1px solid #30363d;
        border-radius: 6px;
        z-index: 1000;
        pointer-events: none;
        overflow: hidden;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    `;const i=500,r=300,s=8;let o=e.right+s,a=e.top;o+i>window.innerWidth&&(o=e.left-i-s),o<0&&(o=s),a+r>window.innerHeight&&(a=window.innerHeight-r-s),a<0&&(a=s),n.style.left=`${o}px`,n.style.top=`${a}px`,document.body.appendChild(n),dt=n;let l;const d=ts.get(t);if(d)l=d;else{const f=new AbortController;jt=f;try{const p=await fetch(`/api/chart/mini-bars?ticker=${encodeURIComponent(t)}`,{signal:f.signal});if(!p.ok)throw new Error(`HTTP ${p.status}`);const h=await p.json();l=Array.isArray(h?.bars)?h.bars:[],l.length>0&&ts.set(t,l)}catch{Vt===t&&zn();return}jt=null}if(Vt!==t||!dt)return;if(l.length===0){zn();return}const c=pi(n,{width:500,height:300,layout:{background:{color:"#0d1117"},textColor:"#d1d4dc",fontFamily:"'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace",attributionLogo:!1},grid:{vertLines:{visible:!1},horzLines:{visible:!1}},rightPriceScale:{visible:!1},timeScale:{visible:!1},handleScroll:!1,handleScale:!1,crosshair:{vertLine:{visible:!1},horzLine:{visible:!1}}});On=c,c.addCandlestickSeries({upColor:"#26a69a",downColor:"#ef5350",borderVisible:!1,wickUpColor:"#26a69a",wickDownColor:"#ef5350",priceLineVisible:!1,lastValueVisible:!1}).setData(l),c.timeScale().fitContent()}function is(t){const n=t.target.closest(".fav-icon");if(!n)return;t.stopPropagation();const i=n.dataset.id,r="DataAPI";if(!i)return;const s=document.querySelectorAll(`.fav-icon[data-id="${i}"][data-source="${r}"]`),o=n.classList.contains("filled");s.forEach(a=>{const l=a.querySelector(".check-mark");o?(a.classList.remove("filled"),l&&(l.style.visibility="hidden",l.style.opacity="0")):(a.classList.add("filled"),l&&(l.style.visibility="visible",l.style.opacity="1"))}),Uc(Number(i)).then(a=>{const l=hi(),d=l.findIndex(c=>c.id===a.id);d!==-1&&(l[d].is_favorite=a.is_favorite,Yo(l)),s.forEach(c=>{const u=c.querySelector(".check-mark");a.is_favorite?(c.classList.add("filled"),u&&(u.style.visibility="visible",u.style.opacity="1")):(c.classList.remove("filled"),u&&(u.style.visibility="hidden",u.style.opacity="0"))})}).catch(()=>{s.forEach(a=>{const l=a.querySelector(".check-mark");o?(a.classList.add("filled"),l&&(l.style.visibility="visible",l.style.opacity="1")):(a.classList.remove("filled"),l&&(l.style.visibility="hidden",l.style.opacity="0"))})})}function fu(){const t=document.getElementById("view-divergence");if(!t)return;t.addEventListener("click",is);const e=document.getElementById("ticker-view");e&&e.addEventListener("click",is),t.addEventListener("click",n=>{const i=n.target;if(i.closest(".fav-icon"))return;const r=i.closest(".alert-card");if(r){const s=r.dataset.ticker;if(s&&window.showTickerView){let o=null;r.closest("#divergence-daily-container")?o="daily":r.closest("#divergence-weekly-container")&&(o="weekly"),window.showTickerView(s,"divergence",o)}}}),document.querySelectorAll("#view-divergence .divergence-daily-sort .tf-btn").forEach(n=>{n.addEventListener("click",()=>{const i=n.dataset.sort;mu(i)})}),document.querySelectorAll("#view-divergence .divergence-weekly-sort .tf-btn").forEach(n=>{n.addEventListener("click",()=>{const i=n.dataset.sort;pu(i)})}),t.addEventListener("mouseenter",n=>{const s=n.target.closest(".alert-card");if(!s)return;const o=s.dataset.ticker;o&&Hn!==s&&(Hn=s,je!==null&&window.clearTimeout(je),je=window.setTimeout(()=>{je=null;const a=s.getBoundingClientRect();du(o,a)},1e3))},!0),t.addEventListener("mouseleave",n=>{const i=n,s=i.target.closest(".alert-card");if(!s)return;const o=i.relatedTarget;o&&s.contains(o)||(Hn=null,zn())},!0),t.addEventListener("click",n=>{const i=n.target.closest(".show-more-btn");if(!i)return;const r=i.dataset.timeframe;r&&(r==="1d"?(un+=Ee,Ve("1d")):(dn+=Ee,Ve("1w")))})}function mu(t){t===we&&t!=="favorite"?$e=$e==="desc"?"asc":"desc":(we=t,$e="desc"),un=Ee,gt("#view-divergence .divergence-daily-sort",we,$e),Ve("1d")}function pu(t){t===ke&&t!=="favorite"?Fe=Fe==="desc"?"asc":"desc":(ke=t,Fe="desc"),dn=Ee,gt("#view-divergence .divergence-weekly-sort",ke,Fe),Ve("1w")}function hu(){we="score",$e="desc",ke="score",Fe="desc",Ci="1",wi="1",gt("#view-divergence .divergence-daily-sort",we,$e),gt("#view-divergence .divergence-weekly-sort",ke,Fe)}function or(t,e,n=!0){if(t==="daily"?Ci=e:wi=e,document.querySelectorAll(`.column-tf-controls[data-column="${t}"]`).forEach(i=>{i.querySelectorAll(".tf-btn[data-tf]").forEach(r=>{const s=r;s.classList.toggle("active",s.dataset.tf===e)})}),n){const i=t==="daily"?"1d":"1w";Et(i).then(()=>Ve(i))}}let mt="score",pt="score",Ot="desc",Ht="desc";function Po(t){t===mt&&t!=="favorite"?Ot=Ot==="desc"?"asc":"desc":(mt=t,Ot="desc"),gt(".ticker-daily-sort",mt,Ot);const e=document.getElementById("ticker-view");if(!e)return;const n=e.dataset.ticker;n&&Ir(n,{refreshCharts:!1})}function _o(t){t===pt&&t!=="favorite"?Ht=Ht==="desc"?"asc":"desc":(pt=t,Ht="desc"),gt(".ticker-weekly-sort",pt,Ht);const e=document.getElementById("ticker-view");if(!e)return;const n=e.dataset.ticker;n&&Ir(n,{refreshCharts:!1})}function Ir(t,e={}){const n=e.refreshCharts!==!1,i=[...Zo(),...hi()];yi(i);const r=i.filter(c=>c.ticker===t);let s=r.filter(c=>(c.timeframe||"").trim()==="1d"),o=r.filter(c=>(c.timeframe||"").trim()==="1w");const a=(c,u)=>u==="1"?ft(c,1):u==="2"?ft(c,2):u==="5"?ft(c,5):c;s=a(s,ii("daily")),o=a(o,ii("weekly")),mt==="favorite"&&(s=s.filter(c=>c.is_favorite)),pt==="favorite"&&(o=o.filter(c=>c.is_favorite)),s.sort(Qt(mt==="favorite"?"time":mt,Ot)),o.sort(Qt(pt==="favorite"?"time":pt,Ht));const l=document.getElementById("ticker-daily-container");l&&(l.innerHTML=s.map(en).join(""),s.length>0&&Jt(l));const d=document.getElementById("ticker-weekly-container");d&&(d.innerHTML=o.map(en).join(""),o.length>0&&Jt(d)),n&&Ce(t)}let In=null,Bo=5,ar="SVIX";async function gu(t,e){const n=await fetch(`/api/breadth?ticker=${t}&days=${e}`);if(!n.ok)throw new Error("Failed to fetch breadth data");return n.json()}function rs(t){if(t.length===0)return[];const e=t[0];return e===0?t.map(()=>100):t.map(n=>n/e*100)}function yu(t,e,n){const i=document.getElementById("breadth-chart");if(!i)return;const r=ue();In&&(In.destroy(),In=null);const s=n?new Set(t.map(u=>new Date(u.date).toLocaleDateString("en-US",{timeZone:r}))).size:0,o=t.map(u=>{if(n){const p=new Date(u.date);return s>1?p.toLocaleDateString("en-US",{month:"numeric",day:"numeric",timeZone:r}):p.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",timeZone:r})}return new Date(u.date+"T00:00:00").toLocaleDateString("en-US",{month:"short",day:"numeric",timeZone:r})}),a=t.map(u=>u.spy),l=t.map(u=>u.comparison),d=rs(a),c=rs(l);In=new Chart(i,{type:"line",data:{labels:o,datasets:[{label:"SPY",data:d,borderColor:"#58a6ff",backgroundColor:"transparent",borderWidth:2.5,pointRadius:d.length>15?0:3,pointHoverRadius:5,tension:.3,order:1,fill:!1},{label:e,data:c,borderColor:"#d2a8ff",backgroundColor:"transparent",borderWidth:2.5,pointRadius:c.length>15?0:3,pointHoverRadius:5,tension:.3,order:2,fill:{target:0,above:"rgba(63, 185, 80, 0.18)",below:"rgba(248, 81, 73, 0.18)"}}]},options:{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{labels:{color:"#c9d1d9",font:{size:12},usePointStyle:!0,pointStyle:"line"}},tooltip:{backgroundColor:"rgba(22, 27, 34, 0.95)",borderColor:"#30363d",borderWidth:1,titleColor:"#c9d1d9",bodyColor:"#8b949e",padding:12,callbacks:{label:function(u){const f=u.parsed.y.toFixed(2);return`${u.dataset.label}: ${f}`}}},filler:{propagate:!0}},scales:{x:{ticks:{color:"#8b949e",maxRotation:0,autoSkip:!0,maxTicksLimit:10,font:{size:11}},grid:{color:"rgba(48, 54, 61, 0.3)"}},y:{ticks:{color:"#8b949e",font:{size:11},callback:function(u){return u.toFixed(1)}},grid:{color:"rgba(48, 54, 61, 0.3)"}}}}})}async function Rr(){const t=document.getElementById("breadth-error");t&&(t.style.display="none");try{const e=await gu(ar,Bo);if(e.points.length===0){t&&(t.textContent="No data available for this timeframe",t.style.display="block");return}yu(e.points,ar,e.intraday)}catch(e){console.error("Breadth load error:",e),t&&(t.textContent="Failed to load breadth data",t.style.display="block")}}function bu(t){Bo=t,document.querySelectorAll("#breadth-tf-btns .tf-btn").forEach(e=>{e.classList.toggle("active",Number(e.dataset.days)===t)}),Rr()}function vu(t){ar=t,document.querySelectorAll("#breadth-metric-btns .tf-btn").forEach(e=>{e.classList.toggle("active",e.dataset.metric===t)}),Rr()}function Vo(){Rr()}let Kt=null,Hi=!1;const Un=8;let le=0,Zt=[];function ae(t){return String(t??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function G(t,e=0){const n=Number(t);return Number.isFinite(n)?n.toFixed(Math.max(0,e)):"--"}function Oo(t){const e=String(t||"").trim();return e||"idle"}function Su(t){const e=String(t||"").trim();if(!e)return"--";const n=new Date(e);return Number.isNaN(n.getTime())?"--":n.toLocaleString()}function zi(t,e,n){const i=Oo(e?.status||n?.status||(n?.running?"running":"idle")),r=Number(e?.tickers?.processed??n?.processed_tickers??0),s=Number(e?.tickers?.total??n?.total_tickers??0),o=Number(e?.tickers?.errors??0),a=G(e?.api?.p95LatencyMs,1),l=G(e?.api?.avgLatencyMs,1),d=G(e?.api?.calls,0),c=G(e?.api?.failures,0),u=G(e?.api?.rateLimited,0),f=G(e?.db?.flushCount,0),p=G(e?.db?.summaryRows,0),h=G(e?.db?.signalRows,0),m=G(e?.durationSeconds,1),g=ae(e?.phase||"--"),w=Array.isArray(e?.failedTickers)?e.failedTickers:[],y=Array.isArray(e?.retryRecovered)?e.retryRecovered:[],v=w.length,C=y.length;let M="";if(v>0||C>0){const H=w.map(He=>`<span class="log-failed-ticker">${ae(He)}</span>`).join(""),ne=y.map(He=>`<span class="log-recovered-ticker">${ae(He)}</span>`).join("");M=`
          <details class="log-failed-details">
            <summary class="log-failed-summary">
              ${v>0?`${v} failed`:""}${v>0&&C>0?", ":""}${C>0?`${C} recovered via retry`:""}
            </summary>
            <div class="log-failed-body">
              ${v>0?`<div class="log-failed-label">Failed:</div><div class="log-failed-list">${H}</div>`:""}
              ${C>0?`<div class="log-recovered-label">Recovered:</div><div class="log-failed-list">${ne}</div>`:""}
            </div>
          </details>
        `}return`
      <article class="log-run-card">
        <div class="log-run-card-title">
          <span>${ae(t)}</span>
          <span class="log-run-card-status">${ae(i)}</span>
        </div>
        <div class="log-run-metrics">
          <span class="log-metric-key">Tickers</span><span class="log-metric-val">${r}/${s||0}</span>
          <span class="log-metric-key">Errors</span><span class="log-metric-val">${o}</span>
          <span class="log-metric-key">API calls</span><span class="log-metric-val">${d}</span>
          <span class="log-metric-key">API fail</span><span class="log-metric-val">${c}</span>
          <span class="log-metric-key">429 count</span><span class="log-metric-val">${u}</span>
          <span class="log-metric-key">API p95 ms</span><span class="log-metric-val">${a}</span>
          <span class="log-metric-key">API avg ms</span><span class="log-metric-val">${l}</span>
          <span class="log-metric-key">DB flushes</span><span class="log-metric-val">${f}</span>
          <span class="log-metric-key">Summary rows</span><span class="log-metric-val">${p}</span>
          <span class="log-metric-key">Signal rows</span><span class="log-metric-val">${h}</span>
          <span class="log-metric-key">Duration s</span><span class="log-metric-val">${m}</span>
          <span class="log-metric-key">Phase</span><span class="log-metric-val">${g}</span>
        </div>
        ${M}
      </article>
    `}function Du(t){const e=t.config||{},n=ae(e.divergenceSourceInterval||"--"),i=G(e.divergenceLookbackDays,0),r=G(e.divergenceConcurrencyConfigured,0),s=G(e.divergenceFlushSize,0),o=G(e.dataApiMaxRequestsPerSecond,0),a=G(e.dataApiRateBucketCapacity,0),l=G(e.dataApiTimeoutMs,0),d=t.schedulerEnabled?"on":"off";return`
      <article class="log-run-card">
        <div class="log-run-card-title">
          <span>Runtime Config</span>
          <span class="log-run-card-status">${ae(d)}</span>
        </div>
        <div class="log-run-metrics">
          <span class="log-metric-key">Source</span><span class="log-metric-val">${n}</span>
          <span class="log-metric-key">Lookback d</span><span class="log-metric-val">${i}</span>
          <span class="log-metric-key">Concurrency</span><span class="log-metric-val">${r}</span>
          <span class="log-metric-key">Flush size</span><span class="log-metric-val">${s}</span>
          <span class="log-metric-key">API max rps</span><span class="log-metric-val">${o}</span>
          <span class="log-metric-key">Bucket cap</span><span class="log-metric-val">${a}</span>
          <span class="log-metric-key">Timeout ms</span><span class="log-metric-val">${l}</span>
        </div>
      </article>
    `}function xu(t){const e=document.getElementById("logs-run-cards");if(!e)return;const n=[zi("Fetch Daily",t.runs?.fetchDaily,t.statuses?.fetchDaily),zi("Fetch Weekly",t.runs?.fetchWeekly,t.statuses?.fetchWeekly),zi("VDF Scan",t.runs?.vdfScan,t.statuses?.vdfScan),Du(t)];e.innerHTML=n.join("")}function Cu(t){const e=Number(t?.tickers?.processed||0),n=Number(t?.tickers?.total||0),i=Number(t?.tickers?.errors||0),r=Number(t?.api?.calls||0),s=G(t?.api?.p95LatencyMs,1),o=Array.isArray(t?.failedTickers)?t.failedTickers:[],a=Array.isArray(t?.retryRecovered)?t.retryRecovered:[],l=o.length,d=a.length;let c="";if(l>0||d>0){const u=o.map(p=>`<span class="log-failed-ticker">${ae(p)}</span>`).join(""),f=a.map(p=>`<span class="log-recovered-ticker">${ae(p)}</span>`).join("");c=`
          <details class="log-failed-details">
            <summary class="log-failed-summary">
              ${l>0?`${l} failed`:""}${l>0&&d>0?", ":""}${d>0?`${d} recovered`:""}
            </summary>
            <div class="log-failed-body">
              ${l>0?`<div class="log-failed-label">Failed:</div><div class="log-failed-list">${u}</div>`:""}
              ${d>0?`<div class="log-recovered-label">Recovered:</div><div class="log-failed-list">${f}</div>`:""}
            </div>
          </details>
        `}return`
      <article class="log-history-entry">
        <div class="log-history-header">
          <span>${ae(String(t?.runType||"run"))}</span>
          <span>${ae(Oo(t?.status))}</span>
        </div>
        <div class="log-history-sub">
          ${ae(Su(t?.startedAt))} |
          tickers ${e}/${n}${i>0?` (${i} err)`:""} |
          api ${r} |
          p95 ${s}ms
        </div>
        ${c}
      </article>
    `}function lr(){const t=document.getElementById("logs-history-container");if(!t)return;if(Zt.length===0){t.innerHTML='<div class="loading">No run history yet</div>';return}const e=Math.ceil(Zt.length/Un);le>=e&&(le=e-1),le<0&&(le=0);const n=le*Un,i=Zt.slice(n,n+Un),r=le===0,s=le>=e-1,o=i.map(Cu).join(""),a=e>1?`
      <div class="log-history-pagination">
        <button class="tf-btn log-history-prev${r?" disabled":""}" title="Previous page"${r?" disabled":""}>&#x2039;</button>
        <button class="tf-btn log-history-next${s?" disabled":""}" title="Next page"${s?" disabled":""}>&#x203A;</button>
      </div>
    `:"";t.innerHTML=o+a}function wu(t){Zt=Array.isArray(t.history)?t.history:[],lr()}async function ku(){const t=await fetch("/api/logs/run-metrics",{cache:"no-store"});if(!t.ok)throw new Error(`Failed to fetch run metrics (HTTP ${t.status})`);return t.json()}async function Li(){if(!Hi){Hi=!0;try{const t=await ku();xu(t),wu(t)}catch(t){const e=document.getElementById("logs-history-container");e&&(e.innerHTML='<div class="loading">Failed to load logs</div>'),console.error("Failed to refresh logs view:",t)}finally{Hi=!1}}}function Tu(){Kt===null&&(Kt=window.setInterval(()=>{Li().catch(()=>{})},5e3))}function Eu(){Kt!==null&&(window.clearInterval(Kt),Kt=null)}function Mu(){document.getElementById("logs-refresh-btn")?.addEventListener("click",()=>{Li().catch(()=>{})}),document.addEventListener("click",e=>{const n=e.target;if(n.closest(".log-history-prev"))le>0&&(le--,lr());else if(n.closest(".log-history-next")){const i=Math.ceil(Zt.length/Un);le<i-1&&(le++,lr())}})}let Yt="divergence",Ho=0,zo="divergence",Uo=null,ss=!1;const os=8;window.setTickerDailySort=Po;window.setTickerWeeklySort=_o;function Wo(){return Uo}function qo(){return zo}window.showTickerView=function(t,e="divergence",n=null){zo=e,Uo=n,Ho=window.scrollY,Yt!=="divergence"&&Ai("divergence"),Go("divergence");const i=document.getElementById("ticker-view");i&&(Nr(),i.dataset.ticker=t,document.getElementById("dashboard-view")?.classList.add("hidden"),document.getElementById("view-divergence")?.classList.add("hidden"),i.classList.remove("hidden"),Ir(t),window.scrollTo(0,0))};window.showOverview=function(){Nr();const t=document.getElementById("ticker-view");t&&delete t.dataset.ticker,Ai("divergence"),window.scrollTo(0,Ho)};function Ai(t){Yt=t,Go(t),document.getElementById("view-logs")?.classList.add("hidden"),document.getElementById("view-divergence")?.classList.add("hidden"),document.getElementById("view-breadth")?.classList.add("hidden"),document.getElementById("ticker-view")?.classList.add("hidden"),Nr(),Eu(),jo(),t==="logs"?(document.getElementById("view-logs")?.classList.remove("hidden"),Li().catch(()=>{}),Tu()):t==="divergence"?(document.getElementById("view-divergence")?.classList.remove("hidden"),Ei().then(Mi),Nt()):t==="breadth"&&(document.getElementById("view-breadth")?.classList.remove("hidden"),Vo())}function jo(){document.getElementById("header-nav-dropdown")?.classList.add("hidden"),document.getElementById("header-nav-dropdown")?.classList.remove("open")}function Go(t){document.querySelectorAll(".header-nav-item").forEach(e=>e.classList.remove("active")),document.querySelector(`.header-nav-item[data-view="${t}"]`)?.classList.add("active")}function Lu(){const t=document.getElementById("search-toggle"),e=document.getElementById("search-input"),n=document.getElementById("search-container");!t||!e||!n||(t.addEventListener("click",i=>{i.stopPropagation(),e.classList.contains("active")?(e.classList.remove("active"),e.blur()):(e.classList.add("active"),e.focus())}),n.addEventListener("click",()=>{e.classList.contains("active")||(e.classList.add("active"),e.focus())}),e.addEventListener("keydown",i=>{if(i.key==="Enter"){const r=e.value.trim().toUpperCase();r&&(window.showTickerView(r),e.value="",e.blur(),e.classList.remove("active"))}}),document.addEventListener("keydown",i=>{document.activeElement instanceof HTMLInputElement||document.activeElement instanceof HTMLTextAreaElement||document.activeElement.isContentEditable||i.ctrlKey||i.altKey||i.metaKey||i.key.length>1||/^[a-zA-Z0-9]$/.test(i.key)&&(e.classList.contains("active")||e.classList.add("active"),e.focus())}))}async function Au(){if(Yt==="divergence"){await Ei(),Mi();return}if(Yt==="breadth"){Vo();return}Yt==="logs"&&await Li()}function Nu(){const t=document.getElementById("global-settings-container"),e=document.getElementById("global-settings-toggle"),n=document.getElementById("global-settings-panel");let i=document.getElementById("global-timezone-select");if(!t||!e||!n)return;const r=()=>{n.querySelectorAll(".global-settings-toggle-row").forEach(f=>f.remove());const c=n.querySelector("#global-enable-v3-fetch, #enable-v3-fetch");c&&(c.closest(".global-settings-row")||c).remove(),n.querySelectorAll("label, span, div").forEach(f=>{String(f.textContent||"").trim().toLowerCase()==="enable v3 fetch"&&(f.closest(".global-settings-row")||f).remove()})},s=()=>{if(i)return i;const c=document.createElement("div");c.className="global-settings-row global-settings-timezone-row";const u=document.createElement("label");u.className="global-settings-label",u.htmlFor="global-timezone-select",u.textContent="Timezone";const f=document.createElement("select");return f.id="global-timezone-select",f.className="glass-input global-settings-select",f.setAttribute("aria-label","Timezone"),c.append(u,f),n.append(c),i=f,f};r(),i=s();const o=i,a=()=>{n.classList.add("hidden"),e.classList.remove("active")},l=()=>{n.classList.remove("hidden"),e.classList.add("active"),o.value=ue()},d=ia();o.innerHTML=d.map(c=>`<option value="${c.value}">${c.label}</option>`).join(""),o.value=ue(),o.addEventListener("change",()=>{ra(o.value)}),sa(c=>{o.value=c,Au().catch(u=>{console.error("Failed to refresh UI after timezone change:",u)})}),e.addEventListener("click",c=>{c.stopPropagation(),n.classList.contains("hidden")?(l(),Nt().catch(()=>{})):a()}),n.addEventListener("click",c=>{c.stopPropagation()}),document.addEventListener("click",c=>{const u=c.target;u&&(u.closest("#global-settings-container")||a())})}async function Iu(){try{return(await fetch("/api/auth/check")).ok}catch{return!1}}async function Ru(t){try{return(await fetch("/api/auth/verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({passcode:t})})).ok}catch{return!1}}async function $u(t){const e=document.getElementById("site-lock-overlay");if(!e){t();return}e.dataset.doubleTapBound||(e.addEventListener("dblclick",y=>{y.preventDefault()}),e.dataset.doubleTapBound="1");const n=e.querySelector(".site-lock-panel"),i=document.getElementById("site-lock-status"),r=Array.from(e.querySelectorAll(".site-lock-dot")),s=Array.from(e.querySelectorAll("[data-lock-digit]")),o=Array.from(e.querySelectorAll("[data-lock-action]"));if(await Iu()){e.classList.add("hidden"),document.body.classList.remove("site-locked"),t();return}document.body.classList.add("site-locked"),e.classList.remove("hidden");let a="",l=!1;const d=()=>{for(let y=0;y<r.length;y++)r[y].classList.toggle("filled",y<a.length)},c=y=>{i&&(i.textContent=y)},u=()=>{a="",d()},f=()=>{e.classList.add("hidden"),document.body.classList.remove("site-locked"),window.removeEventListener("keydown",w,!0),t()},p=()=>{c(""),u(),n&&(n.classList.remove("shake"),n.offsetWidth,n.classList.add("shake")),window.setTimeout(()=>{n&&n.classList.remove("shake")},320)},h=async()=>{if(a.length<os||l)return;l=!0;const v=await Ru(a);l=!1,v?f():p()},m=y=>{/^[0-9]$/.test(y)&&(a.length>=os||(a+=y,c(""),d(),h()))},g=()=>{a.length&&(a=a.slice(0,-1),c(""),d())};s.forEach(y=>{y.addEventListener("click",()=>{m(String(y.dataset.lockDigit||""))})}),o.forEach(y=>{y.addEventListener("click",()=>{const v=String(y.dataset.lockAction||"");if(v==="clear"){u(),c("");return}v==="back"&&g()})});const w=y=>{if(e.classList.contains("hidden"))return;const v=y.key;if(/^[0-9]$/.test(v)){y.preventDefault(),m(v);return}if(v==="Backspace"){y.preventDefault(),g();return}v==="Escape"&&(y.preventDefault(),u(),c(""))};window.addEventListener("keydown",w,!0),d()}function Fu(){const t=document.getElementById("header-nav-toggle"),e=document.getElementById("header-nav-dropdown");!t||!e||(t.addEventListener("click",n=>{n.stopPropagation(),Xt(),e.classList.contains("open")?(e.classList.remove("open"),setTimeout(()=>e.classList.add("hidden"),150)):(e.classList.remove("hidden"),requestAnimationFrame(()=>e.classList.add("open")))}),e.addEventListener("click",n=>{const i=n.target.closest(".header-nav-item");if(!i)return;const r=i.dataset.view;r&&(Ai(r),e.classList.remove("open"),setTimeout(()=>e.classList.add("hidden"),150))}))}function Pu(){document.addEventListener("click",t=>{const e=t.target,n=e.closest(".column-tf-controls .tf-btn[data-tf]");if(n){const r=n.closest(".column-tf-controls");if(!r)return;const s=r.dataset.column,o=n.dataset.tf;if(!s||!o)return;if(o==="custom"){const a=r.querySelector(".column-tf-custom-panel");if(a){const l=!a.classList.contains("hidden");Xt(),l||(a.classList.remove("hidden"),requestAnimationFrame(()=>a.classList.add("open")))}or(s,o,!1);return}Xt(),or(s,o);return}const i=e.closest(".column-tf-apply");if(i){const r=i.closest(".column-tf-custom-panel");r&&Vu(r);return}e.closest(".column-tf-custom-panel")||e.closest(".column-tf-controls")||Xt()}),document.addEventListener("input",_u),document.addEventListener("keydown",Bu)}function as(t){const e=t.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);return e?`${e[3]}-${e[1]}-${e[2]}`:null}function _u(t){const e=t.target;if(!e||!(e.classList.contains("column-tf-from")||e.classList.contains("column-tf-to")))return;let i=e.value.replace(/\D/g,"");i.length>8&&(i=i.slice(0,8));let r="";if(i.length<=2?r=i:i.length<=4?r=i.slice(0,2)+"/"+i.slice(2):r=i.slice(0,2)+"/"+i.slice(2,4)+"/"+i.slice(4),e.value=r,r.length===10&&e.classList.contains("column-tf-from")){const o=e.closest(".column-tf-custom-panel")?.querySelector(".column-tf-to");o&&!o.value&&o.focus()}}function Bu(t){const e=t.target;!e||!(e.classList.contains("column-tf-from")||e.classList.contains("column-tf-to"))||t.key==="Enter"&&(t.preventDefault(),e.closest(".column-tf-custom-panel")?.querySelector(".column-tf-apply")?.click())}function Vu(t){const e=t.closest(".column-tf-controls");if(!e)return;const n=e.dataset.column,i=t.querySelector(".column-tf-from"),r=t.querySelector(".column-tf-to"),s=as(i?.value||""),o=as(r?.value||"");n&&s&&o&&(Xc(n,s,o),or(n,"custom")),Xt()}function Xt(){document.querySelectorAll(".column-tf-custom-panel").forEach(t=>{t.classList.remove("open"),t.classList.add("hidden")})}function Ou(){ss||(ss=!0,document.getElementById("ticker-back-btn")?.addEventListener("click",window.showOverview),document.getElementById("divergence-fetch-daily-btn")?.addEventListener("click",()=>{su()}),document.getElementById("divergence-fetch-daily-stop-btn")?.addEventListener("click",()=>{au()}),document.getElementById("divergence-fetch-weekly-btn")?.addEventListener("click",()=>{ou()}),document.getElementById("divergence-fetch-weekly-stop-btn")?.addEventListener("click",()=>{lu()}),document.getElementById("divergence-vdf-scan-btn")?.addEventListener("click",()=>{cu()}),document.getElementById("divergence-vdf-scan-stop-btn")?.addEventListener("click",()=>{uu()}),document.querySelectorAll(".ticker-daily-sort .tf-btn").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.sort;Po(e)})}),document.querySelectorAll(".ticker-weekly-sort .tf-btn").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.sort;_o(e)})}),document.querySelectorAll("#breadth-tf-btns .tf-btn").forEach(t=>{t.addEventListener("click",()=>{const e=Number(t.dataset.days);bu(e)})}),document.querySelectorAll("#breadth-metric-btns .tf-btn").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.metric;vu(e);const n=document.getElementById("breadth-subtitle");n&&(n.textContent=`SPY vs ${e} — Normalized`)})}),Fu(),Pu(),document.addEventListener("click",t=>{const e=t.target;e&&(e.closest("#header-nav-container")||jo())}),hu(),Nt().catch(()=>{}),Ai("divergence"),Nu(),Lu(),Mu(),fu(),Hu(),Fc())}document.addEventListener("DOMContentLoaded",()=>{$u(()=>{Ou()})});function Hu(){((e,n)=>{e&&e.addEventListener("click",i=>{if(window.innerWidth>768)return;const r=i.target;if(!r)return;const s=r.closest("h2");if(!s||!(s.closest(".column-header")||s.closest(".header-title-group")))return;const a=s.closest(".column");a&&a.closest(n)&&a.classList.toggle("collapsed")})})(document.getElementById("view-divergence"),"#divergence-dashboard-view")}
